SchemaVersion: '1.0'
DataTypes:
- DataType: UserPeerAnalytics
Provider: Sentinel
Type: KQL
EntitiesFilter: {}
BaseQuery: |
  let GetUserPeers = (v_Account_Name:string, v_Account_UPNSuffix:string) { 
  UserPeerAnalytics 
  | extend Account_UPN = strcat(v_Account_Name, '@',v_Account_UPNSuffix) 
  | where UserPrincipalName == Account_UPN};
  GetUserPeers('{{Account_Name}}', '{{Account_UPNSuffix}}')
RequiredInputFieldsSets:
- - Account_Name
  - Account_UPNSuffix
Insights:
  Id: b54b34e3-1c57-440b-b81e-9e82fea8dfcc
  DisplayName: User Peers Based on Security Groups Membership
  Description: "### Description\n ___ \nThis insight presents the user's peers based on Azure AD Security Groups membership"
  DefaultTimeRange:
    BeforeRange: 14d
    AfterRange: 0d
  ReferenceTimeRange:
    BeforeRange: 0d
  SingleValuesQuery: {}
  TableQuery:
    ColumnsDefinitions:
    - Header: Rank
      OutputType: String
      SupportDeepLink: false
    - Header: Peer Name
      OutputType: String
      SupportDeepLink: false
    - Header: Peer UPN
      OutputType: String
      SupportDeepLink: false
    QueriesDefinitions:
    - Filter: "where true"
      Summarize: "summarize arg_max(TimeGenerated,*) by PeerUserId | sort by Rank asc"
      Project: "project Rank, ['Peer Name']=PeerUserName,['Peer UPN']=PeerUserPrincipalName | take 8"
      LinkColumnsDefinitions: []
  AdditionalQuery:
    Text: View all peers
    Query: "summarize arg_max(TimeGenerated,*) by PeerUserId | sort by Rank asc | project Rank, ['Peer Name']=PeerUserName,['Peer UPN']=PeerUserPrincipalName"
