param([string]$ManagedIdentityPrincipalId)

#Define WindowsDefenderATP Application ID and required permissions"
$appId = 'fc780465-2017-40d4-a0c5-307022471b92'
$permissionsNeeded = "SecurityRecommendation.Read.All", "Vulnerability.Read.All"

#Lookup Application Service Principal and permission (App Role) ID information. 
$graph = Get-AzADServicePrincipal -Filter "AppId eq '$appId'"
$permissions = $graph.AppRole | Where-Object Value -in $permissionsNeeded

#Assign defined permissions (App Roles) to the Managed Identity.
foreach ($permission in $permissions) {
    $body = New-Object psobject
    $body | Add-Member -NotePropertyName 'principalId' -NotePropertyValue $ManagedIdentityPrincipalId
    $body | Add-Member -NotePropertyName 'resourceId' -NotePropertyValue $graph.Id
    $body | Add-Member -NotePropertyName 'appRoleId' -NotePropertyValue $permission.id
  
    Invoke-AzRestMethod -Method POST -Uri "https://graph.microsoft.com/v1.0/servicePrincipals/$ManagedIdentityPrincipalId/appRoleAssignedTo" `
        -Payload (ConvertTo-Json $body)
}

#Confirm the new App Role assignments are in place.
#$roleAssignments = Invoke-AzRestMethod -Method GET -Uri "https://graph.microsoft.com/v1.0/servicePrincipals/$ManagedIdentityPrincipalId/appRoleAssignments"
#($roleAssignments.Content | ConvertFrom-Json).value
