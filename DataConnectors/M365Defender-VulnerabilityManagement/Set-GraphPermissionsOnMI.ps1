param([string] $ManagedIdentityPrincipalId, [string] $AppId, [array] $PermissionsNeeded)

#Lookup Application Service Principal and permission (App Role) ID information. 
$graph = Get-AzADServicePrincipal -Filter "AppId eq '$AppId'"
$permissions = $graph.AppRole | Where-Object Value -in $PermissionsNeeded

#Assign defined permissions (App Roles) to the Managed Identity.
foreach ($permission in $permissions) {
    $body = @{
        principalId = $ManagedIdentityPrincipalId
        resourceId = $graph.Id
        appRoleId = $permission.id
    }
  
    Invoke-AzRestMethod -Method POST -Uri "https://graph.microsoft.com/v1.0/servicePrincipals/$ManagedIdentityPrincipalId/appRoleAssignedTo" `
        -Payload (ConvertTo-Json $body)
}

#Confirm the new App Role assignments are in place.
$roleAssignments = Invoke-AzRestMethod -Method GET -Uri "https://graph.microsoft.com/v1.0/servicePrincipals/$ManagedIdentityPrincipalId/appRoleAssignments"
($roleAssignments.Content | ConvertFrom-Json).value