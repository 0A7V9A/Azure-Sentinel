# Ingest M365 Vulnerability Management Data
Author: Alex Anders

This data connector uses a Function App to pull Threat and Vulnerability Management (TVM) data from the M365 Defender API and ingest into the selected Log Analytics workspace via the Azure Monitor DCR API. Three custom tables are created in the workspace:
- TVMRecommendations_CL
- TVMCVEKB_CL
- TVMVulnerabilitiesByDevice_CL

## **Pre-requisites**

To deploy, users will need:
1. An Azure Subscription
2. An Azure Sentinel/Log Analytics workspace
3. An App Registration within Azure Active Directory that has the appropriate permissions to the Defender API.
4. A user that has Log Analytics Contributor or higher permissions on the destination Log Analytics workspace.

## **Set Up**
First, an application needs to registered in Azure AD and assigned API permissions.
1.	Go to https://aad.portal.azure.com/ <strong>> Azure Active Directory > App registrations > click on +New registration</strong>
2.	Enter name (DefenderTVM) and click on Register
3.	And now we need to add permissions connected to Microsoft Defender for Endpoint<br>
- Click on <strong>+Add a permission</strong> and click on <strong>APIs my organization use</strong>. Search for <strong>WindowsDefenderATP</strong> and select it. Select Application permissions and then search and select following permissions <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i.	SecurityRecommendation.Read.All <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ii. Vulnerability.Read.All<br>
- Click on Add permission
4.	Click on <strong>Grant admin consent for {name of your organization}</strong>
5.	Next we need to generate Secret. Click on <strong>Certificates & Secrets</strong> from right menu and choose <strong>+New client secret</strong>
6.	Enter description (M365TVM Secret), select Never and click on Add
7.	Copy <strong>Value</strong> of the secret – if you don’t copy you’ll need to recreate it – you cannot see it once you leave this view
8.	Now click on Overview from right menu and copy fields <strong>Application (client) ID</strong>, <strong>Directory (Tenant) ID</strong>, and <strong>Object ID</strong>

Once the application is ready, obtain the <strong>Log Analytics Workspace Azure Resource Id</strong> and <strong>location</strong>. The Function App can now be deployed. 

## **Deployment Process**
## **Option 1**
1. Click on the "Deploy to Azure" button.
2. Once in the Azure Portal, select the Subscription and Resource Group that Azure Sentinel is under.
3. Enter the details that are required for the Playbook.
4. Click "Review and Create".
5. Click "Create".
6. Within a minute or two, the template should deploy and the Playbook should appear within the Azure Sentinel environment. 

## **Option 2**
1. Enter the template within the GitHub folder.
2. In the top right corner, select Raw.
3. Copy the raw text within the template.
4. Go to the Azure Portal.
5. Within the search bar at the top, type "Deploy" and select "Deploy a custom template".
6. Select "build my own template in the editor".
7. Within the template space, paste the text copied from GitHub.
8. Select the Subscription and Resource Group that where you would like to deploy the Function App and dependencies.
9. Enter the details that are required for the deployment.
10. Click "Review and Create".
11. Click "Create".

[![Deploy to Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fanders-alex%2FAzure-Sentinel%2FDataConnector-M365Defender-VulnerabilityManagement%2FDataConnectors%2FM365Defender-VulnerabilityManagement%2FazureDeploy.json)
