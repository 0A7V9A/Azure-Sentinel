# Ingest M365 Vulnerability Management Data
Author: Alex Anders

This custom data connector uses a Function App to pull Microsoft Defender Vulnerability Management (MDVM) data from the M365 Defender API and ingests into the selected Log Analytics workspace via the Azure Monitor DCR API. Public NIST CVE information is also ingested to enrich the MDVM data. Six custom tables are created in the workspace:
- *MDVMCVEKB_CL* - MDVM CVE knowledge base.
- *MDVMNISTCVEKB_CL* - NIST CVE knowledge base
- *MDVMNISTConfigurations_CL* - NIST CVE knowledge base: known vulnerable software configurations.
- *MDVMRecommendations_CL* - MDVM recommendations.
- *MDVMRecommendationsMachineReferences_CL* - Shows which machines/devices are associated with the applicable recommendations.
- *MDVMVulnerabilitiesByDevice_CL* - Shows which machines/devices are associated with CVEs detected in the environment.


## **Pre-requisites**
1. An Azure Subscription
2. An Azure Sentinel/Log Analytics workspace
3. Permissions required to deploy resources:
    - Owner permissions on the target resource group.
    - Log Analytics Contributor or higher permissions on the destination Log Analytics workspace.
4. Permissions required for assigning the needed permissions post deployment:
    - Global Admin or Application Administrator privileges on Defender Azure AD tenant. This is to give the solution access to the Defender API.
    - Owner or User Access Administrator access to subscriptions containing Virtual Machines or Arc Server resources. This is to provide the solution reader access.

## **Deployment Process**
## 1. Deploy Azure Resources
1. Click on the "Deploy to Azure" button.
2. Once in the Azure Portal, select the Subscription and Resource Group to deploy the resources into.
3. Populate the required Log Analytics Workspace ID and Location parameters. Modify the default parameters as needed but most users can leave these alone.
4. Click "Review and Create".
5. Click "Create".
6. When the deployment has completed, grab the UserAssignedManagedIdentityPrincipalId and UserAssignedManagedIdentityPrincipalName values from the deployment Outputs section. These will be used in the next step.

## 2. Assign Needed Permissions
After the resources have been deployed, we need to assign the appropriate M365 Defender API and Azure permissions to the newly created User Assigned Managed Identity by doing the following:
1. Using the provided Set-GraphPermissionsOnMI.ps1 script, run the following command:
```PowerShell
.\Set-GraphPermissionsOnMI.ps1 -ManagedIdentityPrincipalId [UserAssignedManagedIdentityPrincipalId value Copied from step 6 above.] -AppId 'fc780465-2017-40d4-a0c5-307022471b92' -PermissionsNeeded ("SecurityRecommendation.Read.All", "Vulnerability.Read.All")
```
2. Assign the User Assigned Managed Identity Reader access to all management groups/subscriptions that contain Virtual Machine or Arc Server resources. Do this by: 
    - Navigate to the appropriate management group/subscription in the Azure portal.
    - Select the Access Control (IAM) menu.
    - Select Add => Add Role Assignment.
    - Select the Reader Role and click Next.
    - Select Managed Identity, Select Members, and search for the User Assigned Managed Identity created during the deployment. The name was capture in step 6 above.
    - Click Next, then Review and Assign.



[![Deploy to Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fanders-alex%2FAzure-Sentinel%2FDataConnector-M365Defender-VulnerabilityManagement%2FDataConnectors%2FM365Defender-VulnerabilityManagement%2FazureDeploy.json)
