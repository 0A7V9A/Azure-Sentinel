# Ingest M365 Vulnerability Management Data
Author: Alex Anders

This data connector uses a Function App to pull Microsoft Defender Vulnerability Management (MDVM) data from the M365 Defender API and ingest into the selected Log Analytics workspace via the Azure Monitor DCR API. Three custom tables are created in the workspace:
- MDVMRecommendations_CL
- MDVMRecommendationsMachineReferences_CL
- MDVMCVEKB_CL
- MDVMVulnerabilitiesByDevice_CL


## **Pre-requisites**

To deploy, users will need:
1. An Azure Subscription
2. An Azure Sentinel/Log Analytics workspace
3. A user that has Global Admin or Application Administrator privileges on Defender Azure AD tenant.
4. A user that has Log Analytics Contributor or higher permissions on the destination Log Analytics workspace.
5. A user that can assign reader access to subscriptions containing Virtual Machines or Arc Server resources.

## **Deployment Process**
## **Option 1**
1. Click on the "Deploy to Azure" button.
2. Once in the Azure Portal, select the Subscription and Resource Group that Azure Sentinel is under.
3. Enter the details that are required for the Playbook.
4. Click "Review and Create".
5. Click "Create".
6. Within a minute or two, the template should deploy and the Playbook should appear within the Azure Sentinel environment. 

## **Option 2**
1. Enter the template within the GitHub folder.
2. In the top right corner, select Raw.
3. Copy the raw text within the template.
4. Go to the Azure Portal.
5. Within the search bar at the top, type "Deploy" and select "Deploy a custom template".
6. Select "build my own template in the editor".
7. Within the template space, paste the text copied from GitHub.
8. Select the Subscription and Resource Group that where you would like to deploy the Function App and dependencies.
9. Enter the details that are required for the deployment.
10. Click "Review and Create".
11. Click "Create".

## Post Deployment Permission Assignment
1. Grab the UserAssignedManagedIdentityPrincipalId and UserAssignedManagedIdentityPrincipalName values from the deployment Outputs section.
2. Using the provided Set-GraphPermissionsOnMI.ps1 script, run the following command .\Set-GraphPermissionsOnMI.ps1 -ManagedIdentityPrincipalId [UserAssignedManagedIdentityPrincipalId value Copied from step 1.]
3. Assign the User Assigned Managed Identity Reader access to all management groups/subscriptions that contain Virtual Machine or Arc Server resources.

[![Deploy to Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fanders-alex%2FAzure-Sentinel%2FDataConnector-M365Defender-VulnerabilityManagement%2FDataConnectors%2FM365Defender-VulnerabilityManagement%2FazureDeploy.json)
