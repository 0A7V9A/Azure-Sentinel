id: 87552014-9076-44f3-afc7-56e0a7349112
name: Create account (0)
description: |-
  User accounts may be created to achieve persistence on a machine.
  Read more here: https://attack.mitre.org/wiki/Technique/T1136.
  Tags: #CreateAccount.
  Query #1: Query for users being created using "net user" command.
  "net user" commands are noisy, so needs to be joined with another signal -.
  E.g. in this example we look for use of uncommon & undocumented commandline switches (e.g. /ad instead of /add).
requiredDataConnectors:
- connectorId: Microsoft365Defender
  dataTypes:
  - DeviceProcessEvents
query: "DeviceProcessEvents\r\n// Pro-tip: \r\n// There are many different ways to run a process from a file - e.g. by using full path, env. variables, ~1 annotation, more...\r\n// So, to find executions of a known filename, better filter on the filename (and possibly on folder path) than on the commandline.\r\n| where FileName in~ (\"net.exe\", \"net1.exe\") and Timestamp > ago(3d)\r\n// Parse the user name from the commandline.\r\n// To have case-insensitive parsing use the i flag, to have non-greedy match (e.g. CreatedUser as short as possible), specify U flag:\r\n// \"kind=regex flags=i\"\r\n| parse kind=regex flags=iU ProcessCommandLine with * \"user \" CreatedUser \" \" * \"/ad\"\r\n// Filter rows where user could not be parsed - e.g. because it was not a user command, or the /add commandline switch was not specified.\r\n| where isnotempty(CreatedUser)\r\n// Every net.exe executed will run net1.exe with the same commandline.\r\n// in this where clause we remove such rows, as they duplicate the number of results we have without adding any value.\r\n| where not (FileName =~ \"net1.exe\" and InitiatingProcessFileName =~ \"net.exe\" and replace(\"net\", \"net1\", InitiatingProcessCommandLine) =~ ProcessCommandLine)\r\n// If /domain is specified, so the user is created on the domain controller.\r\n// Also, any prefix that's longer than 1 char will also do the same, e.g. /do, /dom, /doma, ....\r\n| extend CreatedOnLocalMachine=(ProcessCommandLine !contains \"/do\")\r\n| where ProcessCommandLine !contains \"/add\" or (CreatedOnLocalMachine == 0 and ProcessCommandLine !contains \"/domain\")\r\n| summarize MachineCount=dcount(DeviceName) by CreatedUser, CreatedOnLocalMachine, InitiatingProcessFileName, FileName, ProcessCommandLine, InitiatingProcessCommandLine "
