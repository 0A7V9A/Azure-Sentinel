//Name: Exploit/Pentest Framework User Agent
//
//Description: There are several exploit/pen test frameworks that are being used by pen testers as well as attackers to //compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings //used by //these frameworks in some of the data sources that contain UserAgent field. This is based out of sigma rules described here: 
// https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml   
// 
// Id: df75ac6c-7b0b-40d2-82e4-191c012f1a07
//
// DataSource: W3CIISLog, OfficeActivity , AWSCloudTrail
//
// Tactics: #Discovery, #LateralMovement, #PrivilegeEscalation ,#C2 etc.

let UserAgentList = dynamic(["Internet Explorer ", 
"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; InfoPath.2)", 
"Mozilla/5.0 (Windows NT 10.0; Win32; x32; rv:60.0)",
"Mozilla/4.0 (compatible; Metasploit RSPEC)",
"Mozilla/4.0 (compatible; MSIE 6.1; Windows NT)",
"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)",
"Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0)",
"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0; Trident/4.0)",
"Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0; Trident/4.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; .N",
"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US) AppleWebKit/525.13 (KHTML, like Gecko) Chrome/4.0.221.6 Safari/525.13",
"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; MAAU)",
"Mozilla/5.0",
"Mozilla/4.0 (compatible; SPIPE/1.0",
"Mozilla/5.0 (Windows NT 6.3; rv:39.0) Gecko/20100101 Firefox/35.0",
"Sametime Community Agent",
"X-FORWARDED-FOR",
"DotDotPwn v2.1",
"SIPDROID","wordpress hash grabber",
"exploit",
"okhttp/"]);
// build a list to source potential UserAgent matches
(union isfuzzy=true
(OfficeActivity
| where TimeGenerated >= ago(1d) 
// only get items in OfficeActivity that have a UserAgent value
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
// match against list provided
| where UserAgent in~ (UserAgentList)
| extend SourceIP = ClientIP
| project TimeGenerated, Type, UserAgent, SourceIP
),
(
W3CIISLog
| where TimeGenerated >= ago(1d) 
| where csUserAgent in~ (UserAgentList)
| extend UserAgent = csUserAgent, 
SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
),
(
AWSCloudTrail
| where TimeGenerated >= ago(1d) 
| where UserAgent in~ (UserAgentList)
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))