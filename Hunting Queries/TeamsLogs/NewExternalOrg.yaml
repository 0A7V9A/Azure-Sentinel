id: 6fce5baf-bfc2-4c56-a6b7-9c4733fc5a45
name: External user from a new organisation added
description: |
  'This query identifies external users added to Teams where the user's domain is not one 
  previously seen in Teams data.
  This query requires you to have Teams data collected from the O365 Management Activity API
  and the Teams parser function enabled.'
tactics:
  - Persistance
relevantTechniques:
  - T1136
query: |

  // If you have more than 30 days worth of Teams data change this value
  let data_date = 30d;
  // If you want to look at users further back than the last day change this value
  let lookback_data = 1d;
  let known_orgs = (
  TeamsData 
  | where TimeGenerated > ago(data_date)
  | where Operation == "MemberAdded"
  // Parse out the added users UPN and extract the organizations domain
  | extend UPN = tostring(parse_json(Members)[0].UPN)
  | extend Organization = tostring(split(split(UPN, "_")[1], "#")[0])
  | where isnotempty(Organization)
  | summarize by Organization);
  TeamsData 
  | where TimeGenerated > ago(lookback_data)
  | where Operation == "MemberAdded"
  | extend UPN = tostring(parse_json(Members)[0].UPN)
  | extend Organization = tostring(split(split(UPN, "_")[1], "#")[0])
  | where isnotempty(Organization)
  | where Organization !in (known_orgs)