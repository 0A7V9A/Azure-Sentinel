Parser:
  Title: Audit Event ASIM parser for VectraCloud Account Detection Logs Event
  Version: '0.1'
  LastUpdated: Mar 17 2023
Product:
  Name: Vectra
Normalization:
  Schema: AuditEvent
  Version: '0.1.0'
References:
- Title: ASIM Audit Event Schema
  Link: https://aka.ms/ASimAuditEventDoc
- Title: ASIM
  Link: https://aka.ms/AboutASIM
Exceptions:
- Field: Dvc
  Warning: Empty value in mandatory field
  Exception: May be empty for requests for root servers and for requests for RR type DNSKEY
Description: |
  This ASIM parser supports normalizing VectraCloud Account Detection Logs Event in the Account_Detection_Data_CL table to the ASIM Audit Event schema.
ParserName: ASimAuditEventVectraCloudAccountDetection
EquivalentBuiltInParser: _ASim_AuditEvent_VectraCloudAccountDetection
ParserParams:
  - Name: disabled
    Type: bool
    Default: false
ParserQuery: |
  let parser = (disabled:bool = false)
  {
  Account_Detection_Data_CL
  | parse-kv detail_s as (['error_code']:string, ['error_message']:string, ['last_timestamp']: datetime, ['user_agent']: string) with (regex=@'"?(error_code|error_message|last_timestamp|user_agent)":\s"?([^,"]+)"?\s*[,|}]')
  | extend EventMessage = iff((isnull(error_code) and isnull(error_message)) or (isempty(error_code) and isempty(error_message)),"No error", strcat(error_code, " : ",error_message))
  | extend
        EventEndTime = todatetime(last_timestamp),
        EventProduct = 'Vectra Cloud',
        EventResult = "Success",
        EventType = "Other",
        EventSchema = "AuditEvent",
        EventSchemaVersion = "0.1.0",
        EventStartTime = event_timestamp_t,
        EventVendor = 'Vectra',
        EventUid = tostring(id_d),
        EventOriginalUid = tostring(detection_id_d),
        HttpUserAgent = user_agent,
        SrcDescription = src_account_s,
        Type = detection_type_s,
        ThreatConfidence = toint(threat_d),
        EventOriginalSeverity = case(Severity == 0, "Informational", (Severity > 0 and Severity <=3),"Low", (Severity > 3 and Severity <=6),"Medium", (Severity > 6 and Severity <=10), "High","High")
  | project-rename
        Dvc = ip_s,
        EventSubType = detection_type_s,
        Operation = d_type_vname_s,
        Src = src_account_s,
        EventReportUrl = detection_href_s
  | project-away
        *_d, *_s, error_message, error_code, user_agent, last_timestamp, Category, triaged_b, event_timestamp_t, Severity, _SubscriptionId, _ResourceId, RawData, TenantId, SourceSystem, Computer, MG, ManagementGroupName
  };
  parser (disabled=disabled)