Parser:
  Title: ASIM Security Events Process Termination Parser
  Version: '0.1'
  LastUpdated: May 30, 2021
Product:
  Name: Windows Security Events 
Normalization:
  Schema: ProcessEvents
  Version: '0.1.0'
References:
- Title: ASIM Process Schema
  Link: https://aka.ms/AzSentinelProcessEventsDoc
- Title: ASIM
  Link: https:/aka.ms/AzSentinelNormalization
Description: ASIM process creation parser for Security Events (event number 4689)
ParserName: vimProcessTerminateMicrosftSecurityEvents
ParserQuery: | 
             let ProcessEvents=(){
              SecurityEvent
              // -- Filter
              | where EventID == 4689

              // -- Map
              | extend
                // Event
                  EventCount = int(1),
                  EventVendor = "Microsoft",
                  EventProduct = "Security Events",
                  EventSchemaVersion = "0.1.0",
                  EventStartTime = todatetime(TimeGenerated),
                  EventEndTime = todatetime(TimeGenerated),
                  EventType = "ProcessTerminated",
                  EventOritingalType = EventID,
                  EventOriginalUid = EventOriginId,
                  EventResultDetails = Status,
                  EventOriginalResultDetails = Status, 

                // Device
                  DvcId = SourceComputerId,
                  DvcHostname = Computer,
                  DvcOs = "Windows",
 
                // Users
                  ActorUserId = SubjectUserSid,
                  ActorUserIdType = "SID",
                  ActorUsername = iff (SubjectDomainName == '-', SubjectUserName, SubjectAccount),
                  ActorUsernameType = iff(SubjectDomainName == '-','Simple', 'Windows'),
                  ActorUserSessionId = SubjectLogonId,
                  ActorDomainName = SubjectDomainName,


              
                // Processes 

                  TargetProcessId = ProcessId,
                  TargetProcessName = ProcessName,
                  TargetProcessCommandLine = CommandLine,
                  TargetProcessTokenElevation = TokenElevationType,

                  Process = ProcessName
                
                // Aliases
                | extend 
                  User = ActorUsername,
                  Dvc = DvcHostname,
                  Process = TargetProcessName

              }; ProcessEvents


