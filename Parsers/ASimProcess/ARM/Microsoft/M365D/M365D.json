{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
      "workspaceName": {
          "type": "string"
      },
      "location": {
        "type": "string"
      }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2017-03-15-preview",
      "name": "[parameters('workspaceName')]",
      "location": "[parameters('location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "vimProcessEventsMicrosft365D",
            "dependsOn": [
              "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "properties": {
              "etag": "*",
              "displayName": "Azure Information Model Process - Defender for EndPoints process events",
              "category": "Security",
              "FunctionAlias": "vimProcessEventsMicrosft365D",
              "query":"let ProcessEvents_M365D=(){\nDeviceProcessEvents\n|project-rename\n//***** Mandatory Fields - name change ******\n    EventOriginalUid = ReportId,\n    DvcId = DeviceId,\n      DvcHostName = DeviceName,\n      DvcMachineGroup = MachineGroup,\n      TargetUserName = AccountUpn,\n      TargetUserType = \"UPN\",\n      TargetUserId = AccountSid,\n      TargetProcessFileName = FileName,\n      TargetProcessFilePath = FolderPath,\n  //***** Optional Fields - name change ******\n      TargetUserDomain = AccountDomain,\n      TargetUserAadId = AccountObjectId,\n      TargetProcessMD5 = MD5,\n      TargetProcessSHA1 = SHA1,\n      TargetProcessSHA256 = SHA256,\n      TargetProcessCommandLine = ProcessCommandLine,\n      TargetProcessId = ProcessId,\n      TargetProcessIntegrityLevel = ProcessIntegrityLevel,\n      TargetProcessTokenElevation = ProcessTokenElevation,\n      TargetProcessSessionId = LogonId,\n      TargetProcessCreationTime = ProcessCreationTime,\n      ActorUserName = InitiatingProcessAccountName ,\n      ActorUserDomain = InitiatingProcessAccountDomain,\n      ActorUserAadId = InitiatingProcessAccountObjectId,\n      ActorUserId = InitiatingProcessAccountSid ,\n      ActorUserUpn = InitiatingProcessAccountUpn,\n      ActingProcessCommandLine = InitiatingProcessCommandLine , \n      ActingProcessFileName = InitiatingProcessFileName , \n      ActingProcessFilePath = InitiatingProcessFolderPath , \n      ActingProcessId = InitiatingProcessId  ,  \n      ActingProcessIntegrityLevel = InitiatingProcessIntegrityLevel , \n      ActingProcessMD5 = InitiatingProcessMD5 , \n      ActingProcessSHA1 = InitiatingProcessSHA1 , \n      ActingProcessSHA256 = InitiatingProcessSHA256 , \n      ActingProcessSessionId = InitiatingProcessLogonId,\n      ParentProcessFileName = InitiatingProcessParentFileName , \n      ActingProcessTokenElevation = InitiatingProcessTokenElevation,\n      ActingProcessCreationTime = InitiatingProcessCreationTime , \n      ParentProcessId = InitiatingProcessParentId,\n      ParentProcessCreationTime = InitiatingProcessParentCreationTime\n  | extend\n  //***** Mandatory Fields - calculating value ******\n      EventCount = int(1),\n      EventProduct = \"M365 Defender for Endpoint\",\n      EventVendor = \"Microsoft Corporation\",\n      EventSchemaVersion = \"0.0.1\",\n      EventStartTime = todatetime(TimeGenerated),\n      EventEndTime = todatetime(TimeGenerated),\n      EventType = \"ProcessCreated\",\n      DvcOs = \"Windows\",\n      TargetUserIdType = \"SID\",\n      ActorUserIdType = \"SID\"\n  //***** Optional Fields - calculating value ******\n      //***** Aliases ******\n  | extend\n      TargetUser = TargetUserName,\n      TargetProcessName = TargetProcessFilePath,\n      Dvc = DvcHostName\n  };\n  ProcessEvents_M365D\n",
               "version": 1
          }
        }
      ]
    }
  ]
}