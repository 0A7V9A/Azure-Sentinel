{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
      "workspaceName": {
          "type": "string"
      },
      "location": {
        "type": "string"
      }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2017-03-15-preview",
      "name": "[parameters('workspaceName')]",
      "location": "[parameters('location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "vimProcessEventsMicrosft365D",
            "dependsOn": [
              "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "properties": {
              "etag": "*",
              "displayName": "Azure Information Model Process - Defender for EndPoints process events",
              "category": "Security",
              "FunctionAlias": "vimProcessEventsMicrosft365D",
              "query":"let ProcessEvents_M365D=(){ DeviceProcessEvents |project-rename //***** Mandatory Fields - name change ****** EventOriginalUid = ReportId, DvcId = DeviceId, DvcHostName = DeviceName, DvcMachineGroup = MachineGroup, TargetUserName = AccountUpn, TargetUserType = \"UPN\", TargetUserId = AccountSid, TargetProcessFileName = FileName, TargetProcessFilePath = FolderPath, //***** Optional Fields - name change ****** TargetUserDomain = AccountDomain, TargetUserAadId = AccountObjectId, TargetProcessMD5 = MD5, TargetProcessSHA1 = SHA1, TargetProcessSHA256 = SHA256, TargetProcessCommandLine = ProcessCommandLine, TargetProcessId = ProcessId, TargetProcessIntegrityLevel = ProcessIntegrityLevel, TargetProcessTokenElevation = ProcessTokenElevation, TargetProcessSessionId = LogonId, TargetProcessCreationTime = ProcessCreationTime, ActorUserName = InitiatingProcessAccountName , ActorUserDomain = InitiatingProcessAccountDomain, ActorUserAadId = InitiatingProcessAccountObjectId, ActorUserId = InitiatingProcessAccountSid , ActorUserUpn = InitiatingProcessAccountUpn, ActingProcessCommandLine = InitiatingProcessCommandLine , ActingProcessFileName = InitiatingProcessFileName , ActingProcessFilePath = InitiatingProcessFolderPath , ActingProcessId = InitiatingProcessId  , ActingProcessIntegrityLevel = InitiatingProcessIntegrityLevel , ActingProcessMD5 = InitiatingProcessMD5 , ActingProcessSHA1 = InitiatingProcessSHA1 , ActingProcessSHA256 = InitiatingProcessSHA256 , ActingProcessSessionId = InitiatingProcessLogonId, ParentProcessFileName = InitiatingProcessParentFileName , ActingProcessTokenElevation = InitiatingProcessTokenElevation, ActingProcessCreationTime = InitiatingProcessCreationTime , ParentProcessId = InitiatingProcessParentId, ParentProcessCreationTime = InitiatingProcessParentCreationTime | extend //***** Mandatory Fields - calculating value ****** EventCount = int(1), EventProduct = \"M365 Defender for Endpoint\", EventVendor = \"Microsoft Corporation\", EventSchemaVersion = \"0.0.1\", EventStartTime = todatetime(TimeGenerated), EventEndTime = todatetime(TimeGenerated), EventType = \"ProcessCreated\", DvcOs = \"Windows\", TargetUserIdType = \"SID\", ActorUserIdType = \"SID\" //***** Optional Fields - calculating value ****** //***** Aliases ****** | extend TargetUser = TargetUserName, TargetProcessName = TargetProcessFilePath, Dvc = DvcHostName }; ProcessEvents_M365D" ,
              "version": 1
          }
        }
      ]
    }
  ]
}