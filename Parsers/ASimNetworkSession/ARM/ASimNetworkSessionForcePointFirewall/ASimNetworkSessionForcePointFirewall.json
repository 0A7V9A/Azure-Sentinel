{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "Workspace": {
      "type": "string",
      "metadata": {
        "description": "The Microsoft Sentinel workspace into which the function will be deployed. Has to be in the selected Resource Group."
      }
    },
    "WorkspaceRegion": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The region of the selected workspace. The default value will use the Region selection above."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2017-03-15-preview",
      "name": "[parameters('Workspace')]",
      "location": "[parameters('WorkspaceRegion')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "ASimNetworkSessionForcePointFirewall",
          "dependsOn": [
            "[concat('Microsoft.OperationalInsights/workspaces/', parameters('Workspace'))]"
          ],
          "properties": {
            "etag": "*",
            "displayName": "Network Session ASIM parser for Force Point Firewall",
            "category": "ASIM",
            "FunctionAlias": "ASimNetworkSessionForcePointFirewall",
            "query": "let ApplicationProtocolLookup=datatable(ApplicationProtocol:string,NetworkApplicationProtocol:string)\n  [\n        \"HTTPS\",\"HTTPS\", // Bare Minimum\n        \"HTTP-Over-QUIC\",\"HTTP\", // Bare Minimum\n        \"HTTP\",\"HTTP\", // Bare Minimum\n        \"DNS Over TLS\",\"DNS\", // Bare Minimum\n        \"HTTP proxy\",\"HTTP\", // Bare Minimum\n        \"IMAPS\",\"IMAPS\",\n        \"SMTP\",\"SMTP\", // Bare Minimum\n        \"IMAP\",\"IMAP\",\n        \"POP3S\",\"POP3\",\n        \"SMTP Submission Service\",\"SMTP\", // Bare Minimum\n        \"X11\",\"X11\",\n        \"RTSP\",\"RTSP\",\n        \"Telnet\",\"TELNET\", // Bare Minimum\n        \"NNTP\",\"NNTP\",\n        \"ISAKMP\",\"ISAKMP\",\"ISAKMP\",\"ISAKMP\",\n        \"POP3\",\"POP3\",\n        \"BGP\",\"BGP\",\n        \"FTP\",\"FTP\", // Bare Minimum\n        \"RIP\",\"RIP\",\n        \"Squid HTTP proxy\",\"HTTP\", // Bare Minimum\n        \"TFTP\",\"TFTP\", // Bare Minimum\n        \"QOTD\",\"QOTD\",\n        \"SCCP\",\"SCCP\",\n        \"Modbus\",\"MODBUS\",\n        \"SVN\",\"SVN\",\n        \"RADIUS (Accounting)\",\"RADIUS\",\n        \"Kerberos\",\"KERBEROS\",\n        \"GRE\",\"GRE\",\n        \"UUCP-rlogin\",\"UUCP\",\n        \"GTP User Data Tunneling\",\"GTP\",\n        \"NNTPS\",\"NNTP\",\n        \"GTP Control\",\"GTP\",\n        \"IRC-default\",\"IRC\",\n        \"FTPS (Control)\",\"FTPS\",\n        \"ICCP\",\"ICCP\",\n        \"IRCS\",\"IRC\",\n        \"Telnets\",\"TELNET\", // Bare Minimum\n        \"Finger\",\"FINGER\",\n        \"ESP\",\"ESP\",\n        \"Rlogin\",\"RLP\",\n        \"IMAP3\",\"IMAP\",\n        \"MGCP\",\"MGCP\",\n        \"RADIUS Accounting (Old)\",\"RADIUS\",\n        \"RADIUS (Old)\",\"RADIUS\",\n        \"CVS\",\"CVS\",\n        \"Ident\",\"IDENT\",\n        \"Gopher\",\"GOPHER\",\n        \"BGMP\",\"BGMP\",\n        \"FTPS (Data)\",\"FTPS\",\n        \"POP2\",\"POP\",\n        \"TLISRV\",\"TLISRV\",\n        \"INGRES-NET\",\"INGRES-NET\",\n        \"IPIP\",\"IPIP\",\n        \"XTP\",\"XTP\",\n        \"UUCP\",\"UUCP\",\n        \"IRC\",\"IRC\",\n        \"Photuris (ICMP)\",\"ICMP\",\n        \"TACACS-DS\",\"TACACS-DS\",\n        \"WESP\",\"WESP\",\n        \"EGP\",\"EGP\",\n        \"WSN\",\"WSN\",\n        \"XDMCP\",\"XDMCP\",\n        \"Kerberos IV\",\"KERBEROS\",\n        \"IRTP\",\"IRTP\",\n        \"TTP\",\"TTP\",\n        \"IRC-SERV\",\"IRC\",\n        \"I-NLSP\",\"NLSP\",\n        \"SNP\",\"SNP\",\n        \"XNS-IDP\",\"XNS\",\n        \"SECURE-VMTP\",\"VMTP\",\n        \"VMTP\",\"VMTP\",\n        \"IPLT\",\"IPLT\",\n        \"GGP\",\"GGP\",\n        \"MFE-NSP\",\"NSP\",\n        \"HIP\",\"HIP\",\n        \"MERIT-NSP\",\"NSP\",\n        \"NSFNET-IGP\",\"IGP\",\n        \"DCN-MEAS\",\"DCN\",\n        \"STP\",\"STP\",\n        \"SRP\",\"SRP\",\n        \"HMP\",\"HMP\",\n        \"XNET\",\"XNET\",\n        \"VRRP\",\"VRRP\",\n        \"ENCAP\",\"ENCAP\",\n        \"CPNX\",\"CPNX\",\n        \"PTP\",\"PTP\",\n        \"SKIP\",\"SKIP\",\n        \"SCPS\",\"SCPS\",\n        \"Sprite-RPC\",\"RPC\",\n        \"IPv6 ICMP\",\"ICMP\",\n        \"MUX\",\"MUX\",\n        \"CHAOS\",\"CHAOS\",\n        \"SSCOPMCE\",\"SSCOPMCE\",\n        \"CBT\",\"CBT\",\n        \"SPS\",\"SPS\",\n        \"ETHERIP\",\"ETHERIP\",\n        \"MTP\",\"MTP\",\n        \"ROHC\",\"ROHC\",\n        \"CRTP\",\"CRTP\",\n        \"PNNI\",\"PNNI\",\n        \"NETBLT\",\"NETBLT\",\n        \"TLSP\",\"TLSP\",\n        \"IDPR\",\"IDPR\",\n        \"DDX\",\"DDX\",\n        \"PUP\",\"PUP\",\n        \"DSR\",\"DSR\",\n        \"NARP\",\"NARP\",\n        \"CPHB\",\"CPHB\",\n        \"SMP\",\"SMP\",\n        \"L2TP\",\"L2TP\",\n        \"IPv6 ICMP/143/0\",\"ICMP\",\n        \"MICP\",\"MICP\",\n        \"GMTP\",\"GMTP\",\n        \"LARP\",\"LARP\",\n        \"IFMP\",\"IFMP\",\n        \"IGP\",\"IGP\",\n        \"CFTP\",\"CFTP\",\n        \"PGM\",\"PGM\",\n        \"DDP\",\"DDP\",\n        \"PIPE\",\"PIPE\",\n        \"IATP\",\"IATP\",\n        \"IGMP\",\"IGMP\",\n        \"3PC\",\"3PC\",\n        \"DGP\",\"DGP\",\n        \"TCF\",\"TCF\",\n        \"UTI\",\"UTI\",\n        \"DCCP\",\"DCCP\",\n        \"SWIPE\",\"SWIPE\",\n        \"EMCON\",\"EMCON\",\n        \"PIM\",\"PIM\",\n        \"RVD\",\"RVD\",\n  ];\nlet ActionLookup=datatable(DeviceAction:string,DvcAction_ActionLookup:string,EventResult_ActionLookup:string,EventSeverity_ActionLookup:string)\n[\n          \"Allow\",\"Allow\",\"Success\",\"Informational\",          \n          \"Discard\",\"Drop\",\"Failure\",\"Low\",\n          \"Permit\",\"Allow\",\"Success\",\"Informational\",          \n          \"Refuse\",\"Deny\",\"Failure\",\"Low\",\n          \"Terminate\",\"Reset Source\",\"Failure\",\"Low\",          \n          \"Terminate (failed)\",\"\",\"Failure\",\"Low\",\n          \"Terminate (passive)\",\"Reset Destination\",\"Failure\",\"Low\",          \n          \"Terminate (reset)\",\"Reset\",\"Failure\",\"Low\",\n          \"Wait for Authentication\",\"\",\"Success\",\"Informational\",\n          \"Wait for Further Actions\",\"\",\"Success\",\"Informational\",          \n          \"Wait for RPC Reply\",\"\",\"Success\",\"Informational\"\n];\nlet DeviceEventClassIDLookup=datatable(DeviceEventClassID:string,EventSubType:string,DvcAction_DeviceEventClassIDLookup:string,EventResult_DeviceEventClassIDLookup:string,EventSeverity_DeviceEventClassIDLookup:string) //Add more codes if needed\n[\n          \"70018\",\"Start\",\"Allow\",\"Success\",\"Informational\",          \n          \"70019\",\"End\",\"Deny\",\"Failure\",\"Low\", \n          \"70021\",\"End\",\"Reset\",\"Failure\",\"Low\",          \n          \"70022\",\"End\",\"Reset\",\"Failure\",\"Low\"\n];\nlet MessageLookup = datatable (Message:string, DvcAction_MessageLookup:string, EventResult_MessageLookup:string, EventResultDetails:string, EventOriginalResultDetails:string)  \n[\n        \"Connection dropped\", \"Drop\", \"Failure\",\"Terminated\", \"Connection dropped\",\n        \"Connection removed because NGFW Engine is low on memory.\",\"Drop\", \"Failure\",\"Terminated\",\"Connection removed because NGFW Engine is low on memory.\",\n        \"Connection timeout in state TCP_CLOSE_WAIT\", \"\", \"Success\", \"Timeout\",\t\"One end of the Connection waits for the FIN packet (passive close).\",\n        \"Connection timeout in state TCP_CLOSE_WAIT_ACK\", \"\", \"Success\", \"Timeout\", \"One end of the Connection waits for the FIN packet (passive close)\",\n        \"Connection timeout in state TCP_CLOSING\", \"\", \"Success\", \"Timeout\", \"Closing packet (FIN) sent by one end of the Connection (simultaneous).\",\n        \"Connection timeout in state TCP_CLOSING_ACK\", \"\", \"Success\", \"Timeout\", \"Waiting for ACK for the FIN before going to closing status (active close).\",\n        \"Connection timeout in state TCP_ESTABLISHED\", \"\", \"Failure\", \"Timeout\", \"Normal status of TCP Connections for data transfer.\",\n        \"Connection timeout in state TCP_FIN_WAIT_1\", \"\", \"Success\", \"Timeout\",\t\"One end of the Connection waits for sending the FIN packet (active close).\",\n        \"Connection timeout in state TCP_FIN_WAIT_2\", \"\", \"Success\", \"Timeout\", \"One end of the Connection waits for receiving ACK packet.\",\n        \"Connection timeout in state TCP_LAST_ACK\", \"\",\t\"Success\", \"Timeout\", \"One end of the Connection sent a FIN packet (passive close).\",\n        \"Connection timeout in state TCP_LAST_ACK_WAIT\", \"\", \"Failure\",\t\"Timeout\", \"Waiting for the FIN packet to be acknowledged.\",\n        \"Connection timeout in state TCP_SYN_ACK_SEEN\", \"\", \"Failure\",\t\"Timeout\", \"Second phase of the TCP three-way handshake, the server has replied to client sent SYN with SYN+ACK, next status will be established.\",\n        \"Connection timeout in state TCP_SYN_FIN_SEEN\", \"\",\t\"Success\", \"Timeout\", \"T/TCP (Transactional TCP) Connection, RFC 1644.\",\n        \"Connection timeout in state TCP_SYN_RETURN\", \"\", \"Failure\", \"Timeout\", \"Received simultaneous SYN from the other end (simultaneous open).\",\n        \"Connection timeout in state TCP_SYN_SEEN\", \"\", \"Failure\", \"Timeout\", \"First packet sent by one end of the Connection.\",\n        \"Connection timeout in state TCP_TIME_WAIT\", \"\", \"Success\", \"Timeout\", \"One end of the Connection acknowledged closing packet (FIN).\",\n        \"Connection timeout in state TCP_TIME_WAIT_ACK\", \"\", \"Failure\",\t\"Timeout\", \"Waiting for ACK for the FIN status before going to time wait status (active close).\",\n        \"Connection timeout in state ICMP_ECHO\", \"\", \"Failure\", \"Timeout\", \"Ping reply is expected.\",\n        \"Connection timeout in state ICMP_REPLY_WAIT\", \"\", \"Failure\", \"Timeout\", \"Other ICMP request or reply types.\",\n        \"Connection was reset by client\", \"Reset Source\", \"Failure\",\"Reset\", \"\",\n        \"Connection was reset by server\", \"Reset Destination\", \"Failure\",\"Reset\", \"\",\n        \"invalid packet (CT)\", \"\", \"Failure\", \"Invalid TCP\", \"\",\n        \"not a (valid) SYN packet [A] (CT)\", \"\", \"Failure\", \"Invalid TCP\", \"\",\n        \"not a (valid) SYN packet [FA] (CT)\", \"\", \"Failure\", \"Invalid TCP\", \"\",\n        \"not a (valid) SYN packet [FPA] (CT)\", \"\", \"Failure\", \"Invalid TCP\", \"\",\n        \"not a (valid) SYN packet [PA] (CT)\", \"\", \"Failure\", \"Invalid TCP\", \"\",\n        \"not a (valid) SYN packet [RA] (CT)\", \"\", \"Failure\", \"Invalid TCP\", \"\",\n        \"not a (valid) SYN packet [SA] (CT)\", \"\", \"Failure\", \"Invalid TCP\", \"\",\n        \"TCP state violation\",\"Deny\",\"Failure\", \"Invalid TCP\", \"\",\n        \"TCP state violation: Connection end-point replied with ACK to SYN-packet. Connection refused.\", \"Deny\", \"Failure\", \"Invalid TCP\", \"\",\n        \"TSC error: Query timed out\", \"\", \"Failure\", \"Timeout\", \"\"\n];\nlet parser = (disabled:bool) \n{ \n  CommonSecurityLog\n        | where not(disabled)\n        | where DeviceVendor==\"FORCEPOINT\" and DeviceProduct==\"Firewall\"\n        | where DeviceFacility in~ (\"Inspection\",\"Packet Filtering\",\"File Filtering\",\"IPsec VPN\",\"Protocol Agent\")\n        | extend NetworkProtocol = _ASIM_LookupNetworkProtocol(Protocol)            \n        | lookup ActionLookup on DeviceAction\n        | lookup DeviceEventClassIDLookup on DeviceEventClassID\n        | lookup MessageLookup on Message\n        | extend DvcAction = coalesce(DvcAction_ActionLookup, DvcAction_DeviceEventClassIDLookup, DvcAction_MessageLookup), \n                 EventResult = coalesce(EventResult_ActionLookup, EventResult_DeviceEventClassIDLookup, EventResult_MessageLookup), \n                 EventSeverity = coalesce(EventSeverity_ActionLookup, EventSeverity_DeviceEventClassIDLookup)            \n        | project-away DvcAction_*, EventSeverity_*, EventResult_*\n        | lookup ApplicationProtocolLookup on ApplicationProtocol\n        | extend \n                EventCount = toint(1),\n                EventType = \"NetworkSession\",\n                EventSchema = \"NetworkSession\",\n                EventSchemaVersion = \"0.2.6\",\n                EventVendor = \"FORCEPOINT\",\n                EventProduct = \"Firewall\"\n        | parse AdditionalExtensions with * \"requestURL=\" requestURL            \n        | project-rename\n                EventOriginalType = DeviceEventClassID,\n                DstPortNumber = DestinationPort,\n                DstIpAddr = DestinationIP,\n                SrcPortNumber = SourcePort,\n                SrcIpAddr = SourceIP,\n                DstNatIpAddr = DestinationTranslatedAddress,\n                DstNatPortNumber = DestinationTranslatedPort,\n                SrcNatIpAddr = SourceTranslatedAddress,\n                SrcNatPortNumber = SourceTranslatedPort,\n                EventProductVersion = DeviceVersion,\n                EventMessage = Message,\n                DvcOriginalAction = DeviceAction,\n                SrcBytes = SentBytes,\n                DstBytes = ReceivedBytes,\n                EventOriginalSubType = DeviceFacility,\n                DvcId = DeviceExternalID,\n                DvcInboundInterface = DeviceInboundInterface,\n                DvcOutboundInterface = DeviceOutboundInterface,\n                DvcIpAddr = DeviceAddress,\n                EventOriginalSeverity = LogSeverity,\n                ThreatId = DeviceCustomString3        \n        | invoke _ASIM_ResolveDvcFQDN('Computer')            \n        | extend\n                EventStartTime = todatetime(ReceiptTime),\n                EventEndTime = todatetime(ReceiptTime),\n                extractedIP = extract(@\"(\\d+.\\d+.\\d+.\\d+)\",0,requestURL),\n                extractedPort = iff(requestURL has ':', toint(split(requestURL,':')[-1]), int(null))\n        | extend \n                 NetworkRuleName = case(isnotempty(DeviceCustomString2), strcat(DeviceCustomString1,',',DeviceCustomString2),\n                                        DeviceCustomString1),\n                 DstDomain = case(\n                                isempty(extractedIP) and isnotempty(extractedPort), tostring(split(requestURL,':',0)[0]),\n                                isempty(extractedPort), requestURL,\n                                \"\"\n                            ),\n                 DstIpAddr = case(\n                                isnotempty(DstIpAddr), DstIpAddr,\n                                isnotempty(extractedIP), requestURL,\n                                \"\"\n                            )\n        | extend\n                 DvcIdType = case(\n                                isnotempty(DvcId), \"Other\",\n                                \"\"\n                            ),\n                 DstDomainType = case(\n                                isnotempty(DstDomain), \"FQDN\",\n                                \"\"  \n                            ),\n                 DstPortNumber = case(\n                                isnotempty(DstPortNumber), DstPortNumber,\n                                ApplicationProtocol startswith \"TCP\", toint(split(ApplicationProtocol,'/')[1]),\n                                ApplicationProtocol startswith \"UDP\", toint(split(ApplicationProtocol,'/')[1]),\n                                isnotempty(extractedPort), extractedPort,\n                                int(null)\n                        ),\n                 AdditionalFields = pack(\"RequestMethod\",iff(isnotempty(RequestMethod) and RequestMethod != \"UNKNOWN\", RequestMethod, \"\"),\n                                         \"Activity\",Activity,\n                                         \"VirusId\",DeviceCustomString4),\n                 ThreatName = case(isnotempty(ThreatId),DeviceEventCategory,\n                                  \"\"),\n                 DstAppName = case(DestinationServiceName in~ (\"Generic-Web-HTTP\",\"Application-Unknown\",\"Unknown-Encrypted-Application\"), \"\",\n                                    DestinationServiceName),\n                 DvcIpAddr = coalesce(DvcIpAddr,DeviceName)\n        | extend\n                EventSeverity = case(isnotempty(EventSeverity),EventSeverity,\n                                     isnotempty(ThreatName), \"High\",\n                                     \"Informational\"),\n                Dvc = DvcIpAddr,\n                IpAddr = SrcIpAddr,\n                Rule = NetworkRuleName,\n                Dst = DstIpAddr,\n                Src = SrcIpAddr,\n                DvcInterface = DvcInboundInterface\n        | project-away AdditionalExtensions, CommunicationDirection, Device*, Destination*, EndTime, ExternalID, File*, Flex*, IndicatorThreatType, Malicious*, Old*, OriginalLogSeverity, Process*, Protocol, ReceiptTime, Remote*, ReportReferenceLink, Request*, SimplifiedDeviceAction, Source*, StartTime, TenantId, ThreatConfidence, ThreatDescription, ThreatSeverity, ExtID, EventOutcome, FieldDevice*, Reason, ApplicationProtocol, Activity, requestURL, extracted*, Computer\n    };\n    parser(disabled=disabled)",
            "version": 1,
            "functionParameters": "disabled:bool=False"
          }
        }
      ]
    }
  ]
}