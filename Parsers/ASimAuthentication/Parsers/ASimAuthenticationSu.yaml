Parser:
  Title: Authentication ASIM parser for Syslog su
  Version: '0.1.1'
  LastUpdated: November 21, 2022
Product:
  Name: su
Normalization:
  Schema: Authentication
  Version: '0.1.1'
References:
- Title: ASIM Authentication Schema
  Link: https://aka.ms/ASimAuthenticationDoc
- Title: ASIM
  Link: https:/aka.ms/AboutASIM
Description: |
  This ASIM parser supports normalizing Syslog su sign in logs to the ASIM Authentication schema.
ParserName: ASimAuthenticationSu
ParserParams:
  - Name: disabled
    Type: bool
    Default: false
ParserQuery: |
  let SuSignInAuthorized=(disabled:bool=false){
  Syslog | where not(disabled)
    | where ProcessName == "su" and (SyslogMessage has 'pam_unix(su:session): session opened' or SyslogMessage has 'pam_unix(su-l:session): session opened')
    | parse SyslogMessage with "for user " TargetUsername " by " ActorUsername
    | extend
    EventVendor = 'su'
    , EventProduct = 'su'
    , EventCount = int(1)
    , EventSchema = 'Authentication'
    , EventSchemaVersion = '0.1.1'
    , EventResult = 'Success'
    , EventStartTime = TimeGenerated
    , EventEndTime = TimeGenerated
    , EventType = 'Logon'
    , DvcHostname = Computer
    , ActorUsernameType = 'Simple'
    , EventResultDetails = 'Other'
    , EventOriginalRestultDetails = 'Connection authorized'
  // ************************
  //      <Aliases>
  // ************************
  | extend
          User=TargetUsername
        , Dvc=Computer
  // ************************
  //      </Aliases>
  // ************************
    | project-away Computer, MG, SourceSystem, TenantId
    };
  let SuDisconnect=(disabled:bool=false){
  Syslog | where not(disabled)
    | where ProcessName == "su" and (SyslogMessage has 'pam_unix(su:session): session closed' or SyslogMessage has 'pam_unix(su-l:session): session closed')
    | parse SyslogMessage with "for user " TargetUsername
    | extend
    EventVendor = 'su'
    , EventProduct = 'su'
    , EventCount = int(1)
    , EventSchema = 'Authentication'
    , EventSchemaVersion = '0.1.1'
    , EventResult = 'Success'
    , EventStartTime = TimeGenerated
    , EventEndTime = TimeGenerated
    , EventType = 'Logoff'
    , DvcHostname = Computer
    , TargetUsernameType = 'Simple'
    , EventResultDetails = 'Other'
    , EventOriginalRestultDetails = 'User session closed'
  // ************************
  //      <Aliases>
  // ************************
  | extend
          User=TargetUsername
        , Dvc=Computer
  // ************************
  //      </Aliases>
  // ************************
    | project-away Computer, MG, SourceSystem, TenantId
    };
  union isfuzzy=false SuSignInAuthorized(disabled), SuDisconnect(disabled)
