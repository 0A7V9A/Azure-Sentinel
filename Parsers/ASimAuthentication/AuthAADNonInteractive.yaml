Parser:
  Title: Azure active directory non interactive authentication
  Version: '0.0'
  LastUpdated: June 3, 2021
Product:
  Name: Azure active directory nonInteractive signin logs
Normalization:
  Schema: Authentication
  Version: '1.0.0'
References:
- Title: Using functions
  Link: https://docs.microsoft.com/azure/azure-monitor/log-query/function
- Title: Authentication schema documentation
  Link: https://aka.ms/AzSentinelAuthenticationDoc
Description: |
    This Query Parser maps Azure Active Directory Non Interactive sign in logs (AADNonInteractiveUserSignInLogs) to the Azure Sentinel Information Model authenticaion schema.
ParserName: vimAuthAADNonInteractiveUserSignInLogs
ParserQuery: |
  let AADNIAuthentication=(){
  AADNonInteractiveUserSignInLogs
  | extend
      EventVendor = "Microsoft"
      , EventProduct = "Azure Active Directory"
      , EventResult = iff (ResultType ==0, "Success", "Failure")
      , EventResultDetails= ResultType
      , EventOriginalResultDetails = ResultDescription
      , EventStartTime = TimeGenerated
      , EventEndTime= TimeGenerated
      , EventType= "Logon"
      , SrcHostId=tostring(todynamic(DeviceDetail).deviceId)
      , SrcHostname=tostring(todynamic(DeviceDetail).displayName)
      , SrcHostOs=tostring(todynamic(DeviceDetail).operatingSystem)
      , HttpUserAgentOriginal=UserAgent
      , HttpUserAgentName= tostring(todynamic(DeviceDetail).browser)
      , SrcGeoCity=tostring(todynamic(LocationDetails).city)
      , SrcGeoCounty=tostring(todynamic(LocationDetails).countryOrRegion)
      , SrcGeoLocationLatitude=tostring(todynamic(LocationDetails).geoCoordinates.latitude)
      , SrcGeoLocationLongitude=tostring(todynamic(LocationDetails).geoCoordinates.longitude)
      , ResourceId = ResourceIdentity // Overriding the tables ResourceId which is not an interesting value
      , ActorUserType="NonInteractive"
      , ActorUserNameType='Upn'
      , ActorUserIdType='AADID'
     // , ResourceName=ResourceDisplayName
  | project-rename
      EventUid =Id
      , EventOriginalId = ResultType
      , EventKind = AuthenticationRequirement /// ???
      , TargetSessionId=CorrelationId
      , SessionDuration= DurationMs
      , ActorUserId = UserId
      , ActorUserName=UserPrincipalName
      , SrcIpAddr=IPAddress
     , AppName=AppDisplayName
  | project-reorder
      TimeGenerated
      ,EventProduct
      , EventUid
      , EventOriginalId
      , EventResult
      , EventResultDetails
      , EventOriginalResultDetails
      , EventStartTime
      , EventEndTime
      , EventKind
      , TargetSessionId
      , SessionDuration
      , ActorUserId
      , ActorUserName
      , SrcHostId
      , SrcHostname
      , SrcHostOs
      , ResourceId
      , HttpUserAgentOriginal 
      , HttpUserAgentName
      , SrcGeoCity
      , SrcGeoLocation
      , AppId
      , AppName};
      AADNIAuthentication