{
    "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspaceName": {
            "type": "string"
        },
        "location": {
          "type": "string"
        }
    },
    "resources": [
      {
        "type": "Microsoft.OperationalInsights/workspaces",
        "apiVersion": "2017-03-15-preview",
        "name": "[parameters('workspaceName')]",
        "location": "[parameters('location')]",
        "resources": [
          {
            "type": "savedSearches",
            "apiVersion": "2020-08-01",
            "name": "vimAuthWindowsSecurityEvents",
              "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
              ],
              "properties": {
                "etag": "*",
                "displayName": "Vendor Information Model Authentication - Microsoft Windows Sign In",
                "category": "Security",
                "FunctionAlias": "vimAuthWindowsSecurityEvents",
                "query": "let LogonEvents=dynamic([4624,4625]);\nlet LogoffEvents=dynamic([4634,4647]);\nlet LogonTypes=datatable(LogonType:int, EventSubType:string)[\n  2, 'Interactive',\n  3, 'Network',\n  4, 'Batch',\n  5, 'Service',\n  7, 'Unlock',\n  8, 'NetworkCleartext',\n  9, 'NewCredentials',\n  10, 'RemoteInteractive',\n  11, 'CachedInteractive'\n];\nlet LogonStatus=datatable \n  (EventResultDetails:string,EventOriginalResultDetails:string)[\n  '0x80090325', 'SEC_E_UNTRUSTED_ROOT',\n  '0xc0000008', 'STATUS_INVALID_HANDLE',\n  '0xc0000022', 'STATUS_ACCESS_DENIED',\n  '0xc0000064', 'STATUS_NO_SUCH_USER',\n  '0xc000006a', 'STATUS_WRONG_PASSWORD',\n  '0xc000006d', 'STATUS_LOGON_FAILURE',\n  '0xc000006e', 'STATUS_ACCOUNT_RESTRICTION',\n  '0xc000006f', 'STATUS_INVALID_LOGON_HOURS',\n  '0xc0000070', 'STATUS_INVALID_WORKSTATION',\n  '0xc0000071', 'STATUS_PASSWORD_EXPIRED',\n  '0xc0000072', 'STATUS_ACCOUNT_DISABLED',\n  '0xc0000073', 'STATUS_NONE_MAPPED',\n  '0xc00000dc', 'STATUS_INVALID_SERVER_STATE',\n  '0xc0000133', 'STATUS_TIME_DIFFERENCE_AT_DC',\n  '0xc000018d', 'STATUS_TRUSTED_RELATIONSHIP_FAILURE',\n  '0xc0000193', 'STATUS_ACCOUNT_EXPIRED',\n  '0xc0000380', 'STATUS_SMARTCARD_WRONG_PIN',\n  '0xc0000381', 'STATUS_SMARTCARD_CARD_BLOCKED',\n  '0xc0000382', 'STATUS_SMARTCARD_CARD_NOT_AUTHENTICATED',\n  '0xc0000383', 'STATUS_SMARTCARD_NO_CARD',\n  '0xc0000384', 'STATUS_SMARTCARD_NO_KEY_CONTAINER',\n  '0xc0000385', 'STATUS_SMARTCARD_NO_CERTIFICATE',\n  '0xc0000386', 'STATUS_SMARTCARD_NO_KEYSET',\n  '0xc0000387', 'STATUS_SMARTCARD_IO_ERROR',\n  '0xc0000388', 'STATUS_DOWNGRADE_DETECTED',\n  '0xc0000389', 'STATUS_SMARTCARD_CERT_REVOKED',\n  '0x80090302', 'SEC_E_UNSUPPORTED_FUNCTION',\n  '0x80090308', 'SEC_E_INVALID_TOKEN',\n  '0x8009030e', 'SEC_E_NO_CREDENTIALS',\n  '0xc0000008', 'STATUS_INVALID_HANDLE',\n  '0xc0000017', 'STATUS_NO_MEMORY',\n  '0xc0000022', 'STATUS_ACCESS_DENIED',\n  '0xc0000034', 'STATUS_OBJECT_NAME_NOT_FOUND',\n  '0xc000005e', 'STATUS_NO_LOGON_SERVERS',\n  '0xc000006a', 'STATUS_WRONG_PASSWORD',\n  '0xc000006d', 'STATUS_LOGON_FAILURE',\n  '0xc000006e', 'STATUS_ACCOUNT_RESTRICTION',\n  '0xc0000073', 'STATUS_NONE_MAPPED',\n  '0xc00000fe', 'STATUS_NO_SUCH_PACKAGE',\n  '0xc000009a', 'STATUS_INSUFFICIENT_RESOURCES',\n  '0xc00000dc', 'STATUS_INVALID_SERVER_STATE',\n  '0xc0000106', 'STATUS_NAME_TOO_LONG',\n  '0xc000010b', 'STATUS_INVALID_LOGON_TYPE',\n  '0xc000015b', 'STATUS_LOGON_TYPE_NOT_GRANTED',\n  '0xc000018b', 'STATUS_NO_TRUST_SAM_ACCOUNT',\n  '0xc0000224', 'STATUS_PASSWORD_MUST_CHANGE',\n  '0xc0000234', 'STATUS_ACCOUNT_LOCKED_OUT',\n  '0xc00002ee', 'STATUS_UNFINISHED_CONTEXT_DELETED'];\nlet WinLogon=(){\n  SecurityEvent \n  | where EventID in (LogonEvents) or \n          EventID in (LogoffEvents)\n  // ************************** Mandataory\n  | project-rename \n     EventProduct = EventSourceName\n     , EventMessage = Activity\n     , ActorSessionId=SubjectLogonId\n     , TargetSessionId=TargetLogonId\n     , ActorUserId=SubjectUserSid\n     , TargetUserId =TargetUserSid\n     , TargetUserType=AccountType\n     , SrcDvcHostname = WorkstationName\n     , TargetHostname = Computer\n     , EventOriginUid = EventOriginId\n     , AuthenticationProtocol=AuthenticationPackageName\n     , SrcIpAddr=IpAddress\n     , SrcPortNumber=IpPort\n  | extend EventOriginId=EventID | project-away EventID // Cannot use rename to overwrite an existing column\n  | extend EventResult = iff(EventOriginId == 4625, 'Failure', 'Success')\n    , ActorUserIdType='SID'\n    , TargetUserIdType='SID'\n    , EventVendor='Microsoft'  \n    , EventStartTime =TimeGenerated\n    , EventEndTime=TimeGenerated\n    , EventType=iff(EventOriginId in (LogoffEvents), 'Logoff', 'Logon')\n  , ActorUserName = iff (SubjectDomainName == '-', SubjectUserName, SubjectAccount)\n  , ActorUserNameType= iff(SubjectDomainName == '-','Simple', 'Windows' )\n  , TargetUserName = iff (TargetDomainName == '-', trim(@'\\\\',TargetUserName), trim(@'\\\\',TargetAccount))\n  , TargetUserNameType=iff (TargetDomainName == '-', 'Simple', 'Windows')\n  , SrcDvcOs = 'Windows'\n  , ActingProcessId=ProcessId\n  , ActingProcessName=ProcessName   \n  // , ActingProcessName=Process // Only process Name\n  , EventResultDetails= iff(SubStatus=='0x0',Status,SubStatus)\n  | lookup LogonStatus on EventResultDetails\n  | lookup LogonTypes  on LogonType\n  | project-reorder \n      TimeGenerated\n      , EventProduct\n      , EventMessage\n      , EventResult\n      , EventResultDetails\n      , EventStartTime\n      , EventEndTime\n      , EventType\n      , EventSubType\n      , ActorSessionId\n      , TargetSessionId\n      , ActorUserId\n      , ActorUserName\n      , TargetUserId\n      , TargetUserName\n      , TargetUserType\n      , SrcDvcOs\n      , ActingProcessId\n      , ActingProcessName\n      , TargetHostname\n      , EventOriginalResultDetails\n      , AuthenticationProtocol\n      , ImpersonationLevel\n  /// ***** alias \n  | extend\n      UserId=TargetUserId\n      , UserName=TargetUserName\n      , Hostname=TargetHostname\n      , AuthTarget=TargetHostname\n  };\nWinLogon\n",
                "version": 1
            }
          }
        ]
      }
    ]
  }