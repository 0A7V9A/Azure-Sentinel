{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "Workspace": {
      "type": "string",
      "metadata": {
        "description": "The Microsoft Sentinel workspace into which the function will be deployed. Has to be in the selected Resource Group."
      }
    },
    "WorkspaceRegion": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The region of the selected workspace. The default value will use the Region selection above."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2017-03-15-preview",
      "name": "[parameters('Workspace')]",
      "location": "[parameters('WorkspaceRegion')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "ASimAuthenticationSalesforceSC",
          "dependsOn": [
            "[concat('Microsoft.OperationalInsights/workspaces/', parameters('Workspace'))]"
          ],
          "properties": {
            "etag": "*",
            "displayName": "Authentication ASIM parser for Salesforce Service Cloud",
            "category": "ASIM",
            "FunctionAlias": "ASimAuthenticationSalesforceSC",
            "query": "let SalesforceSignin=(disabled:bool=false){\nlet EventResultMapping = datatable (login_status_s:string,EventResultDetails:string,EventResult:string)[\n\"LOGIN_CHALLENGE_ISSUED\",\"Other\",\"Failure\",\n\"LOGIN_CHALLENGE_PENDING\",\"Other\",\"Failure\",\n\"LOGIN_DATA_DOWNLOAD_ONLY\",\"Other\",\"Failure\",\n\"LOGIN_END_SESSION_TXN_SECURITY_POLICY\",\"Logon violates policy\",\"Failure\",\n\"LOGIN_ERROR_API_TOO_OLD\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_APPEXCHANGE_DOWN\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_ASYNC_USER_CREATE\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_AVANTGO_DISABLED\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_AVANTGO_TRIAL_EXP\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_CLIENT_NO_ACCESS\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_CLIENT_REQ_UPDATE\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_CSS_FROZEN\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_CSS_PW_LOCKOUT\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_DUPLICATE_USERNAME\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_EXPORT_RESTRICTED\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_GLOBAL_BLOCK_DOMAIN\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_HT_DOWN\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_HTP_METHD_INVALID\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_INSECURE_LOGIN\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_INVALID_GATEWAY\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_INVALID_ID_FIELD\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_INVALID_PASSWORD\",\"Incorrect password\",\"Failure\",\n\"LOGIN_ERROR_LOGINS_EXCEEDED\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_MUST_USE_API_TOKEN\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_MUTUAL_AUTHENTICATION\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_NETWORK_INACTIVE\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_NO_HT_ACCESS\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_NO_NETWORK_ACCESS\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_NO_NETWORK_INFO\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_NO_PORTAL_ACCESS\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_NO_SET_COOKIES\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_OFFLINE_DISABLED\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_OFFLINE_TRIAL_EXP\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_ORG_CLOSED\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_ORG_DOMAIN_ONLY\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_ORG_IN_MAINTENANCE\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_ORG_INACTIVE\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_ORG_IS_DOT_ORG\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_ORG_LOCKOUT\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_ORG_SIGNING_UP\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_ORG_SUSPENDED\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_OUTLOOK_DISABLED\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_PAGE_REQUIRES_LOGIN\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_PASSWORD_EMPTY\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_PASSWORD_LOCKOUT\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_PORTAL_INACTIVE\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_RATE_EXCEEDED\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_RESTRICTED_DOMAIN\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_RESTRICTED_TIME\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_SESSION_TIMEOUT\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_SSO_PWD_INVALID\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_SSO_SVC_DOWN\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_SSO_URL_INVALID\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_STORE\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_STORE_DOWN\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_SWITCH_SFDC_INSTANCE\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_SWITCH_SFDC_LOGIN\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_SYNCOFFLINE_DISBLD\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_SYSTEM_DOWN\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_UNKNOWN_ERROR\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_USER_API_ONLY\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_USER_FROZEN\",\"User locked\",\"Failure\",\n\"LOGIN_ERROR_USER_INACTIVE\",\"User disabled\",\"Failure\",\n\"LOGIN_ERROR_USER_NON_MOBILE\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_USER_STORE_ACCESS\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_USERNAME_EMPTY\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_WIRELESS_DISABLED\",\"Other\",\"Failure\",\n\"LOGIN_ERROR_WIRELESS_TRIAL_EXP\",\"Other\",\"Failure\",\n\"LOGIN_LIGHTNING_LOGIN\",\"Other\",\"Failure\",\n\"LOGIN_NO_ERROR\",\"\",\"Success\",\n\"LOGIN_OAUTH_API_DISABLED\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_CONSUMER_DELETED\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_DS_NOT_EXPECTED\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_EXCEED_GET_AT_LMT\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_INVALID_CODE_CHALLENGE\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_INVALID_CODE_VERIFIER\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_INVALID_DEVICE\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_INVALID_DS\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_INVALID_DSIG\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_INVALID_IP\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_INVALID_NONCE\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_INVALID_SIG_METHOD\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_INVALID_TIMESTAMP\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_INVALID_TOKEN\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_INVALID_VERIFIER\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_INVALID_VERSION\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_MISSING_DS\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_NO_CALLBACK_URL\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_NO_CONSUMER\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_NO_TOKEN\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_NONCE_REPLAY\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_PACKAGE_MISSING\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_PACKAGE_OLD\",\"Other\",\"Failure\",\n\"LOGIN_OAUTH_UNEXPECTED_PARAM\",\"Other\",\"Failure\",\n\"LOGIN_ORG_TRIAL_EXP\",\"Other\",\"Failure\",\n\"LOGIN_READONLY_CANNOT_VALIDATE\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_AUDIENCE\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_CONFIG\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_FORMAT\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_IN_RES_TO\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_ISSUER\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_ORG_ID\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_PORTAL_ID\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_RECIPIENT\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_SESSION_LEVEL\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_SIGNATURE\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_SITE_URL\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_STATUS\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_SUB_CONFIRM\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_TIMESTAMP\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_USERNAME\",\"Other\",\"Failure\",\n\"LOGIN_SAML_INVALID_VERSION\",\"Other\",\"Failure\",\n\"LOGIN_SAML_MISMATCH_CERT\",\"Other\",\"Failure\",\n\"LOGIN_SAML_MISSING_ORG_ID\",\"Other\",\"Failure\",\n\"LOGIN_SAML_MISSING_PORTAL_ID\",\"Other\",\"Failure\",\n\"LOGIN_SAML_PROVISION_ERROR\",\"Other\",\"Failure\",\n\"LOGIN_SAML_REPLAY_ATTEMPTED\",\"Other\",\"Failure\",\n\"LOGIN_SAML_SITE_INACTIVE\",\"Other\",\"Failure\",\n\"LOGIN_TWOFACTOR_REQ\",\"Other\",\"Failure\"];\nlet SalesforceEventType = dynamic(['Login','Logout']);\nSalesforceServiceCloud_CL | where not(disabled)\n| where event_type_s  in (SalesforceEventType)\n| lookup EventResultMapping on login_status_s\n| extend \n      EventProduct='Salesforce Service Cloud'        \n    , EventSchema = 'Authentication'\n    , EventVendor='Salesforce'\n    , EventCount=int(1)\n    , EventSchemaVersion='0.1.0'\n    , EventResult\n    , EventResultDetails\n    , EventStartTime=todatetime(timestamp_s)\n    , EventEndTime=todatetime(timestamp_s)\n    , EventType = iff(event_type_s == 'Login', 'Logon',iff(event_type_s == 'Logout','Logoff', \"\"))\n    , TargetUserIdType='SaleforceId'\n    , TargetUsernameType='UPN'\n| project-rename\n    EventProductVersion = api_version_s\n    ,EventOriginalResultDetails=login_status_s\n    , TargetSessionId=login_key_s\n    , TargetUserId= user_id_s\n    , TargetUsername=user_name_s\n    , TargetOriginalUserType=user_type_s\n    , EventOriginalUid = request_id_s\n    , SrcIpAddr = source_ip_s\n    , TargetIpAddr = client_ip_s\n     , TargetUserScope = organization_id_s\n    , TlsCipher = cipher_suite_s\n    , TlsVersion = tls_protocol_s\n    , HttpUserAgent= browser_type_s\n| extend \n      User=TargetUsername\n      , Dvc=EventVendor\n      , Src=SrcIpAddr\n      , IpAddr = SrcIpAddr\n      , Dst= TargetIpAddr\n| project-away *_s\n};\nSalesforceSignin(disabled)",
            "version": 1,
            "functionParameters": "disabled:bool=False"
          }
        }
      ]
    }
  ]
}