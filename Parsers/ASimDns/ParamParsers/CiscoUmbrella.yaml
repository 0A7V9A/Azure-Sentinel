Parser:
  Title: Cisco Umbrella DNS Events
  Version: '0.0'
  LastUpdated: May 10, 2021
Product:
  Name: Cisco
Normalization:
  Schema: Dns
  Version: '0.1.0'
References:
- Title: ASIM DNS Schema
  Link: https://aka.ms/AzSentinelDnsDoc
- Title: ASIM
  Link: https:/aka.ms/AzSentinelNormalization
Description: |
  This is a Query Parser that is used to map Cisco Umrella Dns Events (Cisco_Umbrella_dns_CL) to the Azure Sentinel Information Model Dns schema.
ParserName: pmDnsCiscoUmbrella
ParserQuery: |
  let pmDNSQuery_CiscoUmbrella=(starttime:datetime=datetime(null), endtime:datetime=datetime(null), srcipaddr:string='*',domain:string='*', responsecodename:string='*', response:string='*', eventtype:string='lookup'){
      Cisco_Umbrella_dns_CL
      // ******************************************************************
      //  Pre-parsing filterring:
        | where
          (isnull(starttime) or TimeGenerated > starttime)
          and (isnull(endtime) or TimeGenerated < endtime) 
          and (srcipaddr=='*' or InternalIp_s==srcipaddr)
          and (domain=='*' or Domain_s=~domain)
          and (responsecodename=='*' or ResponseCode_s=~responsecodename)
        //  and (response=='*' or has_ipv4(ResponseName,response))
      // *****************************************************************
      | parse QueryType_s with QueryType:int ' ('QueryTypeName:string ')'
      //
      | project 
      //
      // ******************* Mandatory
        Type,
         EventCount=int(1),
         EventStartTime=todatetime(Timestamp_t),
         EventProduct='Umbrella',
         EventVendor='Cisco Systems',
         EventSchemaVersion='0.0.1',
         Dvc='Unknown' ,
         EventType='lookup',
         EventResult=iff(ResponseCode_s=~'NOERROR','Success','Failure'),
         EventResultDetails=ResponseCode_s, 
         //
         TimeGenerated, // not handled by schema, but we need to preserve it
         SrcIpAddr=column_ifexists('InternalIp_s', ''),
         EventSubType='response',
    // ********** Renamed columns
         UrlCategory=column_ifexists('Categories_s', ''),
         Query=column_ifexists('Domain_s', '') ,  
         ThreatCategory=column_ifexists('Blocked_Categories_s', ''),
         SrcNatIpAddr=column_ifexists('ExternalIp_s', ''),
         DvcAction=column_ifexists('Action_s', ''),
         EventEndTime=todatetime(column_ifexists('Timestamp_t', '')),  // [is this the same as TimeGenrated?]
     //
     // *************** keep Parsed data
         QueryType, QueryTypeName, 
     //
     // **** Not in schema
         Identities=column_ifexists('Identities_s', ''), 
         IdentityTypes=column_ifexists('Identity_Types_s', ''),
         PolicyIdentity=column_ifexists('Policy_Identity_s', ''),
         PolicyIdentityType=column_ifexists('Policy_Identity_Type_s', '')
    //
    // **************Aliases
    | extend 
        ResponseCodeName=EventResultDetails, 
        DomainCategory=UrlCategory,
        Domain=Query,
        IpAddr=SrcIpAddr
        // 
         };
  DNSQuery_CiscoUmbrella
