id: 75bf9902-0789-47c1-a5d8-f57046aa72df
name: Malware in the recycle bin
description: |
  'Identifies malware that has been hidden in the recycle bin.
  References: https://azure.microsoft.com/en-us/blog/how-azure-security-center-helps-reveal-a-cyberattack/.'
severity: Medium
requiredDataConnectors:
  - connectorId: SecurityEvents
    dataTypes:
      - SecurityEvent
queryFrequency: 1d
queryPeriod: 1d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - DefenseEvasion
relevantTechniques:
  - T1158
query: |

  let timeframe = 1d;
  let ProcessCreationEvents=() {
  let processEvents=SecurityEvent
  | where EventID==4688
  | project TimeGenerated, ComputerName = Computer, AccountName=SubjectUserName, AccountDomain=SubjectDomainName,
  FileName=tostring(split(NewProcessName, '\\')[-1]), ProcessCommandLine = CommandLine, InitiatingProcessFileName = ParentProcessName, 
  InitiatingProcessCommandLine = "", InitiatingProcessParentFileName = "";
  processEvents};
  ProcessCreationEvents 
  | where TimeGenerated >= timeframe
  | where FileName in~ ('cmd.exe','ftp.exe','schtasks.exe','powershell.exe','rundll32.exe','regsvr32.exe','msiexec.exe')
  | where ProcessCommandLine contains ":\\recycler"
  | project StartTimeUtc = TimeGenerated, ComputerName, AccountName, ProcessCommandLine, InitiatingProcessFileName
  | extend timestamp = StartTimeUtc, AccountCustomEntity = AccountName, HostCustomEntity = ComputerName
