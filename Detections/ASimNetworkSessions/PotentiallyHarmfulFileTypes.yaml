id: 09c49590-4e9d-4da9-a34d-17222d0c9e7e
name: Request to blocklisted file type
description: |
  'Detects request to potentially harmful file types (.ps1, .bat, .vbs, etc.).'
severity: Medium
tags:
  - Id: de58ee9e-b229-4252-8537-41a4c2f4045e
    version: 1.0.0
  - Schema: ASIMNetworkSessions
    SchemaVersion: 0.1.1
requiredDataConnectors:
  - connectorId: []
queryFrequency: 10m
queryPeriod: 10m
triggerOperator: gt
triggerThreshold: 0
tactics:
  - InitialAccess
query: |
  let file_ext_blocklist = dynamic(['.ps1', '.vbs', '.bat', '.scr']);
  let lbtime = 10m;
  ASimWebSession(starttime=lbtime, url_has_any=file_ext_blocklist, dvcaction='Allow')
  | extend requestedFileExtension=tostring(extract(@'^\w+://[^?/]+/[^?]+(\.\w+)',1,Url))
  | where requestedFileExtension in (file_ext_blocklist)
  | project TimeGenerated, SrcIpAddr, Filename
  | extend IPCustomEntity = SrcIpAddr

entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: IPCustomEntity
version: 1.0.0
kind: Scheduled