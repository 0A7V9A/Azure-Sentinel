jobs:
- job: "CallGithubWorkflow"
  pool:
    vmImage: 'ubuntu-latest'

# NAME OF THE JOB THAT DEPENDS
  dependsOn:
  - HyperLinkValidations
  #- SolutionValidations
  # - JsonFileValidation
  # - KqlValidations
  # - logoValidator
  # - NonAsciiValidations
  # - PlaybooksValidations
  # - sampleDataValidator
  # - WorkbooksTemplateValidations
  # - WorkbooksValidations
  # - ContentValidations
  # - DataConnectorValidations
  # - DetectionsValidations
  # - DetectionTemplateSchemaValidation
  # - DocumentsLinkValidation
  #- YamlFileValidation

  condition: |
    and
    (
      ne(variables['Build.SourceBranch'], 'refs/heads/master'),
      ne(variables['Build.SourceBranch'], 'refs/heads/main'),
      eq(dependencies.HyperLinkValidations.result, 'Succeeded'),
      ne(variables['SYSTEM.PULLREQUEST.ISFORK'], 'true')
    )
  steps:
  - pwsh: |
      $branchName = "$(Build.SourceBranch)"
      Write-Host "Branch Name is $branchName"
      $isAutoGeneratedPR = [bool]($branchName -match "-automated-pr")

      if (($branchName -eq 'refs/heads/main' -or $branchName -eq 'refs/heads/master') -and $isAutoGeneratedPR -eq $false)
      {
        $msg = "$(Build.SourceVersionMessage)"
        Write-Host "Message $msg"
        $hashIndex = $msg.IndexOf('#')
        $fromIndex = $msg.IndexOf('from ')
        $prNumberSubstring = $msg.substring($hashIndex + 1)
        $spaceIndex = $prNumberSubstring.IndexOf(' ')
        $prNumber = $prNumberSubstring.substring(0, $spaceIndex)
        $prBranchName = $msg.substring($fromIndex + 5)
        $lastIndexOfSlash = $prBranchName.LastIndexOf('/')
        if ($lastIndexOfSlash -gt 0)
        {
          $prBranchName = $prBranchName.substring($lastIndexOfSlash + 1)
        }
        Write-Host "PR Number is $prNumber, PR Branch Name is $prBranchName"

        # Execute only when branch name and prnumber are not blank or null
        if ($null -ne $prNumber -and $null -ne $prBranchName)
        {
          Write-Host "Invoking Github Workflow for package creation!"
          .script/package-automation/invokeGithubWorklow.ps1 $prBranchName $prNumber
        }
        else
        {
          Write-Host "Skipping Github Workflow Package creation process!"
        }
      }
      else
      {
        Write-Host "Skipping Github Workflow from execution as current branch is not a Master branch or is a automated PR."
      }
    displayName: 'Call Github Workflow'
    continueOnError: true
