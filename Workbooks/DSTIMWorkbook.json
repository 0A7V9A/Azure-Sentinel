{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "DemoDSTIMWorkbook",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "sentinel",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "variables": {
    "workbookContent": {
      "version": "Notebook/1.0",
      "items": [
        {
          "type": 1,
          "content": {
            "json": "# Data Security – Sensitive data Impact Assessment\r\nUse this Workbook to accelerate the investigation and impact assessment of incidents that involve sensitive data such as PII, PCI, PHI, or Intellectual Property present in Azure Blob Storage data source.\r\nThis solution is in its Private Preview stage and will correlate Azure Blob Storage resource audit logs and data sensitivity logs from Azure Purview - to create sensitive data impact assessment report (i.e. Who accessed, What sensitive data, from Where and When).\r\n\r\n"
          },
          "name": "text - 16",
          "styleSettings": {
            "padding": "0px 0px 20px 30px"
          }
        },
        {
          "type": 11,
          "content": {
            "version": "LinkItem/1.0",
            "style": "tabs",
            "links": [
              {
                "id": "5e28d027-8f7a-40c4-a1ee-0424648c6f94",
                "cellValue": "TabName",
                "linkTarget": "parameter",
                "linkLabel": "Summary",
                "subTarget": "Summary",
                "style": "link"
              },
              {
                "id": "e09caa82-1657-4927-b776-916bcb7918dd",
                "cellValue": "TabName",
                "linkTarget": "parameter",
                "linkLabel": "User account",
                "subTarget": "UserAccount",
                "style": "link"
              },
              {
                "id": "bc68a7f4-0783-4ec2-ae6c-052cafcbed05",
                "cellValue": "TabName",
                "linkTarget": "parameter",
                "linkLabel": "IP Address",
                "subTarget": "IPAddress",
                "style": "link"
              }
            ]
          },
          "name": "Tabs",
          "styleSettings": {
            "margin": "0px 30px"
          }
        },
        {
          "type": 1,
          "content": {
            "json": "----\r\n## Investigation scope"
          },
          "name": "break  - Copy",
          "styleSettings": {
            "margin": "0px 30px"
          }
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "items": [
              {
                "type": 9,
                "content": {
                  "version": "KqlParameterItem/1.0",
                  "crossComponentResources": [
                    "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                    "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/cybersecuritysoc"
                  ],
                  "parameters": [
                    {
                      "id": "8957770d-ea80-4383-8fda-e7a3ac4a45aa",
                      "version": "KqlParameterItem/1.0",
                      "name": "TimeRange_IS",
                      "label": "During",
                      "type": 4,
                      "isRequired": true,
                      "value": {
                        "durationMs": 31622400000,
                        "endTime": "2021-12-02T18:39:00.000Z"
                      },
                      "typeSettings": {
                        "selectableValues": [
                          {
                            "durationMs": 300000
                          },
                          {
                            "durationMs": 900000
                          },
                          {
                            "durationMs": 1800000
                          },
                          {
                            "durationMs": 3600000
                          },
                          {
                            "durationMs": 14400000
                          },
                          {
                            "durationMs": 43200000
                          },
                          {
                            "durationMs": 86400000
                          },
                          {
                            "durationMs": 172800000
                          },
                          {
                            "durationMs": 259200000
                          },
                          {
                            "durationMs": 604800000
                          },
                          {
                            "durationMs": 1209600000
                          },
                          {
                            "durationMs": 2419200000
                          },
                          {
                            "durationMs": 2592000000
                          },
                          {
                            "durationMs": 5184000000
                          },
                          {
                            "durationMs": 7776000000
                          }
                        ],
                        "allowCustom": true
                      },
                      "timeContext": {
                        "durationMs": 86400000
                      }
                    },
                    {
                      "id": "96377586-679c-4081-b68d-119b06380ade",
                      "version": "KqlParameterItem/1.0",
                      "name": "Subcriptions_IS",
                      "label": "Subscription",
                      "type": 6,
                      "isRequired": true,
                      "multiSelect": true,
                      "quote": "'",
                      "delimiter": ",",
                      "query": "//drop down parameter, list of subscriptions.\r\nDSTIMAccess_CL\r\n| where AggregationLastEventTime_t {TimeRange_IS} or TimeDiscovered_t {TimeRange_IS}\r\n| project ResourceSubscriptionId = ResourceSubscriptionId_g, AggregationLastEventTime = AggregationLastEventTime_t, TimeGenerated = TimeDiscovered_t\r\n| distinct ResourceSubscriptionId\r\n",
                      "crossComponentResources": [
                        "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                        "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/cybersecuritysoc"
                      ],
                      "typeSettings": {
                        "additionalResourceOptions": [
                          "value::all"
                        ],
                        "selectAllValue": "*",
                        "showDefault": false
                      },
                      "defaultValue": "value::all",
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "id": "db2fcd85-cd0a-4ae5-a2fc-0c8d43eedec9",
                      "version": "KqlParameterItem/1.0",
                      "name": "ResourceGroup_IS",
                      "label": "Resource group",
                      "type": 2,
                      "isRequired": true,
                      "multiSelect": true,
                      "quote": "'",
                      "delimiter": ",",
                      "query": "//dropdown parameter, list of Resource groups according to Subscriptions_IS parameter\r\nDSTIMAccess_CL | project ResourceSubscriptionId_g, ResourceGroup, AggregationLastEventTime_t, TimeDiscovered_t \r\n| where AggregationLastEventTime_t {TimeRange_IS} or TimeDiscovered_t {TimeRange_IS}\r\n| where \"{Subcriptions_IS}\" == \"'*'\" or '{Subcriptions_IS:id}' has ResourceSubscriptionId_g\r\n| distinct ResourceGroup",
                      "crossComponentResources": [
                        "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                        "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/cybersecuritysoc"
                      ],
                      "typeSettings": {
                        "additionalResourceOptions": [
                          "value::all"
                        ],
                        "selectAllValue": "*",
                        "showDefault": false
                      },
                      "defaultValue": "value::all",
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "id": "15fe75b2-3ebc-417a-8c65-0216d32ceef6",
                      "version": "KqlParameterItem/1.0",
                      "name": "UserAccount_IS",
                      "label": "User account",
                      "type": 2,
                      "isRequired": true,
                      "multiSelect": true,
                      "quote": "'",
                      "delimiter": ",",
                      "query": "//union between mailAdress acounts and app id's. (might change after normelizing the user account info we get from accesslogs).\r\n//dropdown parameter, list of Resource groups according to Subscriptions_IS parameter\r\nDSTIMAccess_CL \r\n| project ResourceSubscriptionId = ResourceSubscriptionId_g, ResourceGroup, AggregationLastEventTime = AggregationLastEventTime_t, TimeGenerated = TimeDiscovered_t, RequesterUpn = RequesterUpn_s\r\n| where AggregationLastEventTime {TimeRange_IS} or TimeGenerated {TimeRange_IS}\r\n| where \"{Subcriptions_IS}\" == \"'*'\" or '{Subcriptions_IS:id}' has ResourceSubscriptionId\r\n| where \"{ResourceGroup_IS}\" == \"'*'\" or ResourceGroup in ({ResourceGroup_IS}) \r\n| where isnotempty(RequesterUpn)\r\n| distinct RequesterUpn\r\n| join kind = leftouter (IdentityInfo) on $left.RequesterUpn == $right.MailAddress\r\n| project AccountDisplayName = iff(isempty(AccountDisplayName), RequesterUpn, AccountDisplayName)\r\n| distinct AccountDisplayName\r\n| union (DSTIMAccess_CL \r\n| project ResourceSubscriptionId = ResourceSubscriptionId_g, ResourceGroup, AggregationLastEventTime = AggregationLastEventTime_t, TimeGenerated = TimeDiscovered_t, RequesterUpn = RequesterUpn_s, RequesterAppId = RequesterAppId_s\r\n| where AggregationLastEventTime {TimeRange_IS} or TimeGenerated {TimeRange_IS}\r\n| where \"{Subcriptions_IS}\" == \"'*'\" or '{Subcriptions_IS:id}' has ResourceSubscriptionId\r\n| where \"{ResourceGroup_IS}\" == \"'*'\" or ResourceGroup in ({ResourceGroup_IS}) \r\n| where isnotempty(RequesterAppId)  | project AccountDisplayName = RequesterAppId | distinct AccountDisplayName)\r\n",
                      "crossComponentResources": [
                        "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                        "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/cybersecuritysoc"
                      ],
                      "typeSettings": {
                        "additionalResourceOptions": [
                          "value::all"
                        ],
                        "selectAllValue": "*",
                        "showDefault": false
                      },
                      "defaultValue": "value::all",
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "id": "e652cebc-d5ee-49c2-95dd-d00d18cc7ee7",
                      "version": "KqlParameterItem/1.0",
                      "name": "Classification_IS",
                      "label": "Classification",
                      "type": 2,
                      "isRequired": true,
                      "multiSelect": true,
                      "quote": "'",
                      "delimiter": ",",
                      "query": "GetClassificationList({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))",
                      "crossComponentResources": [
                        "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                        "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/cybersecuritysoc"
                      ],
                      "typeSettings": {
                        "additionalResourceOptions": [
                          "value::all"
                        ],
                        "selectAllValue": "*",
                        "showDefault": false
                      },
                      "defaultValue": "value::all",
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces",
                      "value": [
                        "value::all"
                      ]
                    },
                    {
                      "id": "91768aeb-8cad-411b-bfcb-7012011468c0",
                      "version": "KqlParameterItem/1.0",
                      "name": "SensitivityLabel_IS",
                      "label": "Senitivity Label",
                      "type": 2,
                      "isRequired": true,
                      "multiSelect": true,
                      "quote": "'",
                      "delimiter": ",",
                      "query": "//list of sensitivityLabels accoding to all investigation scope parameters.\r\nDSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| where \"{Classification_IS}\" == \"'*'\" or Classification has_any({Classification_IS})\r\n| project LabelName = iff(isempty(SensitivityLabelName), \"no label\", SensitivityLabelName)\r\n| distinct LabelName",
                      "crossComponentResources": [
                        "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                        "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/cybersecuritysoc"
                      ],
                      "typeSettings": {
                        "additionalResourceOptions": [
                          "value::all"
                        ],
                        "selectAllValue": "*",
                        "showDefault": false
                      },
                      "defaultValue": "value::all",
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    }
                  ],
                  "style": "pills",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "customWidth": "0",
                "name": "InvestigationScope",
                "styleSettings": {
                  "maxWidth": "60"
                }
              },
              {
                "type": 12,
                "content": {
                  "version": "NotebookGroup/1.0",
                  "groupType": "editable",
                  "items": [
                    {
                      "type": 9,
                      "content": {
                        "version": "KqlParameterItem/1.0",
                        "parameters": [
                          {
                            "id": "2318320d-70d3-4dad-a930-10fc51dfe62e",
                            "version": "KqlParameterItem/1.0",
                            "name": "IPAddress_IS",
                            "label": "IP Address",
                            "type": 2,
                            "value": "contains",
                            "typeSettings": {
                              "additionalResourceOptions": []
                            },
                            "jsonData": "[[\"contains\", \"!contains\"]"
                          },
                          {
                            "id": "2987875a-e179-431d-93c1-b8540af04fcd",
                            "version": "KqlParameterItem/1.0",
                            "name": "IPRange_IS",
                            "label": "IP Range",
                            "type": 1,
                            "value": ""
                          }
                        ],
                        "style": "pills",
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      },
                      "customWidth": "0",
                      "name": "InvestigationScope - ip",
                      "styleSettings": {
                        "maxWidth": "50"
                      }
                    },
                    {
                      "type": 9,
                      "content": {
                        "version": "KqlParameterItem/1.0",
                        "parameters": [
                          {
                            "id": "a1470529-ff31-4723-a048-b73a0935805b",
                            "version": "KqlParameterItem/1.0",
                            "name": "AssetPath_IS",
                            "label": "Asset Path",
                            "type": 2,
                            "value": "contains",
                            "typeSettings": {
                              "additionalResourceOptions": [],
                              "showDefault": false
                            },
                            "jsonData": "[[\"contains\", \"!contains\"]"
                          },
                          {
                            "id": "f136c461-4943-47c1-b67c-7bf0cd679d08",
                            "version": "KqlParameterItem/1.0",
                            "name": "Path_IS",
                            "label": "path",
                            "type": 1,
                            "value": ""
                          }
                        ],
                        "style": "pills",
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      },
                      "customWidth": "0",
                      "name": "InvestigationScope - path",
                      "styleSettings": {
                        "margin": "0px 10px",
                        "padding": "0px",
                        "maxWidth": "50"
                      }
                    }
                  ],
                  "exportParameters": true
                },
                "customWidth": "0",
                "name": "DropDownParameters",
                "styleSettings": {
                  "margin": "0px 40px",
                  "maxWidth": "40"
                }
              }
            ],
            "exportParameters": true
          },
          "name": "Investigation scope",
          "styleSettings": {
            "margin": "0px 30px",
            "padding": "-30px 0px"
          }
        },
        {
          "type": 1,
          "content": {
            "json": "----\r\n## General Investigation Information"
          },
          "name": "break ",
          "styleSettings": {
            "margin": "0px 30px"
          }
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "items": [
              {
                "type": 9,
                "content": {
                  "version": "KqlParameterItem/1.0",
                  "parameters": [
                    {
                      "id": "789877b3-4d79-4403-bb7e-0dff8e3d8aad",
                      "version": "KqlParameterItem/1.0",
                      "name": "WatchListEntities",
                      "type": 1,
                      "query": "DSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| project Classification, SensitivityLabelName, RequesterUpn\r\n| where \"'*'\" == \"{Classification_IS}\" or Classification has_any({Classification_IS})\r\n| where \"'*'\" == \"{SensitivityLabel_IS}\" or SensitivityLabelName in ({SensitivityLabel_IS})\r\n| where isnotempty(RequesterUpn)\r\n| join kind=inner (_GetWatchlist(\"VIPUsers\") | distinct SearchKey | union (_GetWatchlist(\"TerminatedEmployees\") | distinct SearchKey ) | union (_GetWatchlist(\"HighValueAssets\") | distinct SearchKey))\r\non $left.RequesterUpn == $right.SearchKey\r\n| distinct RequesterUpn",
                      "isHiddenWhenLocked": true,
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "id": "56682599-5018-4d5b-8139-57ac8703838d",
                      "version": "KqlParameterItem/1.0",
                      "name": "WatchListCount",
                      "type": 1,
                      "query": "print(iff(isempty('{WatchListEntities}'), 'no', tostring(array_length(parse_json(split('{WatchListEntities}', ','))))))",
                      "crossComponentResources": [
                        "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                        "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/cybersecuritysoc"
                      ],
                      "isHiddenWhenLocked": true,
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "id": "904c8770-9e80-4d0b-825b-f8f7a917218e",
                      "version": "KqlParameterItem/1.0",
                      "name": "TIIPEntities",
                      "type": 1,
                      "query": "//query purpose - get count of IP addresses that are part of threat inteligenceIndicator list.\r\nDSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| project Classification, SensitivityLabelName, CallerIPAddress\r\n| where \"'*'\" == \"{Classification_IS}\" or Classification has_any({Classification_IS})\r\n| where \"'*'\" == \"{SensitivityLabel_IS}\" or SensitivityLabelName in ({SensitivityLabel_IS})\r\n| join kind=inner (ThreatIntelligenceIndicator | where TimeGenerated {TimeRange_IS} | project NetworkSourceIP)  on $right.NetworkSourceIP == $left.CallerIPAddress\r\n| distinct CallerIPAddress",
                      "crossComponentResources": [
                        "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/cybersecuritysoc",
                        "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics"
                      ],
                      "isHiddenWhenLocked": true,
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "id": "b43321b8-99d1-4a2b-891d-02374da17074",
                      "version": "KqlParameterItem/1.0",
                      "name": "TIIPCount",
                      "type": 1,
                      "isRequired": true,
                      "query": "print(iff(isempty('{TIIPEntities}'), 'no', \r\ntostring(array_length(parse_json(split('{TIIPEntities}', ','))))))\r\n\r\n",
                      "crossComponentResources": [
                        "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                        "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/cybersecuritysoc"
                      ],
                      "isHiddenWhenLocked": true,
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "id": "70277b70-a538-4d81-b60f-1d73cfdc0bb6",
                      "version": "KqlParameterItem/1.0",
                      "name": "assetCounts",
                      "type": 1,
                      "query": "//Query purpose - present the num of unique assets that were accessed by an IP addres that is part of Threat Inteligence table\r\nDSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| project Classification, SensitivityLabelName, CallerIPAddress, Uri\r\n| where \"'*'\" == \"{Classification_IS}\" or Classification has_any({Classification_IS})\r\n| where \"'*'\" == \"{SensitivityLabel_IS}\" or SensitivityLabelName in ({SensitivityLabel_IS})\r\n| join kind=inner (ThreatIntelligenceIndicator | where TimeGenerated {TimeRange_IS} | project NetworkSourceIP)  on $right.NetworkSourceIP == $left.CallerIPAddress\r\n| distinct Uri\r\n| summarize Count = count()\r\n| project Count = iff(Count == 0, \"no\", tostring(Count))",
                      "crossComponentResources": [
                        "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                        "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/cybersecuritysoc"
                      ],
                      "isHiddenWhenLocked": true,
                      "defaultValue": "value::all",
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "id": "3b3341df-a8fe-42ba-94ee-4d1f4375babb",
                      "version": "KqlParameterItem/1.0",
                      "name": "UserAnomalies",
                      "type": 1,
                      "query": "//Get number of anomalies from Anomalies table that were matching to entities in accessLogs(Note: Currently looking MailAddress match, waiting for response from ed gardner).\r\nDSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| project Classification, SensitivityLabelName, RequesterUpn\r\n| where \"'*'\" == \"{Classification_IS}\" or Classification has_any({Classification_IS})\r\n| where \"'*'\" == \"{SensitivityLabel_IS}\" or SensitivityLabelName in ({SensitivityLabel_IS})\r\n| where isnotempty(RequesterUpn)\r\n| join kind=inner (Anomalies | where TimeGenerated {TimeRange_IS} | project AadUserId = tostring(Entities[0].AadUserId) | where isnotempty(AadUserId)) on $left.RequesterUpn == $right.AadUserId\r\n| summarize total_count = count() \r\n| project Count = iff(total_count == 0, \"no\", tostring(total_count))",
                      "crossComponentResources": [
                        "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                        "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/SOC/providers/Microsoft.OperationalInsights/workspaces/CyberSecuritySOC"
                      ],
                      "isHiddenWhenLocked": true,
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "version": "KqlParameterItem/1.0",
                      "name": "IPAnomalies",
                      "type": 1,
                      "query": "//Get number of anomalies from Anomalies table that were matching to entities in accessLogs(Note: Currently looking IP match, waiting for response from ed gardner).\r\nDSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| project Classification, SensitivityLabelName, CallerIPAddress\r\n| where \"'*'\" == \"{Classification_IS}\" or Classification has_any({Classification_IS})\r\n| where \"'*'\" == \"{SensitivityLabel_IS}\" or SensitivityLabelName in ({SensitivityLabel_IS})\r\n| where isnotempty(CallerIPAddress)\r\n| join kind=inner (Anomalies | where TimeGenerated {TimeRange_IS} | project Address = tostring(Entities[0].Address) | where isnotempty(Address)) on $left.CallerIPAddress == $right.Address\r\n| summarize total_count = count() \r\n| project Count = iff(total_count == 0, \"no\", tostring(total_count))",
                      "crossComponentResources": [
                        "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                        "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/SOC/providers/Microsoft.OperationalInsights/workspaces/CyberSecuritySOC"
                      ],
                      "isHiddenWhenLocked": true,
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces",
                      "id": "81217188-4340-4281-81bb-8b39b6905493"
                    },
                    {
                      "id": "8a446749-7b6a-4aab-9818-7d4d75d34e0b",
                      "version": "KqlParameterItem/1.0",
                      "name": "TotalAnomalies",
                      "type": 1,
                      "isHiddenWhenLocked": true,
                      "criteriaData": [
                        {
                          "criteriaContext": {
                            "operator": "Default",
                            "resultValType": "expression",
                            "resultVal": "{UserAnomalies} + {IPAnomalies}"
                          }
                        }
                      ]
                    },
                    {
                      "id": "b37715cd-5cde-4146-8fa8-3028e9fb7a16",
                      "version": "KqlParameterItem/1.0",
                      "name": "AnomaliesUserEntities",
                      "type": 1,
                      "query": "//Get unique count of entities that are oart of the Anomalies table(Note; Currently looking for MailAddress match, waiting for response from ed gardner).\r\nDSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| project Classification, SensitivityLabelName, RequesterUpn\r\n| where \"'*'\" == \"{Classification_IS}\" or Classification has_any({Classification_IS})\r\n| where \"'*'\" == \"{SensitivityLabel_IS}\" or SensitivityLabelName in ({SensitivityLabel_IS})\r\n| where isnotempty(RequesterUpn)\r\n| join kind=inner (Anomalies | where TimeGenerated {TimeRange_IS} | project AadUserId = tostring(Entities[0].AadUserId) | where isnotempty(AadUserId)) on $left.RequesterUpn == $right.AadUserId\r\n| distinct RequesterUpn",
                      "isHiddenWhenLocked": true,
                      "defaultValue": "value::all",
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "version": "KqlParameterItem/1.0",
                      "name": "AnomaliesIPEntities",
                      "type": 1,
                      "query": "//Get unique count of entities that are oart of the Anomalies table(Note; Currently looking for MailAddress match, waiting for response from ed gardner).\r\nDSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| project Classification, SensitivityLabelName, CallerIPAddress\r\n| where \"'*'\" == \"{Classification_IS}\" or Classification has_any({Classification_IS})\r\n| where \"'*'\" == \"{SensitivityLabel_IS}\" or SensitivityLabelName in ({SensitivityLabel_IS})\r\n| where isnotempty(CallerIPAddress)\r\n| join kind=inner (Anomalies | where TimeGenerated {TimeRange_IS}| project Address = tostring(Entities[1].Address) | where isnotempty(Address)) on $left.CallerIPAddress == $right.Address\r\n| distinct CallerIPAddress",
                      "isHiddenWhenLocked": true,
                      "defaultValue": "value::all",
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces",
                      "id": "c90199c6-e62d-4222-b0f5-1c5d645a3339"
                    },
                    {
                      "version": "KqlParameterItem/1.0",
                      "name": "AnomaliesUserEntitiesCount",
                      "type": 1,
                      "query": "print(iff(isempty('{AnomaliesUserEntities}'), '0', tostring(array_length(parse_json(split('{AnomaliesUserEntities}', ','))))))",
                      "crossComponentResources": [
                        "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                        "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/cybersecuritysoc"
                      ],
                      "isHiddenWhenLocked": true,
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces",
                      "id": "933924e5-2e79-4e1d-8cb3-bafbc937d8e0"
                    },
                    {
                      "version": "KqlParameterItem/1.0",
                      "name": "AnomaliesIPEntitiesCount",
                      "type": 1,
                      "query": "print(iff(isempty('{AnomaliesIPEntities}'), '0', tostring(array_length(parse_json(split('{AnomaliesIPEntities}', ','))))))",
                      "crossComponentResources": [
                        "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                        "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/cybersecuritysoc"
                      ],
                      "isHiddenWhenLocked": true,
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces",
                      "id": "27fcedd6-dd33-4353-9df3-7c63ed204b73"
                    },
                    {
                      "id": "1acf64cd-980d-4048-9146-fc6f915de423",
                      "version": "KqlParameterItem/1.0",
                      "name": "LinkName",
                      "type": 1,
                      "isGlobal": true,
                      "query": "print('default')",
                      "isHiddenWhenLocked": true,
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "id": "7a53c97b-2715-4f39-99dd-f6b452a4ff50",
                      "version": "KqlParameterItem/1.0",
                      "name": "TotalAnomaliesEntitiesCount",
                      "type": 1,
                      "isHiddenWhenLocked": true,
                      "criteriaData": [
                        {
                          "criteriaContext": {
                            "operator": "Default",
                            "resultValType": "expression",
                            "resultVal": "{AnomaliesUserEntitiesCount} + {AnomaliesIPEntitiesCount}"
                          }
                        }
                      ]
                    }
                  ],
                  "style": "pills",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "conditionalVisibility": {
                  "parameterName": "TabName",
                  "comparison": "isEqualTo",
                  "value": "default"
                },
                "name": "Insightsparameters "
              },
              {
                "type": 12,
                "content": {
                  "version": "NotebookGroup/1.0",
                  "groupType": "editable",
                  "items": [
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "//Query purpose = represent KPI cards with data about the access logs.\r\n//Unique count of:Subscriptions, Resource Groups, Sensitive data sources accessed, Sensitive data assets accessed, Classifications accessed, Labels accessed and User Accounts.\r\n\r\nlet totalClassificationCount = GetClassificationList({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| count;\r\n\r\nlet basicTiles = DSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| summarize dcount(ResourceSubscriptionId), dcount(ResourceGroup), dcount(StorageAccountName),dcount(Uri), dcount(SensitivityLabelName), dcount(RequesterUpn), dcount(RequesterAppId)\r\n| project  [\"Subscriptions\"]  = dcount_ResourceSubscriptionId , [\"Resource Groups\"] = dcount_ResourceGroup , [\"Sensitive data sources accessed\"] = dcount_StorageAccountName, [\"User accounts\"] = dcount_RequesterUpn + dcount_RequesterAppId, [\"Sensitive data assets accessed\"] = dcount_Uri , [\"Classifications accessed\"] = toscalar(totalClassificationCount), [\"Labels accessed\"] = dcount_SensitivityLabelName\r\n| evaluate narrow()\r\n| extend TableName = replace(@\"\\[|\\]|\\'\", @'',Column)\r\n| extend Count = Value\r\n| project TableName, Count;\r\n\r\nbasicTiles",
                        "size": 3,
                        "color": "turquoise",
                        "exportFieldName": "TableName",
                        "exportParameterName": "TableName",
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces",
                        "visualization": "tiles",
                        "tileSettings": {
                          "titleContent": {
                            "columnMatch": "TableName",
                            "formatter": 1
                          },
                          "subtitleContent": {
                            "columnMatch": "Count",
                            "formatter": 12,
                            "formatOptions": {
                              "palette": "auto"
                            }
                          },
                          "showBorder": true,
                          "sortOrderField": 1,
                          "size": "auto"
                        },
                        "graphSettings": {
                          "type": 2,
                          "topContent": {
                            "columnMatch": "Subscriptions",
                            "formatter": 1,
                            "numberFormat": {
                              "unit": 0,
                              "options": {
                                "style": "decimal"
                              }
                            },
                            "tooltipFormat": {
                              "tooltip": "Subscriptions"
                            }
                          },
                          "centerContent": {
                            "columnMatch": "Subscriptions",
                            "formatter": 1
                          },
                          "nodeIdField": "Subscriptions",
                          "sourceIdField": "Subscriptions",
                          "targetIdField": "Subscriptions",
                          "graphOrientation": 3,
                          "showOrientationToggles": false,
                          "edgeLabel": "Subscriptions",
                          "nodeSize": null,
                          "staticNodeSize": 100,
                          "colorSettings": null,
                          "hivesMargin": 5
                        },
                        "mapSettings": {
                          "locInfo": "LatLong",
                          "sizeSettings": "Subscriptions",
                          "sizeAggregation": "Sum",
                          "legendMetric": "Subscriptions",
                          "legendAggregation": "Sum",
                          "itemColorSettings": {
                            "type": "heatmap",
                            "colorAggregation": "Sum",
                            "nodeColorField": "Subscriptions",
                            "heatmapPalette": "greenRed"
                          }
                        },
                        "textSettings": {
                          "style": "header"
                        }
                      },
                      "customWidth": "0",
                      "showPin": true,
                      "name": "KPI cards",
                      "styleSettings": {
                        "maxWidth": "100"
                      }
                    },
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "AccessLogs_CL | take 1\r\n| project  [\"Watchlist(S) match\"]  = '{WatchListCount}' , [\"Anomalies match\"] = '{AnomaliesUserEntitiesCount}'\r\n| distinct  [\"Watchlist(S) match\"] ,[\"Anomalies match\"]\r\n| evaluate narrow()\r\n| extend TableName = replace(@\"\\[|\\]|\\'\", @'',Column)\r\n| extend Count = Value\r\n| project TableName, Count",
                        "size": 3,
                        "exportFieldName": "TableName",
                        "exportParameterName": "TableName",
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces",
                        "visualization": "tiles",
                        "tileSettings": {
                          "titleContent": {
                            "columnMatch": "TableName",
                            "formatter": 1
                          },
                          "subtitleContent": {
                            "columnMatch": "Count",
                            "formatter": 12,
                            "formatOptions": {
                              "palette": "auto"
                            }
                          },
                          "showBorder": true,
                          "sortOrderField": 1,
                          "size": "auto"
                        },
                        "graphSettings": {
                          "type": 2,
                          "topContent": {
                            "columnMatch": "Subscriptions",
                            "formatter": 1,
                            "numberFormat": {
                              "unit": 0,
                              "options": {
                                "style": "decimal"
                              }
                            },
                            "tooltipFormat": {
                              "tooltip": "Subscriptions"
                            }
                          },
                          "centerContent": {
                            "columnMatch": "Subscriptions",
                            "formatter": 1
                          },
                          "nodeIdField": "Subscriptions",
                          "sourceIdField": "Subscriptions",
                          "targetIdField": "Subscriptions",
                          "graphOrientation": 3,
                          "showOrientationToggles": false,
                          "edgeLabel": "Subscriptions",
                          "nodeSize": null,
                          "staticNodeSize": 100,
                          "colorSettings": null,
                          "hivesMargin": 5
                        },
                        "mapSettings": {
                          "locInfo": "LatLong",
                          "sizeSettings": "Subscriptions",
                          "sizeAggregation": "Sum",
                          "legendMetric": "Subscriptions",
                          "legendAggregation": "Sum",
                          "itemColorSettings": {
                            "type": "heatmap",
                            "colorAggregation": "Sum",
                            "nodeColorField": "Subscriptions",
                            "heatmapPalette": "greenRed"
                          }
                        },
                        "textSettings": {
                          "style": "header"
                        }
                      },
                      "customWidth": "0",
                      "conditionalVisibility": {
                        "parameterName": "TabName",
                        "comparison": "isEqualTo",
                        "value": "UserAccount"
                      },
                      "showPin": true,
                      "name": "KPI cards - User Account",
                      "styleSettings": {
                        "maxWidth": "30"
                      }
                    },
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "AccessLogs_CL | take 1\r\n| project  [\"Anomalies match\"] = '{AnomaliesIPEntitiesCount}', [\"TI match\"] = '{TIIPCount}'\r\n| distinct  [\"Anomalies match\"],  [\"TI match\"]\r\n| evaluate narrow()\r\n| extend TableName = replace(@\"\\[|\\]|\\'\", @'',Column)\r\n| extend Count = Value\r\n| project TableName, Count",
                        "size": 3,
                        "exportFieldName": "TableName",
                        "exportParameterName": "TableName",
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces",
                        "visualization": "tiles",
                        "tileSettings": {
                          "titleContent": {
                            "columnMatch": "TableName",
                            "formatter": 1
                          },
                          "subtitleContent": {
                            "columnMatch": "Count",
                            "formatter": 12,
                            "formatOptions": {
                              "palette": "auto"
                            }
                          },
                          "showBorder": true,
                          "sortOrderField": 1,
                          "size": "auto"
                        },
                        "graphSettings": {
                          "type": 2,
                          "topContent": {
                            "columnMatch": "Subscriptions",
                            "formatter": 1,
                            "numberFormat": {
                              "unit": 0,
                              "options": {
                                "style": "decimal"
                              }
                            },
                            "tooltipFormat": {
                              "tooltip": "Subscriptions"
                            }
                          },
                          "centerContent": {
                            "columnMatch": "Subscriptions",
                            "formatter": 1
                          },
                          "nodeIdField": "Subscriptions",
                          "sourceIdField": "Subscriptions",
                          "targetIdField": "Subscriptions",
                          "graphOrientation": 3,
                          "showOrientationToggles": false,
                          "edgeLabel": "Subscriptions",
                          "nodeSize": null,
                          "staticNodeSize": 100,
                          "colorSettings": null,
                          "hivesMargin": 5
                        },
                        "mapSettings": {
                          "locInfo": "LatLong",
                          "sizeSettings": "Subscriptions",
                          "sizeAggregation": "Sum",
                          "legendMetric": "Subscriptions",
                          "legendAggregation": "Sum",
                          "itemColorSettings": {
                            "type": "heatmap",
                            "colorAggregation": "Sum",
                            "nodeColorField": "Subscriptions",
                            "heatmapPalette": "greenRed"
                          }
                        },
                        "textSettings": {
                          "style": "header"
                        }
                      },
                      "customWidth": "0",
                      "conditionalVisibility": {
                        "parameterName": "TabName",
                        "comparison": "isEqualTo",
                        "value": "IPAddress"
                      },
                      "showPin": true,
                      "name": "KPI cards - IPAddress",
                      "styleSettings": {
                        "maxWidth": "30"
                      }
                    }
                  ],
                  "exportParameters": true
                },
                "customWidth": "100",
                "name": "Tiles"
              },
              {
                "type": 12,
                "content": {
                  "version": "NotebookGroup/1.0",
                  "groupType": "editable",
                  "items": [
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "DSTIMAccess_CL \r\n| project ResourceSubscriptionId = ResourceSubscriptionId_g, ResourceGroup, AggregationLastEventTime = AggregationLastEventTime_t, TimeGenerated = TimeDiscovered_t, RequesterUpn = RequesterUpn_s, RequesterAppId = RequesterAppId_s\r\n| where TimeGenerated {TimeRange_IS} or AggregationLastEventTime {TimeRange_IS}\r\n| where '{Subcriptions_IS:id}' == '*' or '{Subcriptions_IS:id}' has ResourceSubscriptionId\r\n| where \"'*'\" == \"{ResourceGroup_IS}\" or ResourceGroup in ({ResourceGroup_IS}) \r\n| where  \"'*'\" == \"{UserAccount_IS}\" or RequesterUpn in ({UserAccount_IS}) or RequesterAppId in ({UserAccount_IS})\r\n| distinct ResourceSubscriptionId",
                        "size": 0,
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      },
                      "conditionalVisibility": {
                        "parameterName": "TableName",
                        "comparison": "isEqualTo",
                        "value": "Nothing"
                      },
                      "name": "DSTIMSubscriptions"
                    },
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "resourcecontainers\r\n| project id, subscriptionId, type, tags\r\n| where '{Subcriptions_IS:id}' == '*' or '{Subcriptions_IS:id}' has subscriptionId\r\n| where type == \"microsoft.resources/subscriptions\"",
                        "size": 0,
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources",
                        "crossComponentResources": [
                          "/subscriptions/5733bcb3-7fde-4caf-8629-41dc15e3b352",
                          "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b",
                          "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f",
                          "/subscriptions/fb7a7f00-5566-4e90-b64b-97f8aae9c294"
                        ],
                        "gridSettings": {
                          "formatters": [
                            {
                              "columnMatch": "SubscriptionName",
                              "formatter": 15,
                              "formatOptions": {
                                "linkTarget": null,
                                "showIcon": true
                              }
                            }
                          ]
                        },
                        "sortBy": []
                      },
                      "conditionalVisibility": {
                        "parameterName": "TableName",
                        "comparison": "isEqualTo",
                        "value": "nothing"
                      },
                      "name": "ResourceSubscriptions"
                    },
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"74022f16-9973-482c-a7df-962934df00a4\",\"mergeType\":\"innerunique\",\"leftTable\":\"DSTIMSubscriptions\",\"rightTable\":\"ResourceSubscriptions\",\"leftColumn\":\"ResourceSubscriptionId\",\"rightColumn\":\"subscriptionId\"}],\"projectRename\":[{\"originalName\":\"[ResourceSubscriptions].id\",\"mergedName\":\"id\",\"fromId\":\"74022f16-9973-482c-a7df-962934df00a4\"},{\"originalName\":\"[DSTIMSubscriptions].ResourceSubscriptionId\",\"mergedName\":\"ResourceSubscriptionId\",\"fromId\":\"74022f16-9973-482c-a7df-962934df00a4\"},{\"originalName\":\"[ResourceSubscriptions].tags\",\"mergedName\":\"tags\",\"fromId\":\"74022f16-9973-482c-a7df-962934df00a4\"},{\"originalName\":\"[ResourceSubscriptions].name\"},{\"originalName\":\"[ResourceSubscriptions].type\"},{\"originalName\":\"[ResourceSubscriptions].kind\"},{\"originalName\":\"[ResourceSubscriptions].location\"},{\"originalName\":\"[ResourceSubscriptions].resourceGroup\"},{\"originalName\":\"[ResourceSubscriptions].subscriptionId\"},{\"originalName\":\"[ResourceSubscriptions].sku\"},{\"originalName\":\"[ResourceSubscriptions].plan\"},{\"originalName\":\"[ResourceSubscriptions].identity\"},{\"originalName\":\"[ResourceSubscriptions].zones\"},{\"originalName\":\"[ResourceSubscriptions].tenantId\"},{\"originalName\":\"[ResourceSubscriptions].managedBy\"},{\"originalName\":\"[ResourceSubscriptions].properties\"},{\"originalName\":\"[ResourceSubscriptions].extendedLocation\"}]}",
                        "size": 4,
                        "title": "Subscription Details",
                        "showRefreshButton": true,
                        "queryType": 7,
                        "gridSettings": {
                          "labelSettings": [
                            {
                              "columnId": "id",
                              "label": "Name"
                            },
                            {
                              "columnId": "ResourceSubscriptionId",
                              "label": "Id"
                            }
                          ]
                        }
                      },
                      "customWidth": "0",
                      "conditionalVisibility": {
                        "parameterName": "TableName",
                        "comparison": "isEqualTo",
                        "value": "Subscriptions"
                      },
                      "name": "SubscriptionsView",
                      "styleSettings": {
                        "maxWidth": "50"
                      }
                    }
                  ]
                },
                "customWidth": "0",
                "conditionalVisibility": {
                  "parameterName": "TableName",
                  "comparison": "isEqualTo",
                  "value": "Subscriptions"
                },
                "name": "SubscriptionViewGroup",
                "styleSettings": {
                  "maxWidth": "50"
                }
              },
              {
                "type": 12,
                "content": {
                  "version": "NotebookGroup/1.0",
                  "groupType": "editable",
                  "items": [
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "resourcecontainers\r\n| project id, name, type, subscriptionId, location, tags\r\n| where \"'*'\" == \"{ResourceGroup_IS}\" or name in ({ResourceGroup_IS})\r\n| where type == \"microsoft.resources/subscriptions/resourcegroups\"\r\n\r\n",
                        "size": 0,
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources",
                        "crossComponentResources": [
                          "/subscriptions/5733bcb3-7fde-4caf-8629-41dc15e3b352",
                          "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b",
                          "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f",
                          "/subscriptions/fb7a7f00-5566-4e90-b64b-97f8aae9c294"
                        ],
                        "sortBy": []
                      },
                      "conditionalVisibility": {
                        "parameterName": "TableName",
                        "comparison": "isEqualTo",
                        "value": "nothing"
                      },
                      "name": "Resourcegroups"
                    },
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "DSTIMAccess_CL \r\n| project ResourceSubscriptionId = ResourceSubscriptionId_g, ResourceGroup, AggregationLastEventTime = AggregationLastEventTime_t, TimeGenerated = TimeDiscovered_t, RequesterUpn = RequesterUpn_s, RequesterAppId = RequesterAppId_s\r\n| where TimeGenerated {TimeRange_IS} or AggregationLastEventTime {TimeRange_IS}\r\n| where '{Subcriptions_IS:id}' == '*' or '{Subcriptions_IS:id}' has ResourceSubscriptionId\r\n| where \"'*'\" == \"{ResourceGroup_IS}\" or ResourceGroup in ({ResourceGroup_IS}) \r\n| where  \"'*'\" == \"{UserAccount_IS}\" or RequesterUpn in ({UserAccount_IS}) or RequesterAppId in ({UserAccount_IS})\r\n| distinct ResourceGroup",
                        "size": 0,
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      },
                      "conditionalVisibility": {
                        "parameterName": "TableName",
                        "comparison": "isEqualTo",
                        "value": "nothing"
                      },
                      "name": "DSTIMResourcegroups"
                    },
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"c7ec72da-8ab1-489f-a46b-d79d6489c082\",\"mergeType\":\"innerunique\",\"leftTable\":\"DSTIMResourcegroups\",\"rightTable\":\"Resourcegroups\",\"leftColumn\":\"ResourceGroup\",\"rightColumn\":\"name\"}],\"projectRename\":[{\"originalName\":\"[Resourcegroups].id\",\"mergedName\":\"Resource Group Name\",\"fromId\":\"c7ec72da-8ab1-489f-a46b-d79d6489c082\"},{\"originalName\":\"[Resourcegroups].subscriptionId\",\"mergedName\":\"subscriptionId\",\"fromId\":\"c7ec72da-8ab1-489f-a46b-d79d6489c082\"},{\"originalName\":\"[Resourcegroups].location\",\"mergedName\":\"location\",\"fromId\":\"c7ec72da-8ab1-489f-a46b-d79d6489c082\"},{\"originalName\":\"[Resourcegroups].tags\",\"mergedName\":\"tags\",\"fromId\":\"c7ec72da-8ab1-489f-a46b-d79d6489c082\"},{\"originalName\":\"[DSTIMResourcegroups].ResourceGroup\"},{\"originalName\":\"[Resourcegroups].name\"},{\"originalName\":\"[Resourcegroups].type\"},{\"originalName\":\"[Resourcegroups].tenantId\"},{\"originalName\":\"[Resourcegroups].kind\"},{\"originalName\":\"[Resourcegroups].resourceGroup\"},{\"originalName\":\"[Resourcegroups].managedBy\"},{\"originalName\":\"[Resourcegroups].sku\"},{\"originalName\":\"[Resourcegroups].plan\"},{\"originalName\":\"[Resourcegroups].properties\"},{\"originalName\":\"[Resourcegroups].identity\"},{\"originalName\":\"[Resourcegroups].zones\"},{\"originalName\":\"[Resourcegroups].extendedLocation\"}]}",
                        "size": 4,
                        "title": "Resource Group Details",
                        "showRefreshButton": true,
                        "queryType": 7,
                        "gridSettings": {
                          "formatters": [
                            {
                              "columnMatch": "subscriptionId",
                              "formatter": 15,
                              "formatOptions": {
                                "linkTarget": null,
                                "showIcon": true
                              }
                            }
                          ],
                          "labelSettings": [
                            {
                              "columnId": "subscriptionId",
                              "label": "Subscription Name"
                            },
                            {
                              "columnId": "location",
                              "label": "Location"
                            },
                            {
                              "columnId": "tags",
                              "label": "Tags"
                            }
                          ]
                        }
                      },
                      "customWidth": "0",
                      "conditionalVisibility": {
                        "parameterName": "TableName",
                        "comparison": "isEqualTo",
                        "value": "Resource Groups"
                      },
                      "name": "ResourceGroupView",
                      "styleSettings": {
                        "maxWidth": "50"
                      }
                    }
                  ],
                  "exportParameters": true
                },
                "customWidth": "0",
                "conditionalVisibility": {
                  "parameterName": "TableName",
                  "comparison": "isEqualTo",
                  "value": "Resource Groups"
                },
                "name": "ResourceGroupViewGroup",
                "styleSettings": {
                  "maxWidth": "50"
                }
              },
              {
                "type": 12,
                "content": {
                  "version": "NotebookGroup/1.0",
                  "groupType": "editable",
                  "items": [
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "Resources\r\n| project id, name, subscriptionId, resourceGroup, type, tags, location\r\n| where  '*' == '{Subcriptions_IS:id}' or '{Subcriptions_IS:id}' has subscriptionId\r\n| where \"'*'\" == \"{ResourceGroup_IS}\" or resourceGroup in~ ({ResourceGroup_IS})\r\n| where type =~ 'Microsoft.Storage/storageAccounts'\r\n",
                        "size": 0,
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources",
                        "crossComponentResources": [
                          "/subscriptions/5733bcb3-7fde-4caf-8629-41dc15e3b352",
                          "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b",
                          "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f",
                          "/subscriptions/fb7a7f00-5566-4e90-b64b-97f8aae9c294"
                        ],
                        "gridSettings": {
                          "filter": true,
                          "sortBy": [
                            {
                              "itemKey": "subscriptionId",
                              "sortOrder": 1
                            }
                          ]
                        },
                        "sortBy": [
                          {
                            "itemKey": "subscriptionId",
                            "sortOrder": 1
                          }
                        ]
                      },
                      "conditionalVisibility": {
                        "parameterName": "TableName",
                        "comparison": "isEqualTo",
                        "value": "nothing"
                      },
                      "name": "StorageAccounts"
                    },
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "DSTIMAccess_CL \r\n| project ResourceSubscriptionId = ResourceSubscriptionId_g, ResourceGroup, AggregationLastEventTime = AggregationLastEventTime_t, TimeGenerated = TimeDiscovered_t, RequesterUpn = RequesterUpn_s, RequesterAppId = RequesterAppId_s, StorageAccountName = StorageAccountName_s\r\n| where TimeGenerated {TimeRange_IS} or AggregationLastEventTime {TimeRange_IS}\r\n| where '{Subcriptions_IS:id}' == '*' or '{Subcriptions_IS:id}' has ResourceSubscriptionId\r\n| where \"'*'\" == \"{ResourceGroup_IS}\" or ResourceGroup in ({ResourceGroup_IS}) \r\n| where  \"'*'\" == \"{UserAccount_IS}\" or RequesterUpn in ({UserAccount_IS}) or RequesterAppId in ({UserAccount_IS})\r\n| distinct StorageAccountName",
                        "size": 0,
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      },
                      "conditionalVisibility": {
                        "parameterName": "TableName",
                        "comparison": "isEqualTo",
                        "value": "nothing"
                      },
                      "name": "DSTIMStorageAccounts"
                    },
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"131846c4-cbc1-4e64-a5db-b914d56ed094\",\"mergeType\":\"innerunique\",\"leftTable\":\"DSTIMStorageAccounts\",\"rightTable\":\"StorageAccounts\",\"leftColumn\":\"StorageAccountName\",\"rightColumn\":\"name\"}],\"projectRename\":[{\"originalName\":\"[StorageAccounts].id\",\"mergedName\":\"Name\",\"fromId\":\"131846c4-cbc1-4e64-a5db-b914d56ed094\"},{\"originalName\":\"[StorageAccounts].location\",\"mergedName\":\"Location\",\"fromId\":\"131846c4-cbc1-4e64-a5db-b914d56ed094\"},{\"originalName\":\"[StorageAccounts].tags\",\"mergedName\":\"Tags\",\"fromId\":\"131846c4-cbc1-4e64-a5db-b914d56ed094\"},{\"originalName\":\"[StorageAccounts].subscriptionId\",\"mergedName\":\"Subscription Name\",\"fromId\":\"131846c4-cbc1-4e64-a5db-b914d56ed094\"},{\"originalName\":\"[StorageAccounts].resourceGroup\",\"mergedName\":\"Resource Group\",\"fromId\":\"131846c4-cbc1-4e64-a5db-b914d56ed094\"},{\"originalName\":\"[StorageAccounts].extendedLocation\"},{\"originalName\":\"[StorageAccounts].zones\"},{\"originalName\":\"[StorageAccounts].identity\"},{\"originalName\":\"[StorageAccounts].properties\"},{\"originalName\":\"[StorageAccounts].plan\"},{\"originalName\":\"[StorageAccounts].sku\"},{\"originalName\":\"[StorageAccounts].managedBy\"},{\"originalName\":\"[StorageAccounts].kind\"},{\"originalName\":\"[StorageAccounts].tenantId\"},{\"originalName\":\"[StorageAccounts].type\"},{\"originalName\":\"[StorageAccounts].name\"},{\"originalName\":\"[DSTIMStorageAccounts].StorageAccountName\"}]}",
                        "size": 4,
                        "title": "Data Source Details",
                        "showRefreshButton": true,
                        "queryType": 7,
                        "gridSettings": {
                          "formatters": [
                            {
                              "columnMatch": "Subscription Name",
                              "formatter": 15,
                              "formatOptions": {
                                "linkTarget": null,
                                "showIcon": true
                              }
                            },
                            {
                              "columnMatch": "Resource Group",
                              "formatter": 14,
                              "formatOptions": {
                                "linkTarget": null,
                                "showIcon": true
                              }
                            },
                            {
                              "columnMatch": "subscriptionId",
                              "formatter": 15,
                              "formatOptions": {
                                "linkTarget": null,
                                "showIcon": true
                              }
                            }
                          ]
                        }
                      },
                      "customWidth": "0",
                      "conditionalVisibility": {
                        "parameterName": "TableName",
                        "comparison": "isEqualTo",
                        "value": "Sensitive data sources accessed"
                      },
                      "name": "StorageAccountsView",
                      "styleSettings": {
                        "maxWidth": "50"
                      }
                    }
                  ],
                  "exportParameters": true
                },
                "customWidth": "0",
                "conditionalVisibility": {
                  "parameterName": "TableName",
                  "comparison": "isEqualTo",
                  "value": "Sensitive data sources accessed"
                },
                "name": "StorageAccountViewGroup",
                "styleSettings": {
                  "maxWidth": "50"
                }
              },
              {
                "type": 12,
                "content": {
                  "version": "NotebookGroup/1.0",
                  "groupType": "editable",
                  "items": [
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "DSTIMAccess_CL \r\n| project ResourceSubscriptionId = ResourceSubscriptionId_g, ResourceGroup, AggregationLastEventTime = AggregationLastEventTime_t, TimeGenerated = TimeDiscovered_t, RequesterUpn = RequesterUpn_s, RequesterAppId = RequesterAppId_s, AuthenticationType = AuthenticationType_s\r\n| where TimeGenerated {TimeRange_IS} or AggregationLastEventTime {TimeRange_IS}\r\n| where '{Subcriptions_IS:id}' == '*' or '{Subcriptions_IS:id}' has ResourceSubscriptionId\r\n| where \"'*'\" == \"{ResourceGroup_IS}\" or ResourceGroup in ({ResourceGroup_IS}) \r\n| where  \"'*'\" == \"{UserAccount_IS}\" or RequesterUpn in ({UserAccount_IS})\r\n| where isnotempty(RequesterUpn)\r\n| join kind = leftouter (IdentityInfo) on $left.RequesterUpn == $right.MailAddress\r\n| project AccountDisplayName = iff(isempty(AccountDisplayName), RequesterUpn, AccountDisplayName), AccountID = RequesterUpn, AuthenticationType\r\n| distinct AccountID, AccountDisplayName, AuthenticationType\r\n| union (DSTIMAccess_CL \r\n| project ResourceSubscriptionId = ResourceSubscriptionId_g, ResourceGroup, AggregationLastEventTime = AggregationLastEventTime_t, TimeGenerated = TimeDiscovered_t, RequesterUpn = RequesterUpn_s, RequesterAppId = RequesterAppId_s, AuthenticationType = AuthenticationType_s\r\n| where TimeGenerated {TimeRange_IS} or AggregationLastEventTime {TimeRange_IS}\r\n| where '{Subcriptions_IS:id}' == '*' or '{Subcriptions_IS:id}' has ResourceSubscriptionId\r\n| where \"'*'\" == \"{ResourceGroup_IS}\" or ResourceGroup in ({ResourceGroup_IS}) \r\n| where  \"'*'\" == \"{UserAccount_IS}\" or RequesterAppId in ({UserAccount_IS})\r\n| where isnotempty(RequesterAppId)  | project AccountDisplayName = RequesterAppId, AccountID = RequesterAppId, AuthenticationType | distinct AccountID, AccountDisplayName, AuthenticationType)\r\n",
                        "size": 4,
                        "title": "User Account Details",
                        "showRefreshButton": true,
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces",
                        "crossComponentResources": [
                          "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                          "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/cybersecuritysoc"
                        ]
                      },
                      "customWidth": "0",
                      "conditionalVisibility": {
                        "parameterName": "TableName",
                        "comparison": "isEqualTo",
                        "value": "User accounts"
                      },
                      "name": "StorageAccountView",
                      "styleSettings": {
                        "maxWidth": "50"
                      }
                    }
                  ],
                  "exportParameters": true
                },
                "customWidth": "0",
                "conditionalVisibility": {
                  "parameterName": "TableName",
                  "comparison": "isEqualTo",
                  "value": "User accounts"
                },
                "name": "UserAccountViewGroup",
                "styleSettings": {
                  "maxWidth": "50"
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "let TIIP = DSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| project Classification, SensitivityLabelName, CallerIPAddress, RequesterUpn, Uri\r\n| where \"'*'\" == \"{Classification_IS}\" or Classification has_any({Classification_IS})\r\n| where \"'*'\" == \"{SensitivityLabel_IS}\" or SensitivityLabelName in ({SensitivityLabel_IS})\r\n| join kind=inner (ThreatIntelligenceIndicator | where TimeGenerated {TimeRange_IS} | project NetworkSourceIP, ThreatType, ConfidenceScore, DomainName, SourceSystem)  on $right.NetworkSourceIP == $left.CallerIPAddress\r\n| distinct NetworkSourceIP, ThreatType, ConfidenceScore, DomainName, SourceSystem;\r\n\r\nTIIP",
                  "size": 4,
                  "title": "Sensitive data access done by IP address with TI match",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                    "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/cybersecuritysoc"
                  ],
                  "gridSettings": {
                    "sortBy": [
                      {
                        "itemKey": "SourceSystem",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "sortBy": [
                    {
                      "itemKey": "SourceSystem",
                      "sortOrder": 1
                    }
                  ]
                },
                "customWidth": "0",
                "conditionalVisibilities": [
                  {
                    "parameterName": "TableName",
                    "comparison": "isEqualTo",
                    "value": "TI match"
                  },
                  {
                    "parameterName": "TabName",
                    "comparison": "isEqualTo",
                    "value": "IPAddress"
                  }
                ],
                "name": "TIIPExtendedInfo",
                "styleSettings": {
                  "maxWidth": "50"
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "DSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', '{ResourceGroup_IS:label}' , '{UserAccount_IS:label}')\r\n| where iff('{Classification_IS:id}' == '*', true, Classification has_any({Classification_IS}))\r\n| where iff('{SensitivityLabel_IS:id}' == '*', true, '{SensitivityLabel_IS:label}' has SensitivityLabelName)\r\n| where isnotempty(RequesterUpn)\r\n| join kind=inner (_GetWatchlist(\"VIPUsers\") | distinct SearchKey | extend watchList = \"VIP Users\" | union (_GetWatchlist(\"TerminatedEmployees\") | distinct SearchKey | extend watchList = \"Terminated Employees\" ) | union (_GetWatchlist(\"HighValueAssets\") | distinct SearchKey | extend watchList = \"High Value Assets\" ))\r\non $left.RequesterUpn == $right.SearchKey",
                  "size": 4,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "conditionalVisibility": {
                  "parameterName": "TabName",
                  "comparison": "isEqualTo",
                  "value": "watchlist"
                },
                "name": "GeneralWatchList"
              }
            ],
            "exportParameters": true
          },
          "name": "KPI Cards",
          "styleSettings": {
            "margin": "0px",
            "padding": "0px 30px"
          }
        },
        {
          "type": 1,
          "content": {
            "json": "----\r\n## Entities Insights\r\n"
          },
          "name": "break  - Insights",
          "styleSettings": {
            "margin": "0px 30px"
          }
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "items": [
              {
                "type": 12,
                "content": {
                  "version": "NotebookGroup/1.0",
                  "groupType": "editable",
                  "items": [
                    {
                      "type": 1,
                      "content": {
                        "json": "#### Insights based on investigation scope",
                        "style": "info"
                      },
                      "name": "text - 1"
                    },
                    {
                      "type": 12,
                      "content": {
                        "version": "NotebookGroup/1.0",
                        "groupType": "editable",
                        "items": [
                          {
                            "type": 11,
                            "content": {
                              "version": "LinkItem/1.0",
                              "style": "paragraph",
                              "links": [
                                {
                                  "id": "28f5ce79-5c16-4482-88b9-298e5377d293",
                                  "cellValue": "LinkName",
                                  "linkTarget": "parameter",
                                  "linkLabel": "{TotalAnomaliesEntitiesCount}",
                                  "subTarget": "Anomalies",
                                  "preText": "{TotalAnomalies} anomalies were found pertaining to ",
                                  "postText": "entities",
                                  "style": "link"
                                }
                              ]
                            },
                            "conditionalVisibility": {
                              "parameterName": "TabName",
                              "comparison": "isEqualTo",
                              "value": "Summary"
                            },
                            "name": "TotalAnomalies",
                            "styleSettings": {
                              "margin": "5px"
                            }
                          },
                          {
                            "type": 11,
                            "content": {
                              "version": "LinkItem/1.0",
                              "style": "paragraph",
                              "links": [
                                {
                                  "id": "18fc1e15-b469-470d-9144-284e622c9468",
                                  "cellValue": "LinkName",
                                  "linkTarget": "parameter",
                                  "linkLabel": "{AnomaliesUserEntitiesCount}",
                                  "subTarget": "Anomalies",
                                  "preText": "{UserAnomalies} anomalies were found pertaining to ",
                                  "postText": "entities",
                                  "style": "link"
                                }
                              ]
                            },
                            "conditionalVisibility": {
                              "parameterName": "TabName",
                              "comparison": "isEqualTo",
                              "value": "UserAccount"
                            },
                            "name": "UserAccountAnomalies",
                            "styleSettings": {
                              "margin": "5px"
                            }
                          },
                          {
                            "type": 11,
                            "content": {
                              "version": "LinkItem/1.0",
                              "style": "paragraph",
                              "links": [
                                {
                                  "id": "99ec4f7a-0b38-4abd-8b62-e88b28ed9b00",
                                  "cellValue": "LinkName",
                                  "linkTarget": "parameter",
                                  "linkLabel": "{AnomaliesIPEntitiesCount}",
                                  "subTarget": "Anomalies",
                                  "preText": "{IPAnomalies} anomalies were found pertaining to ",
                                  "postText": "entities",
                                  "style": "link"
                                }
                              ]
                            },
                            "conditionalVisibility": {
                              "parameterName": "TabName",
                              "comparison": "isEqualTo",
                              "value": "IPAddress"
                            },
                            "name": "IPAnomalies",
                            "styleSettings": {
                              "margin": "5px"
                            }
                          },
                          {
                            "type": 11,
                            "content": {
                              "version": "LinkItem/1.0",
                              "style": "paragraph",
                              "links": [
                                {
                                  "id": "55522733-e216-493b-b05b-0394257bb829",
                                  "cellValue": "LinkName",
                                  "linkTarget": "parameter",
                                  "linkLabel": "{TIIPCount}",
                                  "subTarget": "TIIP",
                                  "preText": "{assetCounts} sensitive files were accessed from ",
                                  "postText": "IP addreses with TI match.",
                                  "style": "link"
                                }
                              ]
                            },
                            "conditionalVisibility": {
                              "parameterName": "TabName",
                              "comparison": "isNotEqualTo",
                              "value": "UserAccount"
                            },
                            "name": "TIInsights",
                            "styleSettings": {
                              "margin": "5px"
                            }
                          },
                          {
                            "type": 11,
                            "content": {
                              "version": "LinkItem/1.0",
                              "style": "paragraph",
                              "links": [
                                {
                                  "id": "cf73b9da-13bd-4597-905e-6f089cb2aa76",
                                  "cellValue": "LinkName",
                                  "linkTarget": "parameter",
                                  "linkLabel": "{WatchListCount}",
                                  "subTarget": "WatchList",
                                  "preText": "",
                                  "postText": " entities are part of Built-in Watchlist(S).",
                                  "style": "link"
                                }
                              ]
                            },
                            "conditionalVisibility": {
                              "parameterName": "TabName",
                              "comparison": "isNotEqualTo",
                              "value": "IPAddress"
                            },
                            "name": "WatchListLink",
                            "styleSettings": {
                              "margin": "5px"
                            }
                          }
                        ],
                        "exportParameters": true
                      },
                      "customWidth": "0",
                      "name": "InsightsLinks",
                      "styleSettings": {
                        "padding": "0px 10px",
                        "maxWidth": "100"
                      }
                    }
                  ],
                  "exportParameters": true
                },
                "customWidth": "0",
                "name": "InsightsView",
                "styleSettings": {
                  "padding": "0px",
                  "maxWidth": "400px"
                }
              },
              {
                "type": 9,
                "content": {
                  "version": "KqlParameterItem/1.0",
                  "parameters": [
                    {
                      "id": "b546eb26-f70c-488e-ba96-b087789732e6",
                      "version": "KqlParameterItem/1.0",
                      "name": "WatchListVisible",
                      "type": 1,
                      "isHiddenWhenLocked": true,
                      "criteriaData": [
                        {
                          "criteriaContext": {
                            "leftOperand": "LinkName",
                            "operator": "==",
                            "rightValType": "static",
                            "rightVal": "WatchList",
                            "resultValType": "static",
                            "resultVal": "true"
                          }
                        },
                        {
                          "criteriaContext": {
                            "operator": "Default",
                            "resultValType": "static",
                            "resultVal": "false"
                          }
                        }
                      ],
                      "timeContext": {
                        "durationMs": 86400000
                      }
                    }
                  ],
                  "style": "pills",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "customWidth": "0",
                "conditionalVisibility": {
                  "parameterName": "TabName",
                  "comparison": "isEqualTo",
                  "value": "notSet"
                },
                "name": "parameters - 4",
                "styleSettings": {
                  "maxWidth": "0"
                }
              },
              {
                "type": 12,
                "content": {
                  "version": "NotebookGroup/1.0",
                  "groupType": "editable",
                  "items": [
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "//Query purpose - get the list of entities that are part of one or more of this watchlists: \"VIPUsers\", \"TerminatedEmployees\", \"HighValueAssets\"\r\nlet watchList = DSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| project Classification, SensitivityLabelName, CallerIPAddress, RequesterUpn, Uri\r\n| where \"'*'\" == \"{Classification_IS}\" or Classification has_any({Classification_IS})\r\n| where \"'*'\" == \"{SensitivityLabel_IS}\" or SensitivityLabelName in ({SensitivityLabel_IS})\r\n| where isnotempty(RequesterUpn)\r\n| join kind=inner (_GetWatchlist(\"VIPUsers\") | distinct SearchKey | extend watchList = \"VIP Users\" | union (_GetWatchlist(\"TerminatedEmployees\") | distinct SearchKey | extend watchList = \"Terminated Employees\" ) | union (_GetWatchlist(\"HighValueAssets\") | distinct SearchKey | extend watchList = \"High Value Assets\" ))\r\non $left.RequesterUpn == $right.SearchKey\r\n| join kind=leftouter (ThreatIntelligenceIndicator | where TimeGenerated {TimeRange_IS} | project NetworkSourceIP, ThreatType)  on $right.NetworkSourceIP == $left.CallerIPAddress\r\n| join kind=leftouter (Anomalies | where TimeGenerated {TimeRange_IS}| project entities = Entities, RuleId | project AadUserId = tostring(entities[0].AadUserId), RuleId | where isnotempty(AadUserId)) on $left.RequesterUpn == $right.AadUserId \r\n| join kind=leftouter (SecurityAlert | where TimeGenerated {TimeRange_IS}| mv-expand entities = todynamic(Entities) | project AlertUser = tostring(entities.['DisplayName']), SystemAlertId, IsIncident) on $left.RequesterUpn == $right.AlertUser\r\n| distinct RequesterUpn, CallerIPAddress, Uri, Classification, watchList, ThreatType, RuleId, AlertUser, SystemAlertId, IsIncident\r\n| mv-expand classification = todynamic(Classification)\r\n| where isnotempty( classification.['Name'])\r\n| extend clasType = tostring(classification.['Name']), clasCount = toint(classification.['UniqueCount'])\r\n| summarize Instances = sum(clasCount), class_list = make_set(clasType), watchListNames = make_set(watchList), ThreatType = make_set(ThreatType), Anomalies = countif(isnotempty(RuleId)), Alerts = countif(isnotempty(SystemAlertId) and IsIncident == false), Incidents = countif(isnotempty(SystemAlertId) and IsIncident == true) by RequesterUpn, CallerIPAddress\r\n| project Entity = RequesterUpn, EntityType = \"User Account\", CallerIPAddress, Instances, Classifications = trim(@'[\\[ \\]]', iff(isempty(class_list), 'N/A', class_list)), Watchlist =  trim(@'[\\[ \\]]', iff(watchListNames == '[\"\"]', 'N/A', watchListNames)), ThreatType = trim(@'[\\[ \\]]', iff(ThreatType =='[\"\"]', 'N/A', ThreatType)), Anomalies, Alerts, Incidents; \r\n\r\nwatchList;",
                        "size": 1,
                        "title": "Watchlists Entities Details",
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces",
                        "gridSettings": {
                          "formatters": [
                            {
                              "columnMatch": "Classifications",
                              "formatter": 7,
                              "formatOptions": {
                                "linkTarget": "CellDetails",
                                "linkIsContextBlade": true
                              }
                            }
                          ]
                        }
                      },
                      "conditionalVisibility": {
                        "parameterName": "WatchListVisible",
                        "comparison": "isEqualTo",
                        "value": "true"
                      },
                      "name": "WatchListQuery"
                    },
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "//Query purpose - get the list of entities that are part Anomalies table\r\nlet Anomalies = DSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| project Classification, SensitivityLabelName, CallerIPAddress, RequesterUpn, Uri\r\n| where \"'*'\" == \"{Classification_IS}\" or Classification has_any({Classification_IS})\r\n| where \"'*'\" == \"{SensitivityLabel_IS}\" or SensitivityLabelName in ({SensitivityLabel_IS})\r\n| join kind=inner (Anomalies | where TimeGenerated {TimeRange_IS} | project Entities, RuleId | project AadUserId = tostring(Entities[0].AadUserId), RuleId | where isnotempty(AadUserId)) on $left.RequesterUpn == $right.AadUserId\r\n| join kind=leftouter (_GetWatchlist(\"VIPUsers\") | distinct SearchKey | extend watchList = \"VIP Users\" | union (_GetWatchlist(\"TerminatedEmployees\") | distinct SearchKey | extend watchList = \"Terminated Employees\" ) | union (_GetWatchlist(\"HighValueAssets\") | distinct SearchKey | extend watchList = \"High Value Assets\" ))\r\non $left.RequesterUpn == $right.SearchKey\r\n| join kind=leftouter (ThreatIntelligenceIndicator | where TimeGenerated {TimeRange_IS} | project NetworkSourceIP, ThreatType)  on $right.NetworkSourceIP == $left.CallerIPAddress\r\n| join kind=leftouter (SecurityAlert | where TimeGenerated {TimeRange_IS}| mv-expand entities = todynamic(Entities) | project AlertUser = tostring(entities.['DisplayName']), SystemAlertId, IsIncident) on $left.RequesterUpn == $right.AlertUser\r\n| distinct RequesterUpn, CallerIPAddress, Uri, Classification, watchList, ThreatType, RuleId, AlertUser, SystemAlertId, IsIncident\r\n| mv-expand classification = todynamic(Classification)\r\n| where isnotempty( classification.['Name'])\r\n| extend clasType = tostring(classification.['Name']), clasCount = toint(classification.['UniqueCount'])\r\n| summarize Instances = sum(clasCount), class_list = make_set(clasType), watchListNames = make_set(watchList), ThreatType = make_set(ThreatType), Anomalies = count(RuleId), Alerts = countif(isnotempty(SystemAlertId) and IsIncident == false), Incidents = countif(isnotempty(SystemAlertId) and IsIncident == true) by RequesterUpn, CallerIPAddress\r\n| project Entity = RequesterUpn, EntityType = \"User Account\", CallerIPAddress, Instances, Classifications = trim(@'[\\[ \\]]', iff(isempty(class_list), 'N/A', class_list)), Watchlist =  trim(@'[\\[ \\]]', iff(watchListNames == '[\"\"]', 'N/A', watchListNames)), ThreatType = trim(@'[\\[ \\]]', iff(ThreatType =='[\"\"]', 'N/A', ThreatType)), Anomalies, Alerts, Incidents; \r\n\r\nAnomalies;",
                        "size": 1,
                        "title": "Anomalies Entities Details",
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      },
                      "conditionalVisibility": {
                        "parameterName": "LinkName",
                        "comparison": "isEqualTo",
                        "value": "Anomalies"
                      },
                      "name": "AnomaliesQuery"
                    },
                    {
                      "type": 3,
                      "content": {
                        "version": "KqlItem/1.0",
                        "query": "//Query purpose - get the list of IP entities that are part of ThreatInteligence table\r\nlet TIIP = DSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| project Classification, SensitivityLabelName, CallerIPAddress, RequesterUpn, Uri\r\n| where \"'*'\" == \"{Classification_IS}\" or Classification has_any({Classification_IS})\r\n| where \"'*'\" == \"{SensitivityLabel_IS}\" or SensitivityLabelName in ({SensitivityLabel_IS})\r\n| join kind=inner (ThreatIntelligenceIndicator | where TimeGenerated {TimeRange_IS} | project NetworkSourceIP, ThreatType)  on $right.NetworkSourceIP == $left.CallerIPAddress\r\n| join kind=leftouter (_GetWatchlist(\"VIPUsers\") | distinct SearchKey | extend watchList = \"VIP Users\" | union (_GetWatchlist(\"TerminatedEmployees\") | distinct SearchKey | extend watchList = \"Terminated Employees\" ) | union (_GetWatchlist(\"HighValueAssets\") | distinct SearchKey | extend watchList = \"High Value Assets\" ))\r\non $left.RequesterUpn == $right.SearchKey\r\n| join kind=leftouter (Anomalies | where TimeGenerated {TimeRange_IS}| project Entities, RuleId | project Address = tostring(Entities[1].Address), RuleId | where isnotempty(Address)) on $left.CallerIPAddress == $right.Address\r\n| join kind=leftouter (SecurityAlert | where TimeGenerated {TimeRange_IS}| project IpAddress = tostring(todynamic(ExtendedProperties).['IpAddress']), SystemAlertId, IsIncident) on $left.CallerIPAddress == $right.IpAddress\r\n| distinct RequesterUpn, CallerIPAddress, Uri, Classification, watchList, ThreatType, RuleId, SystemAlertId, IsIncident\r\n| mv-expand classification = todynamic(Classification)\r\n| extend clasType = tostring(classification.['Name']), clasCount = toint(classification.['UniqueCount'])\r\n| summarize Instances = sum(clasCount), class_list = make_set(clasType), watchListNames = make_set(watchList), ThreatType = make_set(ThreatType), Anomalies = countif(isnotempty(RuleId)), Alerts = countif(isnotempty(SystemAlertId) and IsIncident == false), Incidents = countif(isnotempty(SystemAlertId) and IsIncident == true) by RequesterUpn, CallerIPAddress\r\n| project Entity = CallerIPAddress, EntityType = \"IP Address\", RequesterUpn, Instances, Classifications = trim(@'[\\[ \\]]', iff(isempty(class_list), 'N/A', class_list)), Watchlist =  trim(@'[\\[ \\]]', iff(watchListNames == '[\"\"]', 'N/A', watchListNames)), ThreatType = trim(@'[\\[ \\]]', iff(ThreatType =='[\"\"]', 'N/A', ThreatType)), Anomalies, Alerts, Incidents; \r\n\r\nTIIP;",
                        "size": 1,
                        "title": "Threat Inteligence Entities Details",
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces",
                        "crossComponentResources": [
                          "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics",
                          "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/SOC/providers/Microsoft.OperationalInsights/workspaces/CyberSecuritySoc"
                        ],
                        "gridSettings": {
                          "formatters": [
                            {
                              "columnMatch": "Classifications",
                              "formatter": 7,
                              "formatOptions": {
                                "linkTarget": "CellDetails",
                                "linkIsContextBlade": true
                              }
                            },
                            {
                              "columnMatch": "class_list",
                              "formatter": 1
                            }
                          ]
                        }
                      },
                      "conditionalVisibility": {
                        "parameterName": "LinkName",
                        "comparison": "isEqualTo",
                        "value": "TIIP"
                      },
                      "name": "TIIPQuery"
                    },
                    {
                      "type": 1,
                      "content": {
                        "json": "To get insights details view, select a link in the Entities insights section shown on the left.",
                        "style": "info"
                      },
                      "conditionalVisibility": {
                        "parameterName": "LinkName",
                        "comparison": "isEqualTo",
                        "value": "default"
                      },
                      "name": "noInfoText"
                    }
                  ],
                  "exportParameters": true
                },
                "customWidth": "50",
                "name": "EntitiesDetailsGroup",
                "styleSettings": {
                  "margin": "0px 100px",
                  "maxWidth": "50"
                }
              }
            ],
            "exportParameters": true
          },
          "customWidth": "100",
          "name": "Insights",
          "styleSettings": {
            "margin": "0px 30px",
            "maxWidth": "100"
          }
        },
        {
          "type": 1,
          "content": {
            "json": "----\r\n## Classification details"
          },
          "conditionalVisibility": {
            "parameterName": "TabName",
            "comparison": "isEqualTo",
            "value": "Summary"
          },
          "name": "break",
          "styleSettings": {
            "margin": "0px 30px"
          }
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "items": [
              {
                "type": 9,
                "content": {
                  "version": "KqlParameterItem/1.0",
                  "parameters": [
                    {
                      "id": "c0307511-30f8-4dcc-b128-bcb247141db6",
                      "version": "KqlParameterItem/1.0",
                      "name": "Classifications_f",
                      "label": "Classifications",
                      "type": 2,
                      "multiSelect": true,
                      "quote": "'",
                      "delimiter": ",",
                      "query": "GetClassificationList({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))",
                      "typeSettings": {
                        "limitSelectTo": 5,
                        "additionalResourceOptions": [
                          "value::all"
                        ],
                        "selectAllValue": "*",
                        "showDefault": false
                      },
                      "defaultValue": "value::all",
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    }
                  ],
                  "style": "above",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "name": "GraphParameter"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "//Query purpose - present a timechart of access to classification types over time, with 1d bin, per asset(Uri/path)\r\n//Classification types can be filtered by \"Classification_f\" parameter.\r\n\r\nDSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| where iff('{Classifications_f:id}' == '*', true, tostring(Classification) has_any({Classifications_f}))\r\n| mv-expand classification = todynamic(Classification)\r\n| where isnotempty(classification.['Name'])\r\n| where iff('{Classifications_f:id}' == '*', true, tostring(classification.['Name']) has_any({Classifications_f}))\r\n| summarize  TotalAssets=dcount(Uri) by tostring(classification.['Name']), bin(TimeGenerated, 1d)\r\n",
                  "size": 1,
                  "showAnnotations": true,
                  "title": "Access over time",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "timechart",
                  "graphSettings": {
                    "type": 0,
                    "topContent": {
                      "columnMatch": "Classification",
                      "formatter": 1
                    },
                    "centerContent": {
                      "columnMatch": "count_",
                      "formatter": 1,
                      "numberFormat": {
                        "unit": 17,
                        "options": {
                          "maximumSignificantDigits": 3,
                          "maximumFractionDigits": 2
                        }
                      }
                    }
                  }
                },
                "customWidth": "50",
                "conditionalVisibility": {
                  "parameterName": "TabName",
                  "comparison": "isEqualTo",
                  "value": "Summary"
                },
                "name": "AccessOverTime",
                "styleSettings": {
                  "maxWidth": "50"
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "//query purpose - Get the access details per classification type.\r\n//TotalAccess - total accesses to this classification type, including the aggregation count.\r\n//DataSource - total unique storage accounts that were accessed per classification type.\r\n//TotalAssets - total unique assets(Uri/path) that were accessed per classification type.\r\n//TotalInstances - total classification instnces per type that were accesed. this is calculated by unique count * aggregation count per access.\r\n\r\nDSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| extend classification = parse_json(Classification)\r\n| mv-expand classification = todynamic(Classification)\r\n| where isnotempty( classification.['Name'])\r\n| summarize\r\n    TotalAccess=sum(toint(AggregationCount)),\r\n    DataSource=dcount(StorageAccountName),\r\n    TotalAssets=dcount(Uri),\r\n    TotalInstances = sum(toint(classification.['UniqueCount'])*toint(AggregationCount))\r\n        by tostring(classification.['Name'])\r\n| project Classification=classification_Name, DataSource, TotalAssets=min_of(TotalAccess, TotalAssets), TotalAccess, TotalInstances\r\n| order by TotalAccess desc",
                  "size": 1,
                  "title": "Access by classification type",
                  "exportMultipleValues": true,
                  "exportedParameters": [
                    {
                      "fieldName": "Classification",
                      "parameterName": "ClassificationFilter",
                      "parameterType": 1
                    }
                  ],
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "gridSettings": {
                    "filter": true,
                    "sortBy": [
                      {
                        "itemKey": "Classification",
                        "sortOrder": 1
                      }
                    ],
                    "labelSettings": [
                      {
                        "columnId": "DataSource",
                        "label": "Data Source"
                      },
                      {
                        "columnId": "TotalAssets",
                        "label": "Assets"
                      },
                      {
                        "columnId": "TotalAccess",
                        "label": "Accesses"
                      },
                      {
                        "columnId": "TotalInstances",
                        "label": "Instances"
                      }
                    ]
                  },
                  "sortBy": [
                    {
                      "itemKey": "Classification",
                      "sortOrder": 1
                    }
                  ]
                },
                "customWidth": "0",
                "conditionalVisibility": {
                  "parameterName": "TabName",
                  "comparison": "isEqualTo",
                  "value": "Summary"
                },
                "name": "AccessPerClassificationView",
                "styleSettings": {
                  "margin": "0px 50px",
                  "maxWidth": "50"
                }
              }
            ],
            "exportParameters": true
          },
          "conditionalVisibility": {
            "parameterName": "TabName",
            "comparison": "isEqualTo",
            "value": "Summary"
          },
          "name": "Graphs",
          "styleSettings": {
            "margin": "0px 30px 0px 30px"
          }
        },
        {
          "type": 1,
          "content": {
            "json": "----\r\n## Access Details"
          },
          "name": "break",
          "styleSettings": {
            "margin": "0px 30px"
          }
        },
        {
          "type": 9,
          "content": {
            "version": "KqlParameterItem/1.0",
            "parameters": [
              {
                "id": "8be86c8b-b566-44c2-8cc7-d7c3b501a060",
                "version": "KqlParameterItem/1.0",
                "name": "FilterParam",
                "type": 1,
                "isGlobal": true,
                "isHiddenWhenLocked": true,
                "criteriaData": [
                  {
                    "criteriaContext": {
                      "leftOperand": "Classification_IS",
                      "operator": "!=",
                      "rightValType": "static",
                      "rightVal": "*",
                      "resultValType": "static",
                      "resultVal": "{Classification_IS:label}"
                    }
                  },
                  {
                    "criteriaContext": {
                      "leftOperand": "Classifications_f",
                      "operator": "!=",
                      "rightValType": "static",
                      "rightVal": "*",
                      "resultValType": "static",
                      "resultVal": "{Classifications_f:label}"
                    }
                  },
                  {
                    "criteriaContext": {
                      "leftOperand": "ClassificationFilter",
                      "operator": "isNotNull",
                      "rightValType": "static",
                      "rightVal": "*",
                      "resultValType": "static",
                      "resultVal": "{ClassificationFilter:label}"
                    }
                  },
                  {
                    "criteriaContext": {
                      "operator": "Default",
                      "resultValType": "static",
                      "resultVal": "All"
                    }
                  }
                ],
                "timeContext": {
                  "durationMs": 86400000
                }
              }
            ],
            "style": "pills",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          "conditionalVisibility": {
            "parameterName": "TabName",
            "comparison": "isEqualTo",
            "value": "Summary"
          },
          "name": "FilterParameter"
        },
        {
          "type": 1,
          "content": {
            "json": "Filtered by -\r\nSubscriptions: {Subcriptions_IS:label}, Resource groups: {ResourceGroup_IS:label}, User accounts: {UserAccount_IS:label}, Insights: {LinkName}, IP range {IPAddress_IS} {IPRange_IS}, Asset path {AssetPath_IS} {Path_IS}, Classification type: {FilterParam:label}",
            "style": "info"
          },
          "conditionalVisibility": {
            "parameterName": "TabName",
            "comparison": "isEqualTo",
            "value": "Summary"
          },
          "name": "FilteredByText",
          "styleSettings": {
            "margin": "0px 30px"
          }
        },
        {
          "type": 1,
          "content": {
            "json": "Filtered by -\r\nSubscriptions: {Subcriptions_IS:label}, Resource groups: {ResourceGroup_IS:label}, User accounts: {UserAccount_IS:label}, Insights: {LinkName}, IP range {IPAddress_IS} {IPRange_IS}, Asset path {AssetPath_IS} {Path_IS}",
            "style": "info"
          },
          "conditionalVisibility": {
            "parameterName": "TabName",
            "comparison": "isEqualTo",
            "value": "UserAccount"
          },
          "name": "FilteredByText - UserTab",
          "styleSettings": {
            "margin": "0px 30px"
          }
        },
        {
          "type": 1,
          "content": {
            "json": "Filtered by -\r\nSubscriptions: {Subcriptions_IS:label}, Resource groups: {ResourceGroup_IS:label}, User accounts: {UserAccount_IS:label}, Insights: {LinkName}, IP range {IPAddress_IS} {IPRange_IS}, Asset path {AssetPath_IS} {Path_IS}",
            "style": "info"
          },
          "conditionalVisibility": {
            "parameterName": "TabName",
            "comparison": "isEqualTo",
            "value": "IPAddress"
          },
          "name": "FilteredByText - ipTab",
          "styleSettings": {
            "margin": "0px 30px"
          }
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "let clasFilter = dynamic([{ClassificationFilter}]);\r\nlet linkName = '{LinkName}';\r\n\r\nDSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| where iff(linkName =~ 'Watchlist', RequesterUpn has_any(parse_json(split('{WatchListEntities}', ','))), true)\r\n| where iff(linkName =~ 'TIIP', CallerIPAddress has_any(parse_json(split('{TIIPEntities}', ','))), true)\r\n| where iff(linkName =~ 'Anomalies', CallerIPAddress has_any(parse_json(split('{AnomaliesIPEntities}', ','))) or RequesterUpn has_any(parse_json(split('{AnomaliesUserEntities}', ','))), true)\r\n| where '*' in ({Classification_IS}) or Classification has_any({Classification_IS})\r\n| where '*' in ({Classifications_f}) or Classification has_any({Classifications_f})\r\n| where iff(array_length(clasFilter) == 0 , true, Classification has_any(clasFilter))\r\n| where '*' in ({SensitivityLabel_IS}) or SensitivityLabelName in ({SensitivityLabel_IS})\r\n| where iff(isnotempty('{IPRange_IS}') and '{IPAddress_IS}' == \"contains\", ipv4_is_in_range(CallerIPAddress, \"{IPRange_IS:value}\"), iff(isnotempty('{IPRange_IS}'), ipv4_is_in_range(CallerIPAddress, \"{IPRange_IS:value}\") == false, true))\r\n| where iff(isnotempty('{Path_IS}') and '{AssetPath_IS}' == \"contains\", Uri has '{Path_IS}',iff(isnotempty('{Path_IS}'), Uri !has '{Path_IS}', true))",
            "size": 0,
            "showAnalytics": true,
            "showExportToExcel": true,
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "gridSettings": {
              "formatters": [
                {
                  "columnMatch": "$gen_group",
                  "formatter": 13,
                  "formatOptions": {
                    "linkTarget": null,
                    "showIcon": true
                  }
                },
                {
                  "columnMatch": "Uri",
                  "formatter": 7,
                  "formatOptions": {
                    "linkTarget": "GenericDetails",
                    "linkIsContextBlade": true
                  }
                }
              ],
              "rowLimit": 1000,
              "filter": true,
              "hierarchySettings": {
                "treeType": 1,
                "groupBy": [
                  "ResourceSubscriptionId",
                  "ResourceGroup",
                  "StorageAccountName"
                ],
                "expandTopLevel": true
              },
              "labelSettings": [
                {
                  "columnId": "TimeGenerated",
                  "label": "Time Generated"
                },
                {
                  "columnId": "OperationName",
                  "label": "Operation Name"
                },
                {
                  "columnId": "AuthenticationType",
                  "label": "Authentication Type"
                },
                {
                  "columnId": "RequesterAppId",
                  "label": "Requester App Id"
                },
                {
                  "columnId": "RequesterUpn",
                  "label": "Requester Upn"
                },
                {
                  "columnId": "StatusCode",
                  "label": "Status Code"
                },
                {
                  "columnId": "CallerIPAddress",
                  "label": "Caller IP Address"
                },
                {
                  "columnId": "UserAgentHeader",
                  "label": "User Agent Header"
                },
                {
                  "columnId": "AggregationCount",
                  "label": "Aggregation Count"
                },
                {
                  "columnId": "AggregationLastEventTime",
                  "label": "Aggregation Last Event Time"
                },
                {
                  "columnId": "ResponseBodySize",
                  "label": "Response Body Size"
                },
                {
                  "columnId": "ResourceSubscriptionId",
                  "label": "Resource Subscription Id"
                },
                {
                  "columnId": "ResourceGroup",
                  "label": "Resource Group"
                },
                {
                  "columnId": "StorageAccountName",
                  "label": "Storage Account Name"
                },
                {
                  "columnId": "SensitivityLabelName",
                  "label": "Sensitivity Label Name"
                },
                {
                  "columnId": "AssetType",
                  "label": "Asset Type"
                }
              ]
            }
          },
          "conditionalVisibility": {
            "parameterName": "TabName",
            "comparison": "isEqualTo",
            "value": "Summary"
          },
          "name": "Access Logs",
          "styleSettings": {
            "margin": "0px 40px"
          }
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "DSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| where iff('{LinkName}' =~ 'Watchlist', RequesterUpn has_any(parse_json(split('{WatchListEntities}', ','))), true)\r\n| where iff('{LinkName}' =~ 'TIIP', CallerIPAddress has_any(parse_json(split('{TIIPEntities}', ','))), true)\r\n| where iff('{LinkName}' =~ 'Anomalies', CallerIPAddress has_any(parse_json(split('{AnomaliesIPEntities}', ','))) or RequesterUpn has_any(parse_json(split('{AnomaliesUserEntities}', ','))), true)\r\n| where '*' in ({Classification_IS}) or Classification has_any({Classification_IS})\r\n| where '*' in ({Classifications_f}) or Classification has_any({Classifications_f})\r\n| where '*' in ({SensitivityLabel_IS}) or SensitivityLabelName in ({SensitivityLabel_IS})\r\n| where iff(isnotempty('{IPRange_IS}') and '{IPAddress_IS}' == \"contains\", ipv4_is_in_range(CallerIPAddress, \"{IPRange_IS:value}\"), iff(isnotempty('{IPRange_IS}'), ipv4_is_in_range(CallerIPAddress, \"{IPRange_IS:value}\") == false, true))\r\n| where iff(isnotempty('{Path_IS}') and '{AssetPath_IS}' == \"contains\", Uri has '{Path_IS}',iff(isnotempty('{Path_IS}'), Uri !has '{Path_IS}', true))",
            "size": 0,
            "showAnalytics": true,
            "showExportToExcel": true,
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "gridSettings": {
              "formatters": [
                {
                  "columnMatch": "$gen_group",
                  "formatter": 13,
                  "formatOptions": {
                    "linkTarget": null,
                    "showIcon": true
                  }
                },
                {
                  "columnMatch": "Uri",
                  "formatter": 7,
                  "formatOptions": {
                    "linkTarget": "GenericDetails",
                    "linkIsContextBlade": true
                  }
                }
              ],
              "rowLimit": 1000,
              "filter": true,
              "hierarchySettings": {
                "treeType": 1,
                "groupBy": [
                  "RequesterUpn",
                  "ResourceGroup",
                  "StorageAccountName"
                ],
                "expandTopLevel": true
              },
              "labelSettings": [
                {
                  "columnId": "TimeGenerated",
                  "label": "Time Generated"
                },
                {
                  "columnId": "OperationName",
                  "label": "Operation Name"
                },
                {
                  "columnId": "AuthenticationType",
                  "label": "Authentication Type"
                },
                {
                  "columnId": "RequesterAppId",
                  "label": "Requester App Id"
                },
                {
                  "columnId": "RequesterUpn",
                  "label": "Requester Upn"
                },
                {
                  "columnId": "StatusCode",
                  "label": "Status Code"
                },
                {
                  "columnId": "CallerIPAddress",
                  "label": "Caller IP Address"
                },
                {
                  "columnId": "UserAgentHeader",
                  "label": "User Agent Header"
                },
                {
                  "columnId": "AggregationCount",
                  "label": "Aggregation Count"
                },
                {
                  "columnId": "AggregationLastEventTime",
                  "label": "Aggregation Last Event Time"
                },
                {
                  "columnId": "ResponseBodySize",
                  "label": "Response Body Size"
                },
                {
                  "columnId": "ResourceSubscriptionId",
                  "label": "Resource Subscription Id"
                },
                {
                  "columnId": "ResourceGroup",
                  "label": "Resource Group"
                },
                {
                  "columnId": "StorageAccountName",
                  "label": "Storage Account Name"
                },
                {
                  "columnId": "SensitivityLabelName",
                  "label": "Sensitivity Label Name"
                },
                {
                  "columnId": "AssetType",
                  "label": "Asset Type"
                }
              ]
            }
          },
          "conditionalVisibility": {
            "parameterName": "TabName",
            "comparison": "isEqualTo",
            "value": "UserAccount"
          },
          "name": "Access Logs - Users",
          "styleSettings": {
            "margin": "0px 40px"
          }
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "DSTIMCorrelatedLogs({TimeRange_IS:start}, {TimeRange_IS:end}, '{Subcriptions_IS:id}', dynamic([{ResourceGroup_IS}]) , dynamic([{UserAccount_IS}]))\r\n| where iff('{LinkName}' =~ 'Watchlist', RequesterUpn has_any(parse_json(split('{WatchListEntities}', ','))), true)\r\n| where iff('{LinkName}' =~ 'TIIP', CallerIPAddress has_any(parse_json(split('{TIIPEntities}', ','))), true)\r\n| where iff('{LinkName}' =~ 'Anomalies', CallerIPAddress has_any(parse_json(split('{AnomaliesIPEntities}', ','))) or RequesterUpn has_any(parse_json(split('{AnomaliesUserEntities}', ','))), true)\r\n| where '*' in ({Classification_IS}) or Classification has_any({Classification_IS})\r\n| where '*' in ({Classifications_f}) or Classification has_any({Classifications_f})\r\n| where '*' in ({SensitivityLabel_IS}) or SensitivityLabelName in ({SensitivityLabel_IS})\r\n| where iff(isnotempty('{IPRange_IS}') and '{IPAddress_IS}' == \"contains\", ipv4_is_in_range(CallerIPAddress, \"{IPRange_IS:value}\"), iff(isnotempty('{IPRange_IS}'), ipv4_is_in_range(CallerIPAddress, \"{IPRange_IS:value}\") == false, true))\r\n| where iff(isnotempty('{Path_IS}') and '{AssetPath_IS}' == \"contains\", Uri has '{Path_IS}',iff(isnotempty('{Path_IS}'), Uri !has '{Path_IS}', true))",
            "size": 0,
            "showAnalytics": true,
            "showExportToExcel": true,
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "gridSettings": {
              "formatters": [
                {
                  "columnMatch": "$gen_group",
                  "formatter": 13,
                  "formatOptions": {
                    "linkTarget": null,
                    "showIcon": true
                  }
                },
                {
                  "columnMatch": "Uri",
                  "formatter": 7,
                  "formatOptions": {
                    "linkTarget": "GenericDetails",
                    "linkIsContextBlade": true
                  }
                }
              ],
              "rowLimit": 1000,
              "filter": true,
              "hierarchySettings": {
                "treeType": 1,
                "groupBy": [
                  "CallerIPAddress",
                  "ResourceGroup",
                  "StorageAccountName"
                ],
                "expandTopLevel": true
              },
              "labelSettings": [
                {
                  "columnId": "TimeGenerated",
                  "label": "Time Generated"
                },
                {
                  "columnId": "OperationName",
                  "label": "Operation Name"
                },
                {
                  "columnId": "AuthenticationType",
                  "label": "Authentication Type"
                },
                {
                  "columnId": "RequesterAppId",
                  "label": "Requester App Id"
                },
                {
                  "columnId": "RequesterUpn",
                  "label": "Requester Upn"
                },
                {
                  "columnId": "StatusCode",
                  "label": "Status Code"
                },
                {
                  "columnId": "CallerIPAddress",
                  "label": "Caller IP Address"
                },
                {
                  "columnId": "UserAgentHeader",
                  "label": "User Agent Header"
                },
                {
                  "columnId": "AggregationCount",
                  "label": "Aggregation Count"
                },
                {
                  "columnId": "AggregationLastEventTime",
                  "label": "Aggregation Last Event Time"
                },
                {
                  "columnId": "ResponseBodySize",
                  "label": "Response Body Size"
                },
                {
                  "columnId": "ResourceSubscriptionId",
                  "label": "Resource Subscription Id"
                },
                {
                  "columnId": "ResourceGroup",
                  "label": "Resource Group"
                },
                {
                  "columnId": "StorageAccountName",
                  "label": "Storage Account Name"
                },
                {
                  "columnId": "SensitivityLabelName",
                  "label": "Sensitivity Label Name"
                },
                {
                  "columnId": "AssetType",
                  "label": "Asset Type"
                }
              ]
            }
          },
          "conditionalVisibility": {
            "parameterName": "TabName",
            "comparison": "isEqualTo",
            "value": "IPAddress"
          },
          "name": "Access Logs - IP",
          "styleSettings": {
            "margin": "0px 40px"
          }
        }
      ],
      "isLocked": false,
      "fallbackResourceIds": [
        "/subscriptions/bbbabe37-eda3-48ea-98ed-f0a70c31a45b/resourcegroups/breachmanagement-dev/providers/microsoft.operationalinsights/workspaces/yogevtestloganalytics"
      ],
      "styleSettings": {
        "paddingStyle": "none",
        "spacingStyle": "none"
      },
      "fromTemplateId": "sentinel-UserWorkbook"
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2021-03-08",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "[string(variables('workbookContent'))]",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "fromTemplateId": "sentinel-DSTIMWorkbook",
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}