{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for Cisco Umbrella"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "formattedTimeNow": {
      "type": "string",
      "defaultValue": "[utcNow('g')]",
      "metadata": {
        "description": "Appended to workbook displayNames to make them unique"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Cisco Umbrella",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "uiConfigId1": "CiscoUmbrellaDataConnector",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "Cisco_UmbrellaConnector",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'-',variables('_dataConnectorContentId1'))]",
    "dataConnectorVersion1": "2.0.0",
    "solutionId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
    "_solutionId": "[variables('solutionId')]",
    "Cisco_Umbrella_Parser": "Cisco_Umbrella_Parser",
    "_Cisco_Umbrella_Parser": "[variables('Cisco_Umbrella_Parser')]",
    "parserVersion1": "2.0.0",
    "parserContentId1": "Cisco_Umbrella_Parser",
    "_parserContentId1": "[variables('parserContentId1')]",
    "parserName1": "Cisco_Umbrella_Parser",
    "_parserName1": "[concat(parameters('workspace'),'/',variables('parserName1'))]",
    "parserId1": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
    "_parserId1": "[variables('parserId1')]",
    "parserTemplateSpecName1": "[concat(parameters('workspace'),'-',variables('_parserContentId1'))]",
    "CiscoUmbrellaAnomalousFQDNsforDomain_HuntingQueries": "CiscoUmbrellaAnomalousFQDNsforDomain_HuntingQueries",
    "_CiscoUmbrellaAnomalousFQDNsforDomain_HuntingQueries": "[variables('CiscoUmbrellaAnomalousFQDNsforDomain_HuntingQueries')]",
    "huntingQueryVersion1": "2.0.0",
    "huntingQueryContentId1": "Cisco_Umbrella_Hunting_Query_1",
    "_huntingQueryContentId1": "[variables('huntingQueryContentId1')]",
    "huntingQueryResourceId1": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQueryContentId1'))]",
    "huntingQueryTemplateSpecName1": "[concat(parameters('workspace'),'-',variables('_huntingQueryContentId1'))]",
    "CiscoUmbrellaBlockedUserAgents_HuntingQueries": "CiscoUmbrellaBlockedUserAgents_HuntingQueries",
    "_CiscoUmbrellaBlockedUserAgents_HuntingQueries": "[variables('CiscoUmbrellaBlockedUserAgents_HuntingQueries')]",
    "huntingQueryVersion2": "2.0.0",
    "huntingQueryContentId2": "Cisco_Umbrella_Hunting_Query_2",
    "_huntingQueryContentId2": "[variables('huntingQueryContentId2')]",
    "huntingQueryResourceId2": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQueryContentId2'))]",
    "huntingQueryTemplateSpecName2": "[concat(parameters('workspace'),'-',variables('_huntingQueryContentId2'))]",
    "CiscoUmbrellaDNSErrors_HuntingQueries": "CiscoUmbrellaDNSErrors_HuntingQueries",
    "_CiscoUmbrellaDNSErrors_HuntingQueries": "[variables('CiscoUmbrellaDNSErrors_HuntingQueries')]",
    "huntingQueryVersion3": "2.0.0",
    "huntingQueryContentId3": "Cisco_Umbrella_Hunting_Query_3",
    "_huntingQueryContentId3": "[variables('huntingQueryContentId3')]",
    "huntingQueryResourceId3": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQueryContentId3'))]",
    "huntingQueryTemplateSpecName3": "[concat(parameters('workspace'),'-',variables('_huntingQueryContentId3'))]",
    "CiscoUmbrellaDNSRequestsUunreliableCategory_HuntingQueries": "CiscoUmbrellaDNSRequestsUunreliableCategory_HuntingQueries",
    "_CiscoUmbrellaDNSRequestsUunreliableCategory_HuntingQueries": "[variables('CiscoUmbrellaDNSRequestsUunreliableCategory_HuntingQueries')]",
    "huntingQueryVersion4": "2.0.0",
    "huntingQueryContentId4": "Cisco_Umbrella_Hunting_Query_4",
    "_huntingQueryContentId4": "[variables('huntingQueryContentId4')]",
    "huntingQueryResourceId4": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQueryContentId4'))]",
    "huntingQueryTemplateSpecName4": "[concat(parameters('workspace'),'-',variables('_huntingQueryContentId4'))]",
    "CiscoUmbrellaHighCountsOfTheSameBytesInSize_HuntingQueries": "CiscoUmbrellaHighCountsOfTheSameBytesInSize_HuntingQueries",
    "_CiscoUmbrellaHighCountsOfTheSameBytesInSize_HuntingQueries": "[variables('CiscoUmbrellaHighCountsOfTheSameBytesInSize_HuntingQueries')]",
    "huntingQueryVersion5": "2.0.0",
    "huntingQueryContentId5": "Cisco_Umbrella_Hunting_Query_5",
    "_huntingQueryContentId5": "[variables('huntingQueryContentId5')]",
    "huntingQueryResourceId5": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQueryContentId5'))]",
    "huntingQueryTemplateSpecName5": "[concat(parameters('workspace'),'-',variables('_huntingQueryContentId5'))]",
    "CiscoUmbrellaHighValuesOfUploadedData_HuntingQueries": "CiscoUmbrellaHighValuesOfUploadedData_HuntingQueries",
    "_CiscoUmbrellaHighValuesOfUploadedData_HuntingQueries": "[variables('CiscoUmbrellaHighValuesOfUploadedData_HuntingQueries')]",
    "huntingQueryVersion6": "2.0.0",
    "huntingQueryContentId6": "Cisco_Umbrella_Hunting_Query_6",
    "_huntingQueryContentId6": "[variables('huntingQueryContentId6')]",
    "huntingQueryResourceId6": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQueryContentId6'))]",
    "huntingQueryTemplateSpecName6": "[concat(parameters('workspace'),'-',variables('_huntingQueryContentId6'))]",
    "CiscoUmbrellaPossibleConnectionC2_HuntingQueries": "CiscoUmbrellaPossibleConnectionC2_HuntingQueries",
    "_CiscoUmbrellaPossibleConnectionC2_HuntingQueries": "[variables('CiscoUmbrellaPossibleConnectionC2_HuntingQueries')]",
    "huntingQueryVersion7": "2.0.0",
    "huntingQueryContentId7": "Cisco_Umbrella_Hunting_Query_7",
    "_huntingQueryContentId7": "[variables('huntingQueryContentId7')]",
    "huntingQueryResourceId7": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQueryContentId7'))]",
    "huntingQueryTemplateSpecName7": "[concat(parameters('workspace'),'-',variables('_huntingQueryContentId7'))]",
    "CiscoUmbrellaPossibleDataExfiltration_HuntingQueries": "CiscoUmbrellaPossibleDataExfiltration_HuntingQueries",
    "_CiscoUmbrellaPossibleDataExfiltration_HuntingQueries": "[variables('CiscoUmbrellaPossibleDataExfiltration_HuntingQueries')]",
    "huntingQueryVersion8": "2.0.0",
    "huntingQueryContentId8": "Cisco_Umbrella_Hunting_Query_8",
    "_huntingQueryContentId8": "[variables('huntingQueryContentId8')]",
    "huntingQueryResourceId8": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQueryContentId8'))]",
    "huntingQueryTemplateSpecName8": "[concat(parameters('workspace'),'-',variables('_huntingQueryContentId8'))]",
    "CiscoUmbrellaProxyAllowedUnreliableCategory_HuntingQueries": "CiscoUmbrellaProxyAllowedUnreliableCategory_HuntingQueries",
    "_CiscoUmbrellaProxyAllowedUnreliableCategory_HuntingQueries": "[variables('CiscoUmbrellaProxyAllowedUnreliableCategory_HuntingQueries')]",
    "huntingQueryVersion9": "2.0.0",
    "huntingQueryContentId9": "Cisco_Umbrella_Hunting_Query_9",
    "_huntingQueryContentId9": "[variables('huntingQueryContentId9')]",
    "huntingQueryResourceId9": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQueryContentId9'))]",
    "huntingQueryTemplateSpecName9": "[concat(parameters('workspace'),'-',variables('_huntingQueryContentId9'))]",
    "CiscoUmbrellaRequestsUncategorizedURI_HuntingQueries": "CiscoUmbrellaRequestsUncategorizedURI_HuntingQueries",
    "_CiscoUmbrellaRequestsUncategorizedURI_HuntingQueries": "[variables('CiscoUmbrellaRequestsUncategorizedURI_HuntingQueries')]",
    "huntingQueryVersion10": "2.0.0",
    "huntingQueryContentId10": "Cisco_Umbrella_Hunting_Query_10",
    "_huntingQueryContentId10": "[variables('huntingQueryContentId10')]",
    "huntingQueryResourceId10": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQueryContentId10'))]",
    "huntingQueryTemplateSpecName10": "[concat(parameters('workspace'),'-',variables('_huntingQueryContentId10'))]",
    "CiscoUmbrellaConnectionNon-CorporatePrivateNetwork_AnalyticalRules": "CiscoUmbrellaConnectionNon-CorporatePrivateNetwork_AnalyticalRules",
    "_CiscoUmbrellaConnectionNon-CorporatePrivateNetwork_AnalyticalRules": "[variables('CiscoUmbrellaConnectionNon-CorporatePrivateNetwork_AnalyticalRules')]",
    "analyticalRuleConnectorId1": "CiscoUmbrellaDataConnector",
    "analyticRuleVersion1": "2.0.0",
    "analyticRuleContentId1": "Cisco_Umbrella_Analytic_Rule_1",
    "_analyticRuleContentId1": "[variables('AnalyticRuleContentId1')]",
    "analyticRuleResourceId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRuleContentId1'))]",
    "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'-',variables('_analyticRuleContentId1'))]",
    "CiscoUmbrellaConnectionToUnpopularWebsiteDetected_AnalyticalRules": "CiscoUmbrellaConnectionToUnpopularWebsiteDetected_AnalyticalRules",
    "_CiscoUmbrellaConnectionToUnpopularWebsiteDetected_AnalyticalRules": "[variables('CiscoUmbrellaConnectionToUnpopularWebsiteDetected_AnalyticalRules')]",
    "analyticalRuleConnectorId2": "CiscoUmbrellaDataConnector",
    "analyticRuleVersion2": "2.0.0",
    "analyticRuleContentId2": "Cisco_Umbrella_Analytic_Rule_2",
    "_analyticRuleContentId2": "[variables('AnalyticRuleContentId2')]",
    "analyticRuleResourceId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRuleContentId2'))]",
    "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'-',variables('_analyticRuleContentId2'))]",
    "CiscoUmbrellaCryptoMinerUserAgentDetected_AnalyticalRules": "CiscoUmbrellaCryptoMinerUserAgentDetected_AnalyticalRules",
    "_CiscoUmbrellaCryptoMinerUserAgentDetected_AnalyticalRules": "[variables('CiscoUmbrellaCryptoMinerUserAgentDetected_AnalyticalRules')]",
    "analyticalRuleConnectorId3": "CiscoUmbrellaDataConnector",
    "analyticRuleVersion3": "2.0.0",
    "analyticRuleContentId3": "Cisco_Umbrella_Analytic_Rule_3",
    "_analyticRuleContentId3": "[variables('AnalyticRuleContentId3')]",
    "analyticRuleResourceId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRuleContentId3'))]",
    "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'-',variables('_analyticRuleContentId3'))]",
    "CiscoUmbrellaEmptyUserAgentDetected_AnalyticalRules": "CiscoUmbrellaEmptyUserAgentDetected_AnalyticalRules",
    "_CiscoUmbrellaEmptyUserAgentDetected_AnalyticalRules": "[variables('CiscoUmbrellaEmptyUserAgentDetected_AnalyticalRules')]",
    "analyticalRuleConnectorId4": "CiscoUmbrellaDataConnector",
    "analyticRuleVersion4": "2.0.0",
    "analyticRuleContentId4": "Cisco_Umbrella_Analytic_Rule_4",
    "_analyticRuleContentId4": "[variables('AnalyticRuleContentId4')]",
    "analyticRuleResourceId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRuleContentId4'))]",
    "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'-',variables('_analyticRuleContentId4'))]",
    "CiscoUmbrellaHackToolUserAgentDetected_AnalyticalRules": "CiscoUmbrellaHackToolUserAgentDetected_AnalyticalRules",
    "_CiscoUmbrellaHackToolUserAgentDetected_AnalyticalRules": "[variables('CiscoUmbrellaHackToolUserAgentDetected_AnalyticalRules')]",
    "analyticalRuleConnectorId5": "CiscoUmbrellaDataConnector",
    "analyticRuleVersion5": "2.0.0",
    "analyticRuleContentId5": "Cisco_Umbrella_Analytic_Rule_5",
    "_analyticRuleContentId5": "[variables('AnalyticRuleContentId5')]",
    "analyticRuleResourceId5": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRuleContentId5'))]",
    "analyticRuleTemplateSpecName5": "[concat(parameters('workspace'),'-',variables('_analyticRuleContentId5'))]",
    "CiscoUmbrellaPowershellUserAgentDetected_AnalyticalRules": "CiscoUmbrellaPowershellUserAgentDetected_AnalyticalRules",
    "_CiscoUmbrellaPowershellUserAgentDetected_AnalyticalRules": "[variables('CiscoUmbrellaPowershellUserAgentDetected_AnalyticalRules')]",
    "analyticalRuleConnectorId6": "CiscoUmbrellaDataConnector",
    "analyticRuleVersion6": "2.0.0",
    "analyticRuleContentId6": "Cisco_Umbrella_Analytic_Rule_6",
    "_analyticRuleContentId6": "[variables('AnalyticRuleContentId6')]",
    "analyticRuleResourceId6": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRuleContentId6'))]",
    "analyticRuleTemplateSpecName6": "[concat(parameters('workspace'),'-',variables('_analyticRuleContentId6'))]",
    "CiscoUmbrellaRareUserAgentDetected_AnalyticalRules": "CiscoUmbrellaRareUserAgentDetected_AnalyticalRules",
    "_CiscoUmbrellaRareUserAgentDetected_AnalyticalRules": "[variables('CiscoUmbrellaRareUserAgentDetected_AnalyticalRules')]",
    "analyticalRuleConnectorId7": "CiscoUmbrellaDataConnector",
    "analyticRuleVersion7": "2.0.0",
    "analyticRuleContentId7": "Cisco_Umbrella_Analytic_Rule_7",
    "_analyticRuleContentId7": "[variables('AnalyticRuleContentId7')]",
    "analyticRuleResourceId7": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRuleContentId7'))]",
    "analyticRuleTemplateSpecName7": "[concat(parameters('workspace'),'-',variables('_analyticRuleContentId7'))]",
    "CiscoUmbrellaRequestAllowedHarmfulMaliciousURICategory_AnalyticalRules": "CiscoUmbrellaRequestAllowedHarmfulMaliciousURICategory_AnalyticalRules",
    "_CiscoUmbrellaRequestAllowedHarmfulMaliciousURICategory_AnalyticalRules": "[variables('CiscoUmbrellaRequestAllowedHarmfulMaliciousURICategory_AnalyticalRules')]",
    "analyticalRuleConnectorId8": "CiscoUmbrellaDataConnector",
    "analyticRuleVersion8": "2.0.0",
    "analyticRuleContentId8": "Cisco_Umbrella_Analytic_Rule_8",
    "_analyticRuleContentId8": "[variables('AnalyticRuleContentId8')]",
    "analyticRuleResourceId8": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRuleContentId8'))]",
    "analyticRuleTemplateSpecName8": "[concat(parameters('workspace'),'-',variables('_analyticRuleContentId8'))]",
    "CiscoUmbrellaRequestBlocklistedFileType_AnalyticalRules": "CiscoUmbrellaRequestBlocklistedFileType_AnalyticalRules",
    "_CiscoUmbrellaRequestBlocklistedFileType_AnalyticalRules": "[variables('CiscoUmbrellaRequestBlocklistedFileType_AnalyticalRules')]",
    "analyticalRuleConnectorId9": "CiscoUmbrellaDataConnector",
    "analyticRuleVersion9": "2.0.0",
    "analyticRuleContentId9": "Cisco_Umbrella_Analytic_Rule_9",
    "_analyticRuleContentId9": "[variables('AnalyticRuleContentId9')]",
    "analyticRuleResourceId9": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRuleContentId9'))]",
    "analyticRuleTemplateSpecName9": "[concat(parameters('workspace'),'-',variables('_analyticRuleContentId9'))]",
    "CiscoUmbrellaURIContainsIPAddress_AnalyticalRules": "CiscoUmbrellaURIContainsIPAddress_AnalyticalRules",
    "_CiscoUmbrellaURIContainsIPAddress_AnalyticalRules": "[variables('CiscoUmbrellaURIContainsIPAddress_AnalyticalRules')]",
    "analyticalRuleConnectorId10": "CiscoUmbrellaDataConnector",
    "analyticRuleVersion10": "2.0.0",
    "analyticRuleContentId10": "Cisco_Umbrella_Analytic_Rule_10",
    "_analyticRuleContentId10": "[variables('AnalyticRuleContentId10')]",
    "analyticRuleResourceId10": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRuleContentId10'))]",
    "analyticRuleTemplateSpecName10": "[concat(parameters('workspace'),'-',variables('_analyticRuleContentId10'))]",
    "CiscoUmbrella_workbook": "CiscoUmbrella_workbook",
    "_CiscoUmbrella_workbook": "[variables('CiscoUmbrella_workbook')]",
    "workbookVersion1": "2.0.0",
    "workbookContentId1": "Cisco_Umbrella_Workbook_1",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workbookResourceId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workspaceResourceId1": "[resourceId('Microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'-',variables('_workbookContentId1'))]",
    "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "properties": {
        "description": "Cisco Umbrella data connector with template",
        "displayName": "Cisco Umbrella template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('dataConnectorTemplateSpecName1'),'/',variables('dataConnectorVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('dataConnectorTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "Cisco Umbrella data connector with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "Cisco Umbrella",
                  "publisher": "Cisco",
                  "descriptionMarkdown": "The Cisco Umbrella data connector provides the capability to ingest [Cisco Umbrella](https://docs.umbrella.com/) events stored in Amazon S3 into Azure Sentinel using the Amazon S3 REST API. Refer to [Cisco Umbrella log management documentation](https://docs.umbrella.com/deployment-umbrella/docs/log-management) for more information.",
                  "additionalRequirementBanner": "These queries and workbooks are dependent on a parser based on Kusto to work as expected. Follow the steps to use this Kusto functions alias **Cisco_Umbrella** in queries and workbooks. [Follow steps to get this Kusto functions>](https://aka.ms/sentinel-ciscoumbrella-function) ",
                  "graphQueries": [
                    {
                      "metricName": "Cisco Umbrella DNS Logs",
                      "legend": "Cisco_Umbrella_dns_CL",
                      "baseQuery": "Cisco_Umbrella_dns_CL"
                    },
                    {
                      "metricName": "Cisco Umbrella Proxy Logs",
                      "legend": "Cisco_Umbrella_proxy_CL",
                      "baseQuery": "Cisco_Umbrella_proxy_CL"
                    },
                    {
                      "metricName": "Cisco Umbrella IP Logs",
                      "legend": "Cisco_Umbrella_ip_CL",
                      "baseQuery": "Cisco_Umbrella_ip_CL"
                    },
                    {
                      "metricName": "Cisco Umbrella Cloud Firewall Logs",
                      "legend": "Cisco_Umbrella_cloudfirewall_CL",
                      "baseQuery": "Cisco_Umbrella_cloudfirewall_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "All Cisco Umbrella Logs",
                      "query": "Cisco_Umbrella\n| sort by TimeGenerated desc"
                    },
                    {
                      "description": "Cisco Umbrella DNS Logs",
                      "query": "Cisco_Umbrella\n | where EventType == 'dnslogs'\n| sort by TimeGenerated desc"
                    },
                    {
                      "description": "Cisco Umbrella Proxy Logs",
                      "query": "Cisco_Umbrella\n | where EventType == 'proxylogs'\n| sort by TimeGenerated desc"
                    },
                    {
                      "description": "Cisco Umbrella IP Logs",
                      "query": "Cisco_Umbrella\n | where EventType == 'iplogs'\n| sort by TimeGenerated desc"
                    },
                    {
                      "description": "Cisco Umbrella Cloud Firewall Logs",
                      "query": "Cisco_Umbrella\n | where EventType == 'cloudfirewalllogs'\n| sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "Cisco_Umbrella_dns_CL",
                      "lastDataReceivedQuery": "Cisco_Umbrella_dns_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "Cisco_Umbrella_proxy_CL",
                      "lastDataReceivedQuery": "Cisco_Umbrella_proxy_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "Cisco_Umbrella_ip_CL",
                      "lastDataReceivedQuery": "Cisco_Umbrella_ip_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "Cisco_Umbrella_cloudfirewall_CL",
                      "lastDataReceivedQuery": "Cisco_Umbrella_cloudfirewall_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "Cisco_Umbrella_dns_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)",
                        "Cisco_Umbrella_proxy_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)",
                        "Cisco_Umbrella_ip_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)",
                        "Cisco_Umbrella_cloudfirewall_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": true
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions on the workspace are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft.Web/sites permissions",
                        "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
                      },
                      {
                        "name": "Amazon S3 REST API Credentials/permissions",
                        "description": "**AWS Access Key Id**, **AWS Secret Access Key**, **AWS S3 Bucket Name** are required for Amazon S3 REST API."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": ">**NOTE:** This connector uses Azure Functions to connect to the Amazon S3 REST API to pull logs into Azure Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
                    },
                    {
                      "description": ">**NOTE:** This connector has been updated to support [cisco umbrella version 5 and version 6.](https://docs.umbrella.com/deployment-umbrella/docs/log-formats-and-versioning)"
                    },
                    {
                      "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
                    },
                    {
                      "description": ">**NOTE:** This connector uses a parser based on a Kusto Function to normalize fields. [Follow these steps](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Parsers/CiscoUmbrella/Cisco_Umbrella) to create the Kusto function alias **Cisco_Umbrella**."
                    },
                    {
                      "description": "**STEP 1 - Configuration of the Cisco Umbrella logs collection**\n\n[See documentation](https://docs.umbrella.com/deployment-umbrella/docs/log-management#section-logging-to-amazon-s-3) and follow the instructions for set up logging and obtain credentials."
                    },
                    {
                      "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the Cisco Umbrella data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following), as well as the Amazon S3 REST API Authorization credentials, readily available.",
                      "instructions": [
                        {
                          "parameters": {
                            "fillWith": [
                              "WorkspaceId"
                            ],
                            "label": "Workspace ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "fillWith": [
                              "PrimaryKey"
                            ],
                            "label": "Primary Key"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    },
                    {
                      "description": "Use this method for automated deployment of the Cisco Umbrella data connector using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinelciscoumbrellaazuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n3. Enter the **Workspace ID**, **Workspace Key**, **S3Bucket**, **AWSAccessKeyId**, **AWSSecretAccessKey**\n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**.\n5. Click **Purchase** to deploy.",
                      "title": "Option 1 - Azure Resource Manager (ARM) Template"
                    },
                    {
                      "description": "Use the following step-by-step instructions to deploy the Cisco Umbrella data connector manually with Azure Functions (Deployment via Visual Studio Code).",
                      "title": "Option 2 - Manual Deployment of Azure Functions"
                    },
                    {
                      "description": "**1. Deploy a Function App**\n\n> **NOTE:** You will need to [prepare VS code](https://docs.microsoft.com/azure/azure-functions/create-first-function-vs-code-python) for Azure function development.\n\n1. Download the [Azure Function App](https://aka.ms/sentinel-CiscoUmbrellaConn-functionapp) file. Extract archive to your local development computer.\n2. Start VS Code. Choose File in the main menu and select Open Folder.\n3. Select the top level folder from extracted files.\n4. Choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose the **Deploy to function app** button.\nIf you aren't already signed in, choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose **Sign in to Azure**\nIf you're already signed in, go to the next step.\n5. Provide the following information at the prompts:\n\n\ta. **Select folder:** Choose a folder from your workspace or browse to one that contains your function app.\n\n\tb. **Select Subscription:** Choose the subscription to use.\n\n\tc. Select **Create new Function App in Azure** (Don't choose the Advanced option)\n\n\td. **Enter a globally unique name for the function app:** Type a name that is valid in a URL path. The name you type is validated to make sure that it's unique in Azure Functions. (e.g. UmbrellaXYZ).\n\n\te. **Select a runtime:** Choose Python 3.8.\n\n\tf. Select a location for new resources. For better performance and lower costs choose the same [region](https://azure.microsoft.com/regions/) where Azure Sentinel is located.\n\n6. Deployment will begin. A notification is displayed after your function app is created and the deployment package is applied.\n7. Go to Azure Portal for the Function App configuration."
                    },
                    {
                      "description": "**2. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select **+ New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive): \n\t\tWorkspaceID\n\t\tWorkspaceKey\n\t\tS3Bucket\n\t\tAWSAccessKeyId\n\t\tAWSSecretAccessKey\n\t\tlogAnalyticsUri (optional)\n> - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`.\n3. Once all application settings have been entered, click **Save**."
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "Cisco Umbrella",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "support@microsoft.com"
        },
        "support": {
          "tier": "Microsoft",
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "link": "https://support.microsoft.com/"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Cisco Umbrella",
          "publisher": "Cisco",
          "descriptionMarkdown": "The Cisco Umbrella data connector provides the capability to ingest [Cisco Umbrella](https://docs.umbrella.com/) events stored in Amazon S3 into Azure Sentinel using the Amazon S3 REST API. Refer to [Cisco Umbrella log management documentation](https://docs.umbrella.com/deployment-umbrella/docs/log-management) for more information.",
          "graphQueries": [
            {
              "metricName": "Cisco Umbrella DNS Logs",
              "legend": "Cisco_Umbrella_dns_CL",
              "baseQuery": "Cisco_Umbrella_dns_CL"
            },
            {
              "metricName": "Cisco Umbrella Proxy Logs",
              "legend": "Cisco_Umbrella_proxy_CL",
              "baseQuery": "Cisco_Umbrella_proxy_CL"
            },
            {
              "metricName": "Cisco Umbrella IP Logs",
              "legend": "Cisco_Umbrella_ip_CL",
              "baseQuery": "Cisco_Umbrella_ip_CL"
            },
            {
              "metricName": "Cisco Umbrella Cloud Firewall Logs",
              "legend": "Cisco_Umbrella_cloudfirewall_CL",
              "baseQuery": "Cisco_Umbrella_cloudfirewall_CL"
            }
          ],
          "dataTypes": [
            {
              "name": "Cisco_Umbrella_dns_CL",
              "lastDataReceivedQuery": "Cisco_Umbrella_dns_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "Cisco_Umbrella_proxy_CL",
              "lastDataReceivedQuery": "Cisco_Umbrella_proxy_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "Cisco_Umbrella_ip_CL",
              "lastDataReceivedQuery": "Cisco_Umbrella_ip_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "Cisco_Umbrella_cloudfirewall_CL",
              "lastDataReceivedQuery": "Cisco_Umbrella_cloudfirewall_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "Cisco_Umbrella_dns_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)",
                "Cisco_Umbrella_proxy_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)",
                "Cisco_Umbrella_ip_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)",
                "Cisco_Umbrella_cloudfirewall_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "All Cisco Umbrella Logs",
              "query": "Cisco_Umbrella\n| sort by TimeGenerated desc"
            },
            {
              "description": "Cisco Umbrella DNS Logs",
              "query": "Cisco_Umbrella\n | where EventType == 'dnslogs'\n| sort by TimeGenerated desc"
            },
            {
              "description": "Cisco Umbrella Proxy Logs",
              "query": "Cisco_Umbrella\n | where EventType == 'proxylogs'\n| sort by TimeGenerated desc"
            },
            {
              "description": "Cisco Umbrella IP Logs",
              "query": "Cisco_Umbrella\n | where EventType == 'iplogs'\n| sort by TimeGenerated desc"
            },
            {
              "description": "Cisco Umbrella Cloud Firewall Logs",
              "query": "Cisco_Umbrella\n | where EventType == 'cloudfirewalllogs'\n| sort by TimeGenerated desc"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "Amazon S3 REST API Credentials/permissions",
                "description": "**AWS Access Key Id**, **AWS Secret Access Key**, **AWS S3 Bucket Name** are required for Amazon S3 REST API."
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This connector uses Azure Functions to connect to the Amazon S3 REST API to pull logs into Azure Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
            },
            {
              "description": ">**NOTE:** This connector has been updated to support [cisco umbrella version 5 and version 6.](https://docs.umbrella.com/deployment-umbrella/docs/log-formats-and-versioning)"
            },
            {
              "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
            },
            {
              "description": ">**NOTE:** This connector uses a parser based on a Kusto Function to normalize fields. [Follow these steps](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Parsers/CiscoUmbrella/Cisco_Umbrella) to create the Kusto function alias **Cisco_Umbrella**."
            },
            {
              "description": "**STEP 1 - Configuration of the Cisco Umbrella logs collection**\n\n[See documentation](https://docs.umbrella.com/deployment-umbrella/docs/log-management#section-logging-to-amazon-s-3) and follow the instructions for set up logging and obtain credentials."
            },
            {
              "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the Cisco Umbrella data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following), as well as the Amazon S3 REST API Authorization credentials, readily available.",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Workspace ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "fillWith": [
                      "PrimaryKey"
                    ],
                    "label": "Primary Key"
                  },
                  "type": "CopyableLabel"
                }
              ]
            },
            {
              "description": "Use this method for automated deployment of the Cisco Umbrella data connector using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinelciscoumbrellaazuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n3. Enter the **Workspace ID**, **Workspace Key**, **S3Bucket**, **AWSAccessKeyId**, **AWSSecretAccessKey**\n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**.\n5. Click **Purchase** to deploy.",
              "title": "Option 1 - Azure Resource Manager (ARM) Template"
            },
            {
              "description": "Use the following step-by-step instructions to deploy the Cisco Umbrella data connector manually with Azure Functions (Deployment via Visual Studio Code).",
              "title": "Option 2 - Manual Deployment of Azure Functions"
            },
            {
              "description": "**1. Deploy a Function App**\n\n> **NOTE:** You will need to [prepare VS code](https://docs.microsoft.com/azure/azure-functions/create-first-function-vs-code-python) for Azure function development.\n\n1. Download the [Azure Function App](https://aka.ms/sentinel-CiscoUmbrellaConn-functionapp) file. Extract archive to your local development computer.\n2. Start VS Code. Choose File in the main menu and select Open Folder.\n3. Select the top level folder from extracted files.\n4. Choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose the **Deploy to function app** button.\nIf you aren't already signed in, choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose **Sign in to Azure**\nIf you're already signed in, go to the next step.\n5. Provide the following information at the prompts:\n\n\ta. **Select folder:** Choose a folder from your workspace or browse to one that contains your function app.\n\n\tb. **Select Subscription:** Choose the subscription to use.\n\n\tc. Select **Create new Function App in Azure** (Don't choose the Advanced option)\n\n\td. **Enter a globally unique name for the function app:** Type a name that is valid in a URL path. The name you type is validated to make sure that it's unique in Azure Functions. (e.g. UmbrellaXYZ).\n\n\te. **Select a runtime:** Choose Python 3.8.\n\n\tf. Select a location for new resources. For better performance and lower costs choose the same [region](https://azure.microsoft.com/regions/) where Azure Sentinel is located.\n\n6. Deployment will begin. A notification is displayed after your function app is created and the deployment package is applied.\n7. Go to Azure Portal for the Function App configuration."
            },
            {
              "description": "**2. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select **+ New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive): \n\t\tWorkspaceID\n\t\tWorkspaceKey\n\t\tS3Bucket\n\t\tAWSAccessKeyId\n\t\tAWSSecretAccessKey\n\t\tlogAnalyticsUri (optional)\n> - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`.\n3. Once all application settings have been entered, click **Save**."
            }
          ],
          "id": "[variables('_uiConfigId1')]",
          "additionalRequirementBanner": "These queries and workbooks are dependent on a parser based on Kusto to work as expected. Follow the steps to use this Kusto functions alias **Cisco_Umbrella** in queries and workbooks. [Follow steps to get this Kusto functions>](https://aka.ms/sentinel-ciscoumbrella-function) "
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('parserTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "properties": {
        "description": "Cisco_Umbrella_Parser Data Parser with template",
        "displayName": "Cisco_Umbrella_Parser Data Parser template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('parserTemplateSpecName1'),'/',variables('parserVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('parserTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "Cisco_Umbrella_Parser Data Parser with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('_parserName1')]",
              "apiVersion": "2020-08-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco_Umbrella_Parser Data Parser",
                "category": "Samples",
                "functionAlias": "Cisco_Umbrella_Parser",
                "query": "\n\r\n\r\nlet Cisco_Umbrella_dns_view = view () { \r\n    Cisco_Umbrella_dns_CL\r\n    | extend \r\n        EventEndTime=column_ifexists('Timestamp_t', ''),\r\n        SrcIpAddr=column_ifexists('InternalIp_s', ''),\r\n        SrcNatIpAddr=column_ifexists('ExternalIp_s', ''),\r\n        DvcAction=column_ifexists('Action_s', ''),\r\n        DnsQueryName=column_ifexists('Domain_s', ''),\r\n        UrlCategory=column_ifexists('Categories_s', ''),\r\n        ThreatCategory=column_ifexists('Blocked_Categories_s', ''),\r\n        Identities=column_ifexists('Identities_s', ''),\r\n        DnsQueryTypeName=column_ifexists('QueryType_s', ''),\r\n        DnsResponseCodeName=column_ifexists('ResponseCode_s', ''),\r\n        IdentityTypes=column_ifexists('Identity_Types_s', ''),\r\n        EventType=column_ifexists('EventType_s', ''),\r\n        PolicyIdentity=column_ifexists('Policy_Identity_s', ''),\r\n        PolicyIdentityType=column_ifexists('Policy_Identity_Type_s', '')\r\n    | project \r\n        TimeGenerated,\r\n        EventEndTime,\r\n        SrcIpAddr,\r\n        SrcNatIpAddr,\r\n        DvcAction,\r\n        DnsQueryName,\r\n        UrlCategory,\r\n        ThreatCategory,\r\n        Identities,\r\n        DnsQueryTypeName,\r\n        DnsResponseCodeName,\r\n        IdentityTypes,\r\n        EventType,\r\n        PolicyIdentity,\r\n        PolicyIdentityType\r\n};\r\nlet Cisco_Umbrella_proxy_view = view () { \r\n    Cisco_Umbrella_proxy_CL\r\n    | extend \r\n        EventType=column_ifexists('EventType_s', ''),\r\n        EventEndTime=column_ifexists('Timestamp_t', ''),\r\n        Identities=column_ifexists('Identities_s', ''),\r\n        SrcIpAddr=column_ifexists('Internal_IP_s', ''),\r\n        SrcNatIpAddr=column_ifexists('External_IP_s', ''),\r\n        DstIpAddr=column_ifexists('Destination_IP_s', ''),\r\n        HttpContentType=column_ifexists('Content_Type_s', ''),\r\n        DvcAction=column_ifexists('Verdict_s', ''),\r\n        UrlOriginal=column_ifexists('URL_s', ''),\r\n        HttpReferrerOriginal=column_ifexists('Referer_s', ''),\r\n        HttpUserAgentOriginal=column_ifexists('userAgent_s', ''),\r\n        HttpStatusCode=column_ifexists('statusCode_s', ''),\r\n        SrcBytes=column_ifexists('requestSize_d', ''),\r\n        DstBytes=column_ifexists('responseSize_d', ''),\r\n        HttpResponseBodyBytes=column_ifexists('responseBodySize_d', ''),\r\n        HashSha256=column_ifexists('SHA-SHA256_s', ''),\r\n        UrlCategory=column_ifexists('Categories_s', ''),\r\n        AvDetections=column_ifexists('AVDetections_s', ''),\r\n        Puas=column_ifexists('PUAs_s', ''),\r\n        AmpDisposition=column_ifexists('AMP_Disposition_s', ''), \r\n        ThreatName=column_ifexists('AMP_Malware_Name_s', ''),\r\n        AmpScore=column_ifexists('AMP_Score_s', ''),\r\n        IdentityType=column_ifexists('Identity_Type_s', ''),\r\n        ThreatCategory=column_ifexists('Blocked_Categories_s', '')\r\n    | project\r\n        TimeGenerated,\r\n        EventType,\r\n        EventEndTime,\r\n        Identities,\r\n        SrcIpAddr,\r\n        SrcNatIpAddr,\r\n        DstIpAddr,\r\n        HttpContentType,\r\n        DvcAction,\r\n        UrlOriginal,\r\n        HttpReferrerOriginal,\r\n        HttpUserAgentOriginal,\r\n        HttpStatusCode,\r\n        SrcBytes,\r\n        DstBytes,\r\n        HttpResponseBodyBytes,\r\n        HashSha256,\r\n        UrlCategory,\r\n        AvDetections,\r\n        Puas,\r\n        AmpDisposition,\r\n        ThreatName,\r\n        AmpScore,\r\n        IdentityType,\r\n        ThreatCategory\r\n};\r\nlet Cisco_Umbrella_ip_view = view () { \r\n    Cisco_Umbrella_ip_CL\r\n    | extend \r\n        EventType=column_ifexists('EventType_s', ''),\r\n        EventEndTime=column_ifexists('Timestamp_t', ''),\r\n        Identities=column_ifexists('Identity_s', ''),\r\n        SrcIpAddr=column_ifexists('Source_IP_s', ''),\r\n        SrcPortNumber=column_ifexists('Source_Port_s', ''),\r\n        DstIpAddr=column_ifexists('Destination_IP_s', ''),\r\n        DstPortNumber=column_ifexists('Destination_Port_s', ''),\r\n        UrlCategory=column_ifexists('Categories_s', '')\r\n    | project\r\n        TimeGenerated,\r\n        EventType,\r\n        EventEndTime,\r\n        Identities,\r\n        SrcIpAddr,\r\n        SrcPortNumber,\r\n        DstIpAddr,\r\n        DstPortNumber,\r\n        UrlCategory\r\n};\r\nlet Cisco_Umbrella_cloudfirewall_view = view () { \r\n    Cisco_Umbrella_cloudfirewall_CL\r\n    | extend \r\n        EventType=column_ifexists('EventType_s', ''),\r\n        EventEndTime=column_ifexists('Timestamp_t', ''),\r\n        NetworkSessionId=column_ifexists('originId_s', ''),\r\n        NetworkRuleName=column_ifexists('Identity_s', ''),\r\n        IdentityType=column_ifexists('Identity_Type_s', ''),\r\n        NetworkDirection=column_ifexists('Direction_s', ''),\r\n        NetworkProtocol=column_ifexists('ipProtocol_s', ''),\r\n        NetworkPackets=column_ifexists('packetSize_s', ''),\r\n        SrcIpAddr=column_ifexists('SourceIP', ''),\r\n        SrcPortNumber=column_ifexists('sourcePort_s', ''),\r\n        DstIpAddr=column_ifexists('destinationIp_s', ''),\r\n        DstPortNumber=column_ifexists('destinationPort_s', ''),\r\n        DvcHostname=column_ifexists('dataCenter_s', ''),\r\n        NetworkRuleNumber=column_ifexists('ruleId_s', ''),\r\n        DvcAction=column_ifexists('verdict_s', '')\r\n    | project\r\n        TimeGenerated,\r\n        EventType,\r\n        EventEndTime,\r\n        NetworkSessionId,\r\n        NetworkRuleName,\r\n        IdentityType,\r\n        NetworkDirection,\r\n        NetworkProtocol,\r\n        NetworkPackets,\r\n        SrcIpAddr,\r\n        SrcPortNumber,\r\n        DstIpAddr,\r\n        DstPortNumber,\r\n        DvcHostname,\r\n        NetworkRuleNumber,\r\n        DvcAction\r\n};\r\nunion isfuzzy=true Cisco_Umbrella_dns_view, Cisco_Umbrella_proxy_view, Cisco_Umbrella_ip_view, Cisco_Umbrella_cloudfirewall_view",
                "version": 1,
                "tags": [
                  {
                    "name": "description",
                    "value": "Cisco_Umbrella_Parser Data Parser"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
              "dependsOn": [
                "[variables('_parserName1')]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
                "contentId": "[variables('_parserContentId1')]",
                "kind": "Parser",
                "version": "[variables('parserVersion1')]",
                "source": {
                  "name": "Cisco Umbrella",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2021-06-01",
      "name": "[variables('_parserName1')]",
      "properties": {
        "eTag": "*",
        "displayName": "Cisco Umbrella Data Parser",
        "category": "Samples",
        "functionAlias": "Cisco_Umbrella_Parser",
        "query": "\n\r\n\r\nlet Cisco_Umbrella_dns_view = view () { \r\n    Cisco_Umbrella_dns_CL\r\n    | extend \r\n        EventEndTime=column_ifexists('Timestamp_t', ''),\r\n        SrcIpAddr=column_ifexists('InternalIp_s', ''),\r\n        SrcNatIpAddr=column_ifexists('ExternalIp_s', ''),\r\n        DvcAction=column_ifexists('Action_s', ''),\r\n        DnsQueryName=column_ifexists('Domain_s', ''),\r\n        UrlCategory=column_ifexists('Categories_s', ''),\r\n        ThreatCategory=column_ifexists('Blocked_Categories_s', ''),\r\n        Identities=column_ifexists('Identities_s', ''),\r\n        DnsQueryTypeName=column_ifexists('QueryType_s', ''),\r\n        DnsResponseCodeName=column_ifexists('ResponseCode_s', ''),\r\n        IdentityTypes=column_ifexists('Identity_Types_s', ''),\r\n        EventType=column_ifexists('EventType_s', ''),\r\n        PolicyIdentity=column_ifexists('Policy_Identity_s', ''),\r\n        PolicyIdentityType=column_ifexists('Policy_Identity_Type_s', '')\r\n    | project \r\n        TimeGenerated,\r\n        EventEndTime,\r\n        SrcIpAddr,\r\n        SrcNatIpAddr,\r\n        DvcAction,\r\n        DnsQueryName,\r\n        UrlCategory,\r\n        ThreatCategory,\r\n        Identities,\r\n        DnsQueryTypeName,\r\n        DnsResponseCodeName,\r\n        IdentityTypes,\r\n        EventType,\r\n        PolicyIdentity,\r\n        PolicyIdentityType\r\n};\r\nlet Cisco_Umbrella_proxy_view = view () { \r\n    Cisco_Umbrella_proxy_CL\r\n    | extend \r\n        EventType=column_ifexists('EventType_s', ''),\r\n        EventEndTime=column_ifexists('Timestamp_t', ''),\r\n        Identities=column_ifexists('Identities_s', ''),\r\n        SrcIpAddr=column_ifexists('Internal_IP_s', ''),\r\n        SrcNatIpAddr=column_ifexists('External_IP_s', ''),\r\n        DstIpAddr=column_ifexists('Destination_IP_s', ''),\r\n        HttpContentType=column_ifexists('Content_Type_s', ''),\r\n        DvcAction=column_ifexists('Verdict_s', ''),\r\n        UrlOriginal=column_ifexists('URL_s', ''),\r\n        HttpReferrerOriginal=column_ifexists('Referer_s', ''),\r\n        HttpUserAgentOriginal=column_ifexists('userAgent_s', ''),\r\n        HttpStatusCode=column_ifexists('statusCode_s', ''),\r\n        SrcBytes=column_ifexists('requestSize_d', ''),\r\n        DstBytes=column_ifexists('responseSize_d', ''),\r\n        HttpResponseBodyBytes=column_ifexists('responseBodySize_d', ''),\r\n        HashSha256=column_ifexists('SHA-SHA256_s', ''),\r\n        UrlCategory=column_ifexists('Categories_s', ''),\r\n        AvDetections=column_ifexists('AVDetections_s', ''),\r\n        Puas=column_ifexists('PUAs_s', ''),\r\n        AmpDisposition=column_ifexists('AMP_Disposition_s', ''), \r\n        ThreatName=column_ifexists('AMP_Malware_Name_s', ''),\r\n        AmpScore=column_ifexists('AMP_Score_s', ''),\r\n        IdentityType=column_ifexists('Identity_Type_s', ''),\r\n        ThreatCategory=column_ifexists('Blocked_Categories_s', '')\r\n    | project\r\n        TimeGenerated,\r\n        EventType,\r\n        EventEndTime,\r\n        Identities,\r\n        SrcIpAddr,\r\n        SrcNatIpAddr,\r\n        DstIpAddr,\r\n        HttpContentType,\r\n        DvcAction,\r\n        UrlOriginal,\r\n        HttpReferrerOriginal,\r\n        HttpUserAgentOriginal,\r\n        HttpStatusCode,\r\n        SrcBytes,\r\n        DstBytes,\r\n        HttpResponseBodyBytes,\r\n        HashSha256,\r\n        UrlCategory,\r\n        AvDetections,\r\n        Puas,\r\n        AmpDisposition,\r\n        ThreatName,\r\n        AmpScore,\r\n        IdentityType,\r\n        ThreatCategory\r\n};\r\nlet Cisco_Umbrella_ip_view = view () { \r\n    Cisco_Umbrella_ip_CL\r\n    | extend \r\n        EventType=column_ifexists('EventType_s', ''),\r\n        EventEndTime=column_ifexists('Timestamp_t', ''),\r\n        Identities=column_ifexists('Identity_s', ''),\r\n        SrcIpAddr=column_ifexists('Source_IP_s', ''),\r\n        SrcPortNumber=column_ifexists('Source_Port_s', ''),\r\n        DstIpAddr=column_ifexists('Destination_IP_s', ''),\r\n        DstPortNumber=column_ifexists('Destination_Port_s', ''),\r\n        UrlCategory=column_ifexists('Categories_s', '')\r\n    | project\r\n        TimeGenerated,\r\n        EventType,\r\n        EventEndTime,\r\n        Identities,\r\n        SrcIpAddr,\r\n        SrcPortNumber,\r\n        DstIpAddr,\r\n        DstPortNumber,\r\n        UrlCategory\r\n};\r\nlet Cisco_Umbrella_cloudfirewall_view = view () { \r\n    Cisco_Umbrella_cloudfirewall_CL\r\n    | extend \r\n        EventType=column_ifexists('EventType_s', ''),\r\n        EventEndTime=column_ifexists('Timestamp_t', ''),\r\n        NetworkSessionId=column_ifexists('originId_s', ''),\r\n        NetworkRuleName=column_ifexists('Identity_s', ''),\r\n        IdentityType=column_ifexists('Identity_Type_s', ''),\r\n        NetworkDirection=column_ifexists('Direction_s', ''),\r\n        NetworkProtocol=column_ifexists('ipProtocol_s', ''),\r\n        NetworkPackets=column_ifexists('packetSize_s', ''),\r\n        SrcIpAddr=column_ifexists('SourceIP', ''),\r\n        SrcPortNumber=column_ifexists('sourcePort_s', ''),\r\n        DstIpAddr=column_ifexists('destinationIp_s', ''),\r\n        DstPortNumber=column_ifexists('destinationPort_s', ''),\r\n        DvcHostname=column_ifexists('dataCenter_s', ''),\r\n        NetworkRuleNumber=column_ifexists('ruleId_s', ''),\r\n        DvcAction=column_ifexists('verdict_s', '')\r\n    | project\r\n        TimeGenerated,\r\n        EventType,\r\n        EventEndTime,\r\n        NetworkSessionId,\r\n        NetworkRuleName,\r\n        IdentityType,\r\n        NetworkDirection,\r\n        NetworkProtocol,\r\n        NetworkPackets,\r\n        SrcIpAddr,\r\n        SrcPortNumber,\r\n        DstIpAddr,\r\n        DstPortNumber,\r\n        DvcHostname,\r\n        NetworkRuleNumber,\r\n        DvcAction\r\n};\r\nunion isfuzzy=true Cisco_Umbrella_dns_view, Cisco_Umbrella_proxy_view, Cisco_Umbrella_ip_view, Cisco_Umbrella_cloudfirewall_view",
        "version": 1
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
      "dependsOn": [
        "[variables('_parserId1')]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
        "contentId": "[variables('_parserContentId1')]",
        "kind": "Parser",
        "version": "[variables('parserVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "Cisco Umbrella",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "support@microsoft.com"
        },
        "support": {
          "tier": "Microsoft",
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "link": "https://support.microsoft.com/"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2021-06-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": []
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cisco Umbrella Hunting Query 1 with template",
        "displayName": "Cisco Umbrella Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName1'),'/',variables('huntingQueryVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaAnomalousFQDNsforDomain_HuntingQueries Hunting Query with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cisco_Umbrella_Hunting_Query_1",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - Anomalous FQDNs for domain",
                "category": "Hunting Queries",
                "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'dnslogs'\n| extend replaced = replace(@'\\.$', @'', DnsQueryName)\n| extend Domain = extract(@'.*\\.(.*\\.[a-z]+)', 1, replaced)\n| extend fqdn = extract(@'(.*)\\..*\\.[a-z]+', 1, replaced)\n| summarize FQDNs = dcount(fqdn) by Domain\n| sort by FQDNs\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Large number of FQDNs for domain may be indicator of suspicious domain."
                  },
                  {
                    "name": "tactics",
                    "value": "CommandAndControl"
                  },
                  {
                    "name": "techniques",
                    "value": "T1071"
                  }
                ]
              },
              "id": "[guid('19dd0415-76e9-467a-b3b1-31cb92b3815b')]"
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryResourceId1'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Hunting Query 1",
                "parentId": "[variables('huntingQueryResourceId1')]",
                "contentId": "[variables('_huntingQueryContentId1')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cisco Umbrella Hunting Query 2 with template",
        "displayName": "Cisco Umbrella Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName2'),'/',variables('huntingQueryVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaBlockedUserAgents_HuntingQueries Hunting Query with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cisco_Umbrella_Hunting_Query_2",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - 'Blocked' User-Agents.",
                "category": "Hunting Queries",
                "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where DvcAction =~ 'Blocked'\n| summarize count() by HttpUserAgentOriginal\n| sort by count_\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Shows User-Agent values which requests were blocked"
                  },
                  {
                    "name": "tactics",
                    "value": "Exfiltration"
                  },
                  {
                    "name": "techniques",
                    "value": "T1020"
                  }
                ]
              },
              "id": "[guid('56796715-2905-4a74-b764-8787709757df')]"
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryResourceId2'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Hunting Query 2",
                "parentId": "[variables('huntingQueryResourceId2')]",
                "contentId": "[variables('_huntingQueryContentId2')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cisco Umbrella Hunting Query 3 with template",
        "displayName": "Cisco Umbrella Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName3'),'/',variables('huntingQueryVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaDNSErrors_HuntingQueries Hunting Query with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cisco_Umbrella_Hunting_Query_3",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - DNS Errors.",
                "category": "Hunting Queries",
                "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'dnslogs'\n| where DnsResponseCodeName != 'NOERROR'\n| extend URLCustomEntity = UrlOriginal\n| extend AccountCustomEntity = Identities\n| extend IPCustomEntity = SrcIpAddr\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Shows error DNS requests."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1189"
                  }
                ]
              },
              "id": "[guid('ea80b64b-d560-4934-8e46-24dd0da01ba2')]"
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryResourceId3'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Hunting Query 3",
                "parentId": "[variables('huntingQueryResourceId3')]",
                "contentId": "[variables('_huntingQueryContentId3')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cisco Umbrella Hunting Query 4 with template",
        "displayName": "Cisco Umbrella Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName4'),'/',variables('huntingQueryVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaDNSRequestsUunreliableCategory_HuntingQueries Hunting Query with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion4')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cisco_Umbrella_Hunting_Query_4",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - DNS requests to unreliable categories.",
                "category": "Hunting Queries",
                "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'dnslogs'\n| where UrlCategory contains 'Dating' or UrlCategory contains 'Digital Postcards' or UrlCategory contains 'Freeware and Shareware' or UrlCategory contains 'Gambling' or UrlCategory contains  'Hacking' or UrlCategory contains 'Hunting' or UrlCategory contains 'Mobile Phones' or UrlCategory contains 'Software Updates' or UrlCategory contains 'URL Shortener' or UrlCategory contains  'Web Hosting'\n| where DvcAction == 'Allowed'\n| summarize TotalEvents = count() by DnsQueryName, SrcIpAddr\n| sort by TotalEvents\n| summarize listOfIps = make_set(SrcIpAddr) by DnsQueryName\n| extend URLCustomEntity = DnsQueryName\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Shows requests to URI categories which heavily are used in Initial Access stage by threat actiors and may contain malicious content."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1189"
                  }
                ]
              },
              "id": "[guid('bb864e60-8504-41af-927f-bd80a296d38d')]"
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryResourceId4'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Hunting Query 4",
                "parentId": "[variables('huntingQueryResourceId4')]",
                "contentId": "[variables('_huntingQueryContentId4')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cisco Umbrella Hunting Query 5 with template",
        "displayName": "Cisco Umbrella Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName5'),'/',variables('huntingQueryVersion5'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName5'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaHighCountsOfTheSameBytesInSize_HuntingQueries Hunting Query with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion5')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cisco_Umbrella_Hunting_Query_5",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - Higher values of count of the Same BytesIn size",
                "category": "Hunting Queries",
                "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize count() by SrcIpAddr,DstIpAddr, SrcBytes\n| sort by count_ desc\n| extend Message = \"Possible communication with C2\"\n| project Message, SrcIpAddr, DstIpAddr\n| extend IpCustomEntity = SrcIpAddr\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Calculate the count of BytesIn per Source-Destination pair over 24 hours. Higher values may indicate beaconing."
                  },
                  {
                    "name": "tactics",
                    "value": "CommandAndControl"
                  },
                  {
                    "name": "techniques",
                    "value": "T1071"
                  }
                ]
              },
              "id": "[guid('8cce156c-0188-453e-9230-96555b318bcc')]"
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryResourceId5'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Hunting Query 5",
                "parentId": "[variables('huntingQueryResourceId5')]",
                "contentId": "[variables('_huntingQueryContentId5')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cisco Umbrella Hunting Query 6 with template",
        "displayName": "Cisco Umbrella Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName6'),'/',variables('huntingQueryVersion6'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName6'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaHighValuesOfUploadedData_HuntingQueries Hunting Query with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion6')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cisco_Umbrella_Hunting_Query_6",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - High values of Uploaded Data",
                "category": "Hunting Queries",
                "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize sum(DstBytes) by SrcIpAddr,DstIpAddr\n| sort by sum_DstBytes desc\n| project SrcIpAddr, DstIpAddr\n| extend IpCustomEntity = SrcIpAddr\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "A normal user activity consists mostly of downloading data. Uploaded data is usually small unless there is a file/data upload to a website. Calculate the sum of BytesOut per Source-Destination pair over 12/24 hours."
                  },
                  {
                    "name": "tactics",
                    "value": "Exfiltration"
                  },
                  {
                    "name": "techniques",
                    "value": "T1020"
                  }
                ]
              },
              "id": "[guid('d5e3f2c7-bf99-4811-bbff-96d2f74ca071')]"
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryResourceId6'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Hunting Query 6",
                "parentId": "[variables('huntingQueryResourceId6')]",
                "contentId": "[variables('_huntingQueryContentId6')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName7')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cisco Umbrella Hunting Query 7 with template",
        "displayName": "Cisco Umbrella Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName7'),'/',variables('huntingQueryVersion7'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName7'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaPossibleConnectionC2_HuntingQueries Hunting Query with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion7')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cisco_Umbrella_Hunting_Query_7",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - Possible connection to C2.",
                "category": "Hunting Queries",
                "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize count() by SrcIpAddr, DstIpAddr, SrcBytes\n| sort by count_ desc\n| extend Message = \"Possible communication with C2\"\n| extend IPCustomEntity = SrcIpAddr\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Calculate the count of BytesIn per Source-Destination pair over 12/24 hours. Higher values may indicate beaconing. C2 servers reply with the same data, making BytesIn value the same."
                  },
                  {
                    "name": "tactics",
                    "value": "CommandAndControl"
                  },
                  {
                    "name": "techniques",
                    "value": "T1071"
                  }
                ]
              },
              "id": "[guid('3e7083cf-a2c5-4f65-a196-c07c8712abcc')]"
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryResourceId7'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Hunting Query 7",
                "parentId": "[variables('huntingQueryResourceId7')]",
                "contentId": "[variables('_huntingQueryContentId7')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion7')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName8')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cisco Umbrella Hunting Query 8 with template",
        "displayName": "Cisco Umbrella Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName8'),'/',variables('huntingQueryVersion8'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName8'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaPossibleDataExfiltration_HuntingQueries Hunting Query with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion8')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cisco_Umbrella_Hunting_Query_8",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - Possible data exfiltration",
                "category": "Hunting Queries",
                "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize sum(DstBytes) by SrcIpAddr,DstIpAddr\n| sort by sum_DstBytes desc\n| extend Message = \"Possible data exfiltration\"\n| extend IPCustomEntity = SrcIpAddr\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "A normal user activity consists mostly of downloading data. Uploaded data is usually small unless there is a file/data upload to a website. Calculate the sum of BytesOut per Source-Destination pair over 12/24 hours."
                  },
                  {
                    "name": "tactics",
                    "value": "Exfiltration"
                  },
                  {
                    "name": "techniques",
                    "value": "T1020"
                  }
                ]
              },
              "id": "[guid('348bbac3-8a00-447c-af3e-5534489235e1')]"
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryResourceId8'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Hunting Query 8",
                "parentId": "[variables('huntingQueryResourceId8')]",
                "contentId": "[variables('_huntingQueryContentId8')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion8')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName9')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cisco Umbrella Hunting Query 9 with template",
        "displayName": "Cisco Umbrella Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName9'),'/',variables('huntingQueryVersion9'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName9'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaProxyAllowedUnreliableCategory_HuntingQueries Hunting Query with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion9')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cisco_Umbrella_Hunting_Query_9",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - Proxy 'Allowed' to unreliable categories.",
                "category": "Hunting Queries",
                "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'proxylogs'\n| where UrlCategory contains 'Dating' or UrlCategory contains 'Digital Postcards' or UrlCategory contains 'Freeware and Shareware' or UrlCategory contains 'Gambling' or UrlCategory contains  'Hacking' or UrlCategory contains 'Hunting' or UrlCategory contains 'Mobile Phones' or UrlCategory contains 'Software Updates' or UrlCategory contains 'URL Shortener' or UrlCategory contains  'Web Hosting'\n| where DvcAction == 'ALLOWED'\n| summarize TotalEvents = count() by UrlOriginal, SrcIpAddr\n| sort by TotalEvents\n| summarize listOfIps = make_set(SrcIpAddr) by UrlOriginal\n| extend URLCustomEntity = UrlOriginal\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Shows allowed requests to URI categories which heavily are used in Initial Access stage by threat actiors and may contain malicious content."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1189"
                  }
                ]
              },
              "id": "[guid('35358a47-e0a9-4543-b6e7-327a5ba7eaf0')]"
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryResourceId9'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Hunting Query 9",
                "parentId": "[variables('huntingQueryResourceId9')]",
                "contentId": "[variables('_huntingQueryContentId9')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion9')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName10')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cisco Umbrella Hunting Query 10 with template",
        "displayName": "Cisco Umbrella Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName10'),'/',variables('huntingQueryVersion10'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName10'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaRequestsUncategorizedURI_HuntingQueries Hunting Query with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion10')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cisco_Umbrella_Hunting_Query_10",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - Requests to uncategorized resources",
                "category": "Hunting Queries",
                "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where DvcAction =~ 'Allowed'\n| where UrlCategory == ''\n| project UrlOriginal, Identities\n| extend URLCustomEntity = UrlOriginal\n| extend AccountCustomEntity = Identities\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Shows requests to URL where UrlCategory is not set."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1071"
                  }
                ]
              },
              "id": "[guid('f340dca8-186c-49b3-b450-8d628f06cd89')]"
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryResourceId10'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Hunting Query 10",
                "parentId": "[variables('huntingQueryResourceId10')]",
                "contentId": "[variables('_huntingQueryContentId10')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion10')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cisco Umbrella Analytics Rule 1 with template",
        "displayName": "Cisco Umbrella Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName1'),'/',variables('analyticRuleVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaConnectionNon-CorporatePrivateNetwork_AnalyticalRules Analytics Rule with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRuleContentId1')]",
              "apiVersion": "2022-02-01",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "IP addresses of broadband links that usually indicates users attempting to access their home network, for example for a remote session to a home computer.",
                "displayName": "Cisco Umbrella - Connection to non-corporate private network",
                "enabled": false,
                "query": "let lbtime = 10m;\nCisco_Umbrella\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| where UrlCategory contains 'Adult Themes' or\n      UrlCategory contains 'Adware' or\n      UrlCategory contains 'Alcohol' or\n      UrlCategory contains 'Illegal Downloads' or\n      UrlCategory contains 'Drugs' or\n      UrlCategory contains 'Child Abuse Content' or\n      UrlCategory contains 'Hate/Discrimination' or\n      UrlCategory contains 'Nudity' or\n      UrlCategory contains 'Pornography' or\n      UrlCategory contains 'Proxy/Anonymizer' or\n      UrlCategory contains 'Sexuality' or\n      UrlCategory contains 'Tasteless' or\n      UrlCategory contains 'Terrorism' or\n      UrlCategory contains 'Web Spam' or\n      UrlCategory contains 'German Youth Protection' or\n      UrlCategory contains 'Illegal Activities' or\n      UrlCategory contains 'Lingerie/Bikini' or\n      UrlCategory contains 'Weapons'\n| project TimeGenerated, SrcIpAddr, Identities\n| extend IPCustomEntity = SrcIpAddr\n| extend AccountCustomEntity = Identities\n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "requiredDataConnectors": [
                  {
                    "connectorId": "[variables('analyticalRuleConnectorId1')]",
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CommandAndControl",
                  "Exfiltration"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "FullName"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticalRule-', last(split(variables('analyticRuleResourceId1'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Analytics Rule 1",
                "parentId": "[variables('analyticRuleResourceId1')]",
                "contentId": "[variables('_analyticRuleContentId1')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cisco Umbrella Analytics Rule 2 with template",
        "displayName": "Cisco Umbrella Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName2'),'/',variables('analyticRuleVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaConnectionToUnpopularWebsiteDetected_AnalyticalRules Analytics Rule with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRuleContentId2')]",
              "apiVersion": "2022-02-01",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects first connection to an unpopular website (possible malicious payload delivery).",
                "displayName": "Cisco Umbrella - Connection to Unpopular Website Detected",
                "enabled": false,
                "query": "let domain_lookBack= 14d;\nlet timeframe = 1d;\nlet top_million_list = Cisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(domain_lookBack) and TimeGenerated < ago(timeframe)\n| extend Hostname = parse_url(UrlOriginal)[\"Host\"]\n| summarize count() by tostring(Hostname)\n| top 1000000 by count_\n| summarize make_list(Hostname);\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| extend Hostname = parse_url(UrlOriginal)[\"Host\"]\n| where Hostname !in (top_million_list)\n| extend Message = \"Connect to unpopular website (possible malicious payload delivery)\"\n| project Message, SrcIpAddr, DstIpAddr,UrlOriginal, TimeGenerated\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P14D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "requiredDataConnectors": [
                  {
                    "connectorId": "[variables('analyticalRuleConnectorId2')]",
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "entityMappings": [
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlCustomEntity",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticalRule-', last(split(variables('analyticRuleResourceId2'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Analytics Rule 2",
                "parentId": "[variables('analyticRuleResourceId2')]",
                "contentId": "[variables('_analyticRuleContentId2')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cisco Umbrella Analytics Rule 3 with template",
        "displayName": "Cisco Umbrella Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName3'),'/',variables('analyticRuleVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaCryptoMinerUserAgentDetected_AnalyticalRules Analytics Rule with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRuleContentId3')]",
              "apiVersion": "2022-02-01",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects suspicious user agent strings used by crypto miners in proxy logs.",
                "displayName": "Cisco Umbrella - Crypto Miner User-Agent Detected",
                "enabled": false,
                "query": "let timeframe = 15m;\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| where HttpUserAgentOriginal contains \"XMRig\" or HttpUserAgentOriginal contains \"ccminer\"\n| extend Message = \"Crypto Miner User Agent\"\n| project Message, SrcIpAddr, DstIpAddr, UrlOriginal, TimeGenerated,HttpUserAgentOriginal\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "requiredDataConnectors": [
                  {
                    "connectorId": "[variables('analyticalRuleConnectorId3')]",
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "entityMappings": [
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlCustomEntity",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticalRule-', last(split(variables('analyticRuleResourceId3'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Analytics Rule 3",
                "parentId": "[variables('analyticRuleResourceId3')]",
                "contentId": "[variables('_analyticRuleContentId3')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cisco Umbrella Analytics Rule 4 with template",
        "displayName": "Cisco Umbrella Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName4'),'/',variables('analyticRuleVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaEmptyUserAgentDetected_AnalyticalRules Analytics Rule with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion4')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRuleContentId4')]",
              "apiVersion": "2022-02-01",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Rule helps to detect empty and unusual user agent indicating web browsing activity by an unusual process other than a web browser.",
                "displayName": "Cisco Umbrella - Empty User Agent Detected",
                "enabled": false,
                "query": "let timeframe = 15m;\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| where HttpUserAgentOriginal == ''\n| extend Message = \"Empty User Agent\"\n| project Message, SrcIpAddr, DstIpAddr, UrlOriginal, TimeGenerated\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "requiredDataConnectors": [
                  {
                    "connectorId": "[variables('analyticalRuleConnectorId4')]",
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "entityMappings": [
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlCustomEntity",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticalRule-', last(split(variables('analyticRuleResourceId4'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Analytics Rule 4",
                "parentId": "[variables('analyticRuleResourceId4')]",
                "contentId": "[variables('_analyticRuleContentId4')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cisco Umbrella Analytics Rule 5 with template",
        "displayName": "Cisco Umbrella Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName5'),'/',variables('analyticRuleVersion5'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName5'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaHackToolUserAgentDetected_AnalyticalRules Analytics Rule with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion5')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRuleContentId5')]",
              "apiVersion": "2022-02-01",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects suspicious user agent strings used by known hack tools",
                "displayName": "Cisco Umbrella - Hack Tool User-Agent Detected",
                "enabled": false,
                "query": "let timeframe = 15m;\nlet user_agents=dynamic([\n                          '(hydra)',\n                          ' arachni/',\n                          ' BFAC ',\n                          ' brutus ',\n                          ' cgichk ',\n                          'core-project/1.0',\n                          ' crimscanner/',\n                          'datacha0s',\n                          'dirbuster',\n                          'domino hunter',\n                          'dotdotpwn',\n                          'FHScan Core',\n                          'floodgate',\n                          'get-minimal',\n                          'gootkit auto-rooter scanner',\n                          'grendel-scan',\n                          ' inspath ',\n                          'internet ninja',\n                          'jaascois',\n                          ' zmeu ',\n                          'masscan',\n                          ' metis ',\n                          'morfeus fucking scanner',\n                          'n-stealth',\n                          'nsauditor',\n                          'pmafind',\n                          'security scan',\n                          'springenwerk',\n                          'teh forest lobster',\n                          'toata dragostea',\n                          ' vega/',\n                          'voideye',\n                          'webshag',\n                          'webvulnscan',\n                          ' whcc/',\n                          ' Havij',\n                          'absinthe',\n                          'bsqlbf',\n                          'mysqloit',\n                          'pangolin',\n                          'sql power injector',\n                          'sqlmap',\n                          'sqlninja',\n                          'uil2pn',\n                          'ruler',\n                          'Mozilla/5.0 (Windows; U; Windows NT 5.1; pt-PT; rv:1.9.1.2) Gecko/20090729 Firefox/3.5.2 (.NET CLR 3.5.30729)'\n                          ]);\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| where HttpUserAgentOriginal has_any (user_agents)\n| extend Message = \"Hack Tool User Agent\"\n| project Message, SrcIpAddr, DstIpAddr, UrlOriginal, TimeGenerated, HttpUserAgentOriginal\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "requiredDataConnectors": [
                  {
                    "connectorId": "[variables('analyticalRuleConnectorId5')]",
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "entityMappings": [
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlCustomEntity",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticalRule-', last(split(variables('analyticRuleResourceId5'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Analytics Rule 5",
                "parentId": "[variables('analyticRuleResourceId5')]",
                "contentId": "[variables('_analyticRuleContentId5')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cisco Umbrella Analytics Rule 6 with template",
        "displayName": "Cisco Umbrella Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName6'),'/',variables('analyticRuleVersion6'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName6'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaPowershellUserAgentDetected_AnalyticalRules Analytics Rule with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion6')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRuleContentId6')]",
              "apiVersion": "2022-02-01",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Rule helps to detect Powershell user-agent activity by an unusual process other than a web browser.",
                "displayName": "Cisco Umbrella - Windows PowerShell User-Agent Detected",
                "enabled": false,
                "query": "let timeframe = 15m;\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| where HttpUserAgentOriginal contains \"WindowsPowerShell\"\n| extend Message = \"Windows PowerShell User Agent\"\n| project Message, SrcIpAddr, DstIpAddr, UrlOriginal, TimeGenerated,HttpUserAgentOriginal\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "requiredDataConnectors": [
                  {
                    "connectorId": "[variables('analyticalRuleConnectorId6')]",
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CommandAndControl",
                  "DefenseEvasion"
                ],
                "entityMappings": [
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlCustomEntity",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticalRule-', last(split(variables('analyticRuleResourceId6'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Analytics Rule 6",
                "parentId": "[variables('analyticRuleResourceId6')]",
                "contentId": "[variables('_analyticRuleContentId6')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName7')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cisco Umbrella Analytics Rule 7 with template",
        "displayName": "Cisco Umbrella Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName7'),'/',variables('analyticRuleVersion7'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName7'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaRareUserAgentDetected_AnalyticalRules Analytics Rule with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion7')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRuleContentId7')]",
              "apiVersion": "2022-02-01",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Rule helps to detect a rare user-agents indicating web browsing activity by an unusual process other than a web browser.",
                "displayName": "Cisco Umbrella - Rare User Agent Detected",
                "enabled": false,
                "query": "let lookBack = 14d;\nlet timeframe = 1d;\nlet user_agents_list = Cisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(lookBack) and TimeGenerated < ago(timeframe)\n| summarize count() by HttpUserAgentOriginal\n| summarize make_list(HttpUserAgentOriginal);\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| where HttpUserAgentOriginal !in (user_agents_list)\n| extend Message = \"Rare User Agent\"\n| project Message, SrcIpAddr, DstIpAddr, UrlOriginal, TimeGenerated, HttpUserAgentOriginal\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P14D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "requiredDataConnectors": [
                  {
                    "connectorId": "[variables('analyticalRuleConnectorId7')]",
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "entityMappings": [
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlCustomEntity",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticalRule-', last(split(variables('analyticRuleResourceId7'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Analytics Rule 7",
                "parentId": "[variables('analyticRuleResourceId7')]",
                "contentId": "[variables('_analyticRuleContentId7')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion7')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName8')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cisco Umbrella Analytics Rule 8 with template",
        "displayName": "Cisco Umbrella Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName8'),'/',variables('analyticRuleVersion8'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName8'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaRequestAllowedHarmfulMaliciousURICategory_AnalyticalRules Analytics Rule with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion8')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRuleContentId8')]",
              "apiVersion": "2022-02-01",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "It is reccomended that these Categories shoud be blocked by policies because they provide harmful/malicious content..",
                "displayName": "Cisco Umbrella - Request Allowed to harmful/malicious URI category",
                "enabled": false,
                "query": "let lbtime = 10m;\nCisco_Umbrella\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| where UrlCategory contains 'Adult Themes' or\n      UrlCategory contains 'Adware' or\n      UrlCategory contains 'Alcohol' or\n      UrlCategory contains 'Illegal Downloads' or\n      UrlCategory contains 'Drugs' or\n      UrlCategory contains 'Child Abuse Content' or\n      UrlCategory contains 'Hate/Discrimination' or\n      UrlCategory contains 'Nudity' or\n      UrlCategory contains 'Pornography' or\n      UrlCategory contains 'Proxy/Anonymizer' or\n      UrlCategory contains 'Sexuality' or\n      UrlCategory contains 'Tasteless' or\n      UrlCategory contains 'Terrorism' or\n      UrlCategory contains 'Web Spam' or\n      UrlCategory contains 'German Youth Protection' or\n      UrlCategory contains 'Illegal Activities' or\n      UrlCategory contains 'Lingerie/Bikini' or\n      UrlCategory contains 'Weapons'\n| project TimeGenerated, SrcIpAddr, Identities\n| extend IPCustomEntity = SrcIpAddr\n| extend AccountCustomEntity = Identities\n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "requiredDataConnectors": [
                  {
                    "connectorId": "[variables('analyticalRuleConnectorId8')]",
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CommandAndControl",
                  "InitialAccess"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "FullName"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticalRule-', last(split(variables('analyticRuleResourceId8'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Analytics Rule 8",
                "parentId": "[variables('analyticRuleResourceId8')]",
                "contentId": "[variables('_analyticRuleContentId8')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion8')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName9')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cisco Umbrella Analytics Rule 9 with template",
        "displayName": "Cisco Umbrella Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName9'),'/',variables('analyticRuleVersion9'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName9'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaRequestBlocklistedFileType_AnalyticalRules Analytics Rule with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion9')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRuleContentId9')]",
              "apiVersion": "2022-02-01",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects request to potentially harmful file types (.ps1, .bat, .vbs, etc.).",
                "displayName": "Cisco Umbrella - Request to blocklisted file type",
                "enabled": false,
                "query": "let file_ext_blocklist = dynamic(['.ps1', '.vbs', '.bat', '.scr']);\nlet lbtime = 10m;\nCisco_Umbrella\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| extend file_ext = extract(@'.*(\\.\\w+)$', 1, UrlOriginal)\n| extend Filename = extract(@'.*\\/*\\/(.*\\.\\w+)$', 1, UrlOriginal)\n| where file_ext in (file_ext_blocklist)\n| project TimeGenerated, SrcIpAddr, Identities, Filename\n| extend IPCustomEntity = SrcIpAddr\n| extend AccountCustomEntity = Identities\n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "requiredDataConnectors": [
                  {
                    "connectorId": "[variables('analyticalRuleConnectorId9')]",
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ]
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "FullName"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticalRule-', last(split(variables('analyticRuleResourceId9'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Analytics Rule 9",
                "parentId": "[variables('analyticRuleResourceId9')]",
                "contentId": "[variables('_analyticRuleContentId9')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion9')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName10')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cisco Umbrella Analytics Rule 10 with template",
        "displayName": "Cisco Umbrella Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName10'),'/',variables('analyticRuleVersion10'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName10'))]"
      ],
      "properties": {
        "description": "CiscoUmbrellaURIContainsIPAddress_AnalyticalRules Analytics Rule with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion10')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRuleContentId10')]",
              "apiVersion": "2022-02-01",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Malware can use IP address to communicate with C2.",
                "displayName": "Cisco Umbrella - URI contains IP address",
                "enabled": false,
                "query": "let lbtime = 10m;\nCisco_Umbrella\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| where UrlOriginal matches regex @'\\Ahttp:\\/\\/\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}.*'\n| project TimeGenerated, SrcIpAddr, Identities\n| extend IPCustomEntity = SrcIpAddr\n| extend AccountCustomEntity = Identities\n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "requiredDataConnectors": [
                  {
                    "connectorId": "[variables('analyticalRuleConnectorId10')]",
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "FullName"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticalRule-', last(split(variables('analyticRuleResourceId10'),'/'))))]",
              "properties": {
                "description": "Cisco Umbrella Analytics Rule 10",
                "parentId": "[variables('analyticRuleResourceId10')]",
                "contentId": "[variables('_analyticRuleContentId10')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion10')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId1')]",
        "hidden-sentinelContentType": "Parser"
      },
      "properties": {
        "description": "Cisco Umbrella Workbook with template",
        "displayName": "Cisco Umbrella workbook template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('workbookTemplateSpecName1'),'/',variables('workbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId1')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('workbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "CiscoUmbrella_workbook Workbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "properties": {
                "displayName": "[concat(parameters('workbook1-name'), ' - ', parameters('formattedTimeNow'))]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\">**NOTE:** This workbook uses a parser based on a Kusto Function to normalize fields. [Follow these steps](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Parsers/CiscoUmbrella/Cisco_Umbrella) to create the Kusto function alias **Cisco_Umbrella**.\"},\"name\":\"Text\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"464b6899-a8de-4f01-84a6-d4e3ecc7f282\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Cisco Umbrella Main Dashboard\",\"subTarget\":\"cisco_umbrella_main_dashboard\",\"preText\":\"Cisco Umbrella Main Dashboard\",\"style\":\"link\"},{\"id\":\"a3798d8a-a610-475c-9cbf-7252301dab7e\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Cisco Umbrella Dns Dashboard\",\"subTarget\":\"cisco_umbrella_dns_dashboard\",\"style\":\"link\"},{\"id\":\"80bcf252-bcf6-4736-993d-59da0a8e4c76\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Cisco Umbrella Proxy Dashboard\",\"subTarget\":\"cisco_umbrella_proxy_dashboard\",\"style\":\"link\"},{\"id\":\"f536a1e9-362e-4d98-bdd1-0f7dfb23901a\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Cisco Umbrella Firewall Dashboard\",\"subTarget\":\"cisco_umbrella_firewall_dashboard\",\"style\":\"link\"}]},\"name\":\"Links\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"37b91baf-6272-4709-a028-1370823249d4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":5184000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Parameters1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| summarize Count=count() by EventType\\n| render barchart\",\"size\":3,\"title\":\"Events Count by EventType\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"EventType\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"EventType\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Count\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_main_dashboard\"},\"customWidth\":\"30\",\"name\":\"EventsCountByEventType\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n|make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by EventType;\",\"size\":0,\"title\":\"Events over time\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_main_dashboard\"},\"customWidth\":\"70\",\"name\":\"EventsOverTime\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where DvcAction contains \\\"block\\\"\\n| where TimeGenerated {TimeRange} \\n|make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain};\",\"size\":0,\"title\":\"Blocks over time\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_main_dashboard\"},\"customWidth\":\"70\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let CU_Total_Requests =\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| summarize count()\\n| extend evttype=\\\"Total Requests\\\";\\n\\nlet CU_Total_Blocked =\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where DvcAction contains \\\"block\\\"\\n| summarize count()\\n| extend evttype=\\\"Total Blocked\\\";\\n\\nlet CU_Security_Blocked =\\nCisco_Umbrella \\n| where TimeGenerated {TimeRange} \\n| where DvcAction contains \\\"block\\\"\\n| where isnotempty(ThreatCategory)\\n| summarize count()\\n| extend evttype=\\\"Security Blocked\\\";\\n\\nunion CU_Security_Blocked,CU_Total_Blocked,CU_Total_Requests\",\"size\":3,\"title\":\"Network Breakdown Statistic\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"evttype\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"size\":\"auto\"}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_main_dashboard\"},\"customWidth\":\"30\",\"name\":\"NetworkBreakdownStatistic\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| summarize count() by DvcAction\",\"size\":3,\"title\":\"DNS - Events count by Action\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"DvcAction\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"customWidth\":\"30\",\"name\":\"DNSEventsCountByAction\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| summarize Count=count() by DnsQueryTypeName | sort by Count\",\"size\":0,\"title\":\"DNS - Events count by QueryType\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"categoricalbar\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"customWidth\":\"70\",\"name\":\"DNSEventsCountByQueryType\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where EventType == \\\"dnslogs\\\"\\n| where TimeGenerated {TimeRange} \\n| where isnotempty(ThreatCategory)\\n| extend Threat_Category=parsejson(tostring(ThreatCategory))\\n| mv-expand Threat_Category\\n| summarize Count=count() by tostring(Threat_Category)\\n| sort by Count \\n| join kind = inner (\\nCisco_Umbrella\\n| where EventType == \\\"dnslogs\\\"\\n| where isnotempty(ThreatCategory)\\n| where TimeGenerated {TimeRange} \\n| extend Threat_Category=parsejson(tostring(ThreatCategory))\\n| mv-expand Threat_Category\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by tostring(Threat_Category))\\n on Threat_Category\\n | project-away Threat_Category1, TimeGenerated\\n | project Threat_Category, Count, Trend\\n | order by Count\\n| take 10\",\"size\":0,\"title\":\"DNS - Events by Threat Category\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"customWidth\":\"30\",\"name\":\"DNSEventsByThreatCategory\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| where isnotempty(UrlCategory)\\n| extend Url_Category=parsejson(tostring(UrlCategory))\\n| mv-expand Url_Category\\n| summarize Count=count() by tostring(Url_Category)\\n| sort by Count\\n| join kind = inner (\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| where isnotempty(UrlCategory)\\n| extend Url_Category=parsejson(tostring(UrlCategory))\\n| mv-expand Url_Category\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by tostring(Url_Category))\\n on Url_Category\\n | project-away Url_Category1, TimeGenerated\\n | project Url_Category, Count, Trend\\n | order by Count\\n| take 10\",\"size\":0,\"title\":\"DNS - Events by Url Category\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"customWidth\":\"35\",\"name\":\"DNSEventsByUrlCategory\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let list_IP = Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| where DvcAction == \\\"Blocked\\\"\\n|summarize Count=count() by SrcIpAddr | top 10 by Count\\n| summarize makelist(SrcIpAddr);\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| where DvcAction == \\\"Blocked\\\"\\n|summarize Count=count() by SrcIpAddr \\n| join kind = inner (\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| where DvcAction == \\\"Blocked\\\"\\n| where SrcIpAddr in (list_IP)\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SrcIpAddr)\\n on SrcIpAddr\\n |  project-away SrcIpAddr1, TimeGenerated\\n | project SrcIpAddr, Count, Trend\\n | order by Count\\n| take 10\\n\\n\",\"size\":0,\"title\":\"DNS - Top 10 SrcIp with Blocked Action\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"customWidth\":\"35\",\"name\":\"DNSTop10SrcIpBlockedAction\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange}\\n| where EventType == \\\"dnslogs\\\"\\n| where DvcAction == \\\"Blocked\\\"\\n| summarize Count=count() by DnsQueryName, UrlCategory \\n| top 10 by Count\\n\",\"size\":0,\"title\":\"DNS - Top 10 Blocked Url \",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"name\":\"DNSTop10BlockedUrl \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| summarize count() by DvcAction\",\"size\":3,\"title\":\"Proxy - Events count by Action\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"customWidth\":\"30\",\"name\":\"ProxyEventsCountByAction\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let CU_proxy_outcoming_traffic =\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| extend TrafficType = \\\"Outcoming\\\", Bytes = SrcBytes\\n| project TrafficType, Bytes, TimeGenerated;\\n\\nlet CU_proxy_incoming_traffic =\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| extend TrafficType = \\\"Incoming\\\", Bytes = DstBytes\\n| project TrafficType, Bytes, TimeGenerated;\\n\\n\\nunion CU_proxy_outcoming_traffic, CU_proxy_incoming_traffic\\n| make-series TotalGbytes = round(sum(Bytes/(1024*1024*1024)),2) on TimeGenerated  from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by TrafficType\\n\",\"size\":0,\"title\":\"Proxy - Traffic timechart, GB\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"customWidth\":\"70\",\"name\":\"ProxyTrafficTimechart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where isnotempty(UrlCategory)\\n| extend Url_Category=parsejson(tostring(UrlCategory))\\n| mv-expand Url_Category\\n| summarize Count=count() by tostring(Url_Category)\\n| sort by Count\\n| join kind = inner (\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where isnotempty(UrlCategory)\\n| extend Url_Category=parsejson(tostring(UrlCategory))\\n| mv-expand Url_Category\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by tostring(Url_Category))\\n on Url_Category\\n | project-away Url_Category1, TimeGenerated\\n | project Url_Category, Count, Trend\\n | order by Count\\n| take 10\",\"size\":0,\"title\":\"Proxy - Events by Url Category\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"customWidth\":\"30\",\"name\":\"ProxyEventsByUrlCategory\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let list_IP = Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where DvcAction == \\\"BLOCKED\\\"\\n|summarize Count=count() by SrcIpAddr | top 10 by Count\\n| summarize makelist(SrcIpAddr);\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where DvcAction == \\\"BLOCKED\\\"\\n|summarize Count=count() by SrcIpAddr \\n| join kind = inner (\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where DvcAction == \\\"BLOCKED\\\"\\n| where SrcIpAddr in (list_IP)\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SrcIpAddr)\\n on SrcIpAddr\\n |  project-away SrcIpAddr1, TimeGenerated\\n | project SrcIpAddr, Count, Trend\\n | order by Count\\n| take 10\\n\\n\",\"size\":0,\"title\":\"Proxy - Top 10 Source IP with Blocked Action\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"customWidth\":\"35\",\"name\":\"ProxyTop10SourceIPBlockedAction\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where isnotempty(ThreatCategory)\\n| extend Threat_Category=parsejson(tostring(ThreatCategory))\\n| mv-expand Threat_Category\\n| summarize Count=count() by tostring(Threat_Category)\\n| sort by Count \\n| join kind = inner (\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where isnotempty(ThreatCategory)\\n| extend Threat_Category=parsejson(tostring(ThreatCategory))\\n| mv-expand Threat_Category\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by tostring(Threat_Category))\\n on Threat_Category\\n | project-away Threat_Category1, TimeGenerated\\n | project Threat_Category, Count, Trend\\n | order by Count\\n| take 10\",\"size\":0,\"title\":\"Proxy - Events by Threat Category\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"customWidth\":\"35\",\"name\":\"ProxyEventsByThreatCategory\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange}\\n| where EventType == \\\"proxylogs\\\"\\n| where DvcAction == \\\"BLOCKED\\\"\\n| summarize Count=count() by UrlOriginal, UrlCategory \\n| top 10 by Count\\n\",\"size\":0,\"title\":\"Proxy - Top 10 Blocked Url \",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"name\":\"ProxyTop10BlockedUrl \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"cloudfirewalllogs\\\"\\n| summarize count() by DvcAction\",\"size\":3,\"title\":\"Firewall - Events count by Action\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"DvcAction\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_firewall_dashboard\"},\"customWidth\":\"30\",\"name\":\"FirewallEventsCountByAction\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"cloudfirewalllogs\\\"\\n| make-series Packets = sum(toint(NetworkPackets)) on TimeGenerated  from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by NetworkDirection\",\"size\":0,\"title\":\"Firewall - Traffic over time, Packets\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_firewall_dashboard\"},\"customWidth\":\"70\",\"name\":\"FirewallTrafficOverTime\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n|where EventType == \\\"cloudfirewalllogs\\\"\\n| where DvcAction contains \\\"BLOCK\\\"\\n| where TimeGenerated {TimeRange} \\n|make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain};\",\"size\":0,\"title\":\"Firewall - Block Events over time\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_firewall_dashboard\"},\"customWidth\":\"50\",\"name\":\"query - 19\"}],\"fromTemplateId\":\"sentinel-CiscoUmbrella\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId1')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookResourceId1'),'/'))))]",
              "properties": {
                "parentId": "[variables('workbookResourceId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cisco Umbrella",
                  "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "properties": {
        "version": "2.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "2.0.0",
        "contentId": "[variables('_sourceId')]",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "Cisco Umbrella",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "support@microsoft.com"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_Cisco_Umbrella_Parser')]",
              "version": "2.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaAnomalousFQDNsforDomain_HuntingQueries')]",
              "version": "2.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaBlockedUserAgents_HuntingQueries')]",
              "version": "2.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaDNSErrors_HuntingQueries')]",
              "version": "2.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaDNSRequestsUunreliableCategory_HuntingQueries')]",
              "version": "2.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaHighCountsOfTheSameBytesInSize_HuntingQueries')]",
              "version": "2.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaHighValuesOfUploadedData_HuntingQueries')]",
              "version": "2.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaPossibleConnectionC2_HuntingQueries')]",
              "version": "2.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaPossibleDataExfiltration_HuntingQueries')]",
              "version": "2.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaProxyAllowedUnreliableCategory_HuntingQueries')]",
              "version": "2.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaRequestsUncategorizedURI_HuntingQueries')]",
              "version": "2.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaConnectionNon-CorporatePrivateNetwork_AnalyticalRules')]",
              "version": "2.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaConnectionToUnpopularWebsiteDetected_AnalyticalRules')]",
              "version": "2.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaCryptoMinerUserAgentDetected_AnalyticalRules')]",
              "version": "2.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaEmptyUserAgentDetected_AnalyticalRules')]",
              "version": "2.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaHackToolUserAgentDetected_AnalyticalRules')]",
              "version": "2.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaPowershellUserAgentDetected_AnalyticalRules')]",
              "version": "2.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaRareUserAgentDetected_AnalyticalRules')]",
              "version": "2.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaRequestAllowedHarmfulMaliciousURICategory_AnalyticalRules')]",
              "version": "2.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaRequestBlocklistedFileType_AnalyticalRules')]",
              "version": "2.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaURIContainsIPAddress_AnalyticalRules')]",
              "version": "2.0.0"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_CiscoUmbrella_workbook')]",
              "version": "2.0.0"
            }
          ]
        },
        "firstPublishDate": "2022-04-01",
        "providers": [
          "Microsoft"
        ],
        "categories": {
          "domains": [
            "Security - Cloud Security"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]"
    }
  ],
  "outputs": {}
}
