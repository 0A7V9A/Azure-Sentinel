id: 64a3477e-d06f-4491-86a5-6f99702e267f
name: Nasuni File Delete Activity
description: |
  'This query looks for file delete audit events generated by a Nasuni Edge Appliance.'
requiredDataConnectors:
  - connectorId: Syslog
    dataTypes:
      - Syslog
tactics:
  - Impact
relevantTechniques:
  - T1485
query: |
  Syslog 
  | where SyslogMessage matches regex "(nasuni.)([0-9A-Za-z]{8}-[0-9A-Za-z]{4}-[0-9A-Za-z]{4}-[0-9A-Za-z]{4}-[0-9A-Za-z]{1})"
  | extend SyslogMessageJson = extract('{(.*?)}', 0, SyslogMessage)
  | extend event_details_ = parse_json(SyslogMessageJson)
  | extend path_parts_ = parse_path(tostring(event_details_.path))
  | where event_details_.event_type == "AUDIT_UNLINK"
  | project
      TimeGenerated
      ,HostName
      ,event_type_ = event_details_.event_type
      ,sAMAccountName_ = trim(@"(?s)^.*\\\s*", tostring(event_details_.username))
      ,domainName_ = trim_end(@"[\\]\S*", tostring(event_details_.username))
      ,filename_ = path_parts_.Filename
      ,directorypath_ = path_parts_.DirectoryPath
      ,ipaddr_ = event_details_.ipaddr
      ,sid_ = event_details_.sid
      ,volume_guid_ = event_details_.volume
      ,access_point_ = event_details_.resource
      ,primary_group_name_ = trim(@"(?s)^.*\\\s*", tostring(event_details_.groupname))
      ,new_path_ = event_details_.newpath
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: ipaddr_
  - entityType: Account
    fieldMappings:
      - identifier: Sid
        columnName: sid_
      - identifier: Name
        columnName: sAMAccountName_
      - identifier: NTDomain
        columnName: domainName_
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: HostName
  - entityType: File
    fieldMappings:
      - identifier: Name
        columnName: filename_
      - identifier: Directory
        columnName: directorypath_
version: 1.0.0
  
  