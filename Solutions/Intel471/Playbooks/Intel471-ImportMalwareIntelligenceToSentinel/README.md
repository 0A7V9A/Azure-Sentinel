# Malware Intelligence connector

## Table of contents

1. [Overview](#overview)
2. [Test](#test)

## Overview

This connector fetches malware intelligence indicators from the Intel 471's Titan API and ingests them directly
into `ThreatIntelligenceIndicator` table of a Microsoft Sentinel workspace, from which they can be further processed by Microsoft Sentinel or Microsoft Defender.

[azuredeploy.json](azuredeploy.json) Azure Resource Manager template (ARM template) is responsible
for building the connector's Logic App along with auxiliary resources. The ARM builds following components:

- **[Logic App](https://docs.microsoft.com/en-us/azure/sentinel/create-custom-connector#connect-with-logic-apps)** responsible for fetching the data from Titan API and ingesting them into `ThreatIntelligenceIndicator` table
- **[Key Vault](https://docs.microsoft.com/en-us/azure/key-vault/general/basic-concepts)** responsible for securely storing Titan API credentials
- **[Blob storage](https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)** responsible for persisting data such as cursor between the API calls
- Connection objects
  - Logic app to Key Vault *(authorized automatically)*
  - Logic app to Blob storage *(authorized automatically)*
  - Logic app to Microsoft Security Graph *(**requires manual configuration**)*

![Intel 471 Malware Intelligence Logic App](malware-intelligence-screenshot.png "Intel 471 Malware Intelligence Logic App")

## Prerequisites

1. An active account in Titan platform, which is available as part of Intel 471's subscriptions. For more information, please contact sales@intel471.com.
2. Titan API credentials.

## Deployment instructions

1. To deploy the Playbook, click the **Deploy to Azure** button. It will launch the ARM Template deployment wizard.
2. Provide following parameters:
    * **Playbook Name**: Either leave the default one or change it as needed
    * **Titan User Name**: Titan API username
    * **Titan API Key**: Titan API key
    * **Look Back Days**: How many days of history should be pulled on the first run. Leave 0 to start from the current time

    [![Deploy to Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FAzure-Sentinel%2Fmaster%2FSolutions%2FIntel471%2FPlaybooks%2FIntel471-ImportMalwareIntelligenceToSentinel%2Fazuredeploy.json) [![Deploy to Azure](https://aka.ms/deploytoazuregovbutton)](https://portal.azure.us/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FAzure-Sentinel%2Fmaster%2FSolutions%2FIntel471%2FPlaybooks%2FIntel471-ImportMalwareIntelligenceToSentinel%2Fazuredeploy.json)

## Post-deployment instructions

1. Go to created `Logic App → Edit`. Navigate to `Collect Indicators → Submit multiple tiIndicators` block. Inside this block create a new connection. Select `Connect with managed identity`, provide connection name and click `Create`.
2. Navigate to `Collect Indicators → BuildTiIndicatorsPayload → Append to array variable` block. Provide desired `action` for incoming indicators. You can choose from `allow`, `alert`, `block` and `unknown`.
3. Optionally, in the same block, change `targetProduct`. By default, it's `Azure Sentinel`, but it can be changed to `Microsoft Defender ATP`.
4. Grant `ThreatIndicators.ReadWrite.OwnedBy` role for the Logic App to allow indicator ingestion through the tiIndicators API. It can't be done in the UI at the moment. You can use the Azure CLI script listed below instead.
5. Optionally change the schedule's frequency in `Recurrence` block (the first one).

## Querying Intel 471 Malware Intelligence data in Sentinel

Get first 10 ingested indicators

```
ThreatIntelligenceIndicator | where Description contains "Intel 471" | limit 10 
```

Look for a specific indicator

```
ThreatIntelligenceIndicator | where Description has "Intel 471" | where NetworkIP == "227.151.66.29"
ThreatIntelligenceIndicator | where Description has "Intel 471" | where Url == "tcp://58.68.162.115:16"
ThreatIntelligenceIndicator | where Description has "Intel 471" | where FileHashValue == "B55C257F8004F6A742B1A252EEDDDD655256955A931C1BD0F47299ADD326ED6D"
```

Get indicators of a specific type

```
ThreatIntelligenceIndicator | where Description has "Intel 471" | where NetworkIP != ""  | limit 10
ThreatIntelligenceIndicator | where Description has "Intel 471" | where Url != ""  | limit 10
ThreatIntelligenceIndicator | where Description has "Intel 471" | where FileHashValue != ""  | limit 10
```

Get IP indicators with specific confidence

```
ThreatIntelligenceIndicator | where Description has "Intel 471" | where NetworkIP != "" | where  ConfidenceScore > 40  | limit 10
```

Get indicators related to a specific malware family

```
ThreatIntelligenceIndicator | where Description has "Intel 471" | where MalwareNames contains "njrat" | limit 10
```

## Data mapping

Data is fetched from `/v1/indicators/stream` Titan API endpoint and is then transformed to conform with `ThreatIntelligenceIndicator` table.
Table below summarizes the mappings and additional transformations that are performed for several fields.

| Titan API object key          | ThreatIntelligenceIndicator record column | Additional transformations                                                                                                                                                          |
|-------------------------------|-------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| -                             | action                                    | Provided by the user. One of `allow`, `alert`, `block` or `unknown`.                                                                                                                |
| data.confidence               | confidence                                | `high` → `85`, `medium` → `50`, `low` → `15`                                                                                                                                        |
| data.context.description      | description                               | -                                                                                                                                                                                   |
| data.expiration               | expirationDateTime                        | -                                                                                                                                                                                   |
| data.uid                      | externalId                                | -                                                                                                                                                                                   |
| data.indicator_data.file.*    | fileHashType                              | In Titan API each file indicator object contains all hashes. In `ThreatIntelligenceIndicator` table there's a separate row for each hash.                                           |
| data.indicator_data.file.*    | fileHashValue                             | Example transformation: `{"indicator_data": {"file": {"md5": "abc", "sha1": "bcd"}}}` → `[{"fileHashType": "MD5", "fileHashValue": "abc"}, {"fileHashType": "MD5", "SHA1": "bcd"}]` |
| data.indicator_data.file.size | fileSize                                  | -                                                                                                                                                                                   |
| data.indicator_data.file.type | fileType                                  | -                                                                                                                                                                                   |
| data.mitre_tactics            | killChain                                 | `command_and_control` → `C2`, `stage_capabilities` → `Installation`, `initial_access` → `Exploitation`                                                                              |
| activity.last                 | lastReportedDateTime                      | -                                                                                                                                                                                   |
| data.threat.data.family       | malwareFamilyNames                        | -                                                                                                                                                                                   |
| data.indicator_data.address   | networkIPv4                               | -                                                                                                                                                                                   |
| -                             | targetProduct                             | Provided by the user, either `Azure Sentinel` or `Microsoft Defender ATP`                                                                                                           |
| -                             | threatType                                | Set to `Malware`                                                                                                                                                                    |
| -                             | tlpLevel                                  | Set to `amber`                                                                                                                                                                      |
| data.indicator_data.url       | url                                       | -                                                                                                                                                                                   |

## Test

bla bla lbba

## Script for granting ThreatIndicators.ReadWrite.OwnedBy role

```bash
#!/bin/bash

# tested against azure-cli==2.42.0

az login

# Logic App name. IF YOU CHANGED IT DURING THE DEPLOYMENT, CHANGE IT HERE AS WELL
logicAppName="intel471-malware-indicators"

# ID of the Microsoft Graph resource. Do not change.
graphAppId="00000003-0000-0000-c000-000000000000"

# Name of the required role. Do not change.
roleName="ThreatIndicators.ReadWrite.OwnedBy"

# Get the ID of the Logic App
spId=$(az resource list -n $logicAppName --query '[*].identity.principalId' --out tsv)

# Get the ID of the Microsoft Graph resource
graphResourceId=$(az ad sp show --id "$graphAppId" --query 'id' --out tsv)

# Get the ID of the Role
appRoleId=$(az ad sp show --id "$graphAppId" --query "appRoles[?value=='$roleName' && contains(allowedMemberTypes, 'Application')].id" --output tsv)

# Build a Role assignments request for your app
uri=https://graph.microsoft.com/v1.0/servicePrincipals/$spId/appRoleAssignments
body="{'principalId':'$spId','resourceId':'$graphResourceId','appRoleId':'$appRoleId'}"
echo "URI: "$uri
echo "Body: "$body

# Call the endpoint to grant the role
az rest --method post --uri $uri --body $body --headers "Content-Type=application/json"
```
