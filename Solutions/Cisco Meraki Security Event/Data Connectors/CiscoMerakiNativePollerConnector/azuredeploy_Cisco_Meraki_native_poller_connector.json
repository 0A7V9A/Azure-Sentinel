{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "location": {
        "defaultValue": "[resourceGroup().location]",
        "minLength": 1,
        "type": "String",
        "metadata": {
          "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
        }
      },
      "workspace-location": {
        "defaultValue": "[parameters('location')]",
        "minLength": 1,
        "type": "String",
        "metadata": {
          "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
        }
      },
      "workspace": {
        "defaultValue": "<Enter Log Analytics Workspace>",
        "minLength": 1,
        "type": "String",
        "metadata": {
          "description": "Workspace name for Log Analytics where Sentinel is setup"
        }
      }
    },
    "variables": {
      "sourceId": "azuresentinel.azure-sentinel-solution-cisco-meraki",
      "_sourceId": "[variables('sourceId')]",
      "solutionVersion": "1.0.0",
      "parentId": "azuresentinel-ciscomeraki",
      "_parentId": "[variables('parentId')]",
      "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
      "dataConnectorTemplateSpecName": "[concat(parameters('workspace'),'-',variables('_dataConnectorContentId'))]",
      "dataConnectorVersion": "1.0.0",
      "dataConnectorContentId": "CiscoMerakiNativePoller",
      "_dataConnectorContentId": "[variables('dataConnectorContentId')]",
      "dataConnectorId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId'))]",
      "_dataConnectorId": "[variables('dataConnectorId')]",
      "dataCollectionRuleId": "CiscoMerakiRule",
      "logAnalyticsTableId": "CiscoMerakiNativePoller_CL",
      "streamName": "MyTableRawData",
      "uiConfigId": "CiscoMerakiNativePolling",
      "_uiConfigId": "[variables('uiConfigId')]"
    },
    "resources": [
      {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId'))]",
        "apiVersion": "2021-03-01-preview",
        "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
        "location": "[parameters('workspace-location')]",
        "kind": "APIPolling",
        "properties": {
          "connectorUiConfig": {
            "id": "CiscoMerakiNativePolling",
            "title": "Cisco Meraki (using REST API)",
            "publisher": "Microsoft",
            "descriptionMarkdown": "The [Cisco Meraki](https://aka.ms/ciscomeraki) connector allows you to easily connect your Cisco Meraki MX [security events](https://aka.ms/ciscomerakisecurityevents) to Microsoft Sentinel. The data connector uses [Cisco Meraki REST API](https://developer.cisco.com/meraki/api-v1/#!get-organization-appliance-security-events) to fetch security events and supports DCR-based [ingestion time transformations](https://docs.microsoft.com/azure/azure-monitor/logs/custom-logs-overview) that parses the received security event data into a custom columns so that queries don't need to parse it again, thus resulting in better performance.\n\n **Supported ASIM schema:** \n 1. Network Session",
            "graphQueriesTableName": "[variables('logAnalyticsTableId')]",
            "graphQueries": [
              {
                "metricName": "Total events received",
                "legend": "Cisco Meraki Security Events",
                "baseQuery": "{{graphQueriesTableName}}"
              }
            ],
            "sampleQueries": [
              {
                "description": "Get Sample of Cisco Meraki Security Events",
                "query": "{{graphQueriesTableName}}\n | take 10"
              },
              {
                "description": "Total Events by Event Type",
                "query": "{{graphQueriesTableName}}\n | summarize count() by EventOriginalType"
              },
              {
                "description": "Get Rest API Data from Query Time Parser",
                "query": "CiscoMeraki\n| where Type == \"{{graphQueriesTableName}}\""
              }
            ],
            "dataTypes": [
              {
                "name": "{{graphQueriesTableName}}",
                "lastDataReceivedQuery": "{{graphQueriesTableName}}\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
              }
            ],
            "connectivityCriterias": [
              {
                "type": "SentinelKindsV2",
                "value": []
              }
            ],
            "availability": {
              "status": 1,
              "isPreview": true
            },
            "permissions": {
              "resourceProvider": [
                {
                  "provider": "Microsoft.OperationalInsights/workspaces",
                  "permissionsDisplayText": "Read and Write permissions are required.",
                  "providerDisplayName": "Workspace",
                  "scope": "Workspace",
                  "requiredPermissions": {
                    "write": true,
                    "read": true,
                    "delete": true
                  }
                },
                {
                  "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                  "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                  "providerDisplayName": "Keys",
                  "scope": "Workspace",
                  "requiredPermissions": {
                    "action": true
                  }
                }
              ],
              "customs": [
                {
                  "name": "Monitoring Contributor",
                  "description": "This access is required on Subscription and/or Resource group. [Refer to the documentation for more details.](https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/data-collection-rule-overview)"
                },
                {
                  "name": "Cisco Meraki REST API Key",
                  "description": "Enable API access in Cisco Meraki and generate API Key. Please refer to Cisco Meraki official [documentation](https://aka.ms/ciscomerakiapikey) for more information."
                },
                {
                  "name": "Cisco Meraki Organization Id",
                  "description": "Obtain your Cisco Meraki organization id to fetch security events. Follow the steps in the [documentation](https://aka.ms/ciscomerakifindorg) to obtain the Organization Id using the Meraki API Key obtained in previous step."
                }
              ]
            },
            "instructionSteps": [
              {
                "title": "Connect Cisco Meraki Security Events to Microsoft Sentinel",
                "description": "To enable Cisco Meraki Security Events for Microsoft Sentinel, provide the required information below and click on Connect.\n>This data connector depends on a parser based on a Kusto Function to render the content. [**CiscoMeraki**](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/CiscoMeraki/Parsers/CiscoMeraki.txt) Parser currently support only \"**IDS Alert**\" and \"**File Scanned**\" Events.",
                "instructions": [
                  {
                    "parameters": {
                      "enable": "true",
                      "userRequestPlaceHoldersInput": [
                        {
                          "displayText": "Organization Id",
                          "requestObjectKey": "apiEndpoint",
                          "placeHolderName": "{{organization}}"
                        }
                      ],
                      "transformation": {
                        "transformationType": "predefinedTransformation",
                        "outputStream": "[concat('Custom-', variables('streamName'))]",
                        "dataCollectionRuleTemplateSpecName": "[variables('dataCollectionRuleId')]",
                        "logAnalyticsTableTemplateSpecName": "[variables('logAnalyticsTableId')]"
                      }
                    },
                    "type": "APIKey"
                  }
                ]
              }
            ]
          },
          "pollingConfig": {
            "owner": "ASI",
            "version": "2.0",
            "source": "PaaS",
            "templateFilePath": "",
            "templateFileName": "",
            "auth": {
              "authType": "APIKey",
              "APIKeyName": "X-Cisco-Meraki-API-Key",
              "IsAPIKeyInPostPayload": false
            },
            "request": {
              "apiEndpoint": "https://api.meraki.com/api/v1/organizations/{{organization}}/appliance/security/events",
              "rateLimitQPS": 10,
              "queryWindowInMin": 5,
              "httpMethod": "GET",
              "queryTimeFormat": "UnixTimestamp",
              "startTimeAttributeName": "t0",
              "endTimeAttributeName": "t1",
              "queryParameters": {
                "perPage": 1000
              },
              "retryCount": 3,
              "timeoutInSeconds": 60,
              "headers": {
                "Accept": "application/json",
                "User-Agent": "Scuba"
              }
            },
            "paging": {
              "pagingType": "LinkHeader"
            },
            "response": {
              "eventsJsonPaths": [
                "$"
              ]
            }
          }
        }
      }
    ]
  }
