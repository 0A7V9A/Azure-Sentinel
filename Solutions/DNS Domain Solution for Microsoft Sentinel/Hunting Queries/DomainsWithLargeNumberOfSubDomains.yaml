id: 5366b848-0886-439f-b312-0b94bb687d06
name: Top 25 Domains with large number of Subdomains (ASIM DNS Solution)
description: |
  'Large number of subdomains for a domain may be indicator of suspicious domain. This query lists top 25 Domains with most Subdomains.'

tags:
  - Schema: ASimDns
    SchemaVersion: 0.1.6
requiredDataConnectors:
  - connectorId: ASimDnsActivityLogs
    dataTypes:
      - ASimDnsActivityLogs
  - connectorId: GCPDNSDataConnector
    dataTypes:
      - GCPCloudDNS
  - connectorId: AzureFirewall
    dataTypes:
      - AzureDiagnostics
  - connectorId: CiscoUmbrellaDataConnector
    dataTypes:
      - Cisco_Umbrella_proxy_CL
  - connectorId: Corelight
    dataTypes:
      - Corelight
  - connectorId: InfobloxNIOS
    dataTypes:
      - Syslog
  - connectorId: NXLogDnsLogs
    dataTypes:
      - NXLog_DNS_Server_CL
  - connectorId: DNS
    dataTypes:
      - DnsEvents
  - connectorId: AIVectraStream
    dataTypes:
      - VectraStream
  - connectorId: WindowsForwardedEvents
    dataTypes:
      - WindowsEvents
  - connectorId: Zscaler
    dataTypes:
      - CommonSecurityLog
  - connectorId: ISCBind
    dataTypes:
      - Syslog

tactics:
  - CommandAndControl

query: |
  let lookback=1d;
  _Im_Dns(starttime=ago(lookback),endtime=now())
  | distinct DnsQuery
  | extend DomainParts = split(DnsQuery,'.')
  | extend DomainName = strcat(DomainParts[toint(array_length(DomainParts)-2)],'.',DomainParts[toint(array_length(DomainParts)-1)])
  | summarize SubDomainCount=dcount(DnsQuery),make_list(DnsQuery) by DomainName
  | order by SubDomainCount
  | take 25

entityMappings:
  - entityType: DNS
    fieldMappings:
      - identifier: DomainName
        columnName: DomainName