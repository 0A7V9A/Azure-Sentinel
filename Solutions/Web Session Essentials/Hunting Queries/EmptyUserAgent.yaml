id: 69e53015-a309-4a8f-a94d-df61a9217e2f
name: Empty User Agent Detected (ASIM Web Session)
description: |
  'Rule helps to detect empty and unusual user agent indicating web browsing activity by an unusual process other than a web browser.'
tags:
  - Schema: WebSession
    SchemaVersion: 0.2.6
requiredDataConnectors: []
tactics:
  - InitialAccess
relevantTechniques:
  - T1190
  - T1133
query: |
  let lookBack = 1d;
  _Im_WebSession(starttime=ago(lookBack))
  | where isempty(HttpUserAgent)
  | summarize Count=count(), EventStartTime= min(TimeGenerated), EventEndTime=max(TimeGenerated) by SrcIpAddr, DstIpAddr, Url, SrcUsername, DstHostname, SrcHostname
  | extend Name = iif(SrcUsername contains "@", tostring(split(SrcUsername,'@',0)[0]),SrcUsername), UPNSuffix = iif(SrcUsername contains "@",tostring(split(SrcUsername,'@',1)[0]),"")
  | extend IP_0_Address = SrcIpAddr
  | extend IP_1_Address = DstIpAddr
  | extend Account_0_Name = Name
  | extend Account_0_UPNSuffix = UPNSuffix
  | extend URL_0_Url = Url
entityMappings:
  - entityType: URL
    fieldMappings:
      - identifier: Url
        columnName: Url
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SrcIpAddr
      - identifier: Address
        columnName: DstIpAddr
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: Name
      - identifier: UPNSuffix
        columnName: UPNSuffix
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: SrcHostname
version: 1.0.0