id: 05f5cccd-ee93-4293-b7ad-05820aaa54a4
name: Kali Linux UserAgent Detected (ASIM Web Session)
description: |
  'This rule helps to detect usage of Kali Linux in your environment'
tags:
  - Schema: WebSession
    SchemaVersion: 0.2.6
requiredDataConnectors: []
tactics:
  - Exfiltration
relevantTechniques:
  - T1048.003
query: |
  let lookback = 1d;
  _Im_WebSession (starttime=ago(lookback))
  | project HttpUserAgent, SrcIpAddr, SrcUsername, SrcHostname, Url, TimeGenerated
  //| where HttpUserAgent matches regex "(?i).*Linux.*Kali.*|.*Kali.*Linux.*"
  | where HttpUserAgent has_all ("Linux", "Kali")
  | summarize EventCount=count(), EventStartTime=min(TimeGenerated), EventEndTime = max(TimeGenerated), URLs = make_set(Url,100) by HttpUserAgent, SrcIpAddr, SrcUsername, SrcHostname
  | extend Name = tostring(split(SrcUsername,'@',0)[0]), UPNSuffix = tostring(split(SrcUsername,'@',1)[0])
  | extend IP_0_Address = SrcIpAddr
  | extend Account_0_Name = Name
  | extend Account_0_UPNSuffix = UPNSuffix
  | extend Host_0_HostName = SrcHostname
  | extend URL_0_Url = Url
entityMappings:
  - entityType: URL
    fieldMappings:
      - identifier: Url
        columnName: Url
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SrcIpAddr
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: Name
      - identifier: UPNSuffix
        columnName: UPNSuffix
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: SrcHostname
version: 1.0.0