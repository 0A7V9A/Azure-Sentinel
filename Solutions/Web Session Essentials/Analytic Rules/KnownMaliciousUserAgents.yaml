id: 2d50d937-d7f2-4c05-b151-9af7f9ec747e
name: Detect known malicious user agents (ASIM Web Session)
description: |
  'This rule is designed to flag web requests that contain a user agent header that is recognized as malicious. It relies on a predefined list of known user agents, which is referenced from a specific CSV file'
severity: Medium
status: Available 
tags:
  - Schema: WebSession
    SchemaVersion: 0.2.6
requiredDataConnectors: []
queryFrequency: 15m
queryPeriod: 15m
triggerOperator: gt
triggerThreshold: 0
tactics:
  - InitialAccess
relevantTechniques:
  - T1190
  - T1133
query: |
  let knownUserAgentsIndicators = materialize(externaldata(UserAgent:string, Category:string)
        [ @"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/UnusualUserAgents.csv"] 
            with(format="csv", ignoreFirstRecord=True)
            | extend joiner = 1);
    let knownUserAgents=toscalar(knownUserAgentsIndicators | where isnotempty(UserAgent) | summarize make_list(UserAgent,1000));
    _Im_WebSession (httpuseragent_has_any=knownUserAgents)
    | extend joiner = 1
    | join kind=inner knownUserAgentsIndicators on joiner
    | where HttpUserAgent contains UserAgent
    | summarize EventCount=count() by SrcIpAddr, Url,HttpUserAgent, SrcUsername, DstIpAddr, Category
entityMappings:
  - entityType: URL
    fieldMappings:
      - identifier: Url
        columnName: Url
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SrcIpAddr
      - identifier: Address
        columnName: DstIpAddr
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: SrcUsername
eventGroupingSettings:
  aggregationKind: AlertPerResult
alertDetailsOverride:
  alertDisplayNameFormat: "The host with IPAddress '{{SrcIpAddr}}'' requested this URL {{Url}} using the HTTP user agent header {{HttpUserAgent}}. This user agent has been classified as '{{Category}}'"
  alertDescriptionFormat: "In order to ascertain the accuracy of this alert and ensure it is not a false positive, it is crucial to 
                          conduct further analysis of this request. This entails delving deeper into the characteristics, behavior, and context 
                          surrounding this request to gather more information and evidence. By thoroughly investigating this request, its associated components, and 
                          any related activities or patterns, it becomes possible to make an informed determination regarding the validity of the alert"
version: 1.0.0
kind: Scheduled