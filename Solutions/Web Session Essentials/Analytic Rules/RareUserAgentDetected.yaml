id: 2d50d937-d7f2-4c05-b151-9af7f9ec747e
name: Detect presence of uncommon user agents in web requests (ASIM Web Session)
description: |
  'This rule assists in detecting rare user agents, which may indicate web browsing activity by an 
    unconventional process different from the usual ones. The rule specifically searches for UserAgent 
    strings that have not been seen in the past 14 days'
severity: Medium
status: Available 
tags:
  - Schema: WebSession
    SchemaVersion: 0.2.6
requiredDataConnectors: []
queryFrequency: 1h
queryPeriod: 14d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - InitialAccess
relevantTechniques:
  - T1190
  - T1133
query: |
  let lookBack = 14d;
  let timeframe = 1h;
  let user_agents_list = _Im_WebSession(starttime=ago(lookBack), endtime=datetime_add('hour',-1,now())) // endtime until 1 hour before
  | summarize make_set(HttpUserAgent);
  _Im_WebSession (starttime=ago(timeframe))
  | project SrcIpAddr, SrcUsername, DstIpAddr Url, HttpUserAgent, TimeGenerated
  | where isnotempty( HttpUserAgent)
  | where HttpUserAgent !in~ (user_agents_list)
  | summarize EventCount=count(), EventStartTime=min(TimeGenerated), EventEndTime=max(TimeGenerated) by SrcIpAddr, SrcUsername, DstIpAddr, Url, HttpUserAgent
entityMappings:
  - entityType: URL
    fieldMappings:
      - identifier: Url
        columnName: Url
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SrcIpAddr
      - identifier: Address
        columnName: DstIpAddr
eventGroupingSettings:
  aggregationKind: AlertPerResult
customDetails:
  EventCount: Count
alertDetailsOverride:
  alertDisplayNameFormat: "The system has detected that a client with the IP address '{{SrcIpAddr}}' is accessing the URL '{{Url}}' using a rare user agent."
  alertDescriptionFormat: "The user agent '{{HttpUserAgent}}' has not been observed in the past 14 days. Therefore, additional investigation is required to understand the motive behind the detection of this specific user agent linked to the IP address '{{SrcIpAddr}}'. The URL is associated with the IP address '{{DstIpAddr}}'."
version: 1.0.0
kind: Scheduled