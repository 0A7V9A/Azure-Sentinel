id: 7bb55d05-ef39-4a40-8079-0bc3c05e7881
name: Detect Local File Inclusion in web requests (ASIM Web Session)
description: |
  'LFI vulnerabilities allow an attacker to read (and sometimes execute) files on the victim machine. This can be very dangerous because if the web server is misconfigured and running with high privileges, the attacker may gain access to sensitive information'
severity: High
status: Available 
tags:
  - Schema: WebSession
    SchemaVersion: 0.2.6
requiredDataConnectors: []
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
  - InitialAccess
relevantTechniques:
  - T1190
  - T1133
query: |
  // You can add more keywords to the query as necessary, depending on the specific indicators you want to detect.
  let cmd_list = dynamic(['/etc/shadow', '/etc/passwd', '/etc/hosts', '/etc/ssh/', '..\\', '../', 'proc/self/environ']);
  _Im_WebSession (starttime=ago(1h), eventresult='Success')
  | where isnotempty(Url)
  | project Url, SrcIpAddr, SrcUsername, DstIpAddr, TimeGenerated
  | extend Decoded_url = url_decode(Url)
  | where Decoded_url  has_any (cmd_list)
  | summarize EventCount=count(), EventStartTime=min(TimeGenerated), EventEndTime=max(TimeGenerated) by SrcIpAddr, SrcUsername, Url, Decoded_url, DstIpAddr
  | order by EventCount desc
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SrcIpAddr
  - entityType: URL
    fieldMappings:
      - identifier: Url
        columnName: Url
eventGroupingSettings:
  aggregationKind: AlertPerResult
customDetails:
  EventCount: Count
  Decoded_url: Decoded_url
alertDetailsOverride:
  alertDisplayNameFormat: "The system has identified a client with the IP address '{{SrcIpAddr}}' making a request for '{{Url}}' that includes a recognizable malicious command"
  alertDescriptionFormat: "In order to ascertain the accuracy of this alert and ensure it is not a false positive, it is crucial to 
                          conduct further analysis of the detected URL. This entails delving deeper into the characteristics, behavior, and context 
                          surrounding the URL to gather more information and evidence. By thoroughly investigating the URL, its associated components, and 
                          any related activities or patterns, it becomes possible to make an informed determination regarding the validity of the alert"
version: 1.0.0
kind: Scheduled