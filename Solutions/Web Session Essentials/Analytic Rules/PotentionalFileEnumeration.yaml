id: b3731ce1-1f04-47c4-95c2-9827408c4375
name: Detect potential file enumeration activity (ASIM Web Session)
description: |
  'This detection method identifies potential cases of file enumeration activity. The query is designed to identify client sources that generate multiple requests resulting in 404 error codes'
severity: Medium
status: Available 
tags:
  - Schema: WebSession
    SchemaVersion: 0.2.6
requiredDataConnectors: []
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
  - Discovery
relevantTechniques:
  - T1083
query: |
  // HTTP response status codes indicate whether a specific HTTP request has been successfully completed.
  // Please refer this for more details: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status
  let ErrorCode=dynamic(["404"]);
  let threshold = 10;
  let FileNotFoundRequests = 
    _Im_WebSession (starttime=ago(1h), eventresultdetails_in=(ErrorCode))
    // Filter the logs to include only HTTP GET requests with an HTTP status code of 404 and '/' in the URL
    | where HttpRequestMethod =~ "GET" and Url contains "/";
  FileNotFoundRequests
  | summarize RequestCount = count(), FileCount=dcount(Url), RequestedURLs = make_set(Url, 100), DestinationIPList=make_set(DstIpAddr,100) by SrcIpAddr, SrcUsername, bin(TimeGenerated, 1h)
  | where RequestCount > threshold  // Adjust the threshold as per your requirements
  | project SrcIpAddr, SrcUsername, TimeGenerated, RequestCount, FileCount, RequestedURLs, DestinationIPList
  | order by RequestCount desc
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SrcIpAddr
eventGroupingSettings:
  aggregationKind: AlertPerResult
customDetails:
  RequestCount: RequestCount
  RequestedURLs: RequestedURLs
  FileCount: FileCount
alertDetailsOverride:
  alertDisplayNameFormat: "The system has detected multiple requests from a client with the IP address '{{SrcIpAddr}}' that could indicate potential file enumeration activity"
  alertDescriptionFormat: "The client in question has generated multiple requests '{{RequestCount}}' that have resulted in error code 404, suggesting the possibility of file enumeration activity. Further analysis is necessary to ascertain the underlying reasons behind these requests from the client."
version: 1.0.0
kind: Scheduled