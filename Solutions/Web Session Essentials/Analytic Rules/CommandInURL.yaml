id: 7bb55d05-ef39-4a40-8079-0bc3c05e7881
name: Detect URLs containing known malicious keywords or commands (ASIM Web Session)
description: |
  'The utilization of system commands or functions in the request URL may suggest that an attacker is trying to gain unauthorized access to the environment by exploiting a vulnerable service.
  In a similar vein, Local File Inclusion is an attack that is executed on the system, where all attack payloads are delivered via the URL'
severity: High
status: Available 
tags:
  - Schema: WebSession
    SchemaVersion: 0.2.6
requiredDataConnectors: []
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
  - InitialAccess
relevantTechniques:
  - T1190
  - T1133
query: |
  // You can add more keywords to the query as necessary, depending on the specific indicators you want to detect.
  let cmd_list = dynamic(['ping -i', 'phpinfo()', '/bin/bash -c', 'sleep(', '<script>', 'whoami', 'dpkg', 'useradd', 'sudo', 'cat','wget','python', 'gcc', 'systeminfo']);
  _Im_WebSession (starttime=ago(1h), eventresult='Success')
  | where isnotempty(Url)
  | project Url, SrcIpAddr, SrcUsername, DstIpAddr, TimeGenerated
  | extend Decoded_url = url_decode(Url)
  | where Decoded_url  has_any (cmd_list)
  | summarize EventCount=count(), EventStartTime=min(TimeGenerated), EventEndTime=max(TimeGenerated) by SrcIpAddr, SrcUsername, Url, Decoded_url, DstIpAddr
  | extend Name = iif(SrcUsername contains "@", tostring(split(SrcUsername,'@',0)[0]),SrcUsername), UPNSuffix = iif(SrcUsername contains "@",tostring(split(SrcUsername,'@',1)[0]),"")
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SrcIpAddr
      - identifier: Address
        columnName: DstIpAddr
  - entityType: URL
    fieldMappings:
      - identifier: Url
        columnName: Url
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: Name
      - identifier: UPNSuffix
        columnName: UPNSuffix
eventGroupingSettings:
  aggregationKind: AlertPerResult
customDetails:
  EventCount: EventCount
  Decoded_url: Decoded_url
alertDetailsOverride:
  alertDisplayNameFormat: "Client with the IP address '{{SrcIpAddr}}' has been identified as making request for URL '{{Url}}' that includes a recognizable malicious command"
version: 1.0.0
kind: Scheduled