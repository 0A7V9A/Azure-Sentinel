id: c6608467-3678-45fe-b038-b590ce6d00fb
name: A client made a web request to a potentially harmful file (ASIM Web Session)
description: |
  'This rule identifies a web request to a URL that holds a file type, including .ps1, .bat, .vbs, and .scr that can be harmful if downloaded. This rule uses the [Advanced Security Information Model (ASIM)](https://aka.ms/AboutASIM) and supports any web session source that complies with ASIM. To use this Analytics Rule, deploy the Advanced Security Information Model (ASIM)'
severity: Medium
status: Available 
tags:
  - Schema: WebSession
    SchemaVersion: 0.2.6
requiredDataConnectors: []
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
  - InitialAccess
relevantTechniques:
  - 
query: |
  let mal_file_exts_list = dynamic([".exe", ".dll", ".bat", ".cmd", ".vbs", ".jse", ".wsf", ".wsh", ".ps1", ".psm1", ".hta"]);
  _Im_WebSession (url_has_any=mal_file_exts_list,eventresult='Success')
  | project Url, SrcIpAddr
  | where Url has_any (mal_file_exts_list)
  | extend requestedFileName=tostring(split(tostring(parse_url(Url)["Path"]),'/')[-1])
  | extend requestedFileExt=extract(@'(\.\w+)$',1,requestedFileName, typeof(string))
  | where requestedFileExt in (mal_file_exts_list)
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SrcIpAddr
  - entityType: URL
    fieldMappings:
      - identifier: Url
        columnName: Url
eventGroupingSettings:
  aggregationKind: AlertPerResult
customDetails:
  UserAgentCount: UserAgentCount
  UserAgentArray: UserAgentArray
  UserAgentThreshold: threshold
alertDetailsOverride:
  alertDisplayNameFormat: "Client {{SrcIpAddr}} accessed a URL with potentially harmful extension {{requestedFileExt}}"
  alertDescriptionFormat: "The client at address {{SrcIpAddr}} accessed the URL {{Url}} that has the extension {{requestedFileExt}}. Downloading a file with this extension may be harmful and may indicate malicious activity."
version: 1.0.0
kind: Scheduled