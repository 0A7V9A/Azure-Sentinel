id: 6a71687f-00cf-44d3-93fc-8cbacc7b5615
name: Detect potential presence of a malicious file with a double extension (ASIM Web Session)
description: |
  'Double extension vulnerability is a significant concern in file uploads, as it can lead to various 
    issues if an attacker successfully uploads a virus-infected file. Adversaries often exploit this 
    vulnerability by utilizing a double extension in the filename to camouflage the actual file type,
    thereby disguising the malicious content.'
severity: Medium
status: Available 
tags:
  - Schema: WebSession
    SchemaVersion: 0.2.6
requiredDataConnectors: []
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
  - InitialAccess
  - Exfiltration
relevantTechniques:
  - T1190
  - T1133
  - T1048
query: |
  let common_file_ext_list = dynamic([".txt", ".xlsx", ".doc", ".docx", ".csv", ".pdf", ".png", ".jpg", ".jpeg"]); // Add list of common files as per your environment
  _Im_WebSession (starttime=ago(1h), eventresult='Success')
  | where HttpRequestMethod in~ ("POST", "PUT") 
  | project Url, SrcIpAddr, SrcUsername, DstIpAddr, TimeGenerated
  | extend requestedFileName=tostring(split(tostring(parse_url(Url)["Path"]),'/')[-1])
  | extend FileWithdualextension = extract(@'([\w-]+\.\w+\.\w+)$',1, requestedFileName,typeof(string))
  | extend FirstExt = tostring(split(FileWithdualextension,'.')[-2])
  | where strcat('.',FirstExt) in~ (common_file_ext_list) // First extension is mostly from the common files
  | summarize EventCount=count(), EventStartTime=min(TimeGenerated), EventEndTime=max(TimeGenerated) by SrcIpAddr, Url, FileWithdualextension, SrcUsername, DstIpAddr
entityMappings:
  - entityType: File
    fieldMappings:
      - identifier: Name
        columnName: FileWithdualextension
  - entityType: URL
    fieldMappings:
      - identifier: Url
        columnName: Url
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SrcIpAddr
eventGroupingSettings:
  aggregationKind: AlertPerResult
customDetails:
  EventCount: EventCount
alertDetailsOverride:
  alertDisplayNameFormat: "The system has detected that a client with the IP address '{{SrcIpAddr}}' has made a request to a URL that contains a file '{{FileWithdualextension}}' with a potentially malicious double extension"
  alertDescriptionFormat: "In order to verify that this alert is not a false positive, additional analysis is necessary.
                          The vulnerability related to double extensions in file uploads is a serious concern, as it can 
                          result in various complications if an attacker successfully uploads a file infected with a virus.
                          Adversaries commonly take advantage of this vulnerability by employing a double extension in the 
                          filename to conceal the true file type, thus masking the malicious content"
version: 1.0.0
kind: Scheduled