{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
        
        "basics": [
        
            {
                "name": "getLAWorkspace",
                "type": "Microsoft.Solutions.ArmApiControl",
                "toolTip": "This filters by workspaces that exist in the Resource Group selected",
                "condition": "[greater(length(resourceGroup().name),0)]",
                "request": {
                    "method": "GET",
                    "path": "[concat(subscription().id,'/providers/Microsoft.OperationalInsights/workspaces?api-version=2020-08-01')]"
                }
            },
        
            {
                "name": "WorkspaceSelectInstruction",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                    "text": "Select the workspace where you would like to ingest the data into. We will deploy this data connector and supported resources into the same region as your workspace's region"
                }
            },
            {
                "name": "loganalyticsworkspace",
                "type": "Microsoft.Common.DropDown",
                "label": "Workspace",
                "placeholder": "Select a workspace",
                "toolTip": "This dropdown will list the available workspaces to select for data ingestion",
                "constraints": {
                    "allowedValues": "[map(basics('getLAWorkspace').value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
                    "required": true
                },
                "visible": true
            },
            {
                "name": "AzureFunctionsDetailsSection",
                "type": "Microsoft.Common.Section",
                "label": "Azure Functions Configuration",
                "elements": [
                    {
                        "name": "function-name",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Connector Instance",
                        "placeholder": "",
                        "defaultValue": "Instance 01",
                        "toolTip": "",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Instance 01",
                                    "value": "csfdr01"
                                },
                                {
                                    "label": "Instance 02",
                                    "value": "csfdr02"
                                },
                                {
                                    "label": "Instance 03",
                                    "value": "csfdr03"
                                },
                                {
                                    "label": "Instance 04",
                                    "value": "csfdr04"
                                },
                                {
                                    "label": "Instance 05",
                                    "value": "csfdr05"
                                },
                                {
                                    "label": "Instance 06",
                                    "value": "csfdr06"
                                },
                                {
                                    "label": "Instance 07",
                                    "value": "csfdr07"
                                },
                                {
                                    "label": "Instance 08",
                                    "value": "csfdr08"
                                },
                                {
                                    "label": "Instance 09",
                                    "value": "csfdr09"
                                },
                                {
                                    "label": "Instance 10",
                                    "value": "csfdr10"
                                }
                            ],
                            "required": true
                        },
                        "visible": true
                    }
                ]
            }
        ],
        "steps": [
            {
                "name": "AzureFunctionsAppConfig",
                "label": "Provide Credentials",
                "elements": [
                    {
                        "name": "DummySpace10",
                        "type": "Microsoft.Common.InfoBox",
                        "visible": "[steps('DataIngestionConfig').flag-raw-copy-normdata]",
                        "options": {
                            "icon": "",
                            "text": ""
                        }
                    },
                    {
                        "name": "CrowdStrikeAWSDetails",
                        "type": "Microsoft.Common.Section",
                        "label": "CrowdStrike AWS details",
                        "elements": [
                            {
                                "name": "CrowdStrike_AWS_Key",
                                "type": "Microsoft.Common.TextBox",
                                "label": "AWS Access Key ID",
                                "placeholder": "AKIARJFBAG3EGHFG2FPN",
                                "toolTip": "Enter valid AWS Key Id. For example AKIARKFBAG3EGIFG9FPN",
                                "constraints": {
                                    "required": true,
                                    "regex": "([A-Z0-9+/]{20})",
                                    "validationMessage": "Enter valid AWS Key"
                                },
                                "visible": true
                            },
                            {
                                "name": "CrowdStrike_AWS_Secret",
                                "type": "Microsoft.Common.TextBox",
                                "label": "AWS Secret Access Key",
                                "placeholder": "Js6IDrwAIkvSY+8fSJ5bcep05ENlNvXgc+JRRr7Y",
                                "toolTip": "Enter valid AWS Secret key. For example. For example Js6IDrpAIkvSS+8fSK5bcep05EMlNvXgc+JRRr7Y ",
                                "constraints": {
                                    "required": true,
                                    "regex": "([a-zA-Z0-9+/]{40})",
                                    "validationMessage": "Enter valid Access key"
                                },
                                "visible": true
                            },
                            {
                                "name": "CrowdStrike_AWS_Region_Name",
                                "type": "Microsoft.Common.TextBox",
                                "label": "AWS Region",
                                "placeholder": "us-west-2",
                                "toolTip": "Enter valid region. Examples - us-west-2",
                                "constraints": {
                                    "required": true,
                                    "regex": "(us(-gov)?|ap|ca|cn|eu|sa)-(central|(north|south)?(east|west)?)-[0-9]",
                                    "validationMessage": "Enter valid AWS region name"
                                },
                                "visible": true
                            },
                            {
                                "name": "CrowdStrike_AWS_SQS_URL",
                                "type": "Microsoft.Common.TextBox",
                                "label": "SQS Queue URL",
                                "placeholder": "https://sqs.us-east-2.amazonaws.com/123456789012/MyQueue",
                                "toolTip": "Enter valid SQS queue URL. examples - https://sqs.us-east-2.amazonaws.com/123456789012/MyQueue ",
                                "constraints": {
                                    "required": true,
                                    "regex": "(https|http)[:][\/]{2}(sqs)[.][a-z]{2}[-][a-z]{3,}[-][0-9]{1}[.](amazonaws.com)[\/][0-9]{12}[\/]{1}[a-zA-Z0-9-_]{0,80}",
                                    "validationMessage": "Enter valid SQS queue URL"
                                },
                                "visible": true
                            }
                        ]
                    },
                    {
                        "name": "AADAppDetailsforAuthentication",
                        "type": "Microsoft.Common.Section",
                        "label": "Azure AD Application Details",
                        "elements": [
                            {
                                "name": "AADTenantId",
                                "type": "Microsoft.Common.TextBox",
                                "label": "AAD Tenant Id",
                                "placeholder": "72f988bf-86f1-41af-91ab-2d7cd011db47",
                                "toolTip": "If you dont have AAD application created, create one by following [instructions provided here](https://learn.microsoft.com/en-us/azure/azure-monitor/logs/tutorial-logs-ingestion-portal#create-azure-ad-application).Copy Tenant Id and enter here. For example: 72f988bf-86f1-41af-91ab-2d7cd011db47",
                                "constraints": {
                                    "required": true,
                                    "regex": "(^[{]?[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}[}]?$)",
                                    "validationMessage": "Enter valid AAD Tenant (Directory) Id"
                                },
                                "visible": true
                            },
                            {
                                "name": "AADApplicationId",
                                "type": "Microsoft.Common.TextBox",
                                "label": "AAD App (client) Id",
                                "placeholder": "969f7b17-415f-4d01-8ab5-7a7db3aa39cb",
                                "toolTip": "If you dont have AAD application created, create one by following [instructions provided here](https://learn.microsoft.com/en-us/azure/azure-monitor/logs/tutorial-logs-ingestion-portal#create-azure-ad-application).Copy Application Id and enter here. For example: 969f7b17-415f-4d01-8ab5-7a7db3aa39cb",
                                "constraints": {
                                    "required": true,
                                    "regex": "(^[{]?[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}[}]?$)",
                                    "validationMessage": "Enter valid AAD App (client) Id"
                                },
                                "visible": true
                            },
                            {
                                "name": "AADApplicationSecret",
                                "type": "Microsoft.Common.TextBox",
                                "label": "AAD App Secret Key",
                                "placeholder": "oYo8Q~Tno3m6AmFEjgUoWfi2JIjB_1LkB-I.vaWo",
                                "toolTip": "If you dont have AAD application created, create one by following [instructions provided here](https://learn.microsoft.com/en-us/azure/azure-monitor/logs/tutorial-logs-ingestion-portal#create-azure-ad-application).Copy Secret key and enter here. For example: oYo8Q~Tno3m6AmFEjgUoWfi2JIjB_1LkB-I.vaWo",
                                "constraints": {
                                    "required": true,
                                    "regex": "([A-z0-9.~+-\/]{30,50})",
                                    "validationMessage": "Enter valid secret key"
                                },
                                "visible": true
                            }
                        ]
                    },
                   
                    {
                        "name": "CrowdStrikeEPSSection",
                        "type": "Microsoft.Common.Section",
                        "label": "Event Volume Expectations",
                        "elements": [
                            {
                                "name": "Expected_EPS_volume",
                                "type": "Microsoft.Common.Slider",
                                "min": 1,
                                "max": 250000,
                                "label": "CrowdStrike Ingestion EPS (Approx)",
                                "subLabel": "EPS",
                                "defaultValue": 40000,
                                "showStepMarkers": false,
                                "toolTip": "Pick the expected ingestion EPS for this connector. We use this to determine the function app plan that requires to handles this workloads",
                                "constraints": {
                                    "required": true
                                },
                                "visible": true
                            },
                            {
                                "name": "FunctionAppSelectedPlanConsumption",
                                "type": "Microsoft.Common.InfoBox",
                                "visible": "[lessOrEquals(steps('AzureFunctionsAppConfig').CrowdStrikeEPSSection.Expected_EPS_volume,40000)]",
                                "options": {
                                    "icon": "Info",
                                    "text": "Based on the EPS you have selected above, we are auto selecting <b>Consumption</b> plan for azure functions. To know more details about different plans, you can visit https://learn.microsoft.com/en-us/azure/azure-functions/functions-scale#overview-of-plans"
                                }
                            },
                            {
                                "name": "FunctionAppSelectedPlanEP1",
                                "type": "Microsoft.Common.InfoBox",
                                "visible": "[and(greater(steps('AzureFunctionsAppConfig').CrowdStrikeEPSSection.Expected_EPS_volume,40000), lessOrEquals(steps('AzureFunctionsAppConfig').CrowdStrikeEPSSection.Expected_EPS_volume,80000))]",
                                "options": {
                                    "icon": "Info",
                                    "text": "Based on the EPS you have selected above, we are auto selecting <b>Elastic Premium EP1</b> plan for azure functions. To know more details about different plans, you can visit https://learn.microsoft.com/en-us/azure/azure-functions/functions-scale#overview-of-plans"
                                }
                            },
                            {
                                "name": "FunctionAppSelectedPlanEP2",
                                "type": "Microsoft.Common.InfoBox",
                                "visible": "[and(greater(steps('AzureFunctionsAppConfig').CrowdStrikeEPSSection.Expected_EPS_volume,80000), lessOrEquals(steps('AzureFunctionsAppConfig').CrowdStrikeEPSSection.Expected_EPS_volume,100000))]",
                                "options": {
                                    "icon": "Info",
                                    "text": "Based on the EPS you have selected above, we are auto selecting <b>Elastic Premium EP2</b> plan for azure functions. To know more details about different plans, you can visit https://learn.microsoft.com/en-us/azure/azure-functions/functions-scale#overview-of-plans"
                                }
                            },
                            {
                                "name": "FunctionAppSelectedPlanEP3",
                                "type": "Microsoft.Common.InfoBox",
                                "visible": "[and(greater(steps('AzureFunctionsAppConfig').CrowdStrikeEPSSection.Expected_EPS_volume,100000), lessOrEquals(steps('AzureFunctionsAppConfig').CrowdStrikeEPSSection.Expected_EPS_volume,120000))]",
                                "options": {
                                    "icon": "Info",
                                    "text": "Based on the EPS you have selected above, we are auto selecting <b>Elastic Premium EP3</b> plan for azure functions. To know more details about different plans, you can visit https://learn.microsoft.com/en-us/azure/azure-functions/functions-scale#overview-of-plans"
                                }
                            },
                            {
                                "name": "FunctionAppSelectedPlanSplitApps",
                                "type": "Microsoft.Common.InfoBox",
                                "visible": "[greater(steps('AzureFunctionsAppConfig').CrowdStrikeEPSSection.Expected_EPS_volume,120000)]",
                                "options": {
                                    "icon": "Warning",
                                    "text": "For the EPS volume you have selected, its suggested to configure more than one instance of this connector. You can do this by selecting Deploy CrowdStrike data connector again and select Instance 02 to have another instance deployed"
                                }
                            }
                        ]
                    }
                ]
            },
            {
                "name": "VirtualMachineConfig",
                "label": "Virtual Machine Settings",
                "subLabel": {
                    "preValidation": "Configure the virtual machine's resources and settings",
                    "postValidation": "Done"
                },
                "bladeTitle": "Virtual Machine Settings",
                "elements": [
                    {
                        "name": "vmSize",
                        "type": "Microsoft.Compute.SizeSelector",
                        "label": "Virtual machine size",
                        "toolTip": "The size of virtual machine to provision.",
                        "recommendedSizes": [
                            "Standard_D2_v2",
                            "Standard_A2_v2"
                        ],
                        "osPlatform": "Linux",
                        "count": "1"
                    },
                    {
                        "name": "storageAccount",
                        "type": "Microsoft.Storage.StorageAccountSelector",
                        "label": "Diagnostic storage account",
                        "toolTip": "Storage Account for the Virtual Machine's diagnostics",
                        "defaultValue": {
                            "type": "Standard_LRS",
                            "name": "[concat(replace('test', '-', ''), take(replace(guid(), '-', ''), 10))]"
                        },
                        "constraints": {
                            "allowedTypes": [
                                "Standard_LRS",
                                "Standard_GRS"
                            ]
                        }
                    },
                    {
                        "name": "publicIpAddress",
                        "type": "Microsoft.Network.PublicIpAddressCombo",
                        "label": {
                            "publicIpAddress": "Public IP Address for the VM",
                            "domainNameLabel": "DNS Prefix for the public IP Address"
                        },
                        "toolTip": {
                            "publicIpAddress": "Public IP Address for the VM",
                            "domainNameLabel": "DNS Prefix for the public IP Address, must be globally unique"
                        },
                        "defaultValue": {
                            "publicIpAddressName": "[concat('test', '-ip')]",
                            "domainNameLabel": "[concat('test', '-', take(replace(guid(), '-', ''), 10))]"
                        },
                        "options": {
                            "hideExisting": false,
                            "hideNone": false
                        },
                        "constraints": {
                            "required": {
                                "domainNameLabel": true
                            }
                        }
                    },
                    {
                        "name": "virtualNetwork",
                        "type": "Microsoft.Network.VirtualNetworkCombo",
                        "label": {
                            "virtualNetwork": "Virtual network",
                            "subnets": "Subnets"
                        },
                        "toolTip": {
                            "virtualNetwork": "Name of the virtual network",
                            "subnets": "Subnets for the virtual network"
                        },
                        "defaultValue": {
                            "name": "VirtualNetwork",
                            "addressPrefixSize": "/16"
                        },
                        "constraints": {
                            "minAddressPrefixSize": "/16"
                        },
                        "subnets": {
                            "subnet1": {
                                "label": "Subnet",
                                "defaultValue": {
                                    "name": "Subnet-1",
                                    "addressPrefixSize": "/24"
                                },
                                "constraints": {
                                    "minAddressPrefixSize": "/24",
                                    "minAddressCount": 12,
                                    "requireContiguousAddresses": false
                                }
                            }
                        }
                    }
                ]
            }
        ],
        "outputs": {

        }
    }
}
