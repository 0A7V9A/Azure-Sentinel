{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Egress - support@egress.com",
    "comments": "Solution template for Egress Defend"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "formattedTimeNow": {
      "type": "string",
      "defaultValue": "[utcNow('g')]",
      "metadata": {
        "description": "Appended to workbook displayNames to make them unique"
      }
    },
    "workbook1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the workbook"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Egress Defend",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic2-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "connector1-name": {
      "type": "string",
      "defaultValue": "910eddef-59f9-405a-b75c-732a35fe6275"
    }
  },
  "variables": {
    "DefendMetrics_workbook": "DefendMetrics_workbook",
    "_DefendMetrics_workbook": "[variables('DefendMetrics_workbook')]",
    "workbook-source": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'))]",
    "_workbook-source": "[variables('workbook-source')]",
    "DangerousAttachmentReceived_AnalyticalRules": "DangerousAttachmentReceived_AnalyticalRules",
    "_DangerousAttachmentReceived_AnalyticalRules": "[variables('DangerousAttachmentReceived_AnalyticalRules')]",
    "DangerousLinksClicked_AnalyticalRules": "DangerousLinksClicked_AnalyticalRules",
    "_DangerousLinksClicked_AnalyticalRules": "[variables('DangerousLinksClicked_AnalyticalRules')]",
    "workspace-dependency": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]",
    "DefendAuditData_Parser": "DefendAuditData_Parser",
    "_DefendAuditData_Parser": "[variables('DefendAuditData_Parser')]",
    "connector1-source": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'),'/providers/Microsoft.SecurityInsights/dataConnectors/',parameters('connector1-name'))]",
    "_connector1-source": "[variables('connector1-source')]",
    "Connector": "Connector",
    "_Connector": "[variables('Connector')]",
    "sourceId": "egress1589289169584.azure-sentinel-solution-egress-defend",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "name": "[parameters('workbook1-id')]",
      "location": "[parameters('workspace-location')]",
      "kind": "shared",
      "apiVersion": "2022-04-01",
      "properties": {
        "displayName": "[concat(parameters('workbook1-name'), ' - ', parameters('formattedTimeNow'))]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Phishing Insights\"},\"name\":\"text - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DefendAuditData\\r\\n| where isnotempty(PhishType)\\r\\n| mv-expand todynamic(PhishType)\\r\\n| summarize EmailCount=count() by tostring(PhishType), LinksClicked\\r\\n| render columnchart\",\"size\":0,\"title\":\"Number of Detected Phish Types in 48 hours\",\"timeContext\":{\"durationMs\":172800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"unstackedbar\",\"chartSettings\":{\"xAxis\":\"PhishType\",\"seriesLabelSettings\":[{\"seriesName\":\"LinksClicked\",\"color\":\"redDark\"},{\"seriesName\":\"EmailCount\",\"color\":\"blue\"}]}},\"name\":\"query-2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DefendAuditData\\r\\n| where ThreatLevel == \\\"suspicious\\\" or ThreatLevel == \\\"dangerous\\\"\\r\\n| mv-expand todynamic(Attachments)\\r\\n| where Attachments.name matches regex @\\\"(?i)^.*\\\\.(doc|docx|docm|pdf|xls|xlsx|xlsm|html|zip)$(?-i)\\\"\\r\\n| extend path_parts = parse_path(tostring(Attachments.name))\\r\\n| where isnotempty(path_parts.Extension)\\r\\n| summarize attachmentCount=count() by tostring(path_parts.Extension)\\r\\n| render piechart\",\"size\":0,\"title\":\"Number of suspicious files detected in 48 hours\",\"timeContext\":{\"durationMs\":172800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"chartSettings\":{\"yAxis\":[\"attachmentCount\"]}},\"name\":\"query - 1\"}],\"fromTemplateId\":\"sentinel-EgressDefendMetricWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
        "version": "1.0",
        "sourceId": "[variables('_workbook-source')]",
        "category": "sentinel"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
      "apiVersion": "2023-02-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Defend has detected a user has a suspicious file type from a suspicious sender in their mailbox.",
        "displayName": "Egress Defend - Dangerous Attachment Detected",
        "enabled": false,
        "query": "DefendAuditData\n| where ThreatLevel == \"suspicious\" or ThreatLevel == \"dangerous\"\n| mv-expand todynamic(Attachments)\n| where Attachments.name matches regex @\"(?i)^.*\\.(doc|docx|docm|pdf|xls|xlsx|xlsm|html|zip)$(?-i)\"\n| summarize attachmentCount=count() by TimeGenerated, tostring(Attachments.name), Subject, From, Account_0_FullName = trim(@\"[^@.\\w]+\",Recipients), timesClicked = LinksClicked, SenderIP\n",
        "queryFrequency": "PT30M",
        "queryPeriod": "PT30M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Execution",
          "InitialAccess",
          "Persistence",
          "PrivilegeEscalation"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "columnName": "Account_0_FullName",
                "identifier": "FullName"
              }
            ]
          },
          {
            "entityType": "File",
            "fieldMappings": [
              {
                "columnName": "Attachments_name",
                "identifier": "Name"
              }
            ]
          },
          {
            "entityType": "Mailbox",
            "fieldMappings": [
              {
                "columnName": "Account_0_FullName",
                "identifier": "MailboxPrimaryAddress"
              }
            ]
          },
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "columnName": "SenderIP",
                "identifier": "Address"
              }
            ]
          }
        ],
        "alertDetailsOverride": {
          "alertDisplayNameFormat": "Alert - {{Account_0_FullName}} has suspicious attachment."
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic2-id'))]",
      "apiVersion": "2023-02-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Defend has detected a user has clicked a dangerous link in their mailbox.",
        "displayName": "Egress Defend - Dangerous Link Click",
        "enabled": false,
        "query": "DefendAuditData\n| where LinksClicked > 0\n| where ThreatLevel == \"dangerous\" or ThreatLevel == \"suspicious\"\n| extend Account_0_FullName = trim(@\"[^@.\\w]+\",Recipients)\n",
        "queryFrequency": "PT30M",
        "queryPeriod": "PT30M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Execution"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "columnName": "Account_0_FullName",
                "identifier": "FullName"
              }
            ]
          },
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "columnName": "SenderIP",
                "identifier": "Address"
              }
            ]
          },
          {
            "entityType": "URL",
            "fieldMappings": [
              {
                "columnName": "Url",
                "identifier": "Url"
              }
            ]
          },
          {
            "entityType": "Mailbox",
            "fieldMappings": [
              {
                "columnName": "Account_0_FullName",
                "identifier": "MailboxPrimaryAddress"
              }
            ]
          }
        ],
        "customDetails": {
          "timesClicked": "LinksClicked",
          "DefendSenderIP": "SenderIP",
          "DefendSender": "From"
        },
        "alertDetailsOverride": {
          "alertDisplayNameFormat": "Alert - {{Account_0_FullName}} as clicked a suspicious link."
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2022-10-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2022-10-01",
          "name": "Egress Defend Data Parser",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Egress Defend Data Parser",
            "category": "Samples",
            "functionAlias": "DefendAuditData",
            "query": "\nEgressDefend_CL\r\n| project \r\n    TimeGenerated=time_t,\r\n    Event=event_s,\r\n    Recipients=email_rcptTo_s,\r\n    From=email_mailFrom_s,\r\n    Subject=columnifexists('email_subject_s', \"\"),\r\n    Attachments=email_attachments_s,\r\n    MessageId=email_messageId_s,\r\n    ThreatLevel=email_threat_s,\r\n    TrustLevel=email_trust_s,\r\n    FirstTimeSender=email_firstTimeSender_b,\r\n    PayLoad=columnifexists('email_payload_Type_s', \"\"),\r\n    LinksClicked=email_linksClicked_d,\r\n    SenderIP=email_senderIp_s,\r\n    Url=linkClicked_s,\r\n    PhishType=email_phishType_s\r\n    ",
            "version": 1
          }
        }
      ]
    },
    {
      "id": "[variables('_connector1-source')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('connector1-name'))]",
      "apiVersion": "2023-06-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "APIPolling",
      "properties": {
        "connectorUiConfig": {
          "title": "Egress Defend",
          "publisher": "Egress Software Technologies",
          "descriptionMarkdown": "The Egress Defend audit connector provides the capability to ingest Egress Defend Data into Microsoft Sentinel.",
          "graphQueriesTableName": "EgressDefend_CL",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "Egress Defend Events",
              "baseQuery": "{{graphQueriesTableName}}"
            }
          ],
          "sampleQueries": [
            {
              "description": "All logs",
              "query": "DefendAuditData"
            }
          ],
          "dataTypes": [
            {
              "name": "{{graphQueriesTableName}}",
              "lastDataReceivedQuery": "{{graphQueriesTableName}}\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "SentinelKindsV2",
              "value": [
                "APIPolling"
              ]
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "Read and Write permissions on the Log Analytics workspace are required to enable the data connector.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true,
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Egress API Token",
                "description": "An Egress API token is required to ingest audit records to Microsoft Sentinel."
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "Connect Egress Defend with Microsoft Sentinel",
              "description": "Enter your Egress Defend API URl, Egress Domain and API token.",
              "instructions": [
                {
                  "parameters": {
                    "enable": "true",
                    "userRequestPlaceHoldersInput": [
                      {
                        "displayText": "API URL",
                        "requestObjectKey": "apiEndpoint",
                        "placeHolderName": "{{apiUrl}}"
                      },
                      {
                        "displayText": "Domain name",
                        "requestObjectKey": "apiEndpoint",
                        "placeHolderName": "{{domain}}"
                      }
                    ]
                  },
                  "type": "APIKey"
                }
              ]
            }
          ]
        },
        "pollingConfig": {
          "auth": {
            "authType": "APIKey",
            "APIKeyName": "X-Api-Key",
            "IsAPIKeyInPostPayload": false
          },
          "request": {
            "apiEndpoint": "https://{{apiUrl}}/V1/events/?pagingMode=offset&domain={{domain}}",
            "httpMethod": "Get",
            "startTimeAttributeName": "startTime",
            "endTimeAttributeName": "endTime",
            "queryTimeFormat": "yyyy-MM-ddTHH:mm:ss.fffZ",
            "retryCount": 2,
            "queryWindowInMin": 5,
            "timeoutInSeconds": 120,
            "headers": {
              "Accept": "application/json"
            }
          },
          "paging": {
            "pagingType": "Offset",
            "offsetParaName": "offset",
            "pageSizeParaName": "limit",
            "pageSize": 100
          },
          "response": {
            "eventsJsonPaths": [
              "$..items"
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2023-06-01-preview",
      "properties": {
        "version": "1.0.0",
        "kind": "Solution",
        "contentId": "[variables('_sourceId')]",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "Egress Defend",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Egress",
          "email": "support@egress.com"
        },
        "support": {
          "name": "egress1589289169584",
          "email": "support@egress.com",
          "tier": "Partner",
          "link": "https://support.egress.com/s/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_DefendMetrics_workbook')]",
              "version": "1.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_DangerousAttachmentReceived_AnalyticalRules')]",
              "version": "1.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_DangerousLinksClicked_AnalyticalRules')]",
              "version": "1.0.0"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_DefendAuditData_Parser')]",
              "version": "1.0.0"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_Connector')]",
              "version": "1.0.0"
            }
          ]
        },
        "firstPublishDate": "2023-07-26",
        "providers": [
          "Egress"
        ],
        "categories": {
          "domains": [
            "Application"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]"
    }
  ],
  "outputs": {}
}
