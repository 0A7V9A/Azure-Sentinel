// Title:           ESI - Exchange Configuration Environment List Generator
// Author:          Microsoft
// Version:         1.0
// Last Updated:    09/08/2022
// Comment:         Inital Content
//  
// DESCRIPTION:
// This parser takes raw ESI Exchange Configuration Collector to list Exchange Environments that are loaded in the table
//
// USAGE:
// 1. Open Log Analytics/Azure Sentinel Logs blade. Copy the query below and paste into the Logs query window. 
// 2. Click the Save button above the query. A pane will appear on the right, select "as Function" from the drop down. Enter the Function Name "ExchangeConfiguration".
// Parameters : 4 parameters to add during creation. 
//    1. SpecificSectionList, type string, default value ""
//    2. SpecificConfigurationDate, type string, default value "lastdate"
//    3. Target, type string, default value "On-Premises"
//    4. SpecificConfigurationEnv, type string, default value "All"
// 3. Function App usually take 10-15 minutes to activate. You can then use Function Alias for other queries
//
//
// REFERENCE: 
// Using functions in Azure monitor log queries: https://docs.microsoft.com/azure/azure-monitor/log-query/functions
//
// LOG SAMPLES:
// This parser assumes the raw log from the ESI Exchange Collector are on the ESIExchangeConfig_CL table and are uploaded using the builtin REST API uploader of the Collector.
//
//

// Parameters
let _target = iff(isnull(Target) or isempty(Target),"On-Premises",Target);
let ScalarbaseRequest = union(ESIExchangeOnlineConfig_CL | where _target == 'Online' or _target == 'All' | extend Source = "Online"), (ESIExchangeConfig_CL | where _target == 'On-Premises' or _target == 'All' | extend Source = "On-Premises");
// Base Request
ScalarbaseRequest | summarize by ESIEnvironment_s | project-rename ESIEnvironment = ESIEnvironment_s