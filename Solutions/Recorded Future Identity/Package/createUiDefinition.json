{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "isWizard": false,
      "basics": {
        "description": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/RecordedFuture.svg\" width=\"75px\" height=\"75px\">\n\n**Important:** _This Microsoft Sentinel Solution is currently in public preview. This feature is provided without a service level agreement, and it's not recommended for production workloads. Certain features might not be supported or might have constrained capabilities. For more information, see [Supplemental Terms of Use for Microsoft Azure Previews](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)._\n\n**Note:** _There may be [known issues](https://aka.ms/sentinelsolutionsknownissues) pertaining to this Solution, please refer to them before installing._\n\n[Recorded Future](https://www.recordedfuture.com/) Identity Intelligence enables security and IT teams to detect identity compromises, for both employees and customers. To do this, Recorded Future automates the collection, analysis, and production of identity intelligence from a vast range of sources. Organizations can incorporate identity intelligence into automated workflows that regularly monitor for compromised credentials and take immediate action with applications such as Azure Active Directory and Microsoft Sentinel.\nThere are many ways organizations can utilize Recorded Future Identity Intelligence; the playbooks in this Solution are just a quick introduction to some of those ways. In particular, these playbooks include several actions that can be coordinated, or used separately. They include:\n1. searches for compromised workforce or external customer users\n2. looking up existing users and saving the compromised user data to a Log file\n3. confirming high risk Azure Active Directory (AAD) users\n4. adding a compromised user to an AAD security group\n\nFor more information, see the [Documentation for this Solution](https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Recorded%20Future%20Identity/Playbooks).\n\nMicrosoft Sentinel Solutions provide a consolidated way to acquire Microsoft Sentinel content like data connectors, workbooks, analytics, and automations in your workspace with a single deployment step.\n\n**Playbooks:** 5\n\n[Learn more about Microsoft Sentinel](https://aka.ms/azuresentinel) | [Learn more about Solutions](https://aka.ms/azuresentinelsolutionsdoc)",
        "subscription": {
          "resourceProviders": [
            "Microsoft.OperationsManagement/solutions",
            "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "Microsoft.Insights/workbooks",
            "Microsoft.Logic/workflows"
          ]
        },
        "location": {
          "metadata": {
            "hidden": "Hiding location, we get it from the log analytics workspace"
          },
          "visible": false
        },
        "resourceGroup": {
          "allowExisting": true
        }
      }
    },
    "basics": [
      {
        "name": "getLAWorkspace",
        "type": "Microsoft.Solutions.ArmApiControl",
        "toolTip": "This filters by workspaces that exist in the Resource Group selected",
        "condition": "[greater(length(resourceGroup().name),0)]",
        "request": {
          "method": "GET",
          "path": "[concat(subscription().id,'/providers/Microsoft.OperationalInsights/workspaces?api-version=2020-08-01')]"
        }
      },
      {
        "name": "workspace",
        "type": "Microsoft.Common.DropDown",
        "label": "Workspace",
        "placeholder": "Select a workspace",
        "toolTip": "This dropdown will list only workspace that exists in the Resource Group selected",
        "constraints": {
          "allowedValues": "[map(filter(basics('getLAWorkspace').value, (filter) => contains(toLower(filter.id), toLower(resourceGroup().name))), (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
          "required": true
        },
        "visible": true
      }
    ],
    "steps": [
      {
        "name": "playbooks",
        "label": "Playbooks",
        "subLabel": {
          "preValidation": "Configure the playbooks",
          "postValidation": "Done"
        },
        "bladeTitle": "Playbooks",
        "elements": [
          {
            "name": "playbooks-text",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "This solution installs playbook resources.  A security playbook is a collection of procedures that can be run from Microsoft Sentinel in response to an alert. A security playbook can help automate and orchestrate your response, and can be run manually or set to run automatically when specific alerts are triggered. Security playbooks in Microsoft Sentinel are based on Azure Logic Apps, which means that you get all the power, customizability, and built-in templates of Logic Apps. Each playbook is created for the specific subscription you choose, but when you look at the Playbooks page, you will see all the playbooks across any selected subscriptions.",
              "link": {
                "label": "Learn more",
                "uri": "https://docs.microsoft.com/azure/sentinel/tutorial-respond-threats-playbook?WT.mc_id=Portal-Microsoft_Azure_CreateUIDef"
              }
            }
          },
          {
            "name": "playbook1",
            "type": "Microsoft.Common.Section",
            "label": "Add ADD security group user",
            "elements": [
              {
                "name": "playbook1-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "This playbook adds a compromised user to an AAD security group. Triage and remediation should be handled in follow up playbooks or actions."
                }
              },
              {
                "name": "Playbook-Name-add-AAD-security-group-user",
                "type": "Microsoft.Common.TextBox",
                "label": "Playbook Name",
                "defaultValue": "RecordedFutureIdentity-add-AAD-security-group-user",
                "toolTip": "Please enter PlaybookName to use",
                "constraints": {
                  "required": true,
                  "regex": "[a-z0-9A-Z]{1,256}$",
                  "validationMessage": "Please enter the PlaybookName"
                }
              }
            ]
          },
          {
            "name": "playbook2",
            "type": "Microsoft.Common.Section",
            "label": "Confirm ADD risky user",
            "elements": [
              {
                "name": "playbook2-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "This playbook confirms compromise of users deemed 'high risk' by AAD."
                }
              },
              {
                "name": "Playbook-Name-confirm-AAD-risky-user",
                "type": "Microsoft.Common.TextBox",
                "label": "Playbook Name",
                "defaultValue": "RecordedFutureIdentity-confirm-AAD-risky-user",
                "toolTip": "Please enter PlaybookName to use",
                "constraints": {
                  "required": true,
                  "regex": "[a-z0-9A-Z]{1,256}$",
                  "validationMessage": "Please enter the PlaybookName"
                }
              }
            ]
          },
          {
            "name": "playbook3",
            "type": "Microsoft.Common.Section",
            "label": "Lookup and save user",
            "elements": [
              {
                "name": "playbook3-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "This playbook gets compromise identity details from Recorded Future Identity Intelligence and saves the data for further review and analysis."
                }
              },
              {
                "name": "Playbook-Name-lookup-and-save-user",
                "type": "Microsoft.Common.TextBox",
                "label": "Playbook Name",
                "defaultValue": "RecordedFutureIdentity-lookup-and-save-user",
                "toolTip": "Please enter PlaybookName to use",
                "constraints": {
                  "required": true,
                  "regex": "[a-z0-9A-Z]{1,256}$",
                  "validationMessage": "Please enter the PlaybookName"
                }
              }
            ]
          },
          {
            "name": "playbook4",
            "type": "Microsoft.Common.Section",
            "label": "Search workforce user",
            "elements": [
              {
                "name": "playbook4-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "This playbook searches the Recorded Future Identity Intelligence Module for compromised workforce users."
                }
              },
              {
                "name": "Playbook-Name-search-workforce-user",
                "type": "Microsoft.Common.TextBox",
                "label": "Playbook Name",
                "defaultValue": "RecordedFutureIdentity-search-workforce-user",
                "toolTip": "Please enter PlaybookName to use",
                "constraints": {
                  "required": true,
                  "regex": "[a-z0-9A-Z]{1,256}$",
                  "validationMessage": "Please enter the PlaybookName"
                }
              }
            ]
          },
          {
            "name": "playbook5",
            "type": "Microsoft.Common.Section",
            "label": "Search external user",
            "elements": [
              {
                "name": "playbook5-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "This playbook searches the Recorded Future Identity Intelligence Module for compromised external (customer) users."
                }
              },
              {
                "name": "Playbook-Name-search-external-user",
                "type": "Microsoft.Common.TextBox",
                "label": "Playbook Name",
                "defaultValue": "RecordedFutureIdentity-search-external-user",
                "toolTip": "Please enter PlaybookName to use",
                "constraints": {
                  "required": true,
                  "regex": "[a-z0-9A-Z]{1,256}$",
                  "validationMessage": "Please enter the PlaybookName"
                }
              }
            ]
          }
        ]
      }
    ],
    "outputs": {
      "workspace-location": "[first(map(filter(basics('getLAWorkspace').value, (filter) => and(contains(toLower(filter.id), toLower(resourceGroup().name)),equals(filter.name,basics('workspace')))), (item) => item.location))]",
      "location": "[location()]",
      "workspace": "[basics('workspace')]",
      "Playbook-Name-add-AAD-security-group-user": "[steps('playbooks').playbook1.Playbook-Name-add-AAD-security-group-user]",
      "Playbook-Name-confirm-AAD-risky-user": "[steps('playbooks').playbook2.Playbook-Name-confirm-AAD-risky-user]",
      "Playbook-Name-lookup-and-save-user": "[steps('playbooks').playbook3.Playbook-Name-lookup-and-save-user]",
      "Playbook-Name-search-workforce-user": "[steps('playbooks').playbook4.Playbook-Name-search-workforce-user]",
      "Playbook-Name-search-external-user": "[steps('playbooks').playbook5.Playbook-Name-search-external-user]"
    }
  }
}
