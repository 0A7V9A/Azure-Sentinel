id: b8bacbda-3faa-49fb-b000-9334b2b51c8e
name: Vectra AI - 
description: |
  'Query searches for number of sub-domains attached per domain
  A high volume of sub-domains may indicate the usage of DNS Tunneling.
  Metadata required = metadata_dns'
severity: Medium
requiredDataConnectors:
  - connectorId: AIVectraStream
    dataTypes:
      - VectraStream
tactics:
  - CommandAndControl
relevantTechniques:
  - T1071.004
query: |
  VectraStream
  | where metadata_type == "metadata_dns"
  | extend top_domain = extract(@"(?:(?<rex_sub_domain>[^\.\s]+)\.)??(?<rex_domain>(?:(?<rex_domain_no_tld>[^\.\s]+)\.)?(?<rex_tld>[^\.\s]{2,}))$",3,['query'])
  | project ['query'], top_domain
  | extend HostCustomEntity = orig_hostname, IPCustomEntity = id_orig_h
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: IPCustomEntity
  - entityType: Host
    fieldMappings:
      - identifier: FullName
        columnName: HostCustomEntity
