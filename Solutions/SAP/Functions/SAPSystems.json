{
    "properties": {
        "category": "SAPFunctions",
        "displayName": "SAPSystems",
        "query": "// let SelectedSystems =  dynamic([\"All Systems\"]);//can also do:// let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);\r\n// let SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do:let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\r\n// let SelectedSystemUsage=  dynamic([\"All Usage Types\"]); //can also do// let SelectedSystemUsage =  dynamic([\"ERP\", \"CRM\"]);\r\n\r\nlet SystemRolesDictionary= dynamic({\"UP\":\"Unknown (Production)\", \"AH\":\"Agent Heartbeat\",\"P\":\"Production\", \"T\": \"Test\", \"C\": \"Customizing\", \"D\": \"Demo\", \"E\": \"Training/Education\", \"S\": \"SAP reference\"});\r\nlet EmptySystems= datatable ( TimeGenerated:datetime, system_id_s: string, SearchKey:string, SystemID:string , SystemRole: string, SystemUsage: string, Priority: int, sap_client_category_s:string )[];\r\n\r\n// the 'SAP - Systems' watchlist allows for configuring attributes for each system\r\nlet SAPSystemsFromWL= _GetWatchlist('SAP - Systems')\r\n| union isfuzzy=true EmptySystems\r\n// | project-keep SearchKey, SystemRole, SystemUsage\r\n| extend Priority= int(2)\r\n| extend SystemID= SearchKey;\r\n\r\n// As of agent version 64043801 from November 2022, the hearbeat sends the original system role from SAP\r\nlet SAPSystemsFromHeartbeat= SAP_HeartBeat_CL\r\n| union isfuzzy=true EmptySystems\r\n| summarize arg_max(TimeGenerated, *) by system_id_s\r\n| extend SystemID= substring(system_id_s,0,3)\r\n| summarize arg_max(TimeGenerated, *) by SystemID\r\n| order by SystemID\r\n| extend SystemRoleCode= column_ifexists(\"sap_client_category_s\",\"UP\")\r\n| extend SystemRoleCode= iff(bag_has_key(SystemRolesDictionary,SystemRoleCode), SystemRoleCode, \"UP\")\r\n| extend SystemRole= tostring(SystemRolesDictionary[SystemRoleCode])\r\n| project SearchKey= SystemID, Priority= int(1), SystemID, SystemRole;\r\n\r\nunion isfuzzy=true SAPSystemsFromWL, SAPSystemsFromHeartbeat\r\n// allow SystemRole to be controlled by the watchlist so users can set own system role (not the one coming from the hearbeat)\r\n| summarize arg_max(Priority, SystemRole), arg_max(Priority, SystemUsage)\r\nby SystemID, SearchKey\r\n| where SearchKey in (SelectedSystems) or tostring(SelectedSystems) contains 'All Systems'\r\n| where SystemRole in (SelectedSystemRoles) or tostring(SelectedSystemRoles) contains 'All System Roles'\r\n| where SystemUsage in (SelectedSystemUsage) or tostring(SelectedSystemUsage) contains 'All Usage Types'\r\n| project DummyJoinField = 1, SearchKey, SystemID, SystemUsage=iff(isempty(SystemUsage), \"Unknown\", SystemUsage)\r\n// set \"Production\" as default, just in case it cannot be inferred from data. This value is considered for analytics purposes only, and not billing purposes.\r\n, SystemRole= iff(isempty(SystemRole), \"Production\", SystemRole)",
        "functionAlias": "SAPSystems",
        "functionParameters": "SelectedSystems:dynamic = dynamic([\"All Systems\"]), SelectedSystemRoles:dynamic = dynamic([\"All System Roles\"]), SelectedSystemUsage:dynamic = dynamic([\"All Usage Types\"])",
        "version": 2,
        "etag": "*"
    },
    "name": "SAPSystems",
    "type": "savedSearches",
    "apiVersion": "2022-10-01"
}