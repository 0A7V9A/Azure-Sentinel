id: c43824c2-c7cc-44e8-b4c6-a7568ec32131
name: (Private Preview) CMMC Audit & Accountability Control Family Monitoring
description: |
  'CMMC Control Assessments have Deviated from Configured Threshold Baselines'
severity: Medium
requiredDataConnectors:
  - connectorId: AzureSecurityCenter
    dataTypes:
      - SecurityAlert (ASC)
queryFrequency: 7d
queryPeriod: 7d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - Discovery
relevantTechniques:
  - T1082
query: |

let Policymap = datatable(RecommendationName:string, ControlFamily:string, ControlNumber:string, MaturityLevel:string, 800171Map:string, 80053Map:string)
[
'Virtual machines should be connected to a specified workspace',	'Audit & Accountability',	'AU.2.041',	'ML-2',	'3.3.2',	'AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12',
'The Log Analytics agent should be installed on virtual machines',	'Audit & Accountability',	'AU.2.041',	'ML-2',	'3.3.2',	'AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12',
'An activity log alert should exist for Delete SQL Server Firewall Rule',	'Audit & Accountability',	'AU.2.041',	'ML-2',	'3.3.2',	'AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12',
'An activity log alert should exist for the Delete Network Security Group Rule',	'Audit & Accountability',	'AU.2.041',	'ML-2',	'3.3.2',	'AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12',
'Audit diagnostic setting',	'Audit & Accountability',	'AU.2.042',	'ML-2',	'3.3.1',	'AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12',
'Virtual machines should be connected to a specified workspace',	'Audit & Accountability',	'AU.2.042',	'ML-2',	'3.3.1',	'AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12',
'The Log Analytics agent should be installed on virtual machines',	'Audit & Accountability',	'AU.2.042',	'ML-2',	'3.3.1',	'AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12',
'An activity log alert should exist for Delete SQL Server Firewall Rule',	'Audit & Accountability',	'AU.2.042',	'ML-2',	'3.3.1',	'AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12',
'An activity log alert should exist for the Delete Network Security Group Rule',	'Audit & Accountability',	'AU.2.042',	'ML-2',	'3.3.1',	'AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12',
'Audit diagnostic setting',	'Audit & Accountability',	'AU.3.046',	'ML-3',	'3.3.4',	'AU-5',
'Virtual machines should be connected to a specified workspace',	'Audit & Accountability',	'AU.3.046',	'ML-3',	'3.3.4',	'AU-5',
'Azure Defender for SQL should be enabled for unprotected SQL Managed Instances',	'Audit & Accountability',	'AU.3.046',	'ML-3',	'3.3.4',	'AU-5',
'Log Analytics agent should be enabled in virtual machine scale sets for listed virtual machine images',	'Audit & Accountability',	'AU.3.046',	'ML-3',	'3.3.4',	'AU-5',
'Audit diagnostic setting',	'Audit & Accountability',	'AU.3.048',	'ML-3',	'NA',	'AU-6(4)',
'Virtual machines should be connected to a specified workspace',	'Audit & Accountability',	'AU.3.048',	'ML-3',	'NA',	'AU-6(4)',
'The Log Analytics agent should be installed on virtual machines',	'Audit & Accountability',	'AU.3.048',	'ML-3',	'NA',	'AU-6(4)',
'Diagnostic logs should be enabled in App Service',	'Audit & Accountability',	'AU.3.048',	'ML-3',	'NA',	'AU-6(4)',
'Log Analytics agent should be enabled in virtual machine scale sets for listed virtual machine images',	'Audit & Accountability',	'AU.3.048',	'ML-3',	'NA',	'AU-6(4)',
'Audit diagnostic setting',	'Audit & Accountability',	'AU.3.047',	'ML-3',	'3.3.8',	'AU-6(7), AU-9',
'An activity log alert should exist for specific Policy operations',	'Audit & Accountability',	'AU.3.047',	'ML-3',	'3.3.8',	'AU-6(7), AU-9'
];
SecurityRecommendation
| join kind=rightouter Policymap on RecommendationName
| where ControlFamily == 'System & Information Integrity'
| summarize
    Assessments = count(),
    Success = countif(RecommendationState == 'Healthy' or RecommendationState == 'NotApplicable'),
    Failed = countif(RecommendationState == 'Unhealthy')
    by ControlFamily, ControlNumber, MaturityLevel, RecommendationName, AssessedResourceId
| extend SuccessRatePercentage = (Success * 100 / Assessments)
| extend FailedRatePercentage = (Failed * 100 / Assessments)
| project
    ControlNumber,
    ControlFamily,
    MaturityLevel,
    RecommendationName,
    Assessments,
    SuccessRatePercentage,
    FailedRatePercentage,
    AssessedResourceId
| where RecommendationName <> ''
// | where RecommendationName <> '' //Filter Out or Suppress Recommendations
// | where MaturityLevel == 'ML-3' //Filter by Maturity Level 
| where FailedRatePercentage > 30 //Adjust Either FailedRatePercentage or PasedRatePercentage Thresholds within Organizational Needs
| sort by FailedRatePercentage desc
| limit 250
| extend HostCustomEntity = AssessedResourceId

entityMappings:
  - entityType: Host
    fieldMappings:
      - identifier: FullName
        columnName: HostCustomEntity
version: 1.0.0
