id: d7c2bab0-3d3b-4a54-986e-7a7e27e4a2de
name: (Private Preview) CMMC System & Communications Protection Control Family Monitoring
description: |
  'CMMC Control Assessments have Deviated from Configured Threshold Baselines'
severity: Medium
requiredDataConnectors:
  - connectorId: AzureSecurityCenter
    dataTypes:
      - SecurityAlert (ASC)
queryFrequency: 7d
queryPeriod: 7d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - Discovery
relevantTechniques:
  - T1082
query: |

let Policymap = datatable(RecommendationName:string, ControlFamily:string, ControlNumber:string, MaturityLevel:string, 800171Map:string, 80053Map:string)
[
"Access to storage accounts with firewall and virtual network configurations should be restricted",	"System & Communications Protection",	"SC.1.175",	"ML-1",	"3.13.1",	"SC-7, SA-8",
"Storage account public access should be disallowed",	"System & Communications Protection",	"SC.1.175",	"ML-1",	"3.13.1",	"SC-7, SA-8",
"Windows machines should meet requirements for 'Security Options - Network Access'",	"System & Communications Protection",	"SC.1.175",	"ML-1",	"3.13.1",	"SC-7, SA-8",
"Windows machines should meet requirements for 'Security Options - Network Security'",	"System & Communications Protection",	"SC.1.175",	"ML-1",	"3.13.1",	"SC-7, SA-8",
"Non-internet-facing virtual machines should be protected with network security groups",	"System & Communications Protection",	"SC.1.175",	"ML-1",	"3.13.1",	"SC-7, SA-8",
"Access to storage accounts with firewall and virtual network configurations should be restricted",	"System & Communications Protection",	"SC.1.176",	"ML-1",	"3.13.5",	"SC-7",
"Subnets should be associated with a network security group",	"System & Communications Protection",	"SC.1.176",	"ML-1",	"3.13.5",	"SC-7",
"Adaptive network hardening recommendations should be applied on internet facing virtual machines",	"System & Communications Protection",	"SC.1.176",	"ML-1",	"3.13.5",	"SC-7",
"All network ports should be restricted on network security groups associated to your virtual machine",	"System & Communications Protection",	"SC.1.176",	"ML-1",	"3.13.5",	"SC-7",
"Internet-facing virtual machines should be protected with network security groups",	"System & Communications Protection",	"SC.1.176",	"ML-1",	"3.13.5",	"SC-7",
"Management ports of virtual machines should be protected with just-in-time network access control",	"System & Communications Protection",	"SC.2.179",	"ML-2",	"NA",	"NA",
"[Enable if required] Storage accounts should use customer-managed key (CMK) for encryption",	"System & Communications Protection",	"SC.3.177",	"ML-3",	"3.13.11",	"SC-13",
"Storage accounts should have infrastructure encryption",	"System & Communications Protection",	"SC.3.177",	"ML-3",	"3.13.11",	"SC-13",
"Virtual machines should encrypt temp disks, caches, and data flows between Compute and Storage resources",	"System & Communications Protection",	"SC.3.177",	"ML-3",	"3.13.11",	"SC-13",
"Audit Windows machines that do not store passwords using reversible encryption",	"System & Communications Protection",	"SC.3.177",	"ML-3",	"3.13.11",	"SC-13",
"Unattached disks should be encrypted",	"System & Communications Protection",	"SC.3.177",	"ML-3",	"3.13.11",	"SC-13",
"Subnets should be associated with a network security group",	"System & Communications Protection",	"SC.3.180",	"ML-3",	"3.13.2",	"SC-7, SA-8",
"Audit Windows machines that have the specified members in the Administrators group",	"System & Communications Protection",	"SC.3.181",	"ML-3",	"3.13.3",	"SC-2",
"External accounts with owner permissions should be removed from your subscription",	"System & Communications Protection",	"SC.3.181",	"ML-3",	"3.13.3",	"SC-2",
"A maximum of 3 owners should be designated for your subscription",	"System & Communications Protection",	"SC.3.181",	"ML-3",	"3.13.3",	"SC-2",
"An Azure Active Directory administrator should be provisioned for SQL servers",	"System & Communications Protection",	"SC.3.181",	"ML-3",	"3.13.3",	"SC-2",
"Deprecated accounts with owner permissions should be removed from your subscription",	"System & Communications Protection",	"SC.3.181",	"ML-3",	"3.13.3",	"SC-2",
"Access to storage accounts with firewall and virtual network configurations should be restricted",	"System & Communications Protection",	"SC.3.183",	"ML-3",	"3.13.6",	"SC-7(5)",
"Storage account public access should be disallowed",	"System & Communications Protection",	"SC.3.183",	"ML-3",	"3.13.6",	"SC-7(5)",
"Windows machines should meet requirements for 'Security Options - Network Access'",	"System & Communications Protection",	"SC.3.183",	"ML-3",	"3.13.6",	"SC-7(5)",
"Windows machines should meet requirements for 'Security Options - Network Security'",	"System & Communications Protection",	"SC.3.183",	"ML-3",	"3.13.6",	"SC-7(5)",
"Non-internet-facing virtual machines should be protected with network security groups",	"System & Communications Protection",	"SC.3.183",	"ML-3",	"3.13.6",	"SC-7(5)",
"Access to storage accounts with firewall and virtual network configurations should be restricted",	"System & Communications Protection",	"SC.3.185",	"ML-3",	"3.13.8",	"SC-8, SC-8(1)",
"Function App should only be accessible over HTTPS",	"System & Communications Protection",	"SC.3.185",	"ML-3",	"3.13.8",	"SC-8, SC-8(1)",
"Secure transfer to storage accounts should be enabled",	"System & Communications Protection",	"SC.3.185",	"ML-3",	"3.13.8",	"SC-8, SC-8(1)",
"Web Application should only be accessible over HTTPS",	"System & Communications Protection",	"SC.3.185",	"ML-3",	"3.13.8",	"SC-8, SC-8(1)",
"API App should only be accessible over HTTPS",	"System & Communications Protection",	"SC.3.185",	"ML-3",	"3.13.8",	"SC-8, SC-8(1)",
"Key vaults should have purge protection enabled",	"System & Communications Protection",	"SC.3.187",	"ML-3",	"3.13.10",	"SC-12",
"Firewall should be enabled on Key Vault",	"System & Communications Protection",	"SC.3.187",	"ML-3",	"3.13.10",	"SC-12",
"Key vaults should have soft delete enabled",	"System & Communications Protection",	"SC.3.187",	"ML-3",	"3.13.10",	"SC-12",
"Azure Defender for Key Vault should be enabled",	"System & Communications Protection",	"SC.3.187",	"ML-3",	"3.13.10",	"SC-12",
"Keys using RSA cryptography should have a specified minimum key size",	"System & Communications Protection",	"SC.3.187",	"ML-3",	"3.13.10",	"SC-12",
"Function App should only be accessible over HTTPS",	"System & Communications Protection",	"SC.3.190",	"ML-3",	"3.13.15",	"SC-23",
"Web Application should only be accessible over HTTPS",	"System & Communications Protection",	"SC.3.190",	"ML-3",	"3.13.15",	"SC-23",
"MFA should be enabled on accounts with owner permissions on your subscription",	"System & Communications Protection",	"SC.3.190",	"ML-3",	"3.13.15",	"SC-23",
"MFA should be enabled on accounts with write permissions on your subscription",	"System & Communications Protection",	"SC.3.190",	"ML-3",	"3.13.15",	"SC-23",
"MFA should be enabled on accounts with read permissions on your subscription",	"System & Communications Protection",	"SC.3.190",	"ML-3",	"3.13.15",	"SC-23",
"Storage accounts should have infrastructure encryption",	"System & Communications Protection",	"SC.3.191",	"ML-3",	"3.13.16",	"SC-28",
"Access to storage accounts with firewall and virtual network configurations should be restricted",	"System & Communications Protection",	"SC.3.191",	"ML-3",	"3.13.16",	"SC-28",
"Virtual machines should encrypt temp disks, caches, and data flows between Compute and Storage resources",	"System & Communications Protection",	"SC.3.191",	"ML-3",	"3.13.16",	"SC-28",
"Unattached disks should be encrypted",	"System & Communications Protection",	"SC.3.191",	"ML-3",	"3.13.16",	"SC-28",
"Double encryption should be enabled on Azure Data Explorer",	"System & Communications Protection",	"SC.3.191",	"ML-3",	"3.13.16",	"SC-28"
];
SecurityRecommendation
| join kind=rightouter Policymap on RecommendationName
| where ControlFamily == "System & Communications Protection"
| summarize
    Assessments = count(),
    Success = countif(RecommendationState == 'Healthy' or RecommendationState == 'NotApplicable'),
    Failed = countif(RecommendationState == 'Unhealthy')
    by ControlFamily, ControlNumber, MaturityLevel, RecommendationName
| extend SuccessRatePercentage = (Success * 100 / Assessments)
| extend FailedRatePercentage = (Failed * 100 / Assessments)
| extend RemediationLink = strcat("https://portal.azure.com/#blade/Microsoft_Azure_Security/SecurityMenuBlade/22")
| project
    ControlNumber,
    ControlFamily,
    MaturityLevel,
    RecommendationName,
    Assessments,
    SuccessRatePercentage,
    FailedRatePercentage,
    RemediationLink
| where RecommendationName <> ""
// | where RecommendationName <> "" //Filter Out or Suppress Recommendations
// | where MaturityLevel == "ML-3" //Filter by Maturity Level 
| where FailedRatePercentage > 30 //Adjust Either FailedRatePercentage or PasedRatePercentage Thresholds within Organizational Needs
| sort by FailedRatePercentage desc
| limit 250
| extend URLCustomEntity = RemediationLink

entityMappings:
  - entityType: URL
    fieldMappings:
      - identifier: Url
        columnName: URLCustomEntity
version: 1.0.0
