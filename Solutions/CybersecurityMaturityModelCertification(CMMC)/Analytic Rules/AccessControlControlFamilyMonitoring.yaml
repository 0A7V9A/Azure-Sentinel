id: 874cf87f-8f6c-4d21-96bb-08ba80c77cb3
name: (Private Preview) CMMC Access Control Control Family Monitoring
description: |
  'CMMC Control Assessments have Deviated from Configured Threshold Baselines'
severity: Medium
requiredDataConnectors:
  - connectorId: AzureSecurityCenter
    dataTypes:
      - SecurityAlert (ASC)
queryFrequency: 7d
queryPeriod: 7d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - Discovery
relevantTechniques:
  - T1082
query: |
let Policymap = datatable(RecommendationName:string, ControlFamily:string, ControlNumber:string, MaturityLevel:string, 800171Map:string, 80053Map:string)
[
"Access to storage accounts with firewall and virtual network configurations should be restricted", "Access Control", "AC.1.001", "ML-1", "3.1.1", "AC-2, AC-3, AC-17",
"Storage account public access should be disallowed", "Access Control", "AC.1.001", "ML-1", "3.1.1", "AC-2, AC-3, AC-17",
"Add system-assigned managed identity to enable Guest Configuration assignments on virtual machines with no identities", "Access Control", "AC.1.001", "ML-1", "3.1.1", "AC-2, AC-3, AC-17",
"Windows machines should meet requirements for 'Security Options - Network Access'", "Access Control", "AC.1.001", "ML-1", "3.1.1", "AC-2, AC-3, AC-17",
"Deploy the Windows Guest Configuration extension to enable Guest Configuration assignments on Windows VMs", "Access Control", "AC.1.001", "ML-1", "3.1.1", "AC-2, AC-3, AC-17",
"Access to storage accounts with firewall and virtual network configurations should be restricted", "Access Control", "AC.1.002", "ML-1", "3.1.2", "AC-2, AC-3, AC-17",
"Storage account public access should be disallowed", "Access Control", "AC.1.002", "ML-1", "3.1.2", "AC-2, AC-3, AC-17",
"Windows machines should meet requirements for 'Security Options - Network Access'", "Access Control", "AC.1.002", "ML-1", "3.1.2", "AC-2, AC-3, AC-17",
"Firewall should be enabled on Key Vault", "Access Control", "AC.1.002", "ML-1", "3.1.2", "AC-2, AC-3, AC-17",
"Audit Linux machines that allow remote connections from accounts without passwords", "Access Control", "AC.1.002", "ML-1", "3.1.2", "AC-2, AC-3, AC-17",
"RDP access from the Internet should be blocked", "Access Control", "AC.1.003", "ML-1", "3.1.20", "AC-20, AC-20(1)",
"Adaptive network hardening recommendations should be applied on internet facing virtual machines", "Access Control", "AC.1.003", "ML-1", "3.1.20", "AC-20, AC-20(1)",
"Virtual networks should be protected by Azure Firewall", "Access Control", "AC.1.003", "ML-1", "3.1.20", "AC-20, AC-20(1)",
"SSH access from the Internet should be blocked", "Access Control", "AC.1.003", "ML-1", "3.1.20", "AC-20, AC-20(1)",
"Internet-facing virtual machines should be protected with network security groups", "Access Control", "AC.1.003", "ML-1", "3.1.20", "AC-20, AC-20(1)",
"Management ports of virtual machines should be protected with just-in-time network access control", "Access Control", "AC.2.007", "ML-2", "3.1.5", "AC-6, AC-6(1), AC-6(5)",
"Role-Based Access Control should be used on Kubernetes Services", "Access Control", "AC.2.007", "ML-2", "3.1.5", "AC-6, AC-6(1), AC-6(5)",
"External accounts with read permissions should be removed from your subscription", "Access Control", "AC.2.007", "ML-2", "3.1.5", "AC-6, AC-6(1), AC-6(5)",
"External accounts with write permissions should be removed from your subscription", "Access Control", "AC.2.007", "ML-2", "3.1.5", "AC-6, AC-6(1), AC-6(5)",
"Windows machines should meet requirements for 'Security Options - User Account Control'", "Access Control", "AC.2.008", "ML-2", "3.1.6", "AC-6(2)",
"Windows machines should meet requirements for 'User Rights Assignment'", "Access Control", "AC.2.008", "ML-2", "3.1.6", "AC-6(2)",
"Access to storage accounts with firewall and virtual network configurations should be restricted", "Access Control", "AC.2.013", "ML-2", "3.1.12", "AC-17(1)",
"Add system-assigned managed identity to enable Guest Configuration assignments on virtual machines with no identities", "Access Control", "AC.2.013", "ML-2", "3.1.12", "AC-17(1)",
"Deploy the Windows Guest Configuration extension to enable Guest Configuration assignments on Windows VMs", "Access Control", "AC.2.013", "ML-2", "3.1.12", "AC-17(1)",
"Windows machines should meet requirements for 'Security Options - Network Security'", "Access Control", "AC.2.013", "ML-2", "3.1.12", "AC-17(1)",
"Audit Linux machines that allow remote connections from accounts without passwords", "Access Control", "AC.2.013", "ML-2", "3.1.12", "AC-17(1)",
"RDP access from the Internet should be blocked", "Access Control", "AC.2.015", "ML-2", "3.1.14", "AC-17(3)",
"Access to storage accounts with firewall and virtual network configurations should be restricted", "Access Control", "AC.2.016", "ML-2", "3.1.3", "AC-4",
"Storage account public access should be disallowed", "Access Control", "AC.2.016", "ML-2", "3.1.3", "AC-4",
"Windows machines should meet requirements for 'Security Options - Network Access'", "Access Control", "AC.2.016", "ML-2", "3.1.3", "AC-4",
"RDP access from the Internet should be blocked", "Access Control", "AC.2.016", "ML-2", "3.1.3", "AC-4",
"Adaptive network hardening recommendations should be applied on internet facing virtual machines", "Access Control", "AC.2.016", "ML-2", "3.1.3", "AC-4",
"Audit Windows machines missing any of specified members in the Administrators group", "Access Control", "AC.3.017", "ML-3", "3.1.4", "AC-5",
"Audit Windows machines that have the specified members in the Administrators group", "Access Control", "AC.3.017", "ML-3", "3.1.4", "AC-5",
"A maximum of 3 owners should be designated for your subscription", "Access Control", "AC.3.017", "ML-3", "3.1.4", "AC-5",
"There should be more than one owner assigned to your subscription", "Access Control", "AC.3.017", "ML-3", "3.1.4", "AC-5",
"Windows machines should meet requirements for 'System Audit Policies - Privilege Use'", "Access Control", "AC.3.018", "ML-3", "3.1.7", "AC-6(9), AC-6(10)",
"An activity log alert should exist for Delete SQL Server Firewall Rule", "Access Control", "AC.3.018", "ML-3", "3.1.7", "AC-6(9), AC-6(10)",
"An activity log alert should exist for the Delete Network Security Group Rule", "Access Control", "AC.3.018", "ML-3", "3.1.7", "AC-6(9), AC-6(10)",
"An activity log alert should exist for Delete Network Security Solution", "Access Control", "AC.3.018", "ML-3", "3.1.7", "AC-6(9), AC-6(10)",
"An activity log alert should exist for the Delete Classic Network Security Group Rule", "Access Control", "AC.3.018", "ML-3", "3.1.7", "AC-6(9), AC-6(10)",
"Guest Configuration extension should be installed on your machines", "Access Control", "AC.3.021", "ML-3", "3.1.15", "AC-17(4)",
"Add system-assigned managed identity to enable Guest Configuration assignments on virtual machines with no identities", "Access Control", "AC.3.021", "ML-3", "3.1.15", "AC-17(4)",
"Windows machines should meet requirements for 'Security Options - User Account Control'", "Access Control", "AC.3.021", "ML-3", "3.1.15", "AC-17(4)",
"Windows machines should meet requirements for 'User Rights Assignment'", "Access Control", "AC.3.021", "ML-3", "3.1.15", "AC-17(4)",
"Deploy the Windows Guest Configuration extension to enable Guest Configuration assignments on Windows VMs", "Access Control", "AC.3.021", "ML-3", "3.1.15", "AC-17(4)",
"Audit diagnostic setting", "Audit & Accountability", "AU.2.041", "ML-2", "3.3.2", "AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12",
];
SecurityRecommendation
| join kind=rightouter Policymap on RecommendationName
| where ControlFamily == "Access Control"
| summarize
    Assessments = count(),
    Success = countif(RecommendationState == 'Healthy' or RecommendationState == 'NotApplicable'),
    Failed = countif(RecommendationState == 'Unhealthy')
    by ControlFamily, ControlNumber, MaturityLevel, RecommendationName
| extend SuccessRatePercentage = (Success * 100 / Assessments)
| extend FailedRatePercentage = (Failed * 100 / Assessments)
| extend RemediationLink = strcat("https://portal.azure.com/#blade/Microsoft_Azure_Security/SecurityMenuBlade/22")
| project
    ControlNumber,
    ControlFamily,
    MaturityLevel,
    RecommendationName,
    Assessments,
    SuccessRatePercentage,
    FailedRatePercentage,
    RemediationLink
| where RecommendationName <> ""
// | where RecommendationName <> "" //Filter Out or Suppress Recommendations
// | where MaturityLevel == "ML-3" //Filter by Maturity Level 
| where FailedRatePercentage > 30 //Adjust Either FailedRatePercentage or PasedRatePercentage Thresholds within Organizational Needs
| sort by FailedRatePercentage desc
| limit 250
| extend Url = RemediationLink
entityMappings:
  - entityType: URL
    fieldMappings:
      - identifier: Url
        columnName: RemediationLink
version: 1.0.0
