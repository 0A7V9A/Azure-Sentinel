{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/7d82f99b-23d5-419f-9093-8057c8d49060')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/7d82f99b-23d5-419f-9093-8057c8d49060')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2021-03-01-preview",
            "properties": {
                "displayName": "CMMC: Access Control Family Alert",
                "description": "CMMC Control Assessments have Deviated from Configured Threshold Baselines",
                "severity": "Medium",
                "enabled": true,
                "query": "// Rule Name - CMMC: Access Control Family Alert\n// Rule Description - CMMC Control Assessments have Deviated from Configured Threshold Baselines\n// Prerequisite 1: Onboard Azure Security Center (https://docs.microsoft.com/azure/security-center/security-center-get-started)\n// Prerequisite 2: Add the Azure Security Center: CMMC Assessment to Your Dashboard (https://docs.microsoft.com/azure/security-center/update-regulatory-compliance-packages?WT.mc_id=Portal-fx#add-a-regulatory-standard-to-your-dashboard)\n// Prerequisite 3: Continuously Export Security Center Data to Log Analytics Workspace (https://docs.microsoft.com/azure/security-center/continuous-export?WT.mc_id=Portal-fx)\nlet Policymap = datatable (\n    RecommendationName: string,\n    ControlFamily: string,\n    ControlNumber: string,\n    MaturityLevel: string,\n    800171Map: string,\n    80053Map: string\n) [\n    \"Access to storage accounts with firewall and virtual network configurations should be restricted\", \"Access Control\", \"AC.1.001\", \"ML-1\", \"3.1.1\", \"AC-2, AC-3, AC-17\",\n    \"Storage account public access should be disallowed\", \"Access Control\", \"AC.1.001\", \"ML-1\", \"3.1.1\", \"AC-2, AC-3, AC-17\",\n    \"Add system-assigned managed identity to enable Guest Configuration assignments on virtual machines with no identities\", \"Access Control\", \"AC.1.001\", \"ML-1\", \"3.1.1\", \"AC-2, AC-3, AC-17\",\n    \"Windows machines should meet requirements for 'Security Options - Network Access'\", \"Access Control\", \"AC.1.001\", \"ML-1\", \"3.1.1\", \"AC-2, AC-3, AC-17\",\n    \"Deploy the Windows Guest Configuration extension to enable Guest Configuration assignments on Windows VMs\", \"Access Control\", \"AC.1.001\", \"ML-1\", \"3.1.1\", \"AC-2, AC-3, AC-17\",\n    \"Access to storage accounts with firewall and virtual network configurations should be restricted\", \"Access Control\", \"AC.1.002\", \"ML-1\", \"3.1.2\", \"AC-2, AC-3, AC-17\",\n    \"Storage account public access should be disallowed\", \"Access Control\", \"AC.1.002\", \"ML-1\", \"3.1.2\", \"AC-2, AC-3, AC-17\",\n    \"Windows machines should meet requirements for 'Security Options - Network Access'\", \"Access Control\", \"AC.1.002\", \"ML-1\", \"3.1.2\", \"AC-2, AC-3, AC-17\",\n    \"Firewall should be enabled on Key Vault\", \"Access Control\", \"AC.1.002\", \"ML-1\", \"3.1.2\", \"AC-2, AC-3, AC-17\",\n    \"Audit Linux machines that allow remote connections from accounts without passwords\", \"Access Control\", \"AC.1.002\", \"ML-1\", \"3.1.2\", \"AC-2, AC-3, AC-17\",\n    \"RDP access from the Internet should be blocked\", \"Access Control\", \"AC.1.003\", \"ML-1\", \"3.1.20\", \"AC-20, AC-20(1)\",\n    \"Adaptive network hardening recommendations should be applied on internet facing virtual machines\", \"Access Control\", \"AC.1.003\", \"ML-1\", \"3.1.20\", \"AC-20, AC-20(1)\",\n    \"Virtual networks should be protected by Azure Firewall\", \"Access Control\", \"AC.1.003\", \"ML-1\", \"3.1.20\", \"AC-20, AC-20(1)\",\n    \"SSH access from the Internet should be blocked\", \"Access Control\", \"AC.1.003\", \"ML-1\", \"3.1.20\", \"AC-20, AC-20(1)\",\n    \"Internet-facing virtual machines should be protected with network security groups\", \"Access Control\", \"AC.1.003\", \"ML-1\", \"3.1.20\", \"AC-20, AC-20(1)\",\n    \"Management ports of virtual machines should be protected with just-in-time network access control\", \"Access Control\", \"AC.2.007\", \"ML-2\", \"3.1.5\", \"AC-6, AC-6(1), AC-6(5)\",\n    \"Role-Based Access Control should be used on Kubernetes Services\", \"Access Control\", \"AC.2.007\", \"ML-2\", \"3.1.5\", \"AC-6, AC-6(1), AC-6(5)\",\n    \"External accounts with read permissions should be removed from your subscription\", \"Access Control\", \"AC.2.007\", \"ML-2\", \"3.1.5\", \"AC-6, AC-6(1), AC-6(5)\",\n    \"External accounts with write permissions should be removed from your subscription\", \"Access Control\", \"AC.2.007\", \"ML-2\", \"3.1.5\", \"AC-6, AC-6(1), AC-6(5)\",\n    \"Windows machines should meet requirements for 'Security Options - User Account Control'\", \"Access Control\", \"AC.2.008\", \"ML-2\", \"3.1.6\", \"AC-6(2)\",\n    \"Windows machines should meet requirements for 'User Rights Assignment'\", \"Access Control\", \"AC.2.008\", \"ML-2\", \"3.1.6\", \"AC-6(2)\",\n    \"Access to storage accounts with firewall and virtual network configurations should be restricted\", \"Access Control\", \"AC.2.013\", \"ML-2\", \"3.1.12\", \"AC-17(1)\",\n    \"Add system-assigned managed identity to enable Guest Configuration assignments on virtual machines with no identities\", \"Access Control\", \"AC.2.013\", \"ML-2\", \"3.1.12\", \"AC-17(1)\",\n    \"Deploy the Windows Guest Configuration extension to enable Guest Configuration assignments on Windows VMs\", \"Access Control\", \"AC.2.013\", \"ML-2\", \"3.1.12\", \"AC-17(1)\",\n    \"Windows machines should meet requirements for 'Security Options - Network Security'\", \"Access Control\", \"AC.2.013\", \"ML-2\", \"3.1.12\", \"AC-17(1)\",\n    \"Audit Linux machines that allow remote connections from accounts without passwords\", \"Access Control\", \"AC.2.013\", \"ML-2\", \"3.1.12\", \"AC-17(1)\",\n    \"RDP access from the Internet should be blocked\", \"Access Control\", \"AC.2.015\", \"ML-2\", \"3.1.14\", \"AC-17(3)\",\n    \"Access to storage accounts with firewall and virtual network configurations should be restricted\", \"Access Control\", \"AC.2.016\", \"ML-2\", \"3.1.3\", \"AC-4\",\n    \"Storage account public access should be disallowed\", \"Access Control\", \"AC.2.016\", \"ML-2\", \"3.1.3\", \"AC-4\",\n    \"Windows machines should meet requirements for 'Security Options - Network Access'\", \"Access Control\", \"AC.2.016\", \"ML-2\", \"3.1.3\", \"AC-4\",\n    \"RDP access from the Internet should be blocked\", \"Access Control\", \"AC.2.016\", \"ML-2\", \"3.1.3\", \"AC-4\",\n    \"Adaptive network hardening recommendations should be applied on internet facing virtual machines\", \"Access Control\", \"AC.2.016\", \"ML-2\", \"3.1.3\", \"AC-4\",\n    \"Audit Windows machines missing any of specified members in the Administrators group\", \"Access Control\", \"AC.3.017\", \"ML-3\", \"3.1.4\", \"AC-5\",\n    \"Audit Windows machines that have the specified members in the Administrators group\", \"Access Control\", \"AC.3.017\", \"ML-3\", \"3.1.4\", \"AC-5\",\n    \"A maximum of 3 owners should be designated for your subscription\", \"Access Control\", \"AC.3.017\", \"ML-3\", \"3.1.4\", \"AC-5\",\n    \"There should be more than one owner assigned to your subscription\", \"Access Control\", \"AC.3.017\", \"ML-3\", \"3.1.4\", \"AC-5\",\n    \"Windows machines should meet requirements for 'System Audit Policies - Privilege Use'\", \"Access Control\", \"AC.3.018\", \"ML-3\", \"3.1.7\", \"AC-6(9), AC-6(10)\",\n    \"An activity log alert should exist for Delete SQL Server Firewall Rule\", \"Access Control\", \"AC.3.018\", \"ML-3\", \"3.1.7\", \"AC-6(9), AC-6(10)\",\n    \"An activity log alert should exist for the Delete Network Security Group Rule\", \"Access Control\", \"AC.3.018\", \"ML-3\", \"3.1.7\", \"AC-6(9), AC-6(10)\",\n    \"An activity log alert should exist for Delete Network Security Solution\", \"Access Control\", \"AC.3.018\", \"ML-3\", \"3.1.7\", \"AC-6(9), AC-6(10)\",\n    \"An activity log alert should exist for the Delete Classic Network Security Group Rule\", \"Access Control\", \"AC.3.018\", \"ML-3\", \"3.1.7\", \"AC-6(9), AC-6(10)\",\n    \"Guest Configuration extension should be installed on your machines\", \"Access Control\", \"AC.3.021\", \"ML-3\", \"3.1.15\", \"AC-17(4)\",\n    \"Add system-assigned managed identity to enable Guest Configuration assignments on virtual machines with no identities\", \"Access Control\", \"AC.3.021\", \"ML-3\", \"3.1.15\", \"AC-17(4)\",\n    \"Windows machines should meet requirements for 'Security Options - User Account Control'\", \"Access Control\", \"AC.3.021\", \"ML-3\", \"3.1.15\", \"AC-17(4)\",\n    \"Windows machines should meet requirements for 'User Rights Assignment'\", \"Access Control\", \"AC.3.021\", \"ML-3\", \"3.1.15\", \"AC-17(4)\",\n    \"Deploy the Windows Guest Configuration extension to enable Guest Configuration assignments on Windows VMs\", \"Access Control\", \"AC.3.021\", \"ML-3\", \"3.1.15\", \"AC-17(4)\",\n    \"Audit diagnostic setting\", \"Audit & Accountability\", \"AU.2.041\", \"ML-2\", \"3.3.2\", \"AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12\",\n];\nSecurityRecommendation\n| where TimeGenerated > ago(14d) // Adjust Time Threasholds and Subscripition/Workspace Targets within Organizational Needs\n| join kind=rightouter Policymap on RecommendationName\n| where ControlFamily == \"Access Control\"\n| summarize\n    Assessments = count(),\n    Success = countif(RecommendationState == 'Healthy' or RecommendationState == 'NotApplicable'),\n    Failed = countif(RecommendationState == 'Unhealthy')\n    by ControlFamily, ControlNumber, MaturityLevel, RecommendationName\n| extend SuccessRatePercentage = (Success * 100 / Assessments)\n| extend FailedRatePercentage = (Failed * 100 / Assessments)\n| extend RemediationLink = strcat(\"https://portal.azure.com/#blade/Microsoft_Azure_Security/SecurityMenuBlade/22\")\n| project\n    ControlNumber,\n    ControlFamily,\n    MaturityLevel,\n    RecommendationName,\n    Assessments,\n    SuccessRatePercentage,\n    FailedRatePercentage,\n    RemediationLink\n| where RecommendationName <> \"\"\n// | where RecommendationName <> \"\" //Filter Out or Suppress Recommendations\n// | where MaturityLevel == \"ML-3\" //Filter by Maturity Level \n| where FailedRatePercentage > 30 //Adjust Either FailedRatePercentage or PasedRatePercentage Thresholds within Organizational Needs\n| sort by FailedRatePercentage desc\n| limit 250",
                "queryFrequency": "P7D",
                "queryPeriod": "P14D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "tactics": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": null
            }
        },
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/183b6f6c-827b-46d0-9297-bc240a8d7cb9')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/183b6f6c-827b-46d0-9297-bc240a8d7cb9')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2021-03-01-preview",
            "properties": {
                "displayName": "CMMC: Audit & Accountability Family Alert",
                "description": "CMMC Control Assessments have Deviated from Configured Threshold Baselines",
                "severity": "Medium",
                "enabled": true,
                "query": "// Rule Name - CMMC: Audit & Accountability Family Alert\n// Rule Description - CMMC Control Assessments have Deviated from Configured Threshold Baselines\n// Prerequisite 1: Onboard Azure Security Center (https://docs.microsoft.com/azure/security-center/security-center-get-started)\n// Prerequisite 2: Add the Azure Security Center: CMMC Assessment to Your Dashboard (https://docs.microsoft.com/azure/security-center/update-regulatory-compliance-packages?WT.mc_id=Portal-fx#add-a-regulatory-standard-to-your-dashboard)\n// Prerequisite 3: Continuously Export Security Center Data to Log Analytics Workspace (https://docs.microsoft.com/azure/security-center/continuous-export?WT.mc_id=Portal-fx)\nlet Policymap = datatable(RecommendationName:string, ControlFamily:string, ControlNumber: string, MaturityLevel:string, 800171Map:string, 80053Map:string)\n[\n\"Virtual machines should be connected to a specified workspace\",\t\"Audit & Accountability\",\t\"AU.2.041\",\t\"ML-2\",\t\"3.3.2\",\t\"AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12\",\n\"The Log Analytics agent should be installed on virtual machines\",\t\"Audit & Accountability\",\t\"AU.2.041\",\t\"ML-2\",\t\"3.3.2\",\t\"AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12\",\n\"An activity log alert should exist for Delete SQL Server Firewall Rule\",\t\"Audit & Accountability\",\t\"AU.2.041\",\t\"ML-2\",\t\"3.3.2\",\t\"AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12\",\n\"An activity log alert should exist for the Delete Network Security Group Rule\",\t\"Audit & Accountability\",\t\"AU.2.041\",\t\"ML-2\",\t\"3.3.2\",\t\"AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12\",\n\"Audit diagnostic setting\",\t\"Audit & Accountability\",\t\"AU.2.042\",\t\"ML-2\",\t\"3.3.1\",\t\"AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12\",\n\"Virtual machines should be connected to a specified workspace\",\t\"Audit & Accountability\",\t\"AU.2.042\",\t\"ML-2\",\t\"3.3.1\",\t\"AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12\",\n\"The Log Analytics agent should be installed on virtual machines\",\t\"Audit & Accountability\",\t\"AU.2.042\",\t\"ML-2\",\t\"3.3.1\",\t\"AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12\",\n\"An activity log alert should exist for Delete SQL Server Firewall Rule\",\t\"Audit & Accountability\",\t\"AU.2.042\",\t\"ML-2\",\t\"3.3.1\",\t\"AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12\",\n\"An activity log alert should exist for the Delete Network Security Group Rule\",\t\"Audit & Accountability\",\t\"AU.2.042\",\t\"ML-2\",\t\"3.3.1\",\t\"AU-2, AU-3, AU-3(1), AU-6, AU-11, AU-12\",\n\"Audit diagnostic setting\",\t\"Audit & Accountability\",\t\"AU.3.046\",\t\"ML-3\",\t\"3.3.4\",\t\"AU-5\",\n\"Virtual machines should be connected to a specified workspace\",\t\"Audit & Accountability\",\t\"AU.3.046\",\t\"ML-3\",\t\"3.3.4\",\t\"AU-5\",\n\"Azure Defender for SQL should be enabled for unprotected SQL Managed Instances\",\t\"Audit & Accountability\",\t\"AU.3.046\",\t\"ML-3\",\t\"3.3.4\",\t\"AU-5\",\n\"Log Analytics agent should be enabled in virtual machine scale sets for listed virtual machine images\",\t\"Audit & Accountability\",\t\"AU.3.046\",\t\"ML-3\",\t\"3.3.4\",\t\"AU-5\",\n\"[Preview]: Log Analytics Agent should be enabled for listed virtual machine images\",\t\"Audit & Accountability\",\t\"AU.3.046\",\t\"ML-3\",\t\"3.3.4\",\t\"AU-5\",\n\"Audit diagnostic setting\",\t\"Audit & Accountability\",\t\"AU.3.048\",\t\"ML-3\",\t\"NA\",\t\"AU-6(4)\",\n\"Virtual machines should be connected to a specified workspace\",\t\"Audit & Accountability\",\t\"AU.3.048\",\t\"ML-3\",\t\"NA\",\t\"AU-6(4)\",\n\"The Log Analytics agent should be installed on virtual machines\",\t\"Audit & Accountability\",\t\"AU.3.048\",\t\"ML-3\",\t\"NA\",\t\"AU-6(4)\",\n\"Diagnostic logs should be enabled in App Service\",\t\"Audit & Accountability\",\t\"AU.3.048\",\t\"ML-3\",\t\"NA\",\t\"AU-6(4)\",\n\"Log Analytics agent should be enabled in virtual machine scale sets for listed virtual machine images\",\t\"Audit & Accountability\",\t\"AU.3.048\",\t\"ML-3\",\t\"NA\",\t\"AU-6(4)\",\n\"Audit diagnostic setting\",\t\"Audit & Accountability\",\t\"AU.3.047\",\t\"ML-3\",\t\"3.3.8\",\t\"AU-6(7), AU-9\",\n\"An activity log alert should exist for specific Policy operations\",\t\"Audit & Accountability\",\t\"AU.3.047\",\t\"ML-3\",\t\"3.3.8\",\t\"AU-6(7), AU-9\"\n];\nSecurityRecommendation\n| where TimeGenerated > ago(14d) // Adjust Time Threasholds and Subscripition/Workspace Targets within Organizational Needs\n| join kind=rightouter Policymap on RecommendationName\n| where ControlFamily == \"Audit & Accountability\"\n| summarize\n    Assessments = count(),\n    Success = countif(RecommendationState == 'Healthy' or RecommendationState == 'NotApplicable'),\n    Failed = countif(RecommendationState == 'Unhealthy')\n    by ControlFamily, ControlNumber, MaturityLevel, RecommendationName\n| extend SuccessRatePercentage = (Success * 100 / Assessments)\n| extend FailedRatePercentage = (Failed * 100 / Assessments)\n| extend RemediationLink = strcat(\"https://portal.azure.com/#blade/Microsoft_Azure_Security/SecurityMenuBlade/22\")\n| project\n    ControlNumber,\n    ControlFamily,\n    MaturityLevel,\n    RecommendationName,\n    Assessments,\n    SuccessRatePercentage,\n    FailedRatePercentage,\n    RemediationLink\n| where RecommendationName <> \"\"\n// | where RecommendationName <> \"\" //Filter Out or Suppress Recommendations\n// | where MaturityLevel == \"ML-3\" //Filter by Maturity Level \n| where FailedRatePercentage > 30 //Adjust Either FailedRatePercentage or PasedRatePercentage Thresholds within Organizational Needs\n| sort by FailedRatePercentage desc\n| limit 250\n",
                "queryFrequency": "P7D",
                "queryPeriod": "P14D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "tactics": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": null
            }
        },
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/da854cce-ab6a-4b6f-afd1-b75717704d49')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/da854cce-ab6a-4b6f-afd1-b75717704d49')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2021-03-01-preview",
            "properties": {
                "displayName": "CMMC: Configuration Management Family Alert",
                "description": "CMMC Control Assessments have Deviated from Configured Threshold Baselines",
                "severity": "Medium",
                "enabled": true,
                "query": "// Rule Name - CMMC: Configuration Management Family Alert\n// Rule Description - CMMC Control Assessments have Deviated from Configured Threshold Baselines\n// Prerequisite 1: Onboard Azure Security Center (https://docs.microsoft.com/azure/security-center/security-center-get-started)\n// Prerequisite 2: Add the Azure Security Center: CMMC Assessment to Your Dashboard (https://docs.microsoft.com/azure/security-center/update-regulatory-compliance-packages?WT.mc_id=Portal-fx#add-a-regulatory-standard-to-your-dashboard)\n// Prerequisite 3: Continuously Export Security Center Data to Log Analytics Workspace (https://docs.microsoft.com/azure/security-center/continuous-export?WT.mc_id=Portal-fx)\nlet Policymap = datatable(RecommendationName:string, ControlFamily:string, ControlNumber: string, MaturityLevel:string, 800171Map:string, 80053Map:string)\n[\n\"Adaptive application controls for defining safe applications should be enabled on your machines\",\t\"Configuration Management\",\t\"CM.2.061\",\t\"ML-2\",\t\"3.4.1\",\t\"CM-2, CM-6, CM-8, CM-8(1)\",\n\"An activity log alert should exist for specific Policy operations\",\t\"Configuration Management\",\t\"CM.2.061\",\t\"ML-2\",\t\"3.4.1\",\t\"CM-2, CM-6, CM-8, CM-8(1)\",\n\"Windows machines should meet requirements for 'System Audit Policies - Privilege Use'\",\t\"Configuration Management\",\t\"CM.2.062\",\t\"ML-2\",\t\"3.4.6\",\t\"CM-7\",\n\"Role-Based Access Control should be used on Kubernetes Services\",\t\"Configuration Management\",\t\"CM.2.062\",\t\"ML-2\",\t\"3.4.6\",\t\"CM-7\",\n\"Windows machines should meet requirements for 'Security Options - User Account Control'\",\t\"Configuration Management\",\t\"CM.2.063\",\t\"ML-2\",\t\"3.4.9\",\t\"CM-11\",\n\"Adaptive application controls for defining safe applications should be enabled on your machines\",\t\"Configuration Management\",\t\"CM.2.063\",\t\"ML-2\",\t\"3.4.9\",\t\"CM-11\",\n\"Allowlist rules in your adaptive application control policy should be updated\",\t\"Configuration Management\",\t\"CM.2.063\",\t\"ML-2\",\t\"3.4.9\",\t\"CM-11\",\n\"Security Center standard pricing tier should be selected\",\t\"Configuration Management\",\t\"CM.2.063\",\t\"ML-2\",\t\"3.4.9\",\t\"CM-11\",\n\"Windows machines should meet requirements for 'Security Options - Network Security'\",\t\"Configuration Management\",\t\"CM.2.064\",\t\"ML-2\",\t\"3.4.2\",\t\"CM-2, CM-6,CM-8,CM-8(1)\",\n\"Firewall should be enabled on Key Vault\",\t\"Configuration Management\",\t\"CM.2.064\",\t\"ML-2\",\t\"3.4.2\",\t\"CM-2, CM-6,CM-8,CM-8(1)\",\n\"All network ports should be restricted on network security groups associated to your virtual machine\",\t\"Configuration Management\",\t\"CM.2.064\",\t\"ML-2\",\t\"3.4.2\",\t\"CM-2, CM-6,CM-8,CM-8(1)\",\n\"Virtual networks should be protected by Azure Firewall\",\t\"Configuration Management\",\t\"CM.2.064\",\t\"ML-2\",\t\"3.4.2\",\t\"CM-2, CM-6,CM-8,CM-8(1)\",\n\"Web Application Firewall (WAF) should use the specified mode for Azure Front Door Service\",\t\"Configuration Management\",\t\"CM.2.064\",\t\"ML-2\",\t\"3.4.2\",\t\"CM-2, CM-6,CM-8,CM-8(1)\",\n\"Windows machines should meet requirements for 'System Audit Policies - Policy Change'\",\t\"Configuration Management\",\t\"CM.2.065\",\t\"ML-2\",\t\"3.4.3\",\t\"CM-3\",\n\"An activity log alert should exist for Delete SQL Server Firewall Rule\",\t\"Configuration Management\",\t\"CM.2.065\",\t\"ML-2\",\t\"3.4.3\",\t\"CM-3\",\n\"An activity log alert should exist for the Delete Network Security Group Rule\",\t\"Configuration Management\",\t\"CM.2.065\",\t\"ML-2\",\t\"3.4.3\",\t\"CM-3\",\n\"An activity log alert should exist for Delete Network Security Solution\",\t\"Configuration Management\",\t\"CM.2.065\",\t\"ML-2\",\t\"3.4.3\",\t\"CM-3\",\n\"Azure Monitor should collect activity logs from all regions\",\t\"Configuration Management\",\t\"CM.2.065\",\t\"ML-2\",\t\"3.4.3\",\t\"CM-3\",\n\"Access to storage accounts with firewall and virtual network configurations should be restricted\",\t\"Configuration Management\",\t\"CM.3.068\",\t\"ML-3\",\t\"3.4.7\",\t\"CM-7(1), CM-7(2)\",\n\"Storage account public access should be disallowed\",\t\"Configuration Management\",\t\"CM.3.068\",\t\"ML-3\",\t\"3.4.7\",\t\"CM-7(1), CM-7(2)\",\n\"Non-internet-facing virtual machines should be protected with network security groups\",\t\"Configuration Management\",\t\"CM.3.068\",\t\"ML-3\",\t\"3.4.7\",\t\"CM-7(1), CM-7(2)\",\n\"Subnets should be associated with a network security group\",\t\"Configuration Management\",\t\"CM.3.068\",\t\"ML-3\",\t\"3.4.7\",\t\"CM-7(1), CM-7(2)\",\n\"Adaptive application controls for defining safe applications should be enabled on your machines\",\t\"Configuration Management\",\t\"CM.3.068\",\t\"ML-3\",\t\"3.4.7\",\t\"CM-7(1), CM-7(2)\",\n\"Adaptive application controls for defining safe applications should be enabled on your machines\",\t\"Configuration Management\",\t\"CM.3.069\",\t\"ML-3\",\t\"3.4.8\",\t\"CM-7(4), CM-7(5)\"\n];\nSecurityRecommendation\n| where TimeGenerated > ago(14d) // Adjust Time Threasholds and Subscripition/Workspace Targets within Organizational Needs\n| join kind=rightouter Policymap on RecommendationName\n| where ControlFamily == \"Configuration Management\"\n| summarize\n    Assessments = count(),\n    Success = countif(RecommendationState == 'Healthy' or RecommendationState == 'NotApplicable'),\n    Failed = countif(RecommendationState == 'Unhealthy')\n    by ControlFamily, ControlNumber, MaturityLevel, RecommendationName\n| extend SuccessRatePercentage = (Success * 100 / Assessments)\n| extend FailedRatePercentage = (Failed * 100 / Assessments)\n| extend RemediationLink = strcat(\"https://portal.azure.com/#blade/Microsoft_Azure_Security/SecurityMenuBlade/22\")\n| project\n    ControlNumber,\n    ControlFamily,\n    MaturityLevel,\n    RecommendationName,\n    Assessments,\n    SuccessRatePercentage,\n    FailedRatePercentage,\n    RemediationLink\n| where RecommendationName <> \"\"\n// | where RecommendationName <> \"\" //Filter Out or Suppress Recommendations\n// | where MaturityLevel == \"ML-3\" //Filter by Maturity Level \n| where FailedRatePercentage > 30 //Adjust Either FailedRatePercentage or PasedRatePercentage Thresholds within Organizational Needs\n| sort by FailedRatePercentage desc\n| limit 250\n",
                "queryFrequency": "P7D",
                "queryPeriod": "P14D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "tactics": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": null
            }
        },
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/555d423c-91b0-4912-8806-8293c3d2e108')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/555d423c-91b0-4912-8806-8293c3d2e108')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2021-03-01-preview",
            "properties": {
                "displayName": "CMMC: Identification & Authentication Family Alert",
                "description": "CMMC Control Assessments have Deviated from Configured Threshold Baselines",
                "severity": "Medium",
                "enabled": true,
                "query": "// Rule Name - CMMC: Identification & Authentication Family Alert\n// Rule Description - CMMC Control Assessments have Deviated from Configured Threshold Baselines\n// Prerequisite 1: Onboard Azure Security Center (https://docs.microsoft.com/azure/security-center/security-center-get-started)\n// Prerequisite 2: Add the Azure Security Center: CMMC Assessment to Your Dashboard (https://docs.microsoft.com/azure/security-center/update-regulatory-compliance-packages?WT.mc_id=Portal-fx#add-a-regulatory-standard-to-your-dashboard)\n// Prerequisite 3: Continuously Export Security Center Data to Log Analytics Workspace (https://docs.microsoft.com/azure/security-center/continuous-export?WT.mc_id=Portal-fx)\nlet Policymap = datatable(RecommendationName:string, ControlFamily:string, ControlNumber: string, MaturityLevel:string, 800171Map:string, 80053Map:string)\n[\n\"Add system-assigned managed identity to enable Guest Configuration assignments on virtual machines with no identities\",\t\"Identification & Authentication\",\t\"IA.1.077\",\t\"ML-1\",\t\"3.5.2\",\t\"IA-2, IA-3, IA-5\",\n\"Deploy the Windows Guest Configuration extension to enable Guest Configuration assignments on Windows VMs\",\t\"Identification & Authentication\",\t\"IA.1.077\",\t\"ML-1\",\t\"3.5.2\",\t\"IA-2, IA-3, IA-5\",\n\"Windows machines should meet requirements for 'Security Options - Network Security'\",\t\"Identification & Authentication\",\t\"IA.1.077\",\t\"ML-1\",\t\"3.5.2\",\t\"IA-2, IA-3, IA-5\",\n\"Audit Linux machines that have accounts without passwords\",\t\"Identification & Authentication\",\t\"IA.1.077\",\t\"ML-1\",\t\"3.5.2\",\t\"IA-2, IA-3, IA-5\",\n\"Audit Linux machines that do not have the passwd file permissions set to 0644\",\t\"Identification & Authentication\",\t\"IA.1.077\",\t\"ML-1\",\t\"3.5.2\",\t\"IA-2, IA-3, IA-5\",\n\"Add system-assigned managed identity to enable Guest Configuration assignments on virtual machines with no identities\",\t\"Identification & Authentication\",\t\"IA.2.078\",\t\"ML-2\",\t\"3.5.7\",\t\"IA-5(1)\",\n\"Audit Windows machines that do not restrict the minimum password length to 14 characters\",\t\"Identification & Authentication\",\t\"IA.2.078\",\t\"ML-2\",\t\"3.5.7\",\t\"IA-5(1)\",\n\"Deploy the Windows Guest Configuration extension to enable Guest Configuration assignments on Windows VMs\",\t\"Identification & Authentication\",\t\"IA.2.078\",\t\"ML-2\",\t\"3.5.7\",\t\"IA-5(1)\",\n\"Audit Windows machines that do not have the password complexity setting enabled\",\t\"Identification & Authentication\",\t\"IA.2.078\",\t\"ML-2\",\t\"3.5.7\",\t\"IA-5(1)\",\n\"Windows machines should meet requirements for 'Security Options - Network Security'\",\t\"Identification & Authentication\",\t\"IA.2.078\",\t\"ML-2\",\t\"3.5.7\",\t\"IA-5(1)\",\n\"Add system-assigned managed identity to enable Guest Configuration assignments on virtual machines with no identities\",\t\"Identification & Authentication\",\t\"IA.2.079\",\t\"ML-2\",\t\"3.5.8\",\t\"IA-5(1)\",\n\"Audit Windows machines that allow re-use of the previous 24 passwords\",\t\"Identification & Authentication\",\t\"IA.2.079\",\t\"ML-2\",\t\"3.5.8\",\t\"IA-5(1)\",\n\"Deploy the Windows Guest Configuration extension to enable Guest Configuration assignments on Windows VMs\",\t\"Identification & Authentication\",\t\"IA.2.079\",\t\"ML-2\",\t\"3.5.8\",\t\"IA-5(1)\",\n\"Windows machines should meet requirements for 'Security Options - Network Security'\",\t\"Identification & Authentication\",\t\"IA.2.079\",\t\"ML-2\",\t\"3.5.8\",\t\"IA-5(1)\",\n\"Add system-assigned managed identity to enable Guest Configuration assignments on VMs with a user-assigned identity\",\t\"Identification & Authentication\",\t\"IA.2.079\",\t\"ML-2\",\t\"3.5.8\",\t\"IA-5(1)\",\n\"Add system-assigned managed identity to enable Guest Configuration assignments on virtual machines with no identities\",\t\"Identification & Authentication\",\t\"IA.2.079\",\t\"ML-2\",\t\"3.5.10\",\t\"IA-5(1)\",\n\"Audit Windows machines that do not store passwords using reversible encryption\",\t\"Identification & Authentication\",\t\"IA.2.079\",\t\"ML-2\",\t\"3.5.10\",\t\"IA-5(1)\",\n\"Deploy the Windows Guest Configuration extension to enable Guest Configuration assignments on Windows VMs\",\t\"Identification & Authentication\",\t\"IA.2.079\",\t\"ML-2\",\t\"3.5.10\",\t\"IA-5(1)\",\n\"Windows machines should meet requirements for 'Security Options - Network Security'\",\t\"Identification & Authentication\",\t\"IA.2.079\",\t\"ML-2\",\t\"3.5.10\",\t\"IA-5(1)\",\n\"Add system-assigned managed identity to enable Guest Configuration assignments on VMs with a user-assigned identity\",\t\"Identification & Authentication\",\t\"IA.2.079\",\t\"ML-2\",\t\"3.5.10\",\t\"IA-5(1)\",\n\"MFA should be enabled on accounts with owner permissions on your subscription\",\t\"Identification & Authentication\",\t\"IA.3.083\",\t\"ML-3\",\t\"3.5.3\",\t\"IA-2(1), IA-2(2), IA-2(3)\",\n\"MFA should be enabled on accounts with write permissions on your subscription\",\t\"Identification & Authentication\",\t\"IA.3.083\",\t\"ML-3\",\t\"3.5.3\",\t\"IA-2(1), IA-2(2), IA-2(3)\",\n\"MFA should be enabled on accounts with read permissions on your subscription\",\t\"Identification & Authentication\",\t\"IA.3.083\",\t\"ML-3\",\t\"3.5.3\",\t\"IA-2(1), IA-2(2), IA-2(3)\",\n\"Function App should only be accessible over HTTPS\",\t\"Identification & Authentication\",\t\"IA.3.084\",\t\"ML-3\",\t\"3.5.4\",\t\"IA-2(8),IA-2(9)\",\n\"Web Application should only be accessible over HTTPS\",\t\"Identification & Authentication\",\t\"IA.3.084\",\t\"ML-3\",\t\"3.5.4\",\t\"IA-2(8),IA-2(9)\",\n\"MFA should be enabled on accounts with owner permissions on your subscription\",\t\"Identification & Authentication\",\t\"IA.3.084\",\t\"ML-3\",\t\"3.5.4\",\t\"IA-2(8),IA-2(9)\",\n\"MFA should be enabled on accounts with write permissions on your subscription\",\t\"Identification & Authentication\",\t\"IA.3.084\",\t\"ML-3\",\t\"3.5.4\",\t\"IA-2(8),IA-2(9)\",\n\"MFA should be enabled on accounts with read permissions on your subscription\",\t\"Identification & Authentication\",\t\"IA.3.084\",\t\"ML-3\",\t\"3.5.4\",\t\"IA-2(8),IA-2(9)\"\n];\nSecurityRecommendation\n| where TimeGenerated > ago(14d) // Adjust Time Threasholds and Subscripition/Workspace Targets within Organizational Needs\n| join kind=rightouter Policymap on RecommendationName\n| where ControlFamily == \"Identification & Authentication\"\n| summarize\n    Assessments = count(),\n    Success = countif(RecommendationState == 'Healthy' or RecommendationState == 'NotApplicable'),\n    Failed = countif(RecommendationState == 'Unhealthy')\n    by ControlFamily, ControlNumber, MaturityLevel, RecommendationName\n| extend SuccessRatePercentage = (Success * 100 / Assessments)\n| extend FailedRatePercentage = (Failed * 100 / Assessments)\n| extend RemediationLink = strcat(\"https://portal.azure.com/#blade/Microsoft_Azure_Security/SecurityMenuBlade/22\")\n| project\n    ControlNumber,\n    ControlFamily,\n    MaturityLevel,\n    RecommendationName,\n    Assessments,\n    SuccessRatePercentage,\n    FailedRatePercentage,\n    RemediationLink\n| where RecommendationName <> \"\"\n// | where RecommendationName <> \"\" //Filter Out or Suppress Recommendations\n// | where MaturityLevel == \"ML-3\" //Filter by Maturity Level \n| where FailedRatePercentage > 30 //Adjust Either FailedRatePercentage or PasedRatePercentage Thresholds within Organizational Needs\n| sort by FailedRatePercentage desc\n| limit 250\n",
                "queryFrequency": "P7D",
                "queryPeriod": "P14D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "tactics": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": null
            }
        },
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/32ec843c-e7e9-41cf-b378-50032b406696')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/32ec843c-e7e9-41cf-b378-50032b406696')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2021-03-01-preview",
            "properties": {
                "displayName": "CMMC: Incident Response Family Alert",
                "description": "CMMC Control Assessments have Deviated from Configured Threshold Baselines",
                "severity": "Medium",
                "enabled": true,
                "query": "// Rule Name - CMMC: Incident Response Family Alert\n// Rule Description - CMMC Control Assessments have Deviated from Configured Threshold Baselines\n// Prerequisite 1: Onboard Azure Security Center (https://docs.microsoft.com/azure/security-center/security-center-get-started)\n// Prerequisite 2: Add the Azure Security Center: CMMC Assessment to Your Dashboard (https://docs.microsoft.com/azure/security-center/update-regulatory-compliance-packages?WT.mc_id=Portal-fx#add-a-regulatory-standard-to-your-dashboard)\n// Prerequisite 3: Continuously Export Security Center Data to Log Analytics Workspace (https://docs.microsoft.com/azure/security-center/continuous-export?WT.mc_id=Portal-fx)\nlet Policymap = datatable(RecommendationName:string, ControlFamily:string, ControlNumber: string, MaturityLevel:string, 800171Map:string, 80053Map:string)\n[\n\"Vulnerability Assessment settings for SQL server should contain an email address to receive scan reports\",\t\"Incident Response\",\t\"IR.2.092\",\t\"ML-2\",\t\"3.6.1\",\t\"IR-2, IR-4, IR-5, IR-6, IR-7\",\n\"Subscriptions should have a contact email address for security issues\",\t\"Incident Response\",\t\"IR.2.092\",\t\"ML-2\",\t\"3.6.1\",\t\"IR-2, IR-4, IR-5, IR-6, IR-7\",\n\"Email notification to subscription owner for high severity alerts should be enabled\",\t\"Incident Response\",\t\"IR.2.092\",\t\"ML-2\",\t\"3.6.1\",\t\"IR-2, IR-4, IR-5, IR-6, IR-7\",\n\"Email notification for high severity alerts should be enabled\",\t\"Incident Response\",\t\"IR.2.092\",\t\"ML-2\",\t\"3.6.1\",\t\"IR-2, IR-4, IR-5, IR-6, IR-7\",\n\"Flow logs should be configured for every network security group\",\t\"Incident Response\",\t\"IR.2.093\",\t\"ML-2\",\t\"NA\",\t\"AR-4, AU-13, IA-10, IR-4, IR-5, IR-6, PE-6, RA-6\",\n\"Firewall should be enabled on Key Vault\",\t\"Incident Response\",\t\"IR.2.093\",\t\"ML-2\",\t\"NA\",\t\"AR-4, AU-13, IA-10, IR-4, IR-5, IR-6, PE-6, RA-6\",\n\"Endpoint protection health issues should be resolved on your machines\",\t\"Incident Response\",\t\"IR.2.093\",\t\"ML-2\",\t\"NA\",\t\"AR-4, AU-13, IA-10, IR-4, IR-5, IR-6, PE-6, RA-6\",\n\"Virtual networks should be protected by Azure Firewall\",\t\"Incident Response\",\t\"IR.2.093\",\t\"ML-2\",\t\"NA\",\t\"AR-4, AU-13, IA-10, IR-4, IR-5, IR-6, PE-6, RA-6\",\n\"Web Application Firewall (WAF) should use the specified mode for Azure Front Door Service\",\t\"Incident Response\",\t\"IR.2.093\",\t\"ML-2\",\t\"NA\",\t\"AR-4, AU-13, IA-10, IR-4, IR-5, IR-6, PE-6, RA-6\"\n];\nSecurityRecommendation\n| where TimeGenerated > ago(14d) // Adjust Time Threasholds and Subscripition/Workspace Targets within Organizational Needs\n| join kind=rightouter Policymap on RecommendationName\n| where ControlFamily == \"Incident Response\"\n| summarize\n    Assessments = count(),\n    Success = countif(RecommendationState == 'Healthy' or RecommendationState == 'NotApplicable'),\n    Failed = countif(RecommendationState == 'Unhealthy')\n    by ControlFamily, ControlNumber, MaturityLevel, RecommendationName\n| extend SuccessRatePercentage = (Success * 100 / Assessments)\n| extend FailedRatePercentage = (Failed * 100 / Assessments)\n| extend RemediationLink = strcat(\"https://portal.azure.com/#blade/Microsoft_Azure_Security/SecurityMenuBlade/22\")\n| project\n    ControlNumber,\n    ControlFamily,\n    MaturityLevel,\n    RecommendationName,\n    Assessments,\n    SuccessRatePercentage,\n    FailedRatePercentage,\n    RemediationLink\n| where RecommendationName <> \"\"\n// | where RecommendationName <> \"\" //Filter Out or Suppress Recommendations\n// | where MaturityLevel == \"ML-3\" //Filter by Maturity Level \n| where FailedRatePercentage > 30 //Adjust Either FailedRatePercentage or PasedRatePercentage Thresholds within Organizational Needs\n| sort by FailedRatePercentage desc\n| limit 250\n",
                "queryFrequency": "P7D",
                "queryPeriod": "P14D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "tactics": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": null
            }
        },
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/ad871f34-918d-4677-82d0-418b0e465848')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/ad871f34-918d-4677-82d0-418b0e465848')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2021-03-01-preview",
            "properties": {
                "displayName": "CMMC: Recovery Family Alert",
                "description": "CMMC Control Assessments have Deviated from Configured Threshold Baselines",
                "severity": "Medium",
                "enabled": true,
                "query": "// Rule Name - CMMC: Recovery Family Alert\n// Rule Description - CMMC Control Assessments have Deviated from Configured Threshold Baselines\n// Prerequisite 1: Onboard Azure Security Center (https://docs.microsoft.com/azure/security-center/security-center-get-started)\n// Prerequisite 2: Add the Azure Security Center: CMMC Assessment to Your Dashboard (https://docs.microsoft.com/azure/security-center/update-regulatory-compliance-packages?WT.mc_id=Portal-fx#add-a-regulatory-standard-to-your-dashboard)\n// Prerequisite 3: Continuously Export Security Center Data to Log Analytics Workspace (https://docs.microsoft.com/azure/security-center/continuous-export?WT.mc_id=Portal-fx)\nlet Policymap = datatable(RecommendationName:string, ControlFamily:string, ControlNumber: string, MaturityLevel:string, 800171Map:string, 80053Map:string)\n[\n\"Audit virtual machines without disaster recovery configured\",\t\"Recovery\",\t\"RE.2.137\",\t\"ML-2\",\t\"NA\",\t\"CP-9, CP-9(1)\",\n\"Azure Backup should be enabled for virtual machines\",\t\"Recovery\",\t\"RE.2.137\",\t\"ML-2\",\t\"NA\",\t\"CP-9, CP-9(1)\",\n\"Long-term geo-redundant backup should be enabled for Azure SQL Databases\",\t\"Recovery\",\t\"RE.2.137\",\t\"ML-2\",\t\"NA\",\t\"CP-9, CP-9(1)\",\n\"Geo-redundant backup should be enabled for Azure Database for PostgreSQL\",\t\"Recovery\",\t\"RE.2.137\",\t\"ML-2\",\t\"NA\",\t\"CP-9, CP-9(1)\",\n\"Geo-redundant backup should be enabled for Azure Database for MySQL\",\t\"Recovery\",\t\"RE.2.137\",\t\"ML-2\",\t\"NA\",\t\"CP-9, CP-9(1)\",\n\"Audit virtual machines without disaster recovery configured\",\t\"Recovery\",\t\"RE.3.139\",\t\"ML-3\",\t\"NA\",\t\"CP-9, CP-9(3), CP-9(5)\",\n\"Azure Backup should be enabled for virtual machines\",\t\"Recovery\",\t\"RE.3.139\",\t\"ML-3\",\t\"NA\",\t\"CP-9, CP-9(3), CP-9(5)\",\n\"Long-term geo-redundant backup should be enabled for Azure SQL Databases\",\t\"Recovery\",\t\"RE.3.139\",\t\"ML-3\",\t\"NA\",\t\"CP-9, CP-9(3), CP-9(5)\",\n\"Geo-redundant backup should be enabled for Azure Database for PostgreSQL\",\t\"Recovery\",\t\"RE.3.139\",\t\"ML-3\",\t\"NA\",\t\"CP-9, CP-9(3), CP-9(5)\",\n\"Geo-redundant backup should be enabled for Azure Database for MySQL\",\t\"Recovery\",\t\"RE.3.139\",\t\"ML-3\",\t\"NA\",\t\"CP-9, CP-9(3), CP-9(5)\"\n];\nSecurityRecommendation\n| where TimeGenerated > ago(14d) // Adjust Time Threasholds and Subscripition/Workspace Targets within Organizational Needs\n| join kind=rightouter Policymap on RecommendationName\n| where ControlFamily == \"Recovery\"\n| summarize\n    Assessments = count(),\n    Success = countif(RecommendationState == 'Healthy' or RecommendationState == 'NotApplicable'),\n    Failed = countif(RecommendationState == 'Unhealthy')\n    by ControlFamily, ControlNumber, MaturityLevel, RecommendationName\n| extend SuccessRatePercentage = (Success * 100 / Assessments)\n| extend FailedRatePercentage = (Failed * 100 / Assessments)\n| extend RemediationLink = strcat(\"https://portal.azure.com/#blade/Microsoft_Azure_Security/SecurityMenuBlade/22\")\n| project\n    ControlNumber,\n    ControlFamily,\n    MaturityLevel,\n    RecommendationName,\n    Assessments,\n    SuccessRatePercentage,\n    FailedRatePercentage,\n    RemediationLink\n| where RecommendationName <> \"\"\n// | where RecommendationName <> \"\" //Filter Out or Suppress Recommendations\n// | where MaturityLevel == \"ML-3\" //Filter by Maturity Level \n| where FailedRatePercentage > 30 //Adjust Either FailedRatePercentage or PasedRatePercentage Thresholds within Organizational Needs\n| sort by FailedRatePercentage desc\n| limit 250\n",
                "queryFrequency": "P7D",
                "queryPeriod": "P14D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "tactics": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": null
            }
        },
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/6166f4bc-bd75-4b64-a378-cd7b68a07665')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/6166f4bc-bd75-4b64-a378-cd7b68a07665')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2021-03-01-preview",
            "properties": {
                "displayName": "CMMC: Risk Management Family Alert",
                "description": "CMMC Control Assessments have Deviated from Configured Threshold Baselines",
                "severity": "Medium",
                "enabled": true,
                "query": "// Rule Name - CMMC: Risk Management Family Alert\n// Rule Description - CMMC Control Assessments have Deviated from Configured Threshold Baselines\n// Prerequisite 1: Onboard Azure Security Center (https://docs.microsoft.com/azure/security-center/security-center-get-started)\n// Prerequisite 2: Add the Azure Security Center: CMMC Assessment to Your Dashboard (https://docs.microsoft.com/azure/security-center/update-regulatory-compliance-packages?WT.mc_id=Portal-fx#add-a-regulatory-standard-to-your-dashboard)\n// Prerequisite 3: Continuously Export Security Center Data to Log Analytics Workspace (https://docs.microsoft.com/azure/security-center/continuous-export?WT.mc_id=Portal-fx)\nlet Policymap = datatable(RecommendationName:string, ControlFamily:string, ControlNumber: string, MaturityLevel:string, 800171Map:string, 80053Map:string)\n[\n\"Vulnerabilities in your virtual machines should be remediated\",\t\"Risk Management\",\t\"RM.2.141\",\t\"ML-2\",\t\"3.11.1\",\t\"RA-3\",\n\"Vulnerability Assessment settings for SQL server should contain an email address to receive scan reports\",\t\"Risk Management\",\t\"RM.2.141\",\t\"ML-2\",\t\"3.11.1\",\t\"RA-3\",\n\"Vulnerability assessment should be enabled on your SQL servers\",\t\"Risk Management\",\t\"RM.2.141\",\t\"ML-2\",\t\"3.11.1\",\t\"RA-3\",\n\"Azure Defender for SQL should be enabled for unprotected SQL Managed Instances\",\t\"Risk Management\",\t\"RM.2.141\",\t\"ML-2\",\t\"3.11.1\",\t\"RA-3\",\n\"Vulnerability assessment should be enabled on your SQL managed instances\",\t\"Risk Management\",\t\"RM.2.141\",\t\"ML-2\",\t\"3.11.1\",\t\"RA-3\",\n\"Vulnerabilities in your virtual machines should be remediated\",\t\"Risk Management\",\t\"RM.2.142\",\t\"ML-2\",\t\"3.11.2\",\t\"RA-5, RA-5(5)\",\n\"Vulnerability Assessment settings for SQL server should contain an email address to receive scan reports\",\t\"Risk Management\",\t\"RM.2.142\",\t\"ML-2\",\t\"3.11.2\",\t\"RA-5, RA-5(5)\",\n\"Vulnerability assessment should be enabled on your SQL servers\",\t\"Risk Management\",\t\"RM.2.142\",\t\"ML-2\",\t\"3.11.2\",\t\"RA-5, RA-5(5)\",\n\"Azure Defender for SQL should be enabled for unprotected SQL Managed Instances\",\t\"Risk Management\",\t\"RM.2.142\",\t\"ML-2\",\t\"3.11.2\",\t\"RA-5, RA-5(5)\",\n\"Vulnerability assessment should be enabled on your SQL managed instances\",\t\"Risk Management\",\t\"RM.2.142\",\t\"ML-2\",\t\"3.11.2\",\t\"RA-5, RA-5(5)\",\n\"Vulnerabilities in security configuration on your machines should be remediated\",\t\"Risk Management\",\t\"RM.2.143\",\t\"ML-2\",\t\"3.11.3\",\t\"RA-5\",\n\"Vulnerabilities in your virtual machines should be remediated\",\t\"Risk Management\",\t\"RM.2.143\",\t\"ML-2\",\t\"3.11.3\",\t\"RA-5\",\n\"Vulnerability Assessment settings for SQL server should contain an email address to receive scan reports\",\t\"Risk Management\",\t\"RM.2.143\",\t\"ML-2\",\t\"3.11.3\",\t\"RA-5\",\n\"Vulnerability assessment should be enabled on your SQL servers\",\t\"Risk Management\",\t\"RM.2.143\",\t\"ML-2\",\t\"3.11.3\",\t\"RA-5\",\n\"Vulnerabilities in Azure Container Registry images should be remediated (powered by Qualys)\",\t\"Risk Management\",\t\"RM.2.143\",\t\"ML-2\",\t\"3.11.3\",\t\"RA-5\",\n\"Vulnerability Assessment settings for SQL server should contain an email address to receive scan reports\",\t\"Risk Management\",\t\"RM.3.144\",\t\"ML-3\",\t\"NA\",\t\"CA-2, PM-9, RA-3, SA-20\",\n\"Azure Defender for Key Vault should be enabled\",\t\"Risk Management\",\t\"RM.3.144\",\t\"ML-3\",\t\"NA\",\t\"CA-2, PM-9, RA-3, SA-20\",\n\"Azure Defender for Kubernetes should be enabled\",\t\"Risk Management\",\t\"RM.3.144\",\t\"ML-3\",\t\"NA\",\t\"CA-2, PM-9, RA-3, SA-20\",\n\"Azure Defender for SQL servers on machines should be enabled\",\t\"Risk Management\",\t\"RM.3.144\",\t\"ML-3\",\t\"NA\",\t\"CA-2, PM-9, RA-3, SA-20\",\n\"Azure Defender for Azure SQL Database servers should be enabled\",\t\"Risk Management\",\t\"RM.3.144\",\t\"ML-3\",\t\"NA\",\t\"CA-2, PM-9, RA-3, SA-20\"\n];\nSecurityRecommendation\n| where TimeGenerated > ago(14d) // Adjust Time Threasholds and Subscripition/Workspace Targets within Organizational Needs\n| join kind=rightouter Policymap on RecommendationName\n| where ControlFamily == \"Risk Management\"\n| summarize\n    Assessments = count(),\n    Success = countif(RecommendationState == 'Healthy' or RecommendationState == 'NotApplicable'),\n    Failed = countif(RecommendationState == 'Unhealthy')\n    by ControlFamily, ControlNumber, MaturityLevel, RecommendationName\n| extend SuccessRatePercentage = (Success * 100 / Assessments)\n| extend FailedRatePercentage = (Failed * 100 / Assessments)\n| extend RemediationLink = strcat(\"https://portal.azure.com/#blade/Microsoft_Azure_Security/SecurityMenuBlade/22\")\n| project\n    ControlNumber,\n    ControlFamily,\n    MaturityLevel,\n    RecommendationName,\n    Assessments,\n    SuccessRatePercentage,\n    FailedRatePercentage,\n    RemediationLink\n| where RecommendationName <> \"\"\n// | where RecommendationName <> \"\" //Filter Out or Suppress Recommendations\n// | where MaturityLevel == \"ML-3\" //Filter by Maturity Level \n| where FailedRatePercentage > 30 //Adjust Either FailedRatePercentage or PasedRatePercentage Thresholds within Organizational Needs\n| sort by FailedRatePercentage desc\n| limit 250\n",
                "queryFrequency": "P7D",
                "queryPeriod": "P14D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "tactics": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": null
            }
        },
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/d91f43c3-5217-4e30-ac6f-d639e1e05979')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/d91f43c3-5217-4e30-ac6f-d639e1e05979')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2021-03-01-preview",
            "properties": {
                "displayName": "CMMC: Security Assessment Family Alert",
                "description": "CMMC Control Assessments have Deviated from Configured Threshold Baselines",
                "severity": "Medium",
                "enabled": true,
                "query": "// Rule Name - CMMC: Security Assessment Family Alert\n// Rule Description - CMMC Control Assessments have Deviated from Configured Threshold Baselines\n// Prerequisite 1: Onboard Azure Security Center (https://docs.microsoft.com/azure/security-center/security-center-get-started)\n// Prerequisite 2: Add the Azure Security Center: CMMC Assessment to Your Dashboard (https://docs.microsoft.com/azure/security-center/update-regulatory-compliance-packages?WT.mc_id=Portal-fx#add-a-regulatory-standard-to-your-dashboard)\n// Prerequisite 3: Continuously Export Security Center Data to Log Analytics Workspace (https://docs.microsoft.com/azure/security-center/continuous-export?WT.mc_id=Portal-fx)\nlet Policymap = datatable(RecommendationName:string, ControlFamily:string, ControlNumber: string, MaturityLevel:string, 800171Map:string, 80053Map:string)\n[\n\"Adaptive application controls for defining safe applications should be enabled on your machines\",\t\"Security Assessment\",\t\"CA.2.158\",\t\"ML-2\",\t\"3.12.1\",\t\"CA-2, CA-5, CA-7, PL-2\",\n\"Vulnerabilities in your virtual machines should be remediated\",\t\"Security Assessment\",\t\"CA.2.158\",\t\"ML-2\",\t\"3.12.1\",\t\"CA-2, CA-5, CA-7, PL-2\",\n\"Endpoint protection health issues should be resolved on your machines\",\t\"Security Assessment\",\t\"CA.2.158\",\t\"ML-2\",\t\"3.12.1\",\t\"CA-2, CA-5, CA-7, PL-2\",\n\"Vulnerability assessment should be enabled on your SQL servers\",\t\"Security Assessment\",\t\"CA.2.158\",\t\"ML-2\",\t\"3.12.1\",\t\"CA-2, CA-5, CA-7, PL-2\",\n\"An activity log alert should exist for Delete Security Solution\",\t\"Security Assessment\",\t\"CA.2.158\",\t\"ML-2\",\t\"3.12.1\",\t\"CA-2, CA-5, CA-7, PL-2\",\n\"Adaptive application controls for defining safe applications should be enabled on your machines\",\t\"Security Assessment\",\t\"CA.3.161\",\t\"ML-3\",\t\"3.12.3\",\t\"CA-2, CA-5, CA-7, PL-2\",\n\"Vulnerabilities in your virtual machines should be remediated\",\t\"Security Assessment\",\t\"CA.3.161\",\t\"ML-3\",\t\"3.12.3\",\t\"CA-2, CA-5, CA-7, PL-2\",\n\"Endpoint protection health issues should be resolved on your machines\",\t\"Security Assessment\",\t\"CA.3.161\",\t\"ML-3\",\t\"3.12.3\",\t\"CA-2, CA-5, CA-7, PL-2\",\n\"Vulnerability assessment should be enabled on your SQL servers\",\t\"Security Assessment\",\t\"CA.3.161\",\t\"ML-3\",\t\"3.12.3\",\t\"CA-2, CA-5, CA-7, PL-2\",\n\"An activity log alert should exist for Delete Security Solution\",\t\"Security Assessment\",\t\"CA.3.161\",\t\"ML-3\",\t\"3.12.3\",\t\"CA-2, CA-5, CA-7, PL-2\"\n];\nSecurityRecommendation\n| where TimeGenerated > ago(14d) // Adjust Time Threasholds and Subscripition/Workspace Targets within Organizational Needs\n| join kind=rightouter Policymap on RecommendationName\n| where ControlFamily == \"Security Assessment\"\n| summarize\n    Assessments = count(),\n    Success = countif(RecommendationState == 'Healthy' or RecommendationState == 'NotApplicable'),\n    Failed = countif(RecommendationState == 'Unhealthy')\n    by ControlFamily, ControlNumber, MaturityLevel, RecommendationName\n| extend SuccessRatePercentage = (Success * 100 / Assessments)\n| extend FailedRatePercentage = (Failed * 100 / Assessments)\n| extend RemediationLink = strcat(\"https://portal.azure.com/#blade/Microsoft_Azure_Security/SecurityMenuBlade/22\")\n| project\n    ControlNumber,\n    ControlFamily,\n    MaturityLevel,\n    RecommendationName,\n    Assessments,\n    SuccessRatePercentage,\n    FailedRatePercentage,\n    RemediationLink\n| where RecommendationName <> \"\"\n// | where RecommendationName <> \"\" //Filter Out or Suppress Recommendations\n// | where MaturityLevel == \"ML-3\" //Filter by Maturity Level \n| where FailedRatePercentage > 30 //Adjust Either FailedRatePercentage or PasedRatePercentage Thresholds within Organizational Needs\n| sort by FailedRatePercentage desc\n| limit 250",
                "queryFrequency": "P7D",
                "queryPeriod": "P14D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "tactics": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": null
            }
        },
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/652ee89e-23d0-419d-903c-48b03c4c019e')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/652ee89e-23d0-419d-903c-48b03c4c019e')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2021-03-01-preview",
            "properties": {
                "displayName": "CMMC: System & Communications Protection Family Alert",
                "description": "CMMC Control Assessments have Deviated from Configured Threshold Baselines",
                "severity": "Medium",
                "enabled": true,
                "query": "// Rule Name - CMMC: System & Communications Protection Family Alert\n// Rule Description - CMMC Control Assessments have Deviated from Configured Threshold Baselines\n// Prerequisite 1: Onboard Azure Security Center (https://docs.microsoft.com/azure/security-center/security-center-get-started)\n// Prerequisite 2: Add the Azure Security Center: CMMC Assessment to Your Dashboard (https://docs.microsoft.com/azure/security-center/update-regulatory-compliance-packages?WT.mc_id=Portal-fx#add-a-regulatory-standard-to-your-dashboard)\n// Prerequisite 3: Continuously Export Security Center Data to Log Analytics Workspace (https://docs.microsoft.com/azure/security-center/continuous-export?WT.mc_id=Portal-fx)\nlet Policymap = datatable(RecommendationName:string, ControlFamily:string, ControlNumber: string, MaturityLevel:string, 800171Map:string, 80053Map:string)\n[\n\"Access to storage accounts with firewall and virtual network configurations should be restricted\",\t\"System & Communications Protection\",\t\"SC.1.175\",\t\"ML-1\",\t\"3.13.1\",\t\"SC-7, SA-8\",\n\"Storage account public access should be disallowed\",\t\"System & Communications Protection\",\t\"SC.1.175\",\t\"ML-1\",\t\"3.13.1\",\t\"SC-7, SA-8\",\n\"Windows machines should meet requirements for 'Security Options - Network Access'\",\t\"System & Communications Protection\",\t\"SC.1.175\",\t\"ML-1\",\t\"3.13.1\",\t\"SC-7, SA-8\",\n\"Windows machines should meet requirements for 'Security Options - Network Security'\",\t\"System & Communications Protection\",\t\"SC.1.175\",\t\"ML-1\",\t\"3.13.1\",\t\"SC-7, SA-8\",\n\"Non-internet-facing virtual machines should be protected with network security groups\",\t\"System & Communications Protection\",\t\"SC.1.175\",\t\"ML-1\",\t\"3.13.1\",\t\"SC-7, SA-8\",\n\"Access to storage accounts with firewall and virtual network configurations should be restricted\",\t\"System & Communications Protection\",\t\"SC.1.176\",\t\"ML-1\",\t\"3.13.5\",\t\"SC-7\",\n\"Subnets should be associated with a network security group\",\t\"System & Communications Protection\",\t\"SC.1.176\",\t\"ML-1\",\t\"3.13.5\",\t\"SC-7\",\n\"Adaptive network hardening recommendations should be applied on internet facing virtual machines\",\t\"System & Communications Protection\",\t\"SC.1.176\",\t\"ML-1\",\t\"3.13.5\",\t\"SC-7\",\n\"All network ports should be restricted on network security groups associated to your virtual machine\",\t\"System & Communications Protection\",\t\"SC.1.176\",\t\"ML-1\",\t\"3.13.5\",\t\"SC-7\",\n\"Internet-facing virtual machines should be protected with network security groups\",\t\"System & Communications Protection\",\t\"SC.1.176\",\t\"ML-1\",\t\"3.13.5\",\t\"SC-7\",\n\"Management ports of virtual machines should be protected with just-in-time network access control\",\t\"System & Communications Protection\",\t\"SC.2.179\",\t\"ML-2\",\t\"NA\",\t\"NA\",\n\"[Enable if required] Storage accounts should use customer-managed key (CMK) for encryption\",\t\"System & Communications Protection\",\t\"SC.3.177\",\t\"ML-3\",\t\"3.13.11\",\t\"SC-13\",\n\"Storage accounts should have infrastructure encryption\",\t\"System & Communications Protection\",\t\"SC.3.177\",\t\"ML-3\",\t\"3.13.11\",\t\"SC-13\",\n\"Virtual machines should encrypt temp disks, caches, and data flows between Compute and Storage resources\",\t\"System & Communications Protection\",\t\"SC.3.177\",\t\"ML-3\",\t\"3.13.11\",\t\"SC-13\",\n\"Audit Windows machines that do not store passwords using reversible encryption\",\t\"System & Communications Protection\",\t\"SC.3.177\",\t\"ML-3\",\t\"3.13.11\",\t\"SC-13\",\n\"Unattached disks should be encrypted\",\t\"System & Communications Protection\",\t\"SC.3.177\",\t\"ML-3\",\t\"3.13.11\",\t\"SC-13\",\n\"Subnets should be associated with a network security group\",\t\"System & Communications Protection\",\t\"SC.3.180\",\t\"ML-3\",\t\"3.13.2\",\t\"SC-7, SA-8\",\n\"Audit Windows machines that have the specified members in the Administrators group\",\t\"System & Communications Protection\",\t\"SC.3.181\",\t\"ML-3\",\t\"3.13.3\",\t\"SC-2\",\n\"External accounts with owner permissions should be removed from your subscription\",\t\"System & Communications Protection\",\t\"SC.3.181\",\t\"ML-3\",\t\"3.13.3\",\t\"SC-2\",\n\"A maximum of 3 owners should be designated for your subscription\",\t\"System & Communications Protection\",\t\"SC.3.181\",\t\"ML-3\",\t\"3.13.3\",\t\"SC-2\",\n\"An Azure Active Directory administrator should be provisioned for SQL servers\",\t\"System & Communications Protection\",\t\"SC.3.181\",\t\"ML-3\",\t\"3.13.3\",\t\"SC-2\",\n\"Deprecated accounts with owner permissions should be removed from your subscription\",\t\"System & Communications Protection\",\t\"SC.3.181\",\t\"ML-3\",\t\"3.13.3\",\t\"SC-2\",\n\"Access to storage accounts with firewall and virtual network configurations should be restricted\",\t\"System & Communications Protection\",\t\"SC.3.183\",\t\"ML-3\",\t\"3.13.6\",\t\"SC-7(5)\",\n\"Storage account public access should be disallowed\",\t\"System & Communications Protection\",\t\"SC.3.183\",\t\"ML-3\",\t\"3.13.6\",\t\"SC-7(5)\",\n\"Windows machines should meet requirements for 'Security Options - Network Access'\",\t\"System & Communications Protection\",\t\"SC.3.183\",\t\"ML-3\",\t\"3.13.6\",\t\"SC-7(5)\",\n\"Windows machines should meet requirements for 'Security Options - Network Security'\",\t\"System & Communications Protection\",\t\"SC.3.183\",\t\"ML-3\",\t\"3.13.6\",\t\"SC-7(5)\",\n\"Non-internet-facing virtual machines should be protected with network security groups\",\t\"System & Communications Protection\",\t\"SC.3.183\",\t\"ML-3\",\t\"3.13.6\",\t\"SC-7(5)\",\n\"Access to storage accounts with firewall and virtual network configurations should be restricted\",\t\"System & Communications Protection\",\t\"SC.3.185\",\t\"ML-3\",\t\"3.13.8\",\t\"SC-8, SC-8(1)\",\n\"Function App should only be accessible over HTTPS\",\t\"System & Communications Protection\",\t\"SC.3.185\",\t\"ML-3\",\t\"3.13.8\",\t\"SC-8, SC-8(1)\",\n\"Secure transfer to storage accounts should be enabled\",\t\"System & Communications Protection\",\t\"SC.3.185\",\t\"ML-3\",\t\"3.13.8\",\t\"SC-8, SC-8(1)\",\n\"Web Application should only be accessible over HTTPS\",\t\"System & Communications Protection\",\t\"SC.3.185\",\t\"ML-3\",\t\"3.13.8\",\t\"SC-8, SC-8(1)\",\n\"API App should only be accessible over HTTPS\",\t\"System & Communications Protection\",\t\"SC.3.185\",\t\"ML-3\",\t\"3.13.8\",\t\"SC-8, SC-8(1)\",\n\"Key vaults should have purge protection enabled\",\t\"System & Communications Protection\",\t\"SC.3.187\",\t\"ML-3\",\t\"3.13.10\",\t\"SC-12\",\n\"Firewall should be enabled on Key Vault\",\t\"System & Communications Protection\",\t\"SC.3.187\",\t\"ML-3\",\t\"3.13.10\",\t\"SC-12\",\n\"Key vaults should have soft delete enabled\",\t\"System & Communications Protection\",\t\"SC.3.187\",\t\"ML-3\",\t\"3.13.10\",\t\"SC-12\",\n\"Azure Defender for Key Vault should be enabled\",\t\"System & Communications Protection\",\t\"SC.3.187\",\t\"ML-3\",\t\"3.13.10\",\t\"SC-12\",\n\"Keys using RSA cryptography should have a specified minimum key size\",\t\"System & Communications Protection\",\t\"SC.3.187\",\t\"ML-3\",\t\"3.13.10\",\t\"SC-12\",\n\"Function App should only be accessible over HTTPS\",\t\"System & Communications Protection\",\t\"SC.3.190\",\t\"ML-3\",\t\"3.13.15\",\t\"SC-23\",\n\"Web Application should only be accessible over HTTPS\",\t\"System & Communications Protection\",\t\"SC.3.190\",\t\"ML-3\",\t\"3.13.15\",\t\"SC-23\",\n\"MFA should be enabled on accounts with owner permissions on your subscription\",\t\"System & Communications Protection\",\t\"SC.3.190\",\t\"ML-3\",\t\"3.13.15\",\t\"SC-23\",\n\"MFA should be enabled on accounts with write permissions on your subscription\",\t\"System & Communications Protection\",\t\"SC.3.190\",\t\"ML-3\",\t\"3.13.15\",\t\"SC-23\",\n\"MFA should be enabled on accounts with read permissions on your subscription\",\t\"System & Communications Protection\",\t\"SC.3.190\",\t\"ML-3\",\t\"3.13.15\",\t\"SC-23\",\n\"Storage accounts should have infrastructure encryption\",\t\"System & Communications Protection\",\t\"SC.3.191\",\t\"ML-3\",\t\"3.13.16\",\t\"SC-28\",\n\"Access to storage accounts with firewall and virtual network configurations should be restricted\",\t\"System & Communications Protection\",\t\"SC.3.191\",\t\"ML-3\",\t\"3.13.16\",\t\"SC-28\",\n\"Virtual machines should encrypt temp disks, caches, and data flows between Compute and Storage resources\",\t\"System & Communications Protection\",\t\"SC.3.191\",\t\"ML-3\",\t\"3.13.16\",\t\"SC-28\",\n\"Unattached disks should be encrypted\",\t\"System & Communications Protection\",\t\"SC.3.191\",\t\"ML-3\",\t\"3.13.16\",\t\"SC-28\",\n\"Double encryption should be enabled on Azure Data Explorer\",\t\"System & Communications Protection\",\t\"SC.3.191\",\t\"ML-3\",\t\"3.13.16\",\t\"SC-28\"\n];\nSecurityRecommendation\n| where TimeGenerated > ago(14d) // Adjust Time Threasholds and Subscripition/Workspace Targets within Organizational Needs\n| join kind=rightouter Policymap on RecommendationName\n| where ControlFamily == \"System & Communications Protection\"\n| summarize\n    Assessments = count(),\n    Success = countif(RecommendationState == 'Healthy' or RecommendationState == 'NotApplicable'),\n    Failed = countif(RecommendationState == 'Unhealthy')\n    by ControlFamily, ControlNumber, MaturityLevel, RecommendationName\n| extend SuccessRatePercentage = (Success * 100 / Assessments)\n| extend FailedRatePercentage = (Failed * 100 / Assessments)\n| extend RemediationLink = strcat(\"https://portal.azure.com/#blade/Microsoft_Azure_Security/SecurityMenuBlade/22\")\n| project\n    ControlNumber,\n    ControlFamily,\n    MaturityLevel,\n    RecommendationName,\n    Assessments,\n    SuccessRatePercentage,\n    FailedRatePercentage,\n    RemediationLink\n| where RecommendationName <> \"\"\n// | where RecommendationName <> \"\" //Filter Out or Suppress Recommendations\n// | where MaturityLevel == \"ML-3\" //Filter by Maturity Level \n| where FailedRatePercentage > 30 //Adjust Either FailedRatePercentage or PasedRatePercentage Thresholds within Organizational Needs\n| sort by FailedRatePercentage desc\n| limit 250",
                "queryFrequency": "P7D",
                "queryPeriod": "P14D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "tactics": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": null
            }
        },
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/eec5041a-0ba6-4213-b066-d70eb8f52a74')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/eec5041a-0ba6-4213-b066-d70eb8f52a74')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2021-03-01-preview",
            "properties": {
                "displayName": "CMMC: System & Information Integrity Family Alert",
                "description": "CMMC Control Assessments have Deviated from Configured Threshold Baselines",
                "severity": "Medium",
                "enabled": true,
                "query": "// Rule Name - CMMC: System & Information Integrity Family Alert\n// Rule Description - CMMC Control Assessments have Deviated from Configured Threshold Baselines\n// Prerequisite 1: Onboard Azure Security Center (https://docs.microsoft.com/azure/security-center/security-center-get-started)\n// Prerequisite 2: Add the Azure Security Center: CMMC Assessment to Your Dashboard (https://docs.microsoft.com/azure/security-center/update-regulatory-compliance-packages?WT.mc_id=Portal-fx#add-a-regulatory-standard-to-your-dashboard)\n// Prerequisite 3: Continuously Export Security Center Data to Log Analytics Workspace (https://docs.microsoft.com/azure/security-center/continuous-export?WT.mc_id=Portal-fx)\nlet Policymap = datatable(RecommendationName:string, ControlFamily:string, ControlNumber: string, MaturityLevel:string, 800171Map:string, 80053Map:string)\n[\n\"Microsoft Antimalware for Azure should be configured to automatically update protection signatures\",\t\"System & Information Integrity\",\t\"SI.1.210\",\t\"ML-1\",\t\"3.14.1\",\t\"SI-2,SI-3,SI-5\",\n\"Vulnerabilities in security configuration on your machines should be remediated\",\t\"System & Information Integrity\",\t\"SI.1.210\",\t\"ML-1\",\t\"3.14.1\",\t\"SI-2,SI-3,SI-5\",\n\"Ensure that 'HTTP Version' is the latest, if used to run the Function app\",\t\"System & Information Integrity\",\t\"SI.1.210\",\t\"ML-1\",\t\"3.14.1\",\t\"SI-2,SI-3,SI-5\",\n\"Python should be updated to the latest version for your function app\",\t\"System & Information Integrity\",\t\"SI.1.210\",\t\"ML-1\",\t\"3.14.1\",\t\"SI-2,SI-3,SI-5\",\n\"Ensure that 'HTTP Version' is the latest, if used to run the Web app\",\t\"System & Information Integrity\",\t\"SI.1.210\",\t\"ML-1\",\t\"3.14.1\",\t\"SI-2,SI-3,SI-5\",\n\"Microsoft Antimalware for Azure should be configured to automatically update protection signatures\",\t\"System & Information Integrity\",\t\"SI.1.211\",\t\"ML-1\",\t\"3.14.2\",\t\"SI-2,SI-3,SI-5\",\n\"Microsoft IaaSAntimalware extension should be deployed on Windows servers\",\t\"System & Information Integrity\",\t\"SI.1.211\",\t\"ML-1\",\t\"3.14.2\",\t\"SI-2,SI-3,SI-5\",\n\"Endpoint protection health issues should be resolved on your machines\",\t\"System & Information Integrity\",\t\"SI.1.211\",\t\"ML-1\",\t\"3.14.2\",\t\"SI-2,SI-3,SI-5\",\n\"Endpoint protection health failures should be remediated on virtual machine scale sets\",\t\"System & Information Integrity\",\t\"SI.1.211\",\t\"ML-1\",\t\"3.14.2\",\t\"SI-2,SI-3,SI-5\",\n\"Microsoft Antimalware for Azure should be configured to automatically update protection signatures\",\t\"System & Information Integrity\",\t\"SI.1.212\",\t\"ML-1\",\t\"3.14.4\",\t\"SI-3\",\n\"Microsoft Antimalware for Azure should be configured to automatically update protection signatures\",\t\"System & Information Integrity\",\t\"SI.1.213\",\t\"ML-1\",\t\"3.14.5\",\t\"SI-3\",\n\"Microsoft IaaSAntimalware extension should be deployed on Windows servers\",\t\"System & Information Integrity\",\t\"SI.1.213\",\t\"ML-1\",\t\"3.14.5\",\t\"SI-3\",\n\"Endpoint protection health issues should be resolved on your machines\",\t\"System & Information Integrity\",\t\"SI.1.213\",\t\"ML-1\",\t\"3.14.5\",\t\"SI-3\"\n];\nSecurityRecommendation\n| where TimeGenerated > ago(14d) // Adjust Time Threasholds and Subscripition/Workspace Targets within Organizational Needs\n| join kind=rightouter Policymap on RecommendationName\n| where ControlFamily == \"System & Information Integrity\"\n| summarize\n    Assessments = count(),\n    Success = countif(RecommendationState == 'Healthy' or RecommendationState == 'NotApplicable'),\n    Failed = countif(RecommendationState == 'Unhealthy')\n    by ControlFamily, ControlNumber, MaturityLevel, RecommendationName\n| extend SuccessRatePercentage = (Success * 100 / Assessments)\n| extend FailedRatePercentage = (Failed * 100 / Assessments)\n| extend RemediationLink = strcat(\"https://portal.azure.com/#blade/Microsoft_Azure_Security/SecurityMenuBlade/22\")\n| project\n    ControlNumber,\n    ControlFamily,\n    MaturityLevel,\n    RecommendationName,\n    Assessments,\n    SuccessRatePercentage,\n    FailedRatePercentage,\n    RemediationLink\n| where RecommendationName <> \"\"\n// | where RecommendationName <> \"\" //Filter Out or Suppress Recommendations\n// | where MaturityLevel == \"ML-3\" //Filter by Maturity Level \n| where FailedRatePercentage > 30 //Adjust Either FailedRatePercentage or PasedRatePercentage Thresholds within Organizational Needs\n| sort by FailedRatePercentage desc\n| limit 250\n",
                "queryFrequency": "P7D",
                "queryPeriod": "P14D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "tactics": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": null
            }
        }
    ]
}