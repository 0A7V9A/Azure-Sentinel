id: c928e599-ba68-48b5-9109-5290ea69f0f5
name: (Private Preview) CMMC System & Information Integrity Control Family Monitoring
description: |
  'CMMC Control Assessments have Deviated from Configured Threshold Baselines'
severity: Medium
requiredDataConnectors:
  - connectorId: AzureSecurityCenter
    dataTypes:
      - SecurityAlert (ASC)
queryFrequency: 7d
queryPeriod: 7d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - Discovery
relevantTechniques:
  - T1082
query: |

  let Policymap = datatable(RecommendationName:string, ControlFamily:string, ControlNumber:string, MaturityLevel:string, 800171Map:string, 80053Map:string)
  [
  "Microsoft Antimalware for Azure should be configured to automatically update protection signatures",	"System & Information Integrity",	"SI.1.210",	"ML-1",	"3.14.1",	"SI-2,SI-3,SI-5",
  "Vulnerabilities in security configuration on your machines should be remediated",	"System & Information Integrity",	"SI.1.210",	"ML-1",	"3.14.1",	"SI-2,SI-3,SI-5",
  "Ensure that 'HTTP Version' is the latest, if used to run the Function app",	"System & Information Integrity",	"SI.1.210",	"ML-1",	"3.14.1",	"SI-2,SI-3,SI-5",
  "Python should be updated to the latest version for your function app",	"System & Information Integrity",	"SI.1.210",	"ML-1",	"3.14.1",	"SI-2,SI-3,SI-5",
  "Ensure that 'HTTP Version' is the latest, if used to run the Web app",	"System & Information Integrity",	"SI.1.210",	"ML-1",	"3.14.1",	"SI-2,SI-3,SI-5",
  "Microsoft Antimalware for Azure should be configured to automatically update protection signatures",	"System & Information Integrity",	"SI.1.211",	"ML-1",	"3.14.2",	"SI-2,SI-3,SI-5",
  "Microsoft IaaSAntimalware extension should be deployed on Windows servers",	"System & Information Integrity",	"SI.1.211",	"ML-1",	"3.14.2",	"SI-2,SI-3,SI-5",
  "Endpoint protection health issues should be resolved on your machines",	"System & Information Integrity",	"SI.1.211",	"ML-1",	"3.14.2",	"SI-2,SI-3,SI-5",
  "Endpoint protection health failures should be remediated on virtual machine scale sets",	"System & Information Integrity",	"SI.1.211",	"ML-1",	"3.14.2",	"SI-2,SI-3,SI-5",
  "Microsoft Antimalware for Azure should be configured to automatically update protection signatures",	"System & Information Integrity",	"SI.1.212",	"ML-1",	"3.14.4",	"SI-3",
  "Microsoft Antimalware for Azure should be configured to automatically update protection signatures",	"System & Information Integrity",	"SI.1.213",	"ML-1",	"3.14.5",	"SI-3",
  "Microsoft IaaSAntimalware extension should be deployed on Windows servers",	"System & Information Integrity",	"SI.1.213",	"ML-1",	"3.14.5",	"SI-3",
  "Endpoint protection health issues should be resolved on your machines",	"System & Information Integrity",	"SI.1.213",	"ML-1",	"3.14.5",	"SI-3",
  "Azure Defender for Key Vault should be enabled",	"System & Information Integrity",	"SI.1.213",	"ML-1",	"3.14.5",	"SI-3",
  "Azure Defender for Kubernetes should be enabled",	"System & Information Integrity",	"SI.1.213",	"ML-1",	"3.14.5",	"SI-3",
  "Flow logs should be configured for every network security group",	"System & Information Integrity",	"SI.2.216",	"ML-2",	"3.14.6",	"AU-2, AU-2(3), AU-6, SI-4, SI-4(4)",
  "Virtual networks should be protected by Azure Firewall",	"System & Information Integrity",	"SI.2.216",	"ML-2",	"3.14.6",	"AU-2, AU-2(3), AU-6, SI-4, SI-4(4)",
  "Web Application Firewall (WAF) should use the specified mode for Azure Front Door Service",	"System & Information Integrity",	"SI.2.216",	"ML-2",	"3.14.6",	"AU-2, AU-2(3), AU-6, SI-4, SI-4(4)",
  "Web Application Firewall (WAF) should be enabled for Application Gateway",	"System & Information Integrity",	"SI.2.216",	"ML-2",	"3.14.6",	"AU-2, AU-2(3), AU-6, SI-4, SI-4(4)",
  "An activity log alert should exist for Delete SQL Server Firewall Rule",	"System & Information Integrity",	"SI.2.216",	"ML-2",	"3.14.6",	"AU-2, AU-2(3), AU-6, SI-4, SI-4(4)",
  "An activity log alert should exist for Delete SQL Server Firewall Rule",	"System & Information Integrity",	"SI.2.217",	"ML-2",	"3.14.7",	"SI-4",
  "An activity log alert should exist for the Delete Network Security Group Rule",	"System & Information Integrity",	"SI.2.217",	"ML-2",	"3.14.7",	"SI-4",
  "An activity log alert should exist for Delete Network Security Solution",	"System & Information Integrity",	"SI.2.217",	"ML-2",	"3.14.7",	"SI-4",
  "Activity log should be retained for at least one year",	"System & Information Integrity",	"SI.2.217",	"ML-2",	"3.14.7",	"SI-4",
  "Azure Monitor should collect activity logs from all regions",	"System & Information Integrity",	"SI.2.217",	"ML-2",	"3.14.7",	"SI-4"
  ];
  SecurityRecommendation
  | join kind=rightouter Policymap on RecommendationName
  | where ControlFamily == 'System & Information Integrity'
  | summarize
      Assessments = count(),
      Success = countif(RecommendationState == 'Healthy' or RecommendationState == 'NotApplicable'),
      Failed = countif(RecommendationState == 'Unhealthy')
      by ControlFamily, ControlNumber, MaturityLevel, RecommendationName
  | extend SuccessRatePercentage = (Success * 100 / Assessments)
  | extend FailedRatePercentage = (Failed * 100 / Assessments)
  | extend RemediationLink = strcat('https://portal.azure.com/#blade/Microsoft_Azure_Security/SecurityMenuBlade/22')
  | project
      ControlNumber,
      ControlFamily,
      MaturityLevel,
      RecommendationName,
      Assessments,
      SuccessRatePercentage,
      FailedRatePercentage,
      RemediationLink
  | where RecommendationName <> ''
  // | where RecommendationName <> '' //Filter Out or Suppress Recommendations
  // | where MaturityLevel == 'ML-3' //Filter by Maturity Level 
  | where FailedRatePercentage > 30 //Adjust Either FailedRatePercentage or PasedRatePercentage Thresholds within Organizational Needs
  | sort by FailedRatePercentage desc
  | limit 250
  | extend URLCustomEntity = RemediationLink

entityMappings:
  - entityType: URL
    fieldMappings:
      - identifier: Url
        columnName: URLCustomEntity
version: 1.0.0
