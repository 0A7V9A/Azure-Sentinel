id: 7b2a3fe2-ce83-4d56-a509-ab9ef326faea
name: (Private Preview) CMMC Risk Management Control Family Monitoring
description: |
  'CMMC Control Assessments have Deviated from Configured Threshold Baselines'
severity: Medium
requiredDataConnectors:
  - connectorId: AzureSecurityCenter
    dataTypes:
      - SecurityAlert (ASC)
queryFrequency: 7d
queryPeriod: 7d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - Discovery
relevantTechniques:
  - T1082
query: |
let Policymap = datatable(RecommendationName:string, ControlFamily:string, ControlNumber:string, MaturityLevel:string, 800171Map:string, 80053Map:string)
[
"Vulnerabilities in your virtual machines should be remediated",	"Risk Management",	"RM.2.141",	"ML-2",	"3.11.1",	"RA-3",
"Vulnerability Assessment settings for SQL server should contain an email address to receive scan reports",	"Risk Management",	"RM.2.141",	"ML-2",	"3.11.1",	"RA-3",
"Vulnerability assessment should be enabled on your SQL servers",	"Risk Management",	"RM.2.141",	"ML-2",	"3.11.1",	"RA-3",
"Azure Defender for SQL should be enabled for unprotected SQL Managed Instances",	"Risk Management",	"RM.2.141",	"ML-2",	"3.11.1",	"RA-3",
"Vulnerability assessment should be enabled on your SQL managed instances",	"Risk Management",	"RM.2.141",	"ML-2",	"3.11.1",	"RA-3",
"Vulnerabilities in your virtual machines should be remediated",	"Risk Management",	"RM.2.142",	"ML-2",	"3.11.2",	"RA-5, RA-5(5)",
"Vulnerability Assessment settings for SQL server should contain an email address to receive scan reports",	"Risk Management",	"RM.2.142",	"ML-2",	"3.11.2",	"RA-5, RA-5(5)",
"Vulnerability assessment should be enabled on your SQL servers",	"Risk Management",	"RM.2.142",	"ML-2",	"3.11.2",	"RA-5, RA-5(5)",
"Azure Defender for SQL should be enabled for unprotected SQL Managed Instances",	"Risk Management",	"RM.2.142",	"ML-2",	"3.11.2",	"RA-5, RA-5(5)",
"Vulnerability assessment should be enabled on your SQL managed instances",	"Risk Management",	"RM.2.142",	"ML-2",	"3.11.2",	"RA-5, RA-5(5)",
"Vulnerabilities in security configuration on your machines should be remediated",	"Risk Management",	"RM.2.143",	"ML-2",	"3.11.3",	"RA-5",
"Vulnerabilities in your virtual machines should be remediated",	"Risk Management",	"RM.2.143",	"ML-2",	"3.11.3",	"RA-5",
"Vulnerability Assessment settings for SQL server should contain an email address to receive scan reports",	"Risk Management",	"RM.2.143",	"ML-2",	"3.11.3",	"RA-5",
"Vulnerability assessment should be enabled on your SQL servers",	"Risk Management",	"RM.2.143",	"ML-2",	"3.11.3",	"RA-5",
"Vulnerabilities in Azure Container Registry images should be remediated (powered by Qualys)",	"Risk Management",	"RM.2.143",	"ML-2",	"3.11.3",	"RA-5",
"Vulnerability Assessment settings for SQL server should contain an email address to receive scan reports",	"Risk Management",	"RM.3.144",	"ML-3",	"NA",	"CA-2, PM-9, RA-3, SA-20",
"Azure Defender for Key Vault should be enabled",	"Risk Management",	"RM.3.144",	"ML-3",	"NA",	"CA-2, PM-9, RA-3, SA-20",
"Azure Defender for Kubernetes should be enabled",	"Risk Management",	"RM.3.144",	"ML-3",	"NA",	"CA-2, PM-9, RA-3, SA-20",
"Azure Defender for SQL servers on machines should be enabled",	"Risk Management",	"RM.3.144",	"ML-3",	"NA",	"CA-2, PM-9, RA-3, SA-20",
"Azure Defender for Azure SQL Database servers should be enabled",	"Risk Management",	"RM.3.144",	"ML-3",	"NA",	"CA-2, PM-9, RA-3, SA-20"
];
SecurityRecommendation
| join kind=rightouter Policymap on RecommendationName
| where ControlFamily == "Risk Management"
| summarize
    Assessments = count(),
    Success = countif(RecommendationState == 'Healthy' or RecommendationState == 'NotApplicable'),
    Failed = countif(RecommendationState == 'Unhealthy')
    by ControlFamily, ControlNumber, MaturityLevel, RecommendationName
| extend SuccessRatePercentage = (Success * 100 / Assessments)
| extend FailedRatePercentage = (Failed * 100 / Assessments)
| extend RemediationLink = strcat("https://portal.azure.com/#blade/Microsoft_Azure_Security/SecurityMenuBlade/22")
| project
    ControlNumber,
    ControlFamily,
    MaturityLevel,
    RecommendationName,
    Assessments,
    SuccessRatePercentage,
    FailedRatePercentage,
    RemediationLink
| where RecommendationName <> ""
// | where RecommendationName <> "" //Filter Out or Suppress Recommendations
// | where MaturityLevel == "ML-3" //Filter by Maturity Level 
| where FailedRatePercentage > 30 //Adjust Either FailedRatePercentage or PasedRatePercentage Thresholds within Organizational Needs
| sort by FailedRatePercentage desc
| limit 250
| extend Url = RemediationLink
entityMappings:
  - entityType: URL
    fieldMappings:
      - identifier: Url
        columnName: RemediationLink
version: 1.0.0
