id: 6f1e58bd-cd95-4dfb-8883-94207f30929a
kind: Scheduled
name: BTP - Mass user deletion in a sub account
description: Identifies user account deletion activity where the amount of deleted
  users exceeds a predefined threshold.
severity: Medium
requiredDataConnectors:
  - connectorId: SAPBTPAuditLog
    dataTypes:
      - SAPBTPAuditLog_CL
queryFrequency: 15m
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
  - Impact
relevantTechniques:
  - T1531
  - T1485
  - T1489
  - T0813
  - T0826
  - T0827
query: |
  let bulk_delete_threshold = 10;
  SAPBTPAuditLog_CL
  | where isnotnull(Message.object)
  | where Message.object has "scim user" and Message.object has "DELETE"
  | mv-expand Attributes = Message.attributes
  | mv-expand Attributes
  | where isnotempty(Attributes.old)
  | extend DeletedUserName = tostring(parse_json(tostring(Attributes.old)).userName)
  | where isnotempty(DeletedUserName)
  | summarize Start = min(UpdatedOn), End = max(UpdatedOn), DeletedUsers = make_set(DeletedUserName)  by UserName, Tenant, SpaceId
  | where array_length(DeletedUsers) > bulk_delete_threshold
  | project Start, End, AccountCustomEntity = UserName, DeletedUsers, Tenant, SpaceId, CloudApp = "SAP BTP"
eventGroupingSettings:
  aggregationKind: SingleAlert
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: AccountCustomEntity
  - entityType: CloudApplication
    fieldMappings:
      - identifier: Name
        columnName: CloudApp
version: 2.0.1
