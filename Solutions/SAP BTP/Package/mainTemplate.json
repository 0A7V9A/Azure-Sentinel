{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft",
    "comments": "Solution template for SAP BTP"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "SAP BTP Activity",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "solutionId": "sentinel4sap.sap_btp_sentinel_solution-preview",
    "_solutionId": "[variables('solutionId')]",
    "TemplateEmptyArray": "[json('[]')]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "SAPBTPActivity",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1')))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "analyticRuleVersion1": "2.0.1",
    "analyticRulecontentId1": "62357c23-ecdc-4edc-9349-8338063af1ef",
    "_analyticRulecontentId1": "[variables('analyticRulecontentId1')]",
    "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId1'))]",
    "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId1')))]",
    "analyticRuleVersion2": "2.0.1",
    "analyticRulecontentId2": "5acbe4cb-a379-4acc-9ad3-28dc48ad33d3",
    "_analyticRulecontentId2": "[variables('analyticRulecontentId2')]",
    "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId2'))]",
    "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId2')))]",
    "analyticRuleVersion3": "2.0.1",
    "analyticRulecontentId3": "74b243a6-3046-48aa-8b03-e43b3c529cc1",
    "_analyticRulecontentId3": "[variables('analyticRulecontentId3')]",
    "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId3'))]",
    "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId3')))]",
    "analyticRuleVersion4": "2.0.1",
    "analyticRulecontentId4": "6f1e58bd-cd95-4dfb-8883-94207f30929a",
    "_analyticRulecontentId4": "[variables('analyticRulecontentId4')]",
    "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId4'))]",
    "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId4')))]",
    "analyticRuleVersion5": "2.0.1",
    "analyticRulecontentId5": "31997e9a-7447-47f3-8208-4f5d7efe497c",
    "_analyticRulecontentId5": "[variables('analyticRulecontentId5')]",
    "analyticRuleId5": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId5'))]",
    "analyticRuleTemplateSpecName5": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId5')))]",
    "uiConfigId1": "SAPBTPAuditLog",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "SAPBTPAuditLog",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1')))]",
    "dataConnectorVersion1": "1.0.0"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "properties": {
        "description": "SAP BTP Workbook with template",
        "displayName": "SAP BTP workbook template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('workbookTemplateSpecName1'),'/',variables('workbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('workbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "SAPBTPActivityWorkbook with template version 2.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "This workbook contains visualizations and insights in the SAP BTP environment."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"5fcea91d-a1e3-4f09-b39e-0fb2798357a5\",\"cellValue\":\"setTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"Overview\",\"style\":\"link\"},{\"id\":\"76a8c413-8eda-4332-a363-8ab214a3ed01\",\"cellValue\":\"setTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Identity Management\",\"subTarget\":\"Identity\",\"style\":\"link\"}]},\"name\":\"links - 2\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# BTP Overview Dashboard\\r\\n\\r\\nThis dashboard provides a birds-eye view of audit log activity across BTP accounts. This is intended to show the most active accounts and event sources, and general trends in activity.\\r\\n\\r\\nModify the Time Range selector to alter the lookback period and select the Identity Management tab to see more.\"},\"name\":\"text - 4\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"065c5ee8-c358-49aa-b839-47da6759d71d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":2592000000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| make-series Trend = count() default = 0 on UpdatedOn from {TimeRange:start} to now() step 1d by Tenant\\r\\n| project-away UpdatedOn\\r\\n| join kind = inner (SAPBTPAuditLog_CL\\r\\n    | summarize Requests = count() by Tenant\\r\\n    ) on Tenant\\r\\n| project Tenant, Requests, Trend\\r\\n| order by Requests desc\",\"size\":1,\"title\":\"Most active accounts by events generated\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Requests\",\"formatter\":4,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"blue\",\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":\"[variables('TemplateEmptyArray')]\"}}}]},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"Tenant\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where TimeGenerated >= {TimeRange:start}\\r\\n| summarize count() by Category\",\"size\":1,\"title\":\"Ingested events by audit category\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Category\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where Category == \\\"audit.security-events\\\"\\r\\n| where Message has \\\"UserAuthenticationSuccess\\\"\\r\\n| make-series Events = count() default = 0 on UpdatedOn from {TimeRange:start} to now() step 1d by Tenant\",\"size\":0,\"title\":\"Successful user sign-in activity over time\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where Category == \\\"audit.security-events\\\"\\r\\n| where Message has \\\"Unauthorized access attempt\\\"\\r\\n| make-series Events = count() default = 0 on UpdatedOn from {TimeRange:start} to now() step 1d by Tenant\\r\\n| extend (baseline) = series_decompose(Events)\\r\\n| extend (anomalies, baseline) = series_decompose_anomalies(Events, 3, -1, 'linefit')\",\"size\":0,\"title\":\"Business Application Studio sign-in: unauthorized access anomalies\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\"},\"customWidth\":\"50\",\"name\":\"query - 5\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityAlert\\r\\n| where Entities has \\\"SAP BTP\\\"\\r\\n| make-series Events = count() default = 0 on TimeGenerated from {TimeRange:start} to now() step 1d\",\"size\":0,\"title\":\"BTP Security alerts over time\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"50\",\"name\":\"query - 6\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"setTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"group - 1\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# BTP Identity Management\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"04187a88-ee78-4ddf-bab3-5ce201d0c3c1\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":2592000000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where UpdatedOn >= {TimeRange:start}\\r\\n| where Message has \\\"scim user\\\"\\r\\n| extend Action = tostring(parse_json(tostring(parse_json(tostring(Message.object)).id)).crudType)\\r\\n| summarize Events = count() by UserName, Action\\r\\n| evaluate pivot(Action, sum(Events)) : (UserName:string, CREATE:int, UPDATE:int, DELETE:int)\\r\\n| extend Total = CREATE + UPDATE + DELETE\\r\\n| order by Total desc\",\"size\":1,\"title\":\"Top user account management events by user\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"CREATE\",\"formatter\":5},{\"columnMatch\":\"DELETE\",\"formatter\":5},{\"columnMatch\":\"UPDATE\",\"formatter\":5},{\"columnMatch\":\"Total\",\"formatter\":22,\"formatOptions\":{\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":[{\"columnName\":\"CREATE\",\"color\":\"green\"},{\"columnName\":\"UPDATE\",\"color\":\"blue\"},{\"columnName\":\"DELETE\",\"color\":\"orange\"}]}}}]},\"sortBy\":\"[variables('TemplateEmptyArray')]\"},\"customWidth\":\"33.3\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where UpdatedOn >= {TimeRange:start}\\r\\n| where Message has \\\"scim user\\\"\\r\\n| extend Action = tostring(parse_json(tostring(parse_json(tostring(Message.object)).id)).crudType)\\r\\n| summarize count() by Tenant\",\"size\":1,\"title\":\"User account management events by subaccount\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33.3\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where UpdatedOn between ({TimeRange:start} .. {TimeRange:end})\\r\\n| where Message has \\\"scim user\\\"\\r\\n| extend Action = tostring(parse_json(tostring(parse_json(tostring(Message.object)).id)).crudType)\\r\\n| summarize Events = count() by UserName, Action\\r\\n| evaluate pivot(Action, sum(Events)) : (UserName:string, CREATE:int, UPDATE:int, DELETE:int)\\r\\n| extend Events = CREATE + UPDATE + DELETE\\r\\n| order by Events asc\",\"size\":1,\"title\":\"Most rare user account management events by user\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"CREATE\",\"formatter\":5},{\"columnMatch\":\"UPDATE\",\"formatter\":5},{\"columnMatch\":\"DELETE\",\"formatter\":5},{\"columnMatch\":\"Events\",\"formatter\":22,\"formatOptions\":{\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":[{\"columnName\":\"CREATE\",\"color\":\"green\"},{\"columnName\":\"UPDATE\",\"color\":\"blue\"},{\"columnName\":\"DELETE\",\"color\":\"orange\"}]}}}],\"sortBy\":[{\"itemKey\":\"$gen_compositeBar_Events_4\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"$gen_compositeBar_Events_4\",\"sortOrder\":1}]},\"customWidth\":\"33.3\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let user_account_changes = materialize(SAPBTPAuditLog_CL\\r\\n    | where UpdatedOn between ({TimeRange:start} .. {TimeRange:end})\\r\\n    | where isnotempty(Message.object)\\r\\n    | where Message has \\\"scim user\\\"\\r\\n    | extend Attributes = parse_json(Message.attributes)\\r\\n    | mv-expand Attributes\\r\\n    | where isnotempty(Attributes.new)\\r\\n    | extend New = replace_regex(tostring(Attributes.new), \\\"\\\\\\\\r\\\", \\\"\\\")\\r\\n    | extend Old = replace_regex(tostring(Attributes.old), \\\"\\\\\\\\r\\\", \\\"\\\")\\r\\n    | extend Action = tostring(parse_json(tostring(parse_json(tostring(Message.object)).id)).crudType)\\r\\n    | project UpdatedOn, UserName, Action, Tenant, New, Old);\\r\\nlet unpack_object = (Changes: (UpdatedOn: datetime, UserName: string, Tenant:string, Action: string, Column: string, Value: string)) {\\r\\n    Changes\\r\\n    | extend Column = parse_json(Column)\\r\\n    | evaluate bag_unpack(Column): (\\r\\n        UpdatedOn: datetime\\r\\n        , UserName: string\\r\\n        , Tenant: string\\r\\n        , Action: string\\r\\n        , Value: string\\r\\n        , userName: string\\r\\n        , active: string\\r\\n        , emails: string\\r\\n        , externalId: string\\r\\n        , id: string\\r\\n        , meta: string\\r\\n        , name: string\\r\\n        , origin: string\\r\\n        , passwordLastModified: datetime\\r\\n        , verified: string\\r\\n        , zoneid: string)\\r\\n};\\r\\nlet old_user = user_account_changes\\r\\n    | project-away New\\r\\n    | project-rename Column = Old\\r\\n    | extend Value = \\\"Old\\\"\\r\\n    | where not (Action == \\\"CREATE\\\" and Value == \\\"Old\\\");\\r\\nlet new_user = user_account_changes\\r\\n    | project-away Old\\r\\n    | project-rename Column = New\\r\\n    | extend Value = \\\"New\\\";\\r\\nunion (unpack_object(old_user)), (unpack_object(new_user))\\r\\n| where UserName !startswith \\\"sb-\\\"\\r\\n| order by UpdatedOn desc, Value asc \",\"size\":0,\"title\":\"User account management activity\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"filter\":true,\"labelSettings\":[{\"columnId\":\"Action\",\"label\":\"Activity\"},{\"columnId\":\"userName\",\"label\":\"Target User\"},{\"columnId\":\"active\",\"label\":\"Active\"},{\"columnId\":\"emails\",\"label\":\"Email\"},{\"columnId\":\"externalId\",\"label\":\"ExternalId\"},{\"columnId\":\"id\",\"label\":\"Id\"},{\"columnId\":\"meta\",\"label\":\"Meta\"},{\"columnId\":\"name\",\"label\":\"Name\"},{\"columnId\":\"origin\",\"label\":\"Origin\"},{\"columnId\":\"passwordLastModified\",\"label\":\"Password Last Modified\"},{\"columnId\":\"verified\",\"label\":\"Verified\"},{\"columnId\":\"zoneid\",\"label\":\"Zone Id\"}]}},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where UpdatedOn between ({TimeRange:start} .. {TimeRange:end})\\r\\n| where Message has_any (\\\"xs_rolecollection2user\\\", \\\"xsrolecollection2role\\\", \\\"xsrolecollections\\\")\\r\\n| where UserName != \\\"client/hcp_onboarding\\\"\\r\\n| extend ChangeId = parse_json(tostring(parse_json(Message.object).id))\\r\\n| evaluate bag_unpack(ChangeId)\\r\\n| project-away TimeGenerated, Message, MessageUuid, OrgId, SpaceId, AlsServiceId, Category, Type, TenantId, _ResourceId\\r\\n| project-reorder UpdatedOn, UserName\",\"size\":0,\"title\":\"Security role collection management events\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"creationTimestamp\",\"formatter\":5},{\"columnMatch\":\"onBehalfOf\",\"formatter\":5}],\"filter\":true,\"labelSettings\":[{\"columnId\":\"crudType\",\"label\":\"Activity\"},{\"columnId\":\"origin\",\"label\":\"Origin\"},{\"columnId\":\"rolecollection_identity_zone_id\",\"label\":\"Identity Zone\"},{\"columnId\":\"rolecollection_name\",\"label\":\"Role Collection Name\"},{\"columnId\":\"tableName\",\"label\":\"Activity\"},{\"columnId\":\"user_id\",\"label\":\"Target User\"}]}},\"name\":\"query - 2\"}]},\"conditionalVisibility\":{\"parameterName\":\"setTab\",\"comparison\":\"isEqualTo\",\"value\":\"Identity\"},\"name\":\"group - identity\"}],\"isLocked\":true,\"fallbackResourceIds\":\"[variables('TemplateEmptyArray')]\",\"fromTemplateId\":\"sentinel-SAPBTPActivity\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=SAPBTPActivity; logoFileName=SAPBTP.svg; description=This workbook contains visualizations and insights in the SAP BTP environment.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=SAP BTP Activity; templateRelativePath=SAPBTPActivity.json; subtitle=; provider=Microsoft}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "SAPBTPAuditLog_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "SAPBTPAuditLog",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "SAP BTP Analytics Rule 1 with template",
        "displayName": "SAP BTP Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName1'),'/',variables('analyticRuleVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "BTP - Trust and authorization Identity Provider monitor_AnalyticalRules Analytics Rule with template version 2.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId1')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies CRUD operations on Identity Provider settings within a sub account.",
                "displayName": "BTP - Trust and authorization Identity Provider monitor",
                "enabled": false,
                "query": "SAPBTPAuditLog_CL\n| where isnotnull(Message.object)\n| extend Object = Message.object, Attributes = Message.attributes\n| where Object.type == \"IdentityProvider\"\n| extend CrudType = tostring(parse_json(tostring(Object.id)).crudType)\n| mv-expand Attributes\n| extend MessageText = case(CrudType == \"CREATE\", \"An identity provider was created\",\n    CrudType == \"UPDATE\", \"An identity provider was updated\",\n    CrudType == \"DELETE\", \"An identity provider was deleted\",\n    \"Unclassified CRUD operation encountered\")\n| extend NewAttributes = parse_json(replace_regex(tostring(Attributes.new), \"\\\\r\", \"\"))\n| extend OldAttributes = parse_json(replace_regex(tostring(Attributes.old), \"\\\\r\", \"\"))\n| extend IdentityProviderName = case(CrudType == \"CREATE\" or CrudType == \"UPDATE\", NewAttributes.name,\n    CrudType == \"DELETE\", OldAttributes.name, \"Unknown\")\n| extend AccountCustomEntity = tostring(split(UserName, \"/\")[2]), CloudApp = \"SAP BTP\"\n| project\n    UpdatedOn,\n    AccountCustomEntity,\n    MessageText,\n    IdentityProviderName,\n    Tenant,\n    SpaceId,\n    UserName,\n    CloudApp\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ],
                    "connectorId": "SAPBTPAuditLog"
                  }
                ],
                "tactics": [
                  "CredentialAccess",
                  "PrivilegeEscalation"
                ],
                "techniques": [
                  "T1606",
                  "T1556",
                  "T1134"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "FullName"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "columnName": "CloudApp",
                        "identifier": "Name"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                  "alertDisplayNameFormat": "SAP BTP: {{MessageText}}",
                  "alertDescriptionFormat": "{{MessageText}} by {{UserName}}. Identity provider name: {{IdentityProviderName}}"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId1'),'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 1",
                "parentId": "[variables('analyticRuleId1')]",
                "contentId": "[variables('_analyticRulecontentId1')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "SAP BTP Analytics Rule 2 with template",
        "displayName": "SAP BTP Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName2'),'/',variables('analyticRuleVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "BTP - User added to sensitive privileged role collection_AnalyticalRules Analytics Rule with template version 2.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId2')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies identity management actions whereby a user is added to a set of monitored privileged role collections.",
                "displayName": "BTP - User added to sensitive privileged role collection",
                "enabled": false,
                "query": "let monitored_rolecollections = dynamic([\"Subaccount Service Administrator\", \"Subaccount Administrator\", \"Connectivity and Destination Administrator\", \"Destination Administrator\", \"Cloud Connector Administrator\"]);\nSAPBTPAuditLog_CL\n| where Message.object has \"xs_rolecollection2user\"\n| extend ObjectId = parse_json((Message.object).id)\n| where ObjectId.crudType == \"CREATE\"\n| extend RoleCollection = ObjectId.rolecollection_name, TargetUserId = ObjectId.user_id\n| where RoleCollection in (monitored_rolecollections)\n| project UpdatedOn, AccountCustomEntity = UserName, RoleCollection, TargetUserId, Tenant, SpaceId, CloudApp = \"SAP BTP\"\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Low",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ],
                    "connectorId": "SAPBTPAuditLog"
                  }
                ],
                "tactics": [
                  "LateralMovement",
                  "PrivilegeEscalation"
                ],
                "techniques": [
                  "T0859",
                  "T1078"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "FullName"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "columnName": "CloudApp",
                        "identifier": "Name"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId2'),'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 2",
                "parentId": "[variables('analyticRuleId2')]",
                "contentId": "[variables('_analyticRulecontentId2')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "SAP BTP Analytics Rule 3 with template",
        "displayName": "SAP BTP Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName3'),'/',variables('analyticRuleVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "BTP - Failed access attempts across multiple BAS subaccounts_AnalyticalRules Analytics Rule with template version 2.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId3')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies failed Business Application Studio access attempts over a predefined number of subaccounts.",
                "displayName": "BTP - Failed access attempts across multiple BAS subaccounts",
                "enabled": false,
                "query": "let subaccount_detection_threshold = 3;\nSAPBTPAuditLog_CL\n| where Category == \"audit.security-events\" and Message has \"Unauthorized access attempt\"\n| summarize Start=min(UpdatedOn), End=max(UpdatedOn), Tenants = make_set(Tenant) by UserName\n| where array_length(Tenants) > subaccount_detection_threshold\n| project Start, End, AccountCustomEntity = UserName, Tenants, CloudApp = \"BTP\"\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "P1D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ],
                    "connectorId": "SAPBTPAuditLog"
                  }
                ],
                "tactics": [
                  "Reconnaissance",
                  "Discovery"
                ],
                "techniques": [
                  "T1595",
                  "T1526"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "FullName"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "columnName": "CloudApp",
                        "identifier": "Name"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                  "alertDisplayNameFormat": "BTP - Unauthorized access attempt to multiple tenants",
                  "alertDescriptionFormat": "{{AccountCustomEntity}} attempted, and failed, to log into multiple Business Application Studio dev spaces. Tenants accessed: {{Tenants}}"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId3'),'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 3",
                "parentId": "[variables('analyticRuleId3')]",
                "contentId": "[variables('_analyticRulecontentId3')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "SAP BTP Analytics Rule 4 with template",
        "displayName": "SAP BTP Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName4'),'/',variables('analyticRuleVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "BTP - Mass user deletion in a sub account_AnalyticalRules Analytics Rule with template version 2.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion4')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId4')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies user account deletion activity where the amount of deleted users exceeds a predefined threshold.",
                "displayName": "BTP - Mass user deletion in a sub account",
                "enabled": false,
                "query": "let bulk_delete_threshold = 10;\nSAPBTPAuditLog_CL\n| where isnotnull(Message.object)\n| where Message.object has \"scim user\" and Message.object has \"DELETE\"\n| mv-expand Attributes = Message.attributes\n| mv-expand Attributes\n| where isnotempty(Attributes.old)\n| extend DeletedUserName = tostring(parse_json(tostring(Attributes.old)).userName)\n| where isnotempty(DeletedUserName)\n| summarize Start = min(UpdatedOn), End = max(UpdatedOn), DeletedUsers = make_set(DeletedUserName)  by UserName, Tenant, SpaceId\n| where array_length(DeletedUsers) > bulk_delete_threshold\n| project Start, End, AccountCustomEntity = UserName, DeletedUsers, Tenant, SpaceId, CloudApp = \"SAP BTP\"\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ],
                    "connectorId": "SAPBTPAuditLog"
                  }
                ],
                "tactics": [
                  "Impact"
                ],
                "techniques": [
                  "T1531",
                  "T1485",
                  "T1489",
                  "T0813",
                  "T0826",
                  "T0827"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "FullName"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "columnName": "CloudApp",
                        "identifier": "Name"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId4'),'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 4",
                "parentId": "[variables('analyticRuleId4')]",
                "contentId": "[variables('_analyticRulecontentId4')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "SAP BTP Analytics Rule 5 with template",
        "displayName": "SAP BTP Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName5'),'/',variables('analyticRuleVersion5'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName5'))]"
      ],
      "properties": {
        "description": "BTP - Malware detected in BAS dev space_AnalyticalRules Analytics Rule with template version 2.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion5')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId5')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies instances of malware detected using SAP internal malware agent within Business Application Studio dev spaces.",
                "displayName": "BTP - Malware detected in BAS dev space",
                "enabled": false,
                "query": "SAPBTPAuditLog_CL\n| where Message.user =~ \"malware_agent\"\n| extend MessageData = parse_json(tostring(Message.data))\n| extend ClusterID = MessageData.clusterID, WorkspaceID = MessageData.wsID, Message = MessageData.message\n| project UpdatedOn, ClusterID, WorkspaceID, Message, Tenant, SpaceId, Category, CloudApp = \"SAP BTP\"\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ],
                    "connectorId": "SAPBTPAuditLog"
                  }
                ],
                "tactics": [
                  "ResourceDevelopment",
                  "Execution",
                  "Persistence"
                ],
                "techniques": [
                  "T1584",
                  "T1072",
                  "T0873"
                ],
                "entityMappings": [
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "columnName": "CloudApp",
                        "identifier": "Name"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                  "alertDisplayNameFormat": "BTP - Malware detected in Business Apps Studio dev space",
                  "alertDescriptionFormat": "Malware was found in the following subaccount: {{Tenant}}"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId5'),'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 5",
                "parentId": "[variables('analyticRuleId5')]",
                "contentId": "[variables('_analyticRulecontentId5')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "properties": {
        "description": "SAP BTP data connector with template",
        "displayName": "SAP BTP template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('dataConnectorTemplateSpecName1'),'/',variables('dataConnectorVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('dataConnectorTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "SAP BTP data connector with template version 2.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "SAP BTP (using Azure Functions)",
                  "publisher": "Microsoft",
                  "descriptionMarkdown": "SAP Business Technology Platform (SAP BTP) brings together data management, analytics, artificial intelligence, application development, automation, and integration in one, unified environment.",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "SAPBTPAuditLog_CL",
                      "baseQuery": "SAPBTPAuditLog_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "BTP account token issuance events",
                      "query": "SAPBTPAuditLog_CL\n            | where MessageData.message startswith \"TokenIssuedEvent\"\n            | project TimeGeneratedBTP, UserName, IPAddress, MessageData.message"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "SAPBTPAuditLog_CL",
                      "lastDataReceivedQuery": "SAPBTPAuditLog_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "SAPBTPAuditLog_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions on the workspace are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft.Web/Sites, Microsoft.Web/ServerFarms, Microsoft.Insights/Components, Microsoft.Storage/StorageAccounts",
                        "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
                      },
                      {
                        "name": "Microsoft.Insights/DataCollectionEndpoints, Microsoft.Insights/DataCollectionRules",
                        "description": "Read and write permissions to Data Collection Rules/Endpoints is required. Permissions to assign the Monitoring Metrics Publisher role to the Azure Function is required. [See the documentation to learn more about Data Collection Rules](https://docs.microsoft.com/azure/azure-monitor/platform/data-collection-rules)."
                      },
                      {
                        "name": "Azure Key Vault",
                        "description": "A Key Vault to hold SAP BTP client secret [See the documentation to learn more about Key Vault](https://docs.microsoft.com/azure/key-vault/general/overview)."
                      },
                      {
                        "name": "SAP BTP auditlog-management service, and key",
                        "description": "Connectivity and permissions to retrieve SAP BTP Audit logs in the Cloud Foundry environment."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": ">**NOTE:** This connector uses Azure Functions to connect to SAP BTP Global Account to pull its logs into Azure Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
                    },
                    {
                      "description": "**Step 1 - Create a an Azure Key Vault**\n\n Refer to the [Azure Key Vault quickstart guide](https://learn.microsoft.com/azure/key-vault/general/quick-create-portal) for details. This key vault will hold a client secret required to access the Audit Retrieval API."
                    },
                    {
                      "description": "**Step 2 - Configuration steps for the SAP BTP Audit Retrieval API**\n\nFollow the steps provided by SAP [see Audit Log Retrieval API for Global Accounts in the Cloud Foundry Environment](https://help.sap.com/docs/btp/sap-business-technology-platform/audit-log-retrieval-api-for-global-accounts-in-cloud-foundry-environment/). \n\n1. Take a note of the **url** (Audit Retrieval API URL), **uaa.url** (User Account and Authentication Server url) and the associated **uaa.clientid**.\n2. Add the **uaa.clientsecret** as a secret in the Key Vault created in Step 1 and take note of the **name** of the secret.\n\n>**NOTE:** You can onboard one or more BTP subaccounts by following the steps provided by SAP [see Audit Log Retrieval API Usage for Subaccounts in the Cloud Foundry Environment](https://help.sap.com/docs/btp/sap-business-technology-platform/audit-log-retrieval-api-usage-for-subaccounts-in-cloud-foundry-environment/). Repeat the steps above and redeploy the ARM template (step 3) for each subaccount."
                    },
                    {
                      "description": "**Step 3 - Azure Resource Manager (ARM) Template**\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-sapbtp-azuredeploy)\n2. Enter the values collected in steps 1 and 2 as parameters in the ARM template. Populate Key Vault name, name of the Key Vault secret, Audit Retrieval API URL, UAA Server URL, clientid.\n3. Click **Purchase** to deploy."
                    },
                    {
                      "description": "**Step 4 - Set Key Vault Access Policy**\n\nTo allow the Azure Function to access the Key Vault, you need to set the Key Vault Access Policy. \n\n1. Go to the Azure Portal and select the Key Vault created in Step 1.\n2. Select Access Policies from the left menu.\n3. Click on the **+ Add Access Policy** button.\n4. Select the **Secret Permissions** tab.\n5. Select the **Get** permissions.\n6. Select the **Azure Functions** service principal from the **Select principal** dropdown.\n7. Click on the **Add** button.\n8. Click on the **Save** button."
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "SAP BTP",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft"
        },
        "support": {
          "tier": "Microsoft",
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "link": "https://support.microsoft.com/"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "SAP BTP (using Azure Functions)",
          "publisher": "Microsoft",
          "descriptionMarkdown": "SAP Business Technology Platform (SAP BTP) brings together data management, analytics, artificial intelligence, application development, automation, and integration in one, unified environment.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "SAPBTPAuditLog_CL",
              "baseQuery": "SAPBTPAuditLog_CL"
            }
          ],
          "dataTypes": [
            {
              "name": "SAPBTPAuditLog_CL",
              "lastDataReceivedQuery": "SAPBTPAuditLog_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "SAPBTPAuditLog_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "BTP account token issuance events",
              "query": "SAPBTPAuditLog_CL\n            | where MessageData.message startswith \"TokenIssuedEvent\"\n            | project TimeGeneratedBTP, UserName, IPAddress, MessageData.message"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft.Web/Sites, Microsoft.Web/ServerFarms, Microsoft.Insights/Components, Microsoft.Storage/StorageAccounts",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "Microsoft.Insights/DataCollectionEndpoints, Microsoft.Insights/DataCollectionRules",
                "description": "Read and write permissions to Data Collection Rules/Endpoints is required. Permissions to assign the Monitoring Metrics Publisher role to the Azure Function is required. [See the documentation to learn more about Data Collection Rules](https://docs.microsoft.com/azure/azure-monitor/platform/data-collection-rules)."
              },
              {
                "name": "Azure Key Vault",
                "description": "A Key Vault to hold SAP BTP client secret [See the documentation to learn more about Key Vault](https://docs.microsoft.com/azure/key-vault/general/overview)."
              },
              {
                "name": "SAP BTP auditlog-management service, and key",
                "description": "Connectivity and permissions to retrieve SAP BTP Audit logs in the Cloud Foundry environment."
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This connector uses Azure Functions to connect to SAP BTP Global Account to pull its logs into Azure Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
            },
            {
              "description": "**Step 1 - Create a an Azure Key Vault**\n\n Refer to the [Azure Key Vault quickstart guide](https://learn.microsoft.com/azure/key-vault/general/quick-create-portal) for details. This key vault will hold a client secret required to access the Audit Retrieval API."
            },
            {
              "description": "**Step 2 - Configuration steps for the SAP BTP Audit Retrieval API**\n\nFollow the steps provided by SAP [see Audit Log Retrieval API for Global Accounts in the Cloud Foundry Environment](https://help.sap.com/docs/btp/sap-business-technology-platform/audit-log-retrieval-api-for-global-accounts-in-cloud-foundry-environment/). \n\n1. Take a note of the **url** (Audit Retrieval API URL), **uaa.url** (User Account and Authentication Server url) and the associated **uaa.clientid**.\n2. Add the **uaa.clientsecret** as a secret in the Key Vault created in Step 1 and take note of the **name** of the secret.\n\n>**NOTE:** You can onboard one or more BTP subaccounts by following the steps provided by SAP [see Audit Log Retrieval API Usage for Subaccounts in the Cloud Foundry Environment](https://help.sap.com/docs/btp/sap-business-technology-platform/audit-log-retrieval-api-usage-for-subaccounts-in-cloud-foundry-environment/). Repeat the steps above and redeploy the ARM template (step 3) for each subaccount."
            },
            {
              "description": "**Step 3 - Azure Resource Manager (ARM) Template**\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-sapbtp-azuredeploy)\n2. Enter the values collected in steps 1 and 2 as parameters in the ARM template. Populate Key Vault name, name of the Key Vault secret, Audit Retrieval API URL, UAA Server URL, clientid.\n3. Click **Purchase** to deploy."
            },
            {
              "description": "**Step 4 - Set Key Vault Access Policy**\n\nTo allow the Azure Function to access the Key Vault, you need to set the Key Vault Access Policy. \n\n1. Go to the Azure Portal and select the Key Vault created in Step 1.\n2. Select Access Policies from the left menu.\n3. Click on the **+ Add Access Policy** button.\n4. Select the **Secret Permissions** tab.\n5. Select the **Get** permissions.\n6. Select the **Azure Functions** service principal from the **Select principal** dropdown.\n7. Click on the **Add** button.\n8. Click on the **Save** button."
            }
          ],
          "id": "[variables('_uiConfigId1')]"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "2.0.1",
        "kind": "Solution",
        "contentSchemaVersion": "2.0.0",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "SAP BTP",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId1')]",
              "version": "[variables('analyticRuleVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId2')]",
              "version": "[variables('analyticRuleVersion2')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId3')]",
              "version": "[variables('analyticRuleVersion3')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId4')]",
              "version": "[variables('analyticRuleVersion4')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId5')]",
              "version": "[variables('analyticRuleVersion5')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            }
          ]
        },
        "firstPublishDate": "2023-04-04",
        "providers": [
          "Microsoft"
        ],
        "categories": {
          "domains": [
            "Application",
            "Cloud Provider"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
