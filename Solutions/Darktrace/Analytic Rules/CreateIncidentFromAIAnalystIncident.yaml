id: ffa2977f-3077-4bba-b1bf-f3417699cbb0
name: Darktrace AI Analyst 
description: |
  'This rule creates Microsoft Sentinel Incidents based on Darktrace AI Analyst Incidents, fetched every 5 minutes.'
severity: High
requiredDataConnectors:
  - connectorId: DarktraceRESTConnector
    dataTypes:
      - darktrace_model_alerts_CL
tactics: [] # no tactics are ingested for AIA events at the moment 
relevantTechniques: []
query: |
  darktrace_model_alerts_CL //anything starting with 'Dt' is not an ASIM mapping 
  | where dtProduct_s =="AI Analyst"
  | project-rename  EventStartTime=startTime_s
  | project-rename EventEndTime = endTime_s
  | project-rename NetworkRuleName=title_s //incident event name
  | project-rename DtCurrentGroup=externalId_g //externalId is the Current Group ID from Darktrace 
  | project-rename ThreatCategory=dtProduct_s
  | project-rename  ThreatRiskLevel=score_d //incident event score (not the group score)
  | extend EventVendor = "Darktrace"
  | extend EventProduct = "Darktrace DETECT"
  | project-rename SrcHostname=hostname_s
  | project-rename SrcIpAddr=deviceIP_s
  | project-rename DtURL=url_s
  | project-rename DtSummary=summary_s //summary for the incident event 
  | project-rename DtGroupScore=groupScore_d
  | project-rename DtGroupCategory=groupCategory_s // 3 possible catgrs: compliance, suspicious, critical
  | extend DtSentinelCategory=DtGroupCategory
  | extend DtSentinelCategory=replace_regex(DtSentinelCategory, @'compliance', @'Low')
  | extend DtSentinelCategory=replace_regex(DtSentinelCategory, @'suspicious', @'Medium')
  | extend DtSentinelCategory=replace_regex(DtSentinelCategory, @'critical', @'High')
  | project-rename DtSrcDeviceName=bestDeviceName_s, DtIndentifier=identifier_s, ActivityID=activityId_s, DtGroupingID=groupingId_s, DtGroupByActivity=groupByActivity_b, DtSummaryFirstSentence=summaryFirstSentence_s, DtNewEvent=newEvent_b, DtCGLegacy=currentGroup_s, DtGroupPreviousGroups=groupPreviousGroups_s, DtTime=time_s, DtSeverity=Severity, DtLongitude=longitude_d, DtLatitude=latitude_d 
eventGroupingSettings:
  aggregationKind: AlertPerResult
entityMappings: 
 - entityType: Host
   fieldMappings:
    - identifier: "HostName"
      columnName: "SrcHostname"
 - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SrcIpAddr
customDetails:
  EventStartTime: EventStartTime,
  EventEndTime: EventEndTime,
  NetworkRuleName: NetworkRuleName,
  DtCurrentGroup: DtCurrentGroup,
  ThreatCategory: ThreatCategory,
  ThreatRiskLevel: ThreatRiskLevel,
  DtURL: DtURL,
  DtSummary: DtSummary,
  DtGroupScore: DtGroupScore,
  DtGroupCategory: DtGroupCategory,
  DtSentinelCategory: DtSentinelCategory,
  DtSrcDeviceName: DtSrcDeviceName,
  DtNewEvent: DtNewEvent,
  DtSeverity: DtSeverity
alertDetailsOverride: 
  alertDisplayNameFormat: 'Darktrace: {{ThreatRiskLevel}} - {{NetworkRuleName}}'
  alertDescriptionFormat: '{{DtSummary}}'
  alertTacticsColumnName: 
  alertSeverityColumnName: DtSentinelCategory
  alertDynamicProperties:
    - alertProperty: AlertLink
      value: DtURL
    - alertProperty: ProviderName
      value: EventVendor
    - alertProperty: ProductName
      value: EventProduct
    - alertProperty: ProductComponentName
      value: ThreatCategory
version: 1.1.0
kind: NRT               


