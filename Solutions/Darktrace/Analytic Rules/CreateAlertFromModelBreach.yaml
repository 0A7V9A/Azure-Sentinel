id: a3c7b8ed-56a9-47b7-98e5-2555c16e17c9
name: Darktrace Model Breach
description: |
  'This rule creates Microsoft Sentinel Alerts based on Darktrace Model Breaches, fetched every 5 minutes.'
severity: Medium
requiredDataConnectors:
  - connectorId: DarktraceRESTConnector
    dataTypes:
      - darktrace_model_alerts_CL
tactics: # tactics pulled dynamically
relevantTechniques:
query: |
  darktrace_model_alerts_CL //anything starting with 'Dt' is not an ASIM mapping 
  | where dtProduct_s =="Policy Breach"
  | extend EventCount = 1
  | extend EventType = "NetworkSession"
  | extend EventSchema = "NetworkSession"
  | extend EventSchemaVersion = "0.2.2"
  | extend EventResult = "Success"
  | extend DvcAction = "Allow"
  | project-rename EventSeverity=score_d //model breach score 
  | extend EventVendor = "Darktrace"
  | extend EventProduct = "Darktrace DETECT"
  | project-rename  EventStartTime = breachTime_s
  | extend EventEndTime = EventStartTime
  | project-rename NetworkRuleName=modelName_s //model breach name
  | project-rename NetworkRuleNumber=pid_d //model ID 
  | project-rename ThreatId=threatID_d //model breach ID 
  | extend ThreatName = NetworkRuleName
  | project-rename ThreatCategory=dtProduct_s
  | extend ThreatRiskLevel=EventSeverity
  | extend DtSentinelCategory = case(Category == "Suspicious", "Medium", 
                                   Category == "Critical", "High",
                                   "Informational") //Darktrace Informational types map to Sentinel Informational types, suspicious -> medium, critical -> high
  | project-rename SrcIpAddr=SourceIP, SrcHostname=hostname_s, SrcMacAddr=sourceMac_s, SrcPortNumber=sourcePort_s, DstIpAddr=destIP_s, DstPortNumber=destPort_s, DstHostname=destHost_s, DstMacAddr=destMac_s, DtCompliance=compliance_b, DtClientSensor=cSensor_b, DtDescription=description_s, DtAntigena=antigena_b, DtDeviceID=deviceId_d, DtSubnetID=sid_d, DtTags=tags_s, DtMitreTechniques=mitreTechniques_s, DtMessage=Message, DtUUID=uuid_g, DtBreachURL=breachUrl_s, DtSrcTypeLabel=typeLabel_s, DtTriggeredComponents=triggeredComponents_s, DtDetails=details_s, DtLongitude=longitude_d, DtLatitude=latitude_d, DtCategory=Category
eventGroupingSettings:
  aggregationKind: AlertPerResult
entityMappings:
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: SrcHostname
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: DstHostname
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SrcIpAddr
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: DstIpAddr
customDetails:
  SrcMacAddr: SrcMacAddr
  EventSeverity: EventSeverity
  EventStartTime: EventStartTime
  NetworkRuleName: NetworkRuleName
  NetworkRuleNumber: NetworkRuleNumber
  ThreatId: ThreatId
  ThreatCategory: ThreatCategory
  DtSentinelCategory: DtSentinelCategory
  SrcPortNumber: SrcPortNumber
  DstPortNumber: DstPortNumber
  DstMacAddr: DstMacAddr
  DtCompliance: DtCompliance
  DtBreachURL: DtBreachURL
  DtDescription: DtDescription
  DtCategory: DtCategory
  DtDeviceID: DtDeviceID
# These are described here - this is why we're leaving tactics and techniques above empty
alertDetailsOverride:
  # model breach name here
  alertDisplayNameFormat: 'Darktrace: {{ThreatRiskLevel}} - {{NetworkRuleName}}' # Up to 256 chars and 3 placeholders
  alertDescriptionFormat: '{{DtMessage}}' # Up to 5000 chars and 3 placeholders
  # MITRE tactic
  alertTacticsColumnName: #we need to figure out whether this expect a numerical ID or word description of mitre technique
  alertSeverityColumnName: DtSentinelCategory
  alertDynamicProperties:
    - alertProperty: AlertLink
      value: DtBreachURL
    - alertProperty: ProviderName
      value: EventVendor
    - alertProperty: ProductName
      value: EventProduct
    - alertProperty: ProductComponentName
      value: ThreatCategory
version: 1.1.0
kind: NRT