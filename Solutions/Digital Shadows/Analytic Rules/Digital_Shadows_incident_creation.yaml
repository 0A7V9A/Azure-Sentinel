$schema: >-
  https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#
contentVersion: 1.0.0.0
parameters:
  workspace:
    type: String
resources:
  - id: >-
      [concat(resourceId('Microsoft.OperationalInsights/workspaces/providers',
      parameters('workspace'),
      'Microsoft.SecurityInsights'),'/alertRules/584236d8-e4c1-4919-a2fd-63dfaf975d8f')]
    name: >-
      [concat(parameters('workspace'),'/Microsoft.SecurityInsights/584236d8-e4c1-4919-a2fd-63dfaf975d8f')]
    type: Microsoft.OperationalInsights/workspaces/providers/alertRules
    kind: Scheduled
    apiVersion: 2021-09-01-preview
    properties:
      displayName: DigitalShadowsResearch - All incidents promoted
      description: >-
        All DigitalShadows incidents will be promoted to Azure Sentinel
        incidents
      severity: High
      enabled: true
      query: |-
        DigitalShadows_CL
        | summarize arg_max(TimeGenerated, *) by id_d, id_g
      queryFrequency: PT5M
      queryPeriod: PT6M
      triggerOperator: GreaterThan
      triggerThreshold: 0
      suppressionDuration: PT5H
      suppressionEnabled: false
      tactics: []
      techniques: []
      alertRuleTemplateName: null
      incidentConfiguration:
        createIncident: true
        groupingConfiguration:
          enabled: true
          reopenClosedIncident: true
          lookbackDuration: P7D
          matchingMethod: Selected
          groupByEntities: []
          groupByAlertDetails: []
          groupByCustomDetails:
            - triage_id
      eventGroupingSettings:
        aggregationKind: AlertPerResult
      alertDetailsOverride:
        alertDisplayNameFormat: 'DigitalShadows - {{title_s}}'
        alertDescriptionFormat: '{{description_s}}'
        alertTacticsColumnName: null
        alertSeverityColumnName: null
      customDetails:
        incident_id: id_d
        alert_id: id_g
        impact_description: impact_description_s
        mitigation: mitigation_s
        risk_incident: risk_level_s
        risk_alert: risk_assessment_risk_level_s
        status: status_s
        triage_id: triage_id_g
        comments: comments_s
      entityMappings: null
  - id: >-
      [concat(resourceId('Microsoft.OperationalInsights/workspaces/providers',
      parameters('workspace'),
      'Microsoft.SecurityInsights'),'/alertRules/584236d8-e4c1-4919-a2fd-63dfaf975d8f/actions/fec7e5af04f94910a9ec500e1d5c3d59')]
    name: >-
      [concat(parameters('workspace'),'/Microsoft.SecurityInsights/584236d8-e4c1-4919-a2fd-63dfaf975d8f/fec7e5af04f94910a9ec500e1d5c3d59')]
    type: Microsoft.OperationalInsights/workspaces/providers/alertRules/actions
    apiVersion: 2021-09-01-preview
    properties:
      ruleId: >-
        [concat(resourceId('Microsoft.OperationalInsights/workspaces/providers',
        parameters('workspace'),
        'Microsoft.SecurityInsights'),'/alertRules/584236d8-e4c1-4919-a2fd-63dfaf975d8f')]
      triggerUri: >-
        [listCallbackURL(concat('/subscriptions/9ecebafb-a962-4e36-9e10-0cfbbc18b52f/resourceGroups/DigitalShadows/providers/Microsoft.Logic/workflows/status-severity_update','/triggers/When_a_response_to_an_Azure_Sentinel_alert_is_triggered'),'2016-06-01').value]
      logicAppResourceId: >-
        /subscriptions/9ecebafb-a962-4e36-9e10-0cfbbc18b52f/resourceGroups/DigitalShadows/providers/Microsoft.Logic/workflows/status-severity_update
      operatesOn: Alert
    dependsOn:
      - >-
        [concat(resourceId('Microsoft.OperationalInsights/workspaces/providers',
        parameters('workspace'),
        'Microsoft.SecurityInsights'),'/alertRules/584236d8-e4c1-4919-a2fd-63dfaf975d8f')]
