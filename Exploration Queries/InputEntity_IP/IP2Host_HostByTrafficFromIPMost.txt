// Id: 73fb9b8d-fd13-4c43-8136-6d693cafaa23
// DisplayName: Hosts Receiving Most Amount of Data from IP
// Description: Hosts Receiving Most Amount of Data from IP during the range of -1d and +1d
// DataSource: WireData
// InputEntityType: IP
// InputFields: [Address]
// OutputEntityTypes: [Host]
// QueryPeriodBefore: 1d
// QueryPeriodAfter: 1d
// Tactics: #Exfiltration, #CommandAndControl, #Collection

let HostsReceivingDatafromIP = (v_ipAddress:string){
	WireData
	| parse Computer with HostName "." Host_DnsName
    | parse Host_DnsName with * "." Host_NTDomain
	| where SessionState == "Disconnected" 
	| where RemoteIP == v_ipAddress
    | extend Host_HostName = iff(Computer has ".", HostName, Computer)
	| summarize Host_Aux_BytesReceived = sum(ReceivedBytes), make_set(LocalIP) by Host_HostName, Host_DnsName, Host_NTDomain
	| top 10 by Host_Aux_BytesReceived desc nulls last
};
HostsReceivingDatafromIP(<Address>)