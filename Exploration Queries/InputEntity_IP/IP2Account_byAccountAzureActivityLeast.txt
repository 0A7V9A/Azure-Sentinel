// Id: 37ca3555-c135-4a73-a65e-9c1d00323f5d
// DisplayName: Least Active Accounts On Azure From IP
// Description: Least active accounts on azure from IP during the range of -12h and +12h
// InputEntityType: IP
// InputFields: [Address]
// OutputEntityTypes: [Account]
// QueryPeriodBefore: 12h
// QueryPeriodAfter: 12h
// DataSource: AzureActivity
// Tactics: #Exfiltration, #CommandAndControl, #Collection

let AccountActivity_byIP = (v_Address:string){
AzureActivity
| where Caller != ''
| summarize StartTime = min(EventSubmissionTimestamp), 
			  EndTime = min(EventSubmissionTimestamp), 
			  Count = count() by 
			  Caller, TenantId
| top 10 by Count asc nulls last 
| extend UPN = iff(Caller contains '@', Caller, ''), Account_AadUserId = iff(Caller !contains '@', Caller,'')
| extend Account_Name = split(UPN,'@')[0] , Account_UPNSuffix = split(UPN,'@')[1]
| project Account_Name, Account_UPNSuffix, Account_AadUserId, Account_AadTenantId=TenantId, StartTime , EndTime 
};
AccountActivity_byIP(<Address>)