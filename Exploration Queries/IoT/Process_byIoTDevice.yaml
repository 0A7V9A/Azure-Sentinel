Id: 1f3ecde7-5c69-4d44-ac93-5feac6d1cd2f
DisplayName: Most Frequent Command executions on The Device
Description: Most Frequent Command executions on The Device
InputEntityType: IoTDevice
InputFields:
  - DeviceId
  - IoTHub
OutputEntityTypes:
  - Process
QueryPeriodBefore: 30m
QueryPeriodAfter: 30m
DataConnector:
  ConnectorId: SecurityIoTRawEvent
query: |

  let Process_byIoTDevice = (v_IotDevice_DeviceId:string, v_IoTDevice_IoTHub:string){
  SecurityIoTRawEvent 
  | where RawEventName == 'ProcessCreate'
  | where AssociatedResourceId == parse_json(v_IoTDevice_IoTHub)['ResourceId'] and DeviceId == v_IotDevice_DeviceId
  | extend Process_CommandLine = tostring(parse_json(EventDetails)['CommandLine'])
  | summarize procCount = count() by Process_CommandLine
  | top 10 by procCount 
  | project-away procCount
  };
  Process_byIoTDevice('<DeviceId>', '<IoTHub>')